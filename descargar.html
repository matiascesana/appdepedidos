<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Descargar Documentos</title>
</head>
<body>

    <h1>Descargar Documentos</h1>

    <div>
        <label for="dni-search">Ingresa tu DNI:</label>
        <input type="text" id="dni-search">
    </div>

    <button onclick="fetchDocuments()">Buscar Documentos</button>

    <div id="document-list"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'TU_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'TU_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function fetchDocuments() {
            const dni = document.getElementById('dni-search').value;
            if (!dni) {
                alert('Por favor, ingresa tu DNI.');
                return;
            }

            try {
                // Aquí es donde la política RLS hace su magia
                // Solo devuelve documentos con el DNI proporcionado
                const { data: documents, error } = await supabase
                    .from('documents')
                    .select('*')
                    .eq('dni', dni);

                if (error) throw error;

                const list = document.getElementById('document-list');
                list.innerHTML = ''; // Limpia la lista anterior

                if (documents.length === 0) {
                    list.innerHTML = '<p>No se encontraron documentos para este DNI.</p>';
                    return;
                }

                documents.forEach(doc => {
                    const docDiv = document.createElement('div');
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = doc.file_name;
                    link.onclick = () => downloadDocument(doc.storage_path);
                    docDiv.appendChild(link);
                    list.appendChild(docDiv);
                });

            } catch (error) {
                alert(`Error: ${error.message}`);
                console.error(error);
            }
        }

        async function downloadDocument(path) {
            try {
                const { data, error } = await supabase.storage
                    .from('private-documents')
                    .createSignedUrl(path, 60); // URL válida por 60 segundos

                if (error) throw error;

                window.open(data.signedUrl, '_blank');
            } catch (error) {
                alert(`Error al descargar: ${error.message}`);
                console.error(error);
            }
        }
    </script>
</body>
</html>
