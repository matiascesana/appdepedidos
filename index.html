<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administración</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
    }
    /* Sidebar */
    .sidebar {
      width: 220px;
      background: #2c3e50;
      color: #fff;
      min-height: 100vh;
      padding-top: 20px;
      position: fixed;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .tab-btn {
      display: block;
      width: 100%;
      padding: 12px 16px;
      text-align: left;
      border: none;
      background: none;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
    }
    .tab-btn:hover, .tab-btn.active {
      background: #34495e;
    }
    /* Main */
    .main {
      margin-left: 220px;
      padding: 20px;
      flex: 1;
    }
    .item-card {
      display: flex; align-items: center;
      padding: 10px; margin: 6px 0;
      border: 1px solid #ddd; border-radius: 6px;
      background: #fafafa;
    }
    .item-card img {
      width: 56px; height: 56px;
      object-fit: cover; border-radius: 8px;
      margin-right: 10px;
    }
    button { margin-left: 8px; cursor: pointer; }
    .delete-btn { color: red; }
    .small-muted { font-size: 0.9em; color: #555; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Panel</h2>
    <button class="tab-btn active" data-tab="promos">Promociones</button>
    <button class="tab-btn" data-tab="pedidos">Pedidos</button>
    <button class="tab-btn" data-tab="categorias">Categorías</button>
    <button class="tab-btn" data-tab="localidades">Localidades</button>
    <button class="tab-btn" data-tab="documentos">Documentos</button>
  </div>

  <!-- MAIN -->
  <div class="main">
    <h1 id="mainTitle">Gestión de Promociones</h1>

    <!-- SECCIONES -->
    <div class="section" id="promos">
      <form id="promoForm" onsubmit="event.preventDefault(); addPromo();">
        <input type="text" id="promoNombre" placeholder="Nombre" required><br><br>
        <textarea id="promoDescripcion" placeholder="Descripción"></textarea><br><br>
        <input type="number" id="promoPrecio" placeholder="Precio" step="0.01" required><br><br>
        <input type="number" id="promoPrecioAnterior" placeholder="Precio anterior" step="0.01"><br><br>
        <input type="number" id="promoStock" placeholder="Stock"><br><br>
        <select id="promoCategoria">
          <option value="">-- Selecciona categoría --</option>
        </select><br><br>
        <input type="file" id="promoImagen" accept="image/*"><br><br>
        <button type="submit">Agregar promoción</button>
      </form>
      <h2>Listado de Promociones</h2>
      <div id="promoList"></div>
    </div>

    <div class="section" id="pedidos" style="display:none">
      <h2>Gestión de Pedidos</h2>
      <p>Aquí iría el módulo de pedidos.</p>
    </div>

    <div class="section" id="categorias" style="display:none">
      <h2>Gestión de Categorías</h2>
      <p>Aquí iría el módulo de categorías.</p>
    </div>

    <div class="section" id="localidades" style="display:none">
      <h2>Gestión de Localidades</h2>
      <p>Aquí iría el módulo de localidades.</p>
    </div>

    <div class="section" id="documentos" style="display:none">
      <h2>Gestión de Documentos</h2>
      <p>Aquí iría el módulo de documentos.</p>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient("https://ejbqlejlgprvwzrptojo.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8");

    // Sidebar navegación
    const titleMap = {
      promos: "Gestión de Promociones",
      pedidos: "Gestión de Pedidos",
      categorias: "Gestión de Categorías",
      localidades: "Gestión de Localidades",
      documentos: "Gestión de Documentos"
    };
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".section").forEach(sec => sec.style.display="none");
        document.getElementById(btn.dataset.tab).style.display="block";
        document.getElementById("mainTitle").textContent = titleMap[btn.dataset.tab];
      });
    });

    // Helpers
    function escapeHtml(text) {
      var div = document.createElement("div");
      div.innerText = text;
      return div.innerHTML;
    }
    async function safeGetFileUrl(path) {
      if (!path) return "";
      const { data } = supabase.storage.from("promo_images").getPublicUrl(path);
      return data?.publicUrl || "";
    }

    // CRUD PROMOCIONES
    async function fetchPromotions() {
      const { data, error } = await supabase.from('promociones').select('*, categorias(nombre)').order('id');
      if (error) return console.error(error);
      const container = document.getElementById("promoList");
      container.innerHTML = "";
      for (const promo of data) {
        const imgUrl = await safeGetFileUrl(promo.imagen);
        const imgHTML = imgUrl ? `<img src="${imgUrl}" alt="img">` : "";
        let precioHTML = `<strong>$${Number(promo.precio).toFixed(2)}</strong>`;
        if (promo.precio_anterior && Number(promo.precio_anterior) > Number(promo.precio)) {
          precioHTML = `<span style="text-decoration:line-through;color:#999;margin-right:8px;">
                          $${Number(promo.precio_anterior).toFixed(2)}</span>
                        <strong style="color:#e74c3c;font-size:1.1em;">
                          $${Number(promo.precio).toFixed(2)}</strong>`;
        }
        const div = document.createElement("div");
        div.className = "item-card";
        div.innerHTML = `
          ${imgHTML}
          <div style="flex:1">
            <strong>${escapeHtml(promo.nombre)}</strong>
            <div class="small-muted">${precioHTML} · Stock: ${promo.stock ?? 0}</div>
          </div>
          <div>
            <button onclick="editPromo(${promo.id})">Editar</button>
            <button class="delete-btn" onclick="deletePromo(${promo.id}, '${promo.imagen || ''}')">Eliminar</button>
          </div>`;
        container.appendChild(div);
      }
    }

    async function addPromo() {
      const nombre = document.getElementById("promoNombre").value.trim();
      const descripcion = document.getElementById("promoDescripcion").value.trim();
      const precio = parseFloat(document.getElementById("promoPrecio").value);
      const precioAnterior = parseFloat(document.getElementById("promoPrecioAnterior").value);
      const stock = parseInt(document.getElementById("promoStock").value);
      const categoria_id = document.getElementById("promoCategoria").value || null;
      const file = document.getElementById("promoImagen").files[0];
      if (!nombre || isNaN(precio)) return alert("Complete nombre y precio válido");

      let imagen = null;
      if (file) {
        const filePath = `${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabase.storage.from("promo_images").upload(filePath, file);
        if (uploadError) return alert("Error al subir imagen: " + uploadError.message);
        imagen = filePath;
      }

      const { error } = await supabase.from("promociones").insert([{
        nombre, descripcion, precio, precio_anterior: precioAnterior || null,
        stock: stock || 0, categoria_id, imagen
      }]);
      if (error) return alert(error.message);
      document.getElementById("promoForm").reset();
      fetchPromotions();
    }

    async function deletePromo(id, imagePath) {
      if (!confirm("¿Eliminar esta promoción?")) return;
      await supabase.from("promociones").delete().eq("id", id);
      if (imagePath) await supabase.storage.from("promo_images").remove([imagePath]);
      fetchPromotions();
    }

    function editPromo(id) { alert("Aquí va modal de edición para ID " + id); }

    // Inicial
    fetchPromotions();
  </script>
</body>
</html>
```
