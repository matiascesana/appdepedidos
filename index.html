<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>App Completa ‚Äî Pedidos, Promos, Docs</title>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- html2pdf (incluye html2canvas + jsPDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto&display=swap" rel="stylesheet">

<style>
  :root{--accent:#6a1b9a;--accent-2:#7b1fa2;--danger:#e53935;}
  *{box-sizing:border-box}
  body{margin:0;font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial; background:#f9f9f9;color:#222;display:flex;height:100vh;overflow:hidden}
  .sidebar{width:210px;background:var(--accent);color:#fff;padding:20px;display:flex;flex-direction:column}
  .sidebar .logo{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:16px}
  .sidebar button{background:transparent;border:0;color:#fff;padding:10px 12px;border-radius:8px;text-align:left;cursor:pointer;margin-bottom:8px;font-weight:600}
  .sidebar button.active{background:#fff;color:var(--accent);box-shadow:0 4px 12px rgba(0,0,0,0.08)}
  .main{flex:1;padding:20px;overflow:auto}
  h1,h2{font-family:'Playfair Display',serif}
  .section{display:none;background:#fff;padding:18px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:18px}
  .item-card,.doc-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#f4f4f4;margin-bottom:10px}
  .item-card img{width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px}
  label{display:block;margin:8px 0;font-size:14px}
  input[type=text],input[type=number],select{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%}
  button{cursor:pointer;border:0;border-radius:8px;padding:8px 12px;background:var(--accent);color:#fff;font-weight:700}
  button:hover{background:var(--accent-2)}
  .delete-btn{background:var(--danger)}
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
  .modal-content{background:#fff;padding:16px;border-radius:10px;max-width:820px;width:95%;max-height:85vh;overflow:auto;position:relative}
  .modal-close{position:absolute;right:12px;top:8px;cursor:pointer;font-weight:700}
  table{width:100%;border-collapse:collapse}
  table th,table td{padding:8px;border:1px solid #e6e6e6}
  .small-muted{font-size:13px;color:#666}
  .flex{display:flex;gap:10px;align-items:center}
  .row{display:flex;gap:12px}
  @media (max-width:900px){.sidebar{display:none}.main{padding:12px}}
</style>
</head>
<body>

  <div class="sidebar">
    <div class="logo">Mi App ‚Äî Pedidos</div>
    <button class="tab-btn active" data-tab="promos">Promociones</button>
    <button class="tab-btn" data-tab="pedidos">Pedidos</button>
    <button class="tab-btn" data-tab="categorias">Categor√≠as</button>
    <button class="tab-btn" data-tab="localidades">Localidades</button>
    <button class="tab-btn" data-tab="documentos">Documentos</button>
    <div style="margin-top:auto;font-size:12px;opacity:.9">Dise√±o integrado ¬∑ Export PDF incluido</div>
  </div>

  <div class="main">
    <h1>App Completa de Pedidos y Documentos</h1>

    <!-- PROMOCIONES -->
    <section class="section" id="promos">
      <h2>Promociones</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
        <div style="flex:1;min-width:220px">
          <label>Nombre / Descripci√≥n
            <input id="promoNombre" type="text" placeholder="Ej: Promo Super">
          </label>
        </div>
        <div style="width:120px">
          <label>Precio
            <input id="promoPrecio" type="number" step="0.01" placeholder="0.00">
          </label>
        </div>
        <div style="width:120px">
          <label>Stock
            <input id="promoStock" type="number" placeholder="0">
          </label>
        </div>
        <div style="width:200px">
          <label>Imagen (jpg/png)
            <input id="promoImagen" type="file" accept="image/*">
          </label>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:14px">
        <button id="addPromoBtn">Agregar Promoci√≥n</button>
        <button id="exportPromoPdfBtn">Exportar Cat√°logo PDF</button>
        <button id="refreshPromosBtn" style="background:#444">Refrescar listado</button>
      </div>

      <h3>Lista de Promociones</h3>
      <div id="promoList"></div>
    </section>

    <!-- PEDIDOS -->
    <section class="section" id="pedidos">
      <h2>Pedidos</h2>
      <form id="pedidoForm" onsubmit="return false;" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
        <div style="flex:1;min-width:220px">
          <label>Cliente
            <input id="pedidoCliente" type="text" placeholder="Nombre cliente">
          </label>
        </div>
        <div style="width:220px">
          <label>Localidad
            <select id="pedidoLocalidad"></select>
          </label>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button type="button" id="selectProductsBtn">Seleccionar Productos</button>
        </div>

        <div style="width:100%;margin-top:6px">
          <div id="selectedProductsContainer" class="small-muted"></div>
        </div>

        <div style="display:flex;gap:8px">
          <button type="button" id="addOrderBtn">Agregar Pedido</button>
          <button type="button" id="exportPedidosPDFBtn">Exportar Pedidos (PDF)</button>
        </div>
      </form>

      <h3>Lista de Pedidos</h3>
      <div id="pedidoList"></div>
    </section>

    <!-- CATEGOR√çAS -->
    <section class="section" id="categorias">
      <h2>Categor√≠as</h2>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input id="categoriaNombre" placeholder="Nombre categor√≠a" />
        <button id="addCategoriaBtn">Agregar Categor√≠a</button>
      </div>
      <div id="categoriaList"></div>
    </section>

    <!-- LOCALIDADES -->
    <section class="section" id="localidades">
      <h2>Localidades</h2>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input id="localidadNombre" placeholder="Nombre localidad" />
        <button id="addLocalidadBtn">Agregar Localidad</button>
      </div>
      <div id="localidadList"></div>
    </section>

    <!-- DOCUMENTOS -->
    <section class="section" id="documentos">
      <h2>Documentos</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
        <input id="docDni" placeholder="DNI (buscar)" />
        <input id="docFiles" type="file" multiple />
        <button id="uploadDocsBtn">Subir Documentos</button>
        <button id="deleteAllDocsBtn" class="delete-btn">Eliminar Todos</button>
      </div>
      <div id="docProgressContainer" style="width:100%;background:#eee;border-radius:6px;overflow:hidden;margin-bottom:8px;display:none">
        <div id="docProgress" style="width:0;height:8px;background:green"></div>
      </div>
      <h3>Documentos subidos</h3>
      <div id="documentsList"></div>
    </section>

  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">√ó</span>
      <div id="modalInner"></div>
    </div>
  </div>

<script>
/* ============================
   Configuraci√≥n Supabase
   ============================ */
const SUPABASE_URL = 'https://ejbqlejlgprvwzrptojo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================
   Helpers UI / Modal / Toast
   ============================ */
function showToast(msg, ms=3000){
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style,{
    position:'fixed',right:'20px',bottom:'20px',background: 'var(--accent)', color:'#fff', padding:'10px 14px',
    borderRadius:'8px', boxShadow:'0 6px 18px rgba(0,0,0,0.12)', zIndex:9999
  });
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), ms);
}
function openModal(html){
  document.getElementById('modalInner').innerHTML = html;
  document.getElementById('modal').style.display = 'flex';
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

/* ============================
   Tabs
   ============================ */
const tabBtns = document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
  });
});
// default
document.getElementById('promos').style.display = 'block';

/* ============================
   CATEGOR√çAS
   ============================ */
async function fetchCategorias(){
  const {data, error} = await supabase.from('categorias').select('*').order('id');
  if(error) return console.error(error);
  const container = document.getElementById('categoriaList');
  container.innerHTML = '';
  data.forEach(c=>{
    const div = document.createElement('div');
    div.className='item-card';
    div.innerHTML = `<span>${c.nombre}</span>
      <div>
        <button onclick="editCategoria(${c.id},'${escapeHtml(c.nombre)}')">Editar</button>
        <button class="delete-btn" onclick="deleteCategoria(${c.id})">Eliminar</button>
      </div>`;
    container.appendChild(div);
  });
}
window.addCategoria = async function(){
  const nombre = document.getElementById('categoriaNombre').value.trim();
  if(!nombre) return alert('Ingrese nombre');
  const {error} = await supabase.from('categorias').insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById('categoriaNombre').value='';
  fetchCategorias();
}
window.editCategoria = function(id,nombre){
  openModal(`<h3>Editar Categor√≠a</h3>
    <input id="editCatName" value="${escapeHtml(nombre)}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd">
    <div style="margin-top:10px"><button onclick="updateCategoria(${id})">Guardar</button></div>`);
}
window.updateCategoria = async function(id){
  const nombre = document.getElementById('editCatName').value.trim();
  if(!nombre) return alert('Ingrese nombre');
  const {error} = await supabase.from('categorias').update({nombre}).eq('id',id);
  if(error) return alert(error.message);
  closeModal();
  fetchCategorias();
}
window.deleteCategoria = async function(id){
  if(!confirm('Eliminar categor√≠a?')) return;
  await supabase.from('categorias').delete().eq('id',id);
  fetchCategorias();
}
fetchCategorias();

/* ============================
   LOCALIDADES
   ============================ */
async function fetchLocalidades(){
  const {data,error} = await supabase.from('localidades').select('*').order('id');
  if(error) return console.error(error);
  const list = document.getElementById('localidadList');
  const select = document.getElementById('pedidoLocalidad');
  list.innerHTML = ''; select.innerHTML = '<option value="">Seleccione</option>';
  data.forEach(l=>{
    list.innerHTML += `<div class="item-card"><span>${l.nombre}</span>
      <div><button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')">Editar</button>
      <button class="delete-btn" onclick="deleteLocalidad(${l.id})">Eliminar</button></div></div>`;
    select.innerHTML += `<option value="${l.id}">${l.nombre}</option>`;
  });
}
window.addLocalidad = async function(){
  const nombre = document.getElementById('localidadNombre').value.trim();
  if(!nombre) return alert('Ingrese nombre');
  const {error} = await supabase.from('localidades').insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById('localidadNombre').value='';
  fetchLocalidades();
}
window.editLocalidad = function(id,nombre){
  openModal(`<h3>Editar Localidad</h3>
    <input id="editLocName" value="${escapeHtml(nombre)}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd">
    <div style="margin-top:10px"><button onclick="updateLocalidad(${id})">Guardar</button></div>`);
}
window.updateLocalidad = async function(id){
  const nombre = document.getElementById('editLocName').value.trim();
  if(!nombre) return alert('Ingrese nombre');
  const {error} = await supabase.from('localidades').update({nombre}).eq('id',id);
  if(error) return alert(error.message);
  closeModal();
  fetchLocalidades();
}
window.deleteLocalidad = async function(id){
  if(!confirm('Eliminar localidad?')) return;
  await supabase.from('localidades').delete().eq('id',id);
  fetchLocalidades();
}
fetchLocalidades();

/* ============================
   PROMOCIONES
   ============================ */
async function fetchPromotions(){
  const {data,error} = await supabase.from('promociones').select('*').order('id');
  if(error) return console.error(error);
  const container = document.getElementById('promoList');
  container.innerHTML = '';
  for(const promo of data){
    const imgUrl = promo.imagen ? await safeGetFileUrl(promo.imagen) : (promo.imagen_url||'');
    const imgHTML = imgUrl ? `<img src="${imgUrl}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px">` : '';
    const div = document.createElement('div');
    div.className='item-card';
    div.innerHTML = `${imgHTML}<div style="flex:1"><strong>${escapeHtml(promo.nombre||promo.descripcion||'Sin nombre')}</strong><div class="small-muted">$${Number(promo.precio).toFixed(2)} &nbsp; ¬∑ &nbsp; Stock: ${promo.stock ?? 0}</div></div>
      <div>
        <button onclick="editPromo(${promo.id})">Editar</button>
        <button class="delete-btn" onclick="deletePromo(${promo.id})">Eliminar</button>
      </div>`;
    container.appendChild(div);
  }
}
window.addPromo = async function(){
  const nombre = document.getElementById('promoNombre').value.trim();
  const precio = parseFloat(document.getElementById('promoPrecio').value);
  const stock = parseInt(document.getElementById('promoStock').value,10) || 0;
  const file = document.getElementById('promoImagen').files[0];
  if(!nombre || isNaN(precio) || !file) return alert('Complete nombre, precio e imagen');
  // Upload image to bucket 'promo_images'
  const fileName = `promo_${Date.now()}_${file.name.replaceAll(' ','_')}`;
  const {data:upData, error:upErr} = await supabase.storage.from('promo_images').upload(fileName, file, {upsert:true});
  if(upErr) return alert(upErr.message);
  const publicUrl = await safeGetFileUrl(fileName); // signed url
  const {error} = await supabase.from('promociones').insert([{nombre,precio,stock,imagen:fileName,imagen_url:publicUrl}]);
  if(error) return alert(error.message);
  document.getElementById('promoNombre').value='';
  document.getElementById('promoPrecio').value='';
  document.getElementById('promoStock').value='';
  document.getElementById('promoImagen').value='';
  fetchPromotions();
  showToast('Promoci√≥n agregada');
}
window.editPromo = async function(id){
  const {data,error} = await supabase.from('promociones').select('*').eq('id',id).single();
  if(error) return alert(error.message);
  const p = data;
  openModal(`<h3>Editar Promoci√≥n</h3>
    <label>Nombre<input id="editPromoNombre" value="${escapeHtml(p.nombre||p.descripcion||'')}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"></label>
    <label>Precio<input id="editPromoPrecio" type="number" step="0.01" value="${p.precio}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"></label>
    <label>Stock<input id="editPromoStock" type="number" value="${p.stock||0}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"></label>
    <div style="margin-top:10px"><button onclick="updatePromo(${p.id})">Guardar</button></div>`);
}
window.updatePromo = async function(id){
  const nombre = document.getElementById('editPromoNombre').value.trim();
  const precio = parseFloat(document.getElementById('editPromoPrecio').value);
  const stock = parseInt(document.getElementById('editPromoStock').value,10) || 0;
  if(!nombre || isNaN(precio)) return alert('Complete campos');
  const {error} = await supabase.from('promociones').update({nombre,precio,stock}).eq('id',id);
  if(error) return alert(error.message);
  closeModal(); fetchPromotions(); showToast('Promoci√≥n actualizada');
}
window.deletePromo = async function(id){
  if(!confirm('Eliminar promoci√≥n?')) return;
  await supabase.from('promociones').delete().eq('id',id);
  fetchPromotions();
}
document.getElementById('refreshPromosBtn').addEventListener('click', fetchPromotions);
fetchPromotions();

/* ============================
   Documentos (storage)
   ============================ */
async function fetchDocuments(filter=''){
  // list files from 'private-documents' bucket
  const {data,error} = await supabase.storage.from('private-documents').list('', {limit: 500});
  if(error) return console.error(error);
  const container = document.getElementById('documentsList'); container.innerHTML = '';
  for(const f of data){
    if(filter && !f.name.includes(filter)) continue;
    const {data: urlData} = await supabase.storage.from('private-documents').createSignedUrl(f.name, 60*60);
    const div = document.createElement('div'); div.className='doc-item';
    div.innerHTML = `<a href="${urlData.signedUrl}" target="_blank">${f.name}</a>
      <div><button class="delete-btn" onclick="deleteDoc('${f.name}')">Eliminar</button></div>`;
    container.appendChild(div);
  }
}
document.getElementById('uploadDocsBtn').addEventListener('click', async ()=>{
  const files = document.getElementById('docFiles').files;
  if(!files.length) return alert('Seleccione archivos');
  document.getElementById('docProgressContainer').style.display='block';
  const progressEl = document.getElementById('docProgress');
  for(let i=0;i<files.length;i++){
    const file = files[i];
    const name = `${Date.now()}_${file.name.replaceAll(' ','_')}`;
    const {error} = await supabase.storage.from('private-documents').upload(name, file, {upsert:true});
    if(error){ alert(error.message); break; }
    progressEl.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
  }
  setTimeout(()=>{ document.getElementById('docProgressContainer').style.display='none'; document.getElementById('docProgress').style.width='0%'; }, 600);
  document.getElementById('docFiles').value='';
  showToast('Documentos subidos');
  fetchDocuments();
});
document.getElementById('deleteAllDocsBtn').addEventListener('click', async ()=>{
  if(!confirm('Eliminar todos los documentos?')) return;
  const {data} = await supabase.storage.from('private-documents').list('', {limit:500});
  if(data && data.length){
    await supabase.storage.from('private-documents').remove(data.map(f=>f.name));
  }
  fetchDocuments();
});
document.getElementById('docDni')?.addEventListener?.('input', (e)=>fetchDocuments(e.target.value));
fetchDocuments();

/* ============================
   Pedidos ‚Äî selecci√≥n productos, add/edit/delete with stock
   ============================ */
let selectedProducts = []; // {id,nombre,cantidad,precio}
let editingOrderId = null;

function getSelectedQty(id){ const it = selectedProducts.find(x=>x.id===id); return it?it.cantidad:0; }

// Open products modal (table with qty inputs and subtotal)
document.getElementById('selectProductsBtn').addEventListener('click', async ()=>{
  const {data:promos, error} = await supabase.from('promociones').select('*').order('id');
  if(error) return alert(error.message);
  // build table
  let html = `<table><thead><tr><th>Producto</th><th>Precio</th><th>Stock</th><th style="width:120px">Cantidad</th><th>Subtotal</th></tr></thead><tbody>`;
  promos.forEach(p=>{
    const qty = getSelectedQty(p.id);
    html += `<tr>
      <td>${escapeHtml(p.nombre||p.descripcion||'Sin nombre')}</td>
      <td>$${Number(p.precio).toFixed(2)}</td>
      <td>${p.stock ?? 0}</td>
      <td><input type="number" min="0" max="${p.stock ?? 0}" id="prod_${p.id}" value="${qty}" style="width:80px" oninput="updateSubtotal(${p.id}, ${Number(p.precio)})"></td>
      <td id="sub_${p.id}">$${(qty * Number(p.precio)).toFixed(2)}</td>
    </tr>`;
  });
  html += `<tr><td colspan="3" style="text-align:right"><strong>Total:</strong></td><td colspan="2" id="totalPedido">$0.00</td></tr></tbody></table>
    <div style="margin-top:12px"><button onclick="confirmProducts()">Confirmar selecci√≥n</button></div>`;
  openModal(html);
  // after showing modal, set initial total
  setTimeout(()=>{ document.getElementById('totalPedido').textContent = `$${calculateTotal().toFixed(2)}` }, 50);
});

function updateSubtotal(id, precio){
  const input = document.getElementById(`prod_${id}`);
  if(!input) return;
  let qty = parseInt(input.value,10) || 0;
  if(qty < 0) qty = 0;
  if(input.max) { const mx = parseInt(input.max,10); if(qty > mx) qty = mx; }
  input.value = qty;
  const subEl = document.getElementById(`sub_${id}`);
  if(subEl) subEl.textContent = `$${(qty*precio).toFixed(2)}`;
  const totalEl = document.getElementById('totalPedido');
  if(totalEl) totalEl.textContent = `$${calculateTotal().toFixed(2)}`;
}

function calculateTotal(){
  let total = 0;
  const inputs = document.querySelectorAll('#modalInner input[type=number]');
  inputs.forEach(inp=>{
    const id = parseInt(inp.id.replace('prod_',''),10);
    const qty = parseInt(inp.value,10) || 0;
    const subText = (document.getElementById(`sub_${id}`)?.textContent || '').replace('$','');
    const sub = parseFloat(subText) || (qty * (parseFloat(inp.getAttribute('data-price'))||0));
    total += sub;
  });
  return total;
}

function confirmProducts(){
  selectedProducts = [];
  const inputs = document.querySelectorAll('#modalInner input[type=number]');
  inputs.forEach(inp=>{
    const qty = parseInt(inp.value,10) || 0;
    if(qty>0){
      const id = parseInt(inp.id.replace('prod_',''),10);
      const row = inp.closest('tr');
      const nombre = row.cells[0].textContent;
      const precio = parseFloat(row.cells[1].textContent.replace('$','')) || 0;
      selectedProducts.push({id, nombre, cantidad: qty, precio});
    }
  });
  closeModal();
  renderSelectedProducts();
}

function renderSelectedProducts(){
  const container = document.getElementById('selectedProductsContainer');
  if(!selectedProducts.length){ container.innerHTML = '<span class="small-muted">No hay productos seleccionados</span>'; return; }
  let html = `<table><thead><tr><th>Producto</th><th>Cantidad</th><th>Subtotal</th></tr></thead><tbody>`;
  selectedProducts.forEach(p=>{
    html += `<tr><td>${escapeHtml(p.nombre)}</td><td>${p.cantidad}</td><td>$${(p.precio*p.cantidad).toFixed(2)}</td></tr>`;
  });
  const total = selectedProducts.reduce((s,p)=>s+p.precio*p.cantidad,0);
  html += `<tr><td colspan="2" style="text-align:right"><strong>Total:</strong></td><td>$${total.toFixed(2)}</td></tr></tbody></table>`;
  container.innerHTML = html;
}

/* Helper: fetch promo by id (single) */
async function getPromoById(id){
  const {data,error} = await supabase.from('promociones').select('*').eq('id',id).single();
  if(error) throw new Error(error.message);
  return data;
}

/* Add pedido (with stock check & decrement) */
document.getElementById('addOrderBtn').addEventListener('click', async ()=>{
  await addOrder();
});
async function addOrder(){
  const cliente = document.getElementById('pedidoCliente').value.trim();
  const localidad_id = document.getElementById('pedidoLocalidad').value || null;
  if(!cliente) return alert('Ingrese cliente');
  if(!selectedProducts.length) return alert('Seleccione productos');

  // check stock for each selected product
  for(const p of selectedProducts){
    const promo = await getPromoById(p.id);
    if(p.cantidad > (promo.stock || 0)) return alert(`Stock insuficiente para ${p.nombre} (disponible: ${promo.stock})`);
  }

  // subtract stock
  for(const p of selectedProducts){
    const promo = await getPromoById(p.id);
    const newStock = (promo.stock || 0) - p.cantidad;
    await supabase.from('promociones').update({stock:newStock}).eq('id',p.id);
  }

  // prepare products payload (store id, nombre, cantidad, precio)
  const productosPayload = selectedProducts.map(p=>({id:p.id,nombre:p.nombre,cantidad:p.cantidad,precio:p.precio}));
  const total = productosPayload.reduce((s,x)=>s + x.precio * x.cantidad,0);

  const {error} = await supabase.from('pedidos').insert([{cliente,localidad_id,productos:productosPayload,total}]);
  if(error) return alert(error.message);

  // reset form
  document.getElementById('pedidoCliente').value = '';
  document.getElementById('pedidoLocalidad').value = '';
  selectedProducts = []; renderSelectedProducts();
  fetchOrders();
  fetchPromotions(); // refresh stock view
  showToast('Pedido agregado');
}

/* Fetch and display orders; include edit and delete */
async function fetchOrders(){
  const {data:errorCheck, error} = await supabase.from('pedidos').select('*').order('id');
  if(error) return console.error(error);
  const container = document.getElementById('pedidoList');
  container.innerHTML = '';
  for(const p of errorCheck){
    let productosHtml = '<ul style="margin:6px 0;padding-left:18px">';
    p.productos.forEach(pr => { productosHtml += `<li>${escapeHtml(pr.nombre)} x ${pr.cantidad} ‚Äî $${(pr.precio*pr.cantidad).toFixed(2)}</li>`; });
    productosHtml += '</ul>';
    const div = document.createElement('div'); div.className = 'item-card';
    div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(p.cliente)}</strong> <div class="small-muted">${p.localidad_id ? 'Localidad ID: '+p.localidad_id : ''}</div>${productosHtml}<strong>Total: $${Number(p.total).toFixed(2)}</strong></div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button onclick="openEditOrder(${p.id})">Editar</button>
        <button class="delete-btn" onclick="deleteOrder(${p.id})">Eliminar</button>
      </div>`;
    container.appendChild(div);
  }
}
fetchOrders();

/* Edit order: returns stock of current order to promos, load order into selectedProducts for editing */
async function openEditOrder(orderId){
  const {data, error} = await supabase.from('pedidos').select('*').eq('id',orderId).single();
  if(error) return alert(error.message);
  // Return stock from old order first
  if(data.productos && data.productos.length){
    for(const pr of data.productos){
      // pr.id maybe saved as id or producto_id depending on structure; we used {id:...}
      const promo = await getPromoById(pr.id);
      const newStock = (promo.stock || 0) + pr.cantidad;
      await supabase.from('promociones').update({stock:newStock}).eq('id',pr.id);
    }
  }
  // Load order into form
  editingOrderId = orderId;
  selectedProducts = data.productos.map(pr => ({id:pr.id, nombre:pr.nombre, cantidad:pr.cantidad, precio:pr.precio}));
  document.getElementById('pedidoCliente').value = data.cliente;
  document.getElementById('pedidoLocalidad').value = data.localidad_id || '';
  renderSelectedProducts();
  // Change add button behavior to update
  const btn = document.getElementById('addOrderBtn');
  btn.textContent = 'Actualizar Pedido';
  btn.onclick = async ()=>{
    await updateOrder(orderId);
    // restore add button behavior
    btn.textContent = 'Agregar Pedido';
    btn.onclick = addOrder;
  };
  showToast('Editando pedido ‚Äî ajusta productos y presiona "Actualizar Pedido"');
}

/* Update order: similar to addOrder but uses editingOrderId */
async function updateOrder(orderId){
  const cliente = document.getElementById('pedidoCliente').value.trim();
  const localidad_id = document.getElementById('pedidoLocalidad').value || null;
  if(!cliente) return alert('Ingrese cliente');
  if(!selectedProducts.length) return alert('Seleccione productos');

  // check stock for new selection
  for(const p of selectedProducts){
    const promo = await getPromoById(p.id);
    if(p.cantidad > (promo.stock || 0)) return alert(`Stock insuficiente para ${p.nombre} (disponible: ${promo.stock})`);
  }
  // subtract stock for new selection
  for(const p of selectedProducts){
    const promo = await getPromoById(p.id);
    const newStock = (promo.stock || 0) - p.cantidad;
    await supabase.from('promociones').update({stock:newStock}).eq('id',p.id);
  }

  // update pedido record
  const productosPayload = selectedProducts.map(p=>({id:p.id,nombre:p.nombre,cantidad:p.cantidad,precio:p.precio}));
  const total = productosPayload.reduce((s,x)=>s + x.precio * x.cantidad,0);
  const {error} = await supabase.from('pedidos').update({cliente,localidad_id,productos:productosPayload,total}).eq('id',orderId);
  if(error) return alert(error.message);

  // reset form
  editingOrderId = null;
  selectedProducts = []; renderSelectedProducts();
  document.getElementById('pedidoCliente').value = '';
  document.getElementById('pedidoLocalidad').value = '';
  fetchOrders();
  fetchPromotions();
  showToast('Pedido actualizado');
}

/* Delete order: return stock then delete */
async function deleteOrder(orderId){
  if(!confirm('Eliminar pedido?')) return;
  const {data, error} = await supabase.from('pedidos').select('*').eq('id',orderId).single();
  if(error) return alert(error.message);
  if(data.productos && data.productos.length){
    for(const pr of data.productos){
      const promo = await getPromoById(pr.id);
      const newStock = (promo.stock || 0) + pr.cantidad;
      await supabase.from('promociones').update({stock:newStock}).eq('id',pr.id);
    }
  }
  await supabase.from('pedidos').delete().eq('id',orderId);
  fetchOrders();
  fetchPromotions();
  showToast('Pedido eliminado y stock restaurado');
}

/* ============================
   Exportar cat√°logo promociones a PDF (4 por p√°gina + im√°genes base64)
   ============================ */

/* safeGetFileUrl: returns signed URL for image in bucket 'promo_images' (60s) */
async function safeGetFileUrl(fileName){
  if(!fileName) return null;
  try{
    const {data, error} = await supabase.storage.from('promo_images').createSignedUrl(fileName, 60*5);
    if(error) return null;
    return data.signedUrl;
  }catch{return null;}
}

/* convert image url to base64 (use CORS anonymous) */
async function toBase64(url){
  return new Promise((resolve)=>{
    if(!url) return resolve(null);
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=> {
      try{
        const canvas = document.createElement('canvas');
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
        resolve(dataUrl);
      }catch(e){ resolve(null); }
    };
    img.onerror = ()=> resolve(null);
    img.src = url;
    // if browser cached image without CORS, we may still get it; otherwise returns null
  });
}

document.getElementById('exportPromoPdfBtn').addEventListener('click', async ()=>{
  const {data:promos, error} = await supabase.from('promociones').select('*').order('id');
  if(error) return alert(error.message);
  if(!promos || promos.length===0) return alert('No hay promociones');

  // Build html grouped to ensure 4 per page and page-break-inside:avoid
  let html = `<div style="font-family: Arial, sans-serif; width:100%;">`;
  html += `<h2 style="text-align:center;margin-bottom:12px">üìñ Cat√°logo de Promociones</h2>`;

  for(const [i, promo] of promos.entries()){
    const signedUrl = promo.imagen ? await safeGetFileUrl(promo.imagen) : (promo.imagen_url || null);
    const img64 = signedUrl ? await toBase64(signedUrl) : null;

    html += `<div style="display:flex;align-items:center;margin-bottom:12px;border:1px solid #ddd;border-radius:10px;padding:10px;page-break-inside:avoid;">
      ${img64 ? `<img src="${img64}" style="width:120px;height:120px;object-fit:cover;margin-right:12px;border-radius:8px;border:1px solid #ccc">` : ''}
      <div style="flex:1">
        <div style="font-size:15px;font-weight:700;margin-bottom:6px">${escapeHtml(promo.nombre||promo.descripcion||'Sin nombre')}</div>
        <div style="font-size:14px">üí≤ <strong>$${Number(promo.precio).toFixed(2)}</strong></div>
      </div>
    </div>`;

    // every 4 promos -> page break
    if((i+1) % 4 === 0) html += `<div style="page-break-after:always"></div>`;
  }

  html += `</div>`;

  // PDF options
  const opt = {
    margin: 0.5,
    filename: 'catalogo_promociones.pdf',
    image: { type: 'jpeg', quality: 1 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
  };

  // Trigger download
  html2pdf().from(html).set(opt).save();
});

/* ============================
   Small utilities
   ============================ */
function escapeHtml(str){
  if(!str && str!==0) return '';
  return String(str).replace(/[&<>"']/g, s=>{
    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s];
  });
}

/* ============================
   Initial fetches & handlers
   ============================ */
document.getElementById('addPromoBtn').addEventListener('click', addPromo);
document.getElementById('addCategoriaBtn').addEventListener('click', ()=>window.addCategoria?.());
document.getElementById('addLocalidadBtn').addEventListener('click', ()=>window.addLocalidad?.());
fetchPromotions();
fetchCategorias();
fetchLocalidades();
fetchOrders();
fetchDocuments();

/* Expose some functions for inline onclicks (already used above) */
window.fetchPromotions = fetchPromotions;
window.fetchOrders = fetchOrders;
window.fetchDocuments = fetchDocuments;
window.fetchCategorias = fetchCategorias;
window.fetchLocalidades = fetchLocalidades;

/* ============================
   End
   ============================ */
</script>
</body>
</html>
