<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>App Completa — Pedidos, Promos, Docs</title>

<!-- Librerías -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto&display=swap" rel="stylesheet">

<style>
:root{--accent:#6a1b9a;--accent-2:#7b1fa2;--danger:#e53935}
*{box-sizing:border-box}
body{margin:0;font-family:Roboto,Arial,Helvetica,sans-serif;background:#f9f9f9;color:#222;display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--accent);color:#fff;padding:18px;display:flex;flex-direction:column}
.sidebar .logo{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:12px}
.sidebar button{background:transparent;border:0;color:#fff;padding:10px;border-radius:8px;text-align:left;cursor:pointer;margin-bottom:8px;font-weight:700}
.sidebar button.active{background:#fff;color:var(--accent);box-shadow:0 6px 20px rgba(0,0,0,0.08)}
.main{flex:1;padding:20px;overflow:auto}
h1,h2{font-family:'Playfair Display',serif;margin:0 0 12px 0}
.section{display:none;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:18px}
.item-card,.doc-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#f4f4f4;margin-bottom:10px}
.item-card img{width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px}
label{display:block;margin:8px 0;font-size:14px}
input[type=text],input[type=number],select{padding:8px;margin-top:4px;border-radius:8px;border:1px solid #ddd;width:100%}
button{cursor:pointer;border:0;border-radius:8px;padding:8px 12px;background:var(--accent);color:#fff;font-weight:700}
button:hover{background:var(--accent-2)}
.delete-btn{background:var(--danger)}
.delete-btn:hover{background:#c62828}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal-content{background:#fff;padding:16px;border-radius:10px;max-width:860px;width:96%;max-height:86vh;overflow:auto;position:relative}
.modal-close{position:absolute;right:12px;top:8px;cursor:pointer;font-weight:700}
.table {width:100%;border-collapse:collapse;margin:8px 0}
.table th,.table td{padding:8px;border:1px solid #e6e6e6}
.small-muted{font-size:13px;color:#666}
.flex{display:flex;gap:10px;align-items:center}
.row{display:flex;gap:12px}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">App Pedidos</div>
  <button class="tab-btn active" data-tab="promos">Promociones</button>
  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
  <button class="tab-btn" data-tab="categorias">Categorías</button>
  <button class="tab-btn" data-tab="localidades">Localidades</button>
  <button class="tab-btn" data-tab="documentos">Documentos</button>
  <div style="margin-top:auto;font-size:12px;opacity:.9">Integrado · PDF catálogo · Stock</div>
</div>

<div class="main">
  <h1>App Completa de Pedidos y Documentos</h1>

  <!-- PROMOCIONES -->
  <div class="section" id="promos">
    <h2>Promociones</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
      <div style="flex:1;min-width:220px">
        <label>Nombre / Descripción
          <input id="promoNombre" type="text" placeholder="Ej: Combo Hamburguesa + Papas">
        </label>
      </div>
      <div style="width:140px">
        <label>Precio
          <input id="promoPrecio" type="number" step="0.01" placeholder="0.00">
        </label>
      </div>
      <div style="width:140px">
        <label>Stock
          <input id="promoStock" type="number" placeholder="0">
        </label>
      </div>
      <div style="width:220px">
        <label>Categoría
          <select id="promoCategoria"></select>
        </label>
      </div>
      <div style="width:220px">
        <label>Imagen (jpg/png)
          <input id="promoImagen" type="file" accept="image/*">
        </label>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:12px">
      <button id="addPromoBtn">Agregar Promoción</button>
      <button id="exportPromoPdfBtn">Exportar Catálogo PDF</button>
      <button id="refreshPromosBtn" style="background:#444">Refrescar</button>
    </div>

    <h3>Lista de Promociones</h3>
    <div id="promoList"></div>
  </div>

  <!-- PEDIDOS -->
  <div class="section" id="pedidos">
    <h2>Pedidos</h2>
    <form id="pedidoForm" onsubmit="return false;" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
      <div style="flex:1;min-width:220px">
        <label>Cliente
          <input id="pedidoCliente" type="text" placeholder="Nombre cliente">
        </label>
      </div>
      <div style="width:220px">
        <label>Localidad
          <select id="pedidoLocalidad"></select>
        </label>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button type="button" id="selectProductsBtn">Seleccionar Productos</button>
      </div>

      <div style="width:100%;margin-top:6px">
        <div id="selectedProductsContainer" class="small-muted"></div>
      </div>

      <div style="display:flex;gap:8px">
        <button type="button" id="addOrderBtn">Agregar Pedido</button>
        <button type="button" id="exportPedidosPDFBtn">Exportar Pedidos (PDF)</button>
      </div>
    </form>

    <h3>Lista de Pedidos</h3>
    <div id="pedidoList"></div>
  </div>

  <!-- CATEGORÍAS -->
  <div class="section" id="categorias">
    <h2>Categorías</h2>
    <form id="categoriaForm" onsubmit="return false;" style="display:flex;gap:8px;margin-bottom:12px">
      <input id="categoriaNombre" placeholder="Nombre categoría" />
      <button id="addCategoriaBtn">Agregar Categoría</button>
    </form>
    <div id="categoriaList"></div>
  </div>

  <!-- LOCALIDADES -->
  <div class="section" id="localidades">
    <h2>Localidades</h2>
    <form id="localidadForm" onsubmit="return false;" style="display:flex;gap:8px;margin-bottom:12px">
      <input id="localidadNombre" placeholder="Nombre localidad" />
      <button id="addLocalidadBtn">Agregar Localidad</button>
    </form>
    <div id="localidadList"></div>
  </div>

  <!-- DOCUMENTOS -->
  <div class="section" id="documentos">
    <h2>Documentos y Clientes</h2>

    <!-- FORMULARIO CLIENTES -->
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:flex-end;border-bottom:1px solid #ccc;padding-bottom:12px">
      <div style="width:180px"><label>DNI<input id="clienteDNI" type="text"></label></div>
      <div style="width:180px"><label>Nombre<input id="clienteNombre" type="text"></label></div>
      <div style="width:180px"><label>Apellido<input id="clienteApellido" type="text"></label></div>
      <div style="width:180px"><label>Localidad<select id="clienteLocalidad"></select></label></div>
      <div style="width:120px"><label>Saldo Pendiente<input id="clienteSaldo" type="number" step="0.01"></label></div>
      <div style="display:flex;gap:8px">
        <button id="addClienteBtn">Agregar Cliente</button>
        <button id="refreshClientesBtn" style="background:#444">Refrescar</button>
      </div>
    </div>

    <!-- FORMULARIO DOCUMENTOS -->
    <form id="docForm" onsubmit="return false;" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:flex-end">
      <div style="width:220px">
        <label>Subir Documento
          <input id="docFile" type="file" multiple accept=".pdf">
        </label>
      </div>
      <div style="width:180px">
        <label>DNI Cliente (opcional)
          <input id="docDNI" type="text">
        </label>
      </div>
      <div>
        <button id="uploadDocsBtn">Cargar Documento(s)</button>
      </div>
    </form>

    <!-- BÚSQUEDA DOCUMENTOS -->
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input id="searchDNIInput" type="text" placeholder="Buscar por DNI">
      <button id="searchDNIBtn">Buscar</button>
    </div>

    <div id="docList"></div>
  </div>

</div>

<script>
const supabase = supabase.createClient('https://ejbqlejlgprvwzrptojo.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8');

// ------------------- TABS -------------------
const tabs = document.querySelectorAll('.tab-btn');
const sections = document.querySelectorAll('.section');
tabs.forEach(btn => {
  btn.addEventListener('click',()=>{
    tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    sections.forEach(s=>s.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
  });
});
// mostrar primera sección
sections[0].style.display='block';

// ------------------- CARGA CLIENTES -------------------
async function fetchLocalidades(selectId){
  const {data,error} = await supabase.from('localidades').select('nombre');
  if(!error){
    const sel = document.getElementById(selectId);
    sel.innerHTML='';
    data.forEach(l=>{
      const opt = document.createElement('option'); opt.value=l.nombre; opt.textContent=l.nombre;
      sel.appendChild(opt);
    });
  }
}

async function addCliente(){
  const dni=document.getElementById('clienteDNI').value.trim();
  const nombre=document.getElementById('clienteNombre').value.trim();
  const apellido=document.getElementById('clienteApellido').value.trim();
  const localidad=document.getElementById('clienteLocalidad').value;
  const saldo=parseFloat(document.getElementById('clienteSaldo').value)||0;
  if(!dni||!nombre||!apellido){alert('Completa los datos');return;}
  const {error}=await supabase.from('clientes').upsert({dni,nombre,apellido,localidad,saldo_pendiente:saldo});
  if(error){alert('Error al guardar');console.error(error);}else{alert('Cliente guardado');fetchClientes();}
}

async function fetchClientes(){
  const {data,error}=await supabase.from('clientes').select('*').order('apellido');
  if(!error){
    const container = document.getElementById('docList');
    container.innerHTML='<h4>Clientes Registrados:</h4>';
    data.forEach(c=>{
      const div = document.createElement('div');
      div.className='doc-item';
      div.innerHTML=`<div>${c.apellido}, ${c.nombre} | ${c.dni} | ${c.localidad}</div>
                      <div>Saldo: $${c.saldo_pendiente.toFixed(2)}</div>`;
      container.appendChild(div);
    });
  }
}

// ------------------- SUBIDA DOCUMENTOS -------------------
async function uploadDocs(){
  const files = document.getElementById('docFile').files;
  const dni=document.getElementById('docDNI').value.trim();
  if(!files.length){alert('Selecciona archivos');return;}
  for(let file of files){
    const fileName = dni ? `${dni}_${file.name}` : file.name;
    const {data,error}=await supabase.storage.from('private-documents').upload(fileName,file,{upsert:true});
    if(error){console.error(error);alert('Error al subir '+file.name);} 
  }
  alert('Documentos cargados');document.getElementById('docFile').value='';
}

// ------------------- BUSQUEDA DOCUMENTOS -------------------
async function searchDocsByDNI(){
  const dni = document.getElementById('searchDNIInput').value.trim();
  if(!dni){alert('Ingresa DNI');return;}
  const {data:error1}=await supabase.from('clientes').select('*').eq('dni',dni).single();
  const cliente = error1 ? null : error1;
  const {data:files,error}=await supabase.storage.from('private-documents').list('',{limit:100});
  const filtered = files.filter(f=>f.name.startsWith(dni));
  const container = document.getElementById('docList');
  container.innerHTML=`<h4>Resultados para DNI: ${dni}</h4>`;
  if(cliente){
    const div=document.createElement('div');
    div.className='doc-item';
    div.innerHTML=`<b>Cliente:</b> ${cliente.nombre} ${cliente.apellido} | <b>Localidad:</b> ${cliente.localidad} | <b>Saldo:</b> $${cliente.saldo_pendiente.toFixed(2)}`;
    container.appendChild(div);
  }
  if(!filtered.length){container.innerHTML+='<p>No hay documentos para este DNI</p>';return;}
  for(let f of filtered){
    const div=document.createElement('div');div.className='doc-item';
    div.innerHTML=`<div>${f.name}</div>
      <button onclick="downloadDoc('${f.name}')">Descargar</button>`;
    container.appendChild(div);
  }
}

async function downloadDoc(name){
  const {data,error}=await supabase.storage.from('private-documents').download(name);
  if(error){alert('Error al descargar');return;}
  const url = URL.createObjectURL(data);
  const a=document.createElement('a');a.href=url;a.download=name;a.click();
}

// ------------------- INIT -------------------
fetchLocalidades('clienteLocalidad');
fetchClientes();

document.getElementById('addClienteBtn').addEventListener('click',addCliente);
document.getElementById('refreshClientesBtn').addEventListener('click',fetchClientes);
document.getElementById('uploadDocsBtn').addEventListener('click',uploadDocs);
document.getElementById('searchDNIBtn').addEventListener('click',searchDocsByDNI);

// ------------------- EJEMPLO updateOrder COMPLETO -------------------
async function updateOrder(orderId,newProducts){
  // 1. Obtener pedido actual
  const {data:oldOrder,error:getOld} = await supabase.from('pedidos').select('*').eq('id',orderId).single();
  if(getOld){console.error(getOld);return;}

  // 2. Restaurar stock anterior
  for(let p of oldOrder.products){
    const {data:prod,error:prodErr}=await supabase.from('productos').select('stock').eq('id',p.id).single();
    if(!prodErr){
      await supabase.from('productos').update({stock:prod.stock+p.cantidad}).eq('id',p.id);
    }
  }

  // 3. Restar stock por productos nuevos
  for(let p of newProducts){
    const {data:prod,error:prodErr}=await supabase.from('productos').select('stock').eq('id',p.id).single();
    if(!prodErr){
      await supabase.from('productos').update({stock:prod.stock-p.cantidad}).eq('id',p.id);
    }
  }

  // 4. Actualizar pedido
  const total = newProducts.reduce((acc,p)=>acc+p.precio*p.cantidad,0);
  const {error:updateErr}=await supabase.from('pedidos').update({products:newProducts,total}).eq('id',orderId);
  if(updateErr){console.error(updateErr);}else{alert('Pedido actualizado');}
}
</script>
</body>
</html>
