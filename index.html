<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Administrativo Completo</title>
<style>
:root {
  --sidebar-bg: #2c3e50;
  --sidebar-hover: #34495e;
  --accent: #ff4d4f;
  --card-bg: #fff;
  --text-muted: #555;
}
body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; background:#f0f2f5; }
.sidebar { width:220px; background:var(--sidebar-bg); color:#fff; display:flex; flex-direction:column; padding-top:20px; flex-shrink:0; }
.sidebar h2 { text-align:center; margin-bottom:20px; font-size:22px; }
.sidebar button { background:none; border:none; color:white; text-align:left; padding:12px 20px; cursor:pointer; font-size:16px; width:100%; transition:0.2s; }
.sidebar button:hover, .sidebar button.active { background:var(--sidebar-hover); }
.content { flex:1; padding:20px; overflow-y:auto; }
.section { display:none; }
.section.active { display:block; }
h1 { margin-top:0; margin-bottom:15px; }

/* Tarjetas y listas */
.card { display:flex; align-items:center; gap:15px; background:var(--card-bg); padding:15px; border-radius:10px; margin-bottom:12px; border:1px solid #ddd; transition:0.3s; }
.card:hover { box-shadow:0 6px 18px rgba(0,0,0,0.15); }
.card img { width:100px; height:100px; object-fit:cover; border-radius:10px; border:1px solid #ccc; }
.card-info { flex:1; display:flex; flex-direction:column; gap:6px; }
.card-info b { font-size:1.1em; }
.card-price { font-size:1em; color:var(--accent); }
.card-price del { color:#999; margin-right:6px; }
.card-stock { font-size:0.85em; color:var(--text-muted); }
.card-actions { display:flex; flex-direction:column; gap:6px; }
.card-actions button { cursor:pointer; border:none; border-radius:6px; padding:6px 12px; font-weight:bold; transition:0.2s; }
.card-actions .edit-btn { background:#3498db; color:#fff; }
.card-actions .edit-btn:hover { background:#2980b9; }
.card-actions .delete-btn { background:var(--accent); color:#fff; }
.card-actions .delete-btn:hover { background:#e8434f; }

/* Modal */
#modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:9999; }
#modalInner { background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:90%; overflow-y:auto; }
input, select, button { margin-bottom:8px; padding:6px; font-size:14px; border-radius:4px; border:1px solid #ccc; }
button[type=submit]{background:var(--accent); color:#fff; border:none; cursor:pointer;}
button[type=submit]:hover{background:#e8434f;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<div class="sidebar">
  <h2>Admin</h2>
  <button class="tab-btn active" data-tab="promos">Promociones</button>
  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
  <button class="tab-btn" data-tab="categorias">Categorías</button>
  <button class="tab-btn" data-tab="localidades">Localidades</button>
  <button class="tab-btn" data-tab="documentos">Documentos</button>
</div>

<div class="content">

  <!-- PROMOCIONES -->
  <div id="promos" class="section active">
    <h1>Gestión de Promociones</h1>
    <form id="promoForm" onsubmit="event.preventDefault(); addPromo();">
      <input type="text" id="promoNombre" placeholder="Nombre" required>
      <input type="number" id="promoPrecio" placeholder="Precio" step="0.01" required>
      <input type="number" id="promoPrecioAnterior" placeholder="Precio anterior" step="0.01">
      <input type="number" id="promoStock" placeholder="Stock">
      <select id="promoCategoria"></select>
      <input type="file" id="promoImagen" accept="image/*">
      <button type="submit">Agregar promoción</button>
    </form>
    <button onclick="exportPDF()">Exportar PDF</button>
    <div id="promoList"></div>
  </div>

  <!-- CATEGORÍAS -->
  <div id="categorias" class="section">
    <h1>Gestión de Categorías</h1>
    <input type="text" id="categoriaNombre" placeholder="Nueva categoría">
    <button onclick="addCategoria()">Agregar</button>
    <div id="categoriaList"></div>
  </div>

  <!-- LOCALIDADES -->
  <div id="localidades" class="section">
    <h1>Gestión de Localidades</h1>
    <input type="text" id="localidadNombre" placeholder="Nueva localidad">
    <button onclick="addLocalidad()">Agregar</button>
    <div id="localidadList"></div>
  </div>

  <!-- PEDIDOS -->
  <div id="pedidos" class="section">
    <h1>Gestión de Pedidos</h1>
    <button onclick="fetchPedidos()">Actualizar Pedidos</button>
    <div id="pedidoList"></div>
  </div>

  <!-- DOCUMENTOS -->
  <div id="documentos" class="section">
    <h1>Gestión de Documentos</h1>
    <input type="text" id="docNombre" placeholder="Nombre del documento">
    <input type="file" id="docArchivo">
    <button onclick="addDocumento()">Agregar Documento</button>
    <button onclick="fetchDocumentos()">Actualizar Documentos</button>
    <div id="docList"></div>
  </div>

</div>

<div id="modal"><div id="modalInner"></div></div>

<script>
// Supabase
const SUPABASE_URL="https://ejbqlejlgprvwzrptojo.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";
const supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// Sidebar
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// Modal
function openModal(title, html){ document.getElementById("modalInner").innerHTML=`<h3>${title}</h3>${html}`; document.getElementById("modal").style.display="flex"; }
function closeModal(){ document.getElementById("modal").style.display="none"; }
document.getElementById("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });

// Escape HTML
function escapeHtml(text){ var div=document.createElement("div"); div.innerText=text; return div.innerHTML; }

// ===================== PROMOCIONES =====================
async function fetchPromotions(){
  const { data: promos, error } = await supabase.from("promociones").select("id,nombre,precio,precio_anterior,stock,imagen_url,categoria_id,categorias(nombre)").order("id",{ascending:false});
  if(error){ console.error(error); return; }
  const promoList=document.getElementById("promoList"); promoList.innerHTML="";
  const grouped={};
  promos.forEach(p=>{ const cat=p.categorias?.nombre||"Sin categoría"; if(!grouped[cat]) grouped[cat]=[]; grouped[cat].push(p); });
  Object.keys(grouped).forEach(cat=>{
    const catTitle=document.createElement("div"); catTitle.innerHTML=`<h3>${cat}</h3>`; promoList.appendChild(catTitle);
    grouped[cat].forEach(p=>{
      const card=document.createElement("div"); card.className="card";
      const checkbox=document.createElement("input"); checkbox.type="checkbox"; checkbox.checked=true; checkbox.dataset.promo=JSON.stringify(p); card.appendChild(checkbox);
      const img=document.createElement("img"); if(p.imagen_url) img.src=supabase.storage.from("promo_images").getPublicUrl(p.imagen_url).data.publicUrl; card.appendChild(img);
      const info=document.createElement("div"); info.className="card-info";
      let precioHTML=`<span class="card-price">$${Number(p.precio).toFixed(2)}</span>`;
      if(p.precio_anterior && Number(p.precio_anterior)>Number(p.precio)) precioHTML=`<del>$${p.precio_anterior}</del> <span class="card-price">$${Number(p.precio).toFixed(2)}</span>`;
      info.innerHTML=`<b>${escapeHtml(p.nombre)}</b><div>${precioHTML}</div><div class="card-stock">Stock: ${p.stock??0}</div>`; card.appendChild(info);
      const actions=document.createElement("div"); actions.className="card-actions";
      const editBtn=document.createElement("button"); editBtn.textContent="Editar"; editBtn.className="edit-btn"; editBtn.onclick=()=>editPromo(p); actions.appendChild(editBtn);
      const delBtn=document.createElement("button"); delBtn.textContent="Eliminar"; delBtn.className="delete-btn"; delBtn.onclick=()=>deletePromo(p.id); actions.appendChild(delBtn);
      card.appendChild(actions); promoList.appendChild(card);
    });
  });
}

async function addPromo(){
  const nombre=document.getElementById("promoNombre").value.trim();
  const precio=document.getElementById("promoPrecio").value;
  const precioAnterior=document.getElementById("promoPrecioAnterior").value;
  const stock=document.getElementById("promoStock").value;
  const categoriaId=document.getElementById("promoCategoria").value;
  const file=document.getElementById("promoImagen").files[0];
  if(!nombre || !precio){ alert("Nombre y precio obligatorios"); return; }
  let imgName=null;
  if(file){ imgName=`${Date.now()}_${file.name}`; const { error } = await supabase.storage.from("promo_images").upload(imgName,file); if(error) return alert(error.message); }
  const { error } = await supabase.from("promociones").insert([{nombre,precio:parseFloat(precio),precio_anterior:precioAnterior?parseFloat(precioAnterior):null,stock:stock?parseInt(stock):0,categoria_id:categoriaId,imagen_url:imgName}]);
  if(error) return alert(error.message);
  document.getElementById("promoForm").reset();
  fetchPromotions();
}

function editPromo(p){
  openModal("Editar Promo", `
    <input type="text" id="editNombre" value="${escapeHtml(p.nombre)}" placeholder="Nombre">
    <input type="number" id="editPrecio" value="${p.precio}" placeholder="Precio">
    <input type="number" id="editPrecioAnterior" value="${p.precio_anterior||''}" placeholder="Precio anterior">
    <input type="number" id="editStock" value="${p.stock}" placeholder="Stock">
    <select id="editCategoria"></select>
    <input type="file" id="editImagen">
    <button onclick="updatePromo(${p.id})">Guardar</button>
  `);
  fetchCategoriasForSelect("editCategoria", p.categoria_id);
}

async function updatePromo(id){
  const nombre=document.getElementById("editNombre").value.trim();
  const precio=parseFloat(document.getElementById("editPrecio").value);
  const precioAnterior=document.getElementById("editPrecioAnterior").value?parseFloat(document.getElementById("editPrecioAnterior").value):null;
  const stock=parseInt(document.getElementById("editStock").value);
  const categoriaId=document.getElementById("editCategoria").value;
  const file=document.getElementById("editImagen").files[0];
  let imgName=null;
  if(file){ imgName=`${Date.now()}_${file.name}`; const { error } = await supabase.storage.from("promo_images").upload(imgName,file); if(error) return alert(error.message); }
  const updateData={nombre,precio,precio_anterior:precioAnterior,stock,categoria_id:categoriaId};
  if(imgName) updateData.imagen_url=imgName;
  const { error } = await supabase.from("promociones").update(updateData).eq("id",id);
  if(error) return alert(error.message);
  closeModal(); fetchPromotions();
}

async function deletePromo(id){ if(!confirm("Eliminar promo?")) return; await supabase.from("promociones").delete().eq("id",id); fetchPromotions(); }

function exportPDF(){
  const selected=[]; document.querySelectorAll("#promoList input[type=checkbox]").forEach(cb=>{ if(cb.checked) selected.push(JSON.parse(cb.dataset.promo)); });
  if(selected.length===0){ alert("Seleccione al menos una promo"); return; }
  let html="<h1>Promociones</h1>"; selected.forEach(p=>{ html+=`<p><b>${p.nombre}</b> - $${p.precio}</p>`; });
  html2pdf().from(html).save("promociones.pdf");
}

// -------------------- CATEGORÍAS --------------------
async function fetchCategorias(){
  const { data, error } = await supabase.from("categorias").select("*").order("id");
  if(error) return console.error(error);
  const container=document.getElementById("categoriaList"); container.innerHTML="";
  const select=document.getElementById("promoCategoria"); select.innerHTML='<option value="">Sin categoría</option>';
  data.forEach(c=>{
    const div=document.createElement("div"); div.className="card"; div.innerHTML=`<span>${escapeHtml(c.nombre)}</span> <button onclick="editCategoria(${c.id},'${escapeHtml(c.nombre)}')">Editar</button> <button onclick="deleteCategoria(${c.id})">Eliminar</button>`; container.appendChild(div);
    select.innerHTML+=`<option value="${c.id}">${escapeHtml(c.nombre)}</option>`;
  });
}
async function fetchCategoriasForSelect(selId, selectedId=null){
  const { data } = await supabase.from("categorias").select("*").order("id");
  const sel=document.getElementById(selId); sel.innerHTML='<option value="">Sin categoría</option>';
  data.forEach(c=>{ sel.innerHTML+=`<option value="${c.id}" ${selectedId==c.id?'selected':''}>${escapeHtml(c.nombre)}</option>`; });
}
async function addCategoria(){ const nombre=document.getElementById("categoriaNombre").value.trim(); if(!nombre) return alert("Ingrese nombre"); await supabase.from("categorias").insert([{nombre}]); document.getElementById("categoriaNombre").value=""; fetchCategorias(); }
function editCategoria(id,nombre){ openModal("Editar categoría", `<input id="editCatName" value="${escapeHtml(nombre)}"><button onclick="updateCategoria(${id})">Guardar</button>`); }
async function updateCategoria(id){ const nombre=document.getElementById("editCatName").value.trim(); if(!nombre) return alert("Ingrese nombre"); await supabase.from("categorias").update({nombre}).eq("id",id); closeModal(); fetchCategorias(); }
async function deleteCategoria(id){ if(!confirm("Eliminar categoría?")) return; await supabase.from("categorias").delete().eq("id",id); fetchCategorias(); }

// -------------------- LOCALIDADES --------------------
async function fetchLocalidades(){
  const { data, error } = await supabase.from("localidades").select("*").order("id");
  if(error) return console.error(error);
  const container=document.getElementById("localidadList"); container.innerHTML="";
  data.forEach(l=>{ const div=document.createElement("div"); div.className="card"; div.innerHTML=`<span>${escapeHtml(l.nombre)}</span> <button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')">Editar</button> <button onclick="deleteLocalidad(${l.id})">Eliminar</button>`; container.appendChild(div); });
}
async function addLocalidad(){ const nombre=document.getElementById("localidadNombre").value.trim(); if(!nombre) return alert("Ingrese nombre"); await supabase.from("localidades").insert([{nombre}]); document.getElementById("localidadNombre").value=""; fetchLocalidades(); }
function editLocalidad(id,nombre){ openModal("Editar localidad", `<input id="editLocName" value="${escapeHtml(nombre)}"><button onclick="updateLocalidad(${id})">Guardar</button>`); }
async function updateLocalidad(id){ const nombre=document.getElementById("editLocName").value.trim(); if(!nombre) return alert("Ingrese nombre"); await supabase.from("localidades").update({nombre}).eq("id",id); closeModal(); fetchLocalidades(); }
async function deleteLocalidad(id){ if(!confirm("Eliminar localidad?")) return; await supabase.from("localidades").delete().eq("id",id); fetchLocalidades(); }

// -------------------- PEDIDOS --------------------
async function fetchPedidos(){
  const { data, error } = await supabase.from("pedidos").select("*,localidades(nombre)").order("id",{ascending:false});
  if(error) return console.error(error);
  const container=document.getElementById("pedidoList"); container.innerHTML="";
  data.forEach(p=>{ const div=document.createElement("div"); div.className="card"; div.innerHTML=`<b>${escapeHtml(p.cliente)}</b> - ${p.localidades?.nombre||''} - Total: $${p.total} <div>Productos: ${p.productos}</div>`; container.appendChild(div); });
}

// -------------------- DOCUMENTOS --------------------
async function fetchDocumentos(){
  const { data, error } = await supabase.from("documentos").select("*").order("id",{ascending:false});
  if(error) return console.error(error);
  const container=document.getElementById("docList"); container.innerHTML="";
  data.forEach(d=>{ const a=document.createElement("a"); a.href=supabase.storage.from("docs").getPublicUrl(d.archivo).data.publicUrl; a.target="_blank"; a.textContent=d.nombre; container.appendChild(a); container.appendChild(document.createElement("br")); });
}
async function addDocumento(){
  const nombre=document.getElementById("docNombre").value.trim(); const file=document.getElementById("docArchivo").files[0]; if(!nombre || !file) return alert("Nombre y archivo"); 
  const fileName=`${Date.now()}_${file.name}`; const { error } = await supabase.storage.from("docs").upload(fileName,file); if(error) return alert(error.message); 
  await supabase.from("documentos").insert([{nombre,archivo:fileName}]); 
  document.getElementById("docNombre").value=""; document.getElementById("docArchivo").value=""; fetchDocumentos();
}

// Inicialización
fetchCategorias(); fetchLocalidades(); fetchPromotions(); fetchPedidos(); fetchDocumentos();
</script>

</body>
</html>
