<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>App de Pedidos</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">

<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-4">App de Pedidos</h1>
    <div class="mb-4">
        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg mr-2 tab-btn" data-tab="promotions">Promociones</button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg mr-2 tab-btn" data-tab="orders">Pedidos</button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg mr-2 tab-btn" data-tab="locations">Localidades</button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg tab-btn" data-tab="categories">Categorías</button>
    </div>

    <!-- Tabs -->
    <div id="promotions-tab" class="tab-content">
        <div class="flex justify-between mb-2">
            <h2 class="text-xl font-bold">Promociones</h2>
            <button id="add-promo-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg">Nueva Promoción</button>
        </div>
        <ul id="promotions-list" class="space-y-2"></ul>
    </div>

    <div id="orders-tab" class="tab-content hidden">
        <div class="flex justify-between mb-2">
            <h2 class="text-xl font-bold">Pedidos</h2>
            <button id="add-order-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg">Nuevo Pedido</button>
        </div>
        <ul id="orders-list" class="space-y-2"></ul>
        <div class="mt-4 flex space-x-4">
            <div>Total General: <span id="total-general">$0.00</span></div>
            <div>Total Entregados: <span id="total-delivered">$0.00</span></div>
            <div>Total Pendientes: <span id="total-pending">$0.00</span></div>
        </div>
    </div>

    <div id="locations-tab" class="tab-content hidden">
        <div class="flex mb-2">
            <input type="text" id="new-location-input" placeholder="Nueva localidad" class="flex-grow p-2 border rounded-lg mr-2">
            <button id="add-location-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg">Agregar</button>
        </div>
        <ul id="locations-list" class="space-y-2"></ul>
    </div>

    <div id="categories-tab" class="tab-content hidden">
        <div class="flex mb-2">
            <input type="text" id="new-category-input" placeholder="Nueva categoría" class="flex-grow p-2 border rounded-lg mr-2">
            <button id="add-category-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg">Agregar</button>
        </div>
        <ul id="categories-list" class="space-y-2"></ul>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg w-96 max-w-full relative">
        <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
        <div id="modal-content"></div>
    </div>
</div>

<script>
const supabaseUrl = 'https://ejbqlejlgprvwzrptojo.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const appState = {
    promotions: {},
    orders: {},
    locations: {},
    categories: {},
    orderProducts: [],
    selectedOrder: null
};

// --- UI Tabs ---
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.add('hidden'));
        document.getElementById(`${tab}-tab`).classList.remove('hidden');
    });
});

// --- Modal ---
function showModal(html) {
    document.getElementById('modal-content').innerHTML = html;
    document.getElementById('modal').classList.remove('hidden');
}
function closeModal() {
    document.getElementById('modal').classList.add('hidden');
}

// --- Fetch all data ---
async function fetchAllData() {
    // Promociones
    let { data: promotions } = await supabase.from('promotions').select('*');
    appState.promotions = {};
    promotions.forEach(p => appState.promotions[p.id] = p);

    // Pedidos
    let { data: orders } = await supabase.from('orders').select('*');
    appState.orders = {};
    orders.forEach(o => appState.orders[o.id] = o);

    // Localidades
    let { data: locations } = await supabase.from('locations').select('*');
    appState.locations = {};
    locations.forEach(l => appState.locations[l.id] = l.name);

    // Categorías
    let { data: categories } = await supabase.from('categories').select('*');
    appState.categories = {};
    categories.forEach(c => appState.categories[c.id] = c.name);

    renderPromotions();
    renderOrders();
    renderLocations();
    renderCategories();
}

// --- Render functions ---
function renderPromotions() {
    const list = document.getElementById('promotions-list');
    list.innerHTML = '';
    Object.values(appState.promotions).forEach(p => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow hover:shadow-md';
        li.innerHTML = `
            <div>
                <h3 class="font-bold">${p.name}</h3>
                <p>Precio Original: $${p.original_price || 0}</p>
                <p>Precio: $${p.price || 0}</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="showPromotionModal('${p.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">Editar</button>
                <button onclick="deletePromotion('${p.id}')" class="bg-red-500 text-white px-2 py-1 rounded">Eliminar</button>
            </div>
        `;
        list.appendChild(li);
    });
}

function renderOrders() {
    const list = document.getElementById('orders-list');
    list.innerHTML = '';
    let totalGeneral = 0, totalDelivered = 0, totalPending = 0;
    Object.values(appState.orders).forEach(o => {
        totalGeneral += o.total || 0;
        if(o.status==='Entregado') totalDelivered+=o.total;
        else totalPending+=o.total;
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow hover:shadow-md';
        li.innerHTML = `
            <div>
                <h3 class="font-bold">#${o.id}</h3>
                <p>Cliente: ${o.client_name}</p>
                <p>Localidad: ${appState.locations[o.location_id]||'Desconocida'}</p>
                <p>Status: ${o.status}</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="showOrderModal('${o.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">Ver</button>
                <button onclick="toggleOrderStatus('${o.id}')" class="bg-gray-500 text-white px-2 py-1 rounded">${o.status==='Pendiente'?'Marcar Entregado':'Marcar Pendiente'}</button>
                <button onclick="deleteOrder('${o.id}')" class="bg-red-500 text-white px-2 py-1 rounded">Eliminar</button>
            </div>
        `;
        list.appendChild(li);
    });
    document.getElementById('total-general').innerText = `$${totalGeneral}`;
    document.getElementById('total-delivered').innerText = `$${totalDelivered}`;
    document.getElementById('total-pending').innerText = `$${totalPending}`;
}

function renderLocations() {
    const list = document.getElementById('locations-list');
    list.innerHTML = '';
    Object.keys(appState.locations).forEach(id => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow hover:shadow-md';
        li.innerHTML = `<span>${appState.locations[id]}</span><button onclick="deleteLocation('${id}')" class="text-red-500"><i class="fas fa-trash"></i></button>`;
        list.appendChild(li);
    });
}

function renderCategories() {
    const list = document.getElementById('categories-list');
    list.innerHTML = '';
    Object.keys(appState.categories).forEach(id => {
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow hover:shadow-md';
        li.innerHTML = `<span>${appState.categories[id]}</span><button onclick="deleteCategory('${id}')" class="text-red-500"><i class="fas fa-trash"></i></button>`;
        list.appendChild(li);
    });
}

// --- CRUD Promotions ---
document.getElementById('add-promo-btn').addEventListener('click', ()=>showPromotionModal());
async function showPromotionModal(promoId=null){
    const promo = promoId ? appState.promotions[promoId]: {};
    let html = `
        <h3 class="text-xl font-bold mb-4">${promoId?'Editar':'Nueva'} Promoción</h3>
        <div class="space-y-2">
            <input id="promo-name" placeholder="Nombre" class="w-full p-2 border rounded" value="${promo.name||''}">
            <input id="promo-original-price" type="number" placeholder="Precio Original" class="w-full p-2 border rounded" value="${promo.original_price||''}">
            <input id="promo-price" type="number" placeholder="Precio" class="w-full p-2 border rounded" value="${promo.price||''}">
            <input id="promo-image" type="file" accept="image/*" class="w-full p-2 border rounded">
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
                <button onclick="savePromotion('${promoId||''}')" class="px-4 py-2 bg-blue-600 text-white rounded">Guardar</button>
            </div>
        </div>
    `;
    showModal(html);
}

async function savePromotion(promoId){
    const name = document.getElementById('promo-name').value;
    const price = parseFloat(document.getElementById('promo-price').value)||0;
    const original_price = parseFloat(document.getElementById('promo-original-price').value)||0;
    const file = document.getElementById('promo-image').files[0];

    if(!name) return alert('Nombre obligatorio');

    let imageUrl = '';
    if(file){
        const { data, error } = await supabase.storage.from('images').upload(`promotions/${Date.now()}-${file.name}`, file);
        if(error) return alert(error.message);
        imageUrl = supabase.storage.from('images').getPublicUrl(data.path).publicUrl;
    }

    const payload = { name, price, original_price };
    if(imageUrl) payload.image = imageUrl;

    const { error } = promoId ?
        await supabase.from('promotions').update(payload).eq('id',promoId) :
        await supabase.from('promotions').insert([payload]);

    if(error) return alert(error.message);
    closeModal();
    fetchAllData();
}

async function deletePromotion(id){
    if(!confirm('Eliminar promoción?')) return;
    await supabase.from('promotions').delete().eq('id',id);
    fetchAllData();
}

// --- CRUD Orders ---
document.getElementById('add-order-btn').addEventListener('click', ()=>showOrderModal());
async function showOrderModal(orderId=null){
    const order = orderId ? appState.orders[orderId] : {};
    let html = `
        <h3 class="text-xl font-bold mb-4">${orderId?'Editar':'Nuevo'} Pedido</h3>
        <div class="space-y-2">
            <input id="order-client" placeholder="Cliente" class="w-full p-2 border rounded" value="${order.client_name||''}">
            <select id="order-location" class="w-full p-2 border rounded mb-2">
                <option value="">Seleccione localidad</option>
                ${Object.keys(appState.locations).map(id=>`<option value="${id}" ${order.location_id==id?'selected':''}>${appState.locations[id]}</option>`).join('')}
            </select>
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
                <button onclick="saveOrder('${orderId||''}')" class="px-4 py-2 bg-blue-600 text-white rounded">Guardar</button>
            </div>
        </div>
    `;
    showModal(html);
}

async function saveOrder(orderId){
    const client_name = document.getElementById('order-client').value;
    const location_id = document.getElementById('order-location').value;
    if(!client_name || !location_id) return alert('Todos los campos son obligatorios');

    const payload = { client_name, location_id, status:'Pendiente', total:0 };

    const { error } = orderId ?
        await supabase.from('orders').update(payload).eq('id',orderId) :
        await supabase.from('orders').insert([payload]);
    
    if(error) return alert(error.message);
    closeModal();
    fetchAllData();
}

async function toggleOrderStatus(orderId){
    const order = appState.orders[orderId];
    const newStatus = order.status==='Pendiente'?'Entregado':'Pendiente';
    await supabase.from('orders').update({status:newStatus}).eq('id',orderId);
    fetchAllData();
}

async function deleteOrder(orderId){
    if(!confirm('Eliminar pedido?')) return;
    await supabase.from('orders').delete().eq('id',orderId);
    fetchAllData();
}

// --- CRUD Locations ---
document.getElementById('add-location-btn').addEventListener('click', addLocation);
async function addLocation(){
    const name = document.getElementById('new-location-input').value.trim();
    if(!name) return;
    await supabase.from('locations').insert([{name}]);
    document.getElementById('new-location-input').value='';
    fetchAllData();
}
async function deleteLocation(id){
    await supabase.from('locations').delete().eq('id',id);
    fetchAllData();
}

// --- CRUD Categories ---
document.getElementById('add-category-btn').addEventListener('click', addCategory);
async function addCategory(){
    const name = document.getElementById('new-category-input').value.trim();
    if(!name) return;
    await supabase.from('categories').insert([{name}]);
    document.getElementById('new-category-input').value='';
    fetchAllData();
}
async function deleteCategory(id){
    await supabase.from('categories').delete().eq('id',id);
    fetchAllData();
}

// --- Inicialización ---
fetchAllData();
</script>
</body>
</html>




