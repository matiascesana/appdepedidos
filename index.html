<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>App de Pedidos</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<div class="container mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6">App de Pedidos</h1>

    <!-- Tabs -->
    <div class="mb-4">
        <button class="tab-btn px-4 py-2 bg-blue-500 text-white rounded-l-lg" data-tab="promotions">Promociones</button>
        <button class="tab-btn px-4 py-2 bg-gray-200 text-gray-700" data-tab="orders">Pedidos</button>
        <button class="tab-btn px-4 py-2 bg-gray-200 text-gray-700" data-tab="locations">Localidades</button>
        <button class="tab-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-r-lg" data-tab="categories">Categorías</button>
    </div>

    <!-- Tab Contents -->
    <div id="promotions-tab" class="tab-content">
        <div class="mb-4 flex justify-end">
            <button onclick="showPromoModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Nueva Promoción</button>
        </div>
        <div id="promotions-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>

    <div id="orders-tab" class="tab-content hidden">
        <div class="mb-4 flex justify-end">
            <button onclick="showOrderModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Nuevo Pedido</button>
        </div>
        <div id="orders-list" class="space-y-4"></div>
        <div class="mt-4 text-right space-y-1">
            <p>Total General: <span id="total-general">$0.00</span></p>
            <p>Total Entregados: <span id="total-delivered">$0.00</span></p>
            <p>Total Pendientes: <span id="total-pending">$0.00</span></p>
        </div>
    </div>

    <div id="locations-tab" class="tab-content hidden">
        <div class="mb-4 flex space-x-2">
            <input type="text" id="new-location-input" placeholder="Nueva Localidad" class="border rounded-lg p-2 flex-grow">
            <button onclick="addLocation()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Agregar</button>
        </div>
        <ul id="locations-list" class="space-y-2"></ul>
    </div>

    <div id="categories-tab" class="tab-content hidden">
        <div class="mb-4 flex space-x-2">
            <input type="text" id="new-category-input" placeholder="Nueva Categoría" class="border rounded-lg p-2 flex-grow">
            <button onclick="addCategory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Agregar</button>
        </div>
        <ul id="categories-list" class="space-y-2"></ul>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div id="modal-content" class="bg-white rounded-lg p-6 w-full max-w-lg relative"></div>
</div>

<!-- Loading Overlay -->
<div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg flex items-center space-x-2">
        <i class="fas fa-spinner fa-spin text-2xl"></i>
        <span id="loading-text">Cargando...</span>
    </div>
</div>

<script>
const supabaseUrl = 'https://ejbqlejlgprvwzrptojo.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0am8iLCJyb2xlIjoiYW5vbiIsImlhdCI6MTc1NzAyOTAyMiwiZXhwIjoyMDcyNjA1MDIyfQ.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const appState = {
    promotions: {},
    orders: {},
    locations: {},
    categories: {},
    selectedOrder: null,
    orderProducts: []
};

// --- Tabs ---
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.replace('bg-blue-500','bg-gray-200') || b.classList.replace('text-white','text-gray-700'));
        btn.classList.replace('bg-gray-200','bg-blue-500');
        btn.classList.replace('text-gray-700','text-white');
        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.add('hidden'));
        document.getElementById(`${tab}-tab`).classList.remove('hidden');
    });
});

// --- Loading UI ---
function showLoading(show, text='Cargando...') {
    document.getElementById('loading').classList.toggle('hidden', !show);
    document.getElementById('loading-text').innerText = text;
}

// --- Modal ---
function showModal(html) {
    document.getElementById('modal-content').innerHTML = html;
    document.getElementById('modal').classList.remove('hidden');
}
function closeModal() {
    document.getElementById('modal').classList.add('hidden');
}

// --- Fetch Data ---
async function fetchAllData() {
    showLoading(true, 'Cargando datos...');
    try {
        const { data: promotions } = await supabase.from('promotions').select('*');
        const { data: orders } = await supabase.from('orders').select('*');
        const { data: locations } = await supabase.from('locations').select('*');
        const { data: categories } = await supabase.from('categories').select('*');

        appState.promotions = {};
        promotions.forEach(p => appState.promotions[p.id] = p);
        appState.orders = {};
        orders.forEach(o => appState.orders[o.id] = o);
        appState.locations = {};
        locations.forEach(l => appState.locations[l.id] = l.name);
        appState.categories = {};
        categories.forEach(c => appState.categories[c.id] = c.name);

        renderPromotions();
        renderOrders();
        renderLocations();
        renderCategories();
    } catch (e) {
        console.error('Error fetching data:', e);
        alert('Error al cargar datos.');
    } finally {
        showLoading(false);
    }
}

// --- Render Functions ---
function renderPromotions() {
    const container = document.getElementById('promotions-list');
    container.innerHTML = '';
    Object.values(appState.promotions).forEach(promo => {
        const card = document.createElement('div');
        card.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col';
        card.innerHTML = `
            <h3 class="font-bold">${promo.name}</h3>
            <p>Precio: $${promo.price.toFixed(2)}</p>
            <p>Stock: ${promo.stock}</p>
            ${promo.image ? `<img src="${promo.image}" class="mt-2 w-full h-32 object-cover rounded-lg">` : ''}
            <div class="mt-2 flex space-x-2">
                <button onclick="showPromoModal('${promo.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Editar</button>
                <button onclick="deletePromo('${promo.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Eliminar</button>
            </div>
        `;
        container.appendChild(card);
    });
}

function renderOrders() {
    const container = document.getElementById('orders-list');
    container.innerHTML = '';
    let totalGeneral = 0, totalDelivered = 0, totalPending = 0;

    Object.values(appState.orders).sort((a,b)=>b.id.localeCompare(a.id)).forEach(order => {
        totalGeneral += order.total;
        if(order.status==='Entregado') totalDelivered+=order.total;
        else totalPending+=order.total;

        const card = document.createElement('div');
        card.className = `bg-white p-4 rounded-lg shadow-md flex justify-between items-center border-l-4 ${order.status==='Entregado'?'border-green-500':'border-red-500'}`;
        const locationName = appState.locations[order.locationId] || 'Desconocida';
        const statusColor = order.status==='Entregado'?'text-green-600':'text-red-600';

        card.innerHTML = `
            <div class="flex-grow">
                <h3 class="font-bold">Pedido #${order.id.substring(0,6)}</h3>
                <p>Cliente: ${order.clientName}</p>
                <p>Localidad: ${locationName}</p>
                <p class="${statusColor}">${order.status}</p>
            </div>
            <div class="text-right">
                <p class="font-bold text-blue-600">$${order.total.toFixed(2)}</p>
                <div class="mt-2 flex space-x-2">
                    <button onclick="showOrderModal('${order.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Ver</button>
                    <button onclick="toggleOrderStatus('${order.id}')" class="bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">${order.status==='Pendiente'?'Marcar Entregado':'Marcar Pendiente'}</button>
                    <button onclick="deleteOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Eliminar</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });

    document.getElementById('total-general').innerText = `$${totalGeneral.toFixed(2)}`;
    document.getElementById('total-delivered').innerText = `$${totalDelivered.toFixed(2)}`;
    document.getElementById('total-pending').innerText = `$${totalPending.toFixed(2)}`;
}

function renderLocations() {
    const container = document.getElementById('locations-list');
    container.innerHTML = '';
    Object.keys(appState.locations).forEach(id => {
        const li = document.createElement('li');
        li.className = 'flex justify-between p-2 bg-gray-50 rounded hover:bg-gray-100';
        li.innerHTML = `<span>${appState.locations[id]}</span>
                        <button onclick="deleteLocation('${id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>`;
        container.appendChild(li);
    });
}

function renderCategories() {
    const container = document.getElementById('categories-list');
    container.innerHTML = '';
    Object.keys(appState.categories).forEach(id => {
        const li = document.createElement('li');
        li.className = 'flex justify-between p-2 bg-gray-50 rounded hover:bg-gray-100';
        li.innerHTML = `<span>${appState.categories[id]}</span>
                        <button onclick="deleteCategory('${id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>`;
        container.appendChild(li);
    });
}

// --- CRUD ---
async function addLocation() {
    const input = document.getElementById('new-location-input');
    if(!input.value.trim()) return;
    await supabase.from('locations').insert({name: input.value.trim()});
    input.value='';
    fetchAllData();
}
async function addCategory() {
    const input = document.getElementById('new-category-input');
    if(!input.value.trim()) return;
    await supabase.from('categories').insert({name: input.value.trim()});
    input.value='';
    fetchAllData();
}
async function deleteLocation(id) {
    if(!confirm('Eliminar localidad?')) return;
    await supabase.from('locations').delete().eq('id',id);
    fetchAllData();
}
async function deleteCategory(id) {
    if(!confirm('Eliminar categoría?')) return;
    await supabase.from('categories').delete().eq('id',id);
    fetchAllData();
}
async function toggleOrderStatus(orderId){
    const order = appState.orders[orderId];
    const newStatus = order.status==='Entregado'?'Pendiente':'Entregado';
    await supabase.from('orders').update({status:newStatus}).eq('id',orderId);
    fetchAllData();
}
async function deleteOrder(orderId){
    if(!confirm('Eliminar pedido?')) return;
    await supabase.from('orders').delete().eq('id',orderId);
    fetchAllData();
}

// --- Modales para crear/editar Promociones y Pedidos ---
function showPromoModal(promoId=null){
    const promo = promoId ? appState.promotions[promoId] : {name:'', price:0, stock:0, image:''};
    showModal(`
        <h3 class="text-xl font-bold mb-4">${promoId?'Editar':'Nueva'} Promoción</h3>
        <form id="promo-form" class="space-y-4">
            <input type="text" id="promo-name" placeholder="Nombre" class="border rounded p-2 w-full" value="${promo.name}" required>
            <input type="number" id="promo-price" placeholder="Precio" class="border rounded p-2 w-full" value="${promo.price}" required min="0" step="0.01">
            <input type="number" id="promo-stock" placeholder="Stock" class="border rounded p-2 w-full" value="${promo.stock}" required min="0">
            <input type="text" id="promo-image" placeholder="URL de imagen" class="border rounded p-2 w-full" value="${promo.image}">
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">${promoId?'Actualizar':'Crear'}</button>
            </div>
        </form>
    `);
    document.getElementById('promo-form').onsubmit = async e=>{
        e.preventDefault();
        const name = document.getElementById('promo-name').value.trim();
        const price = parseFloat(document.getElementById('promo-price').value);
        const stock = parseInt(document.getElementById('promo-stock').value);
        const image = document.getElementById('promo-image').value.trim();
        if(!name || price<0 || stock<0){ alert('Complete los campos correctamente'); return; }
        if(promoId){
            await supabase.from('promotions').update({name, price, stock, image}).eq('id',promoId);
        }else{
            await supabase.from('promotions').insert({name, price, stock, image});
        }
        closeModal();
        fetchAllData();
    };
}

function showOrderModal(orderId=null){
    const order = orderId ? appState.orders[orderId] : {clientName:'', locationId:'', status:'Pendiente', total:0};
    const locationsOptions = Object.entries(appState.locations).map(([id,name])=>`<option value="${id}" ${id===order.locationId?'selected':''}>${name}</option>`).join('');
    showModal(`
        <h3 class="text-xl font-bold mb-4">${orderId?'Editar':'Nuevo'} Pedido</h3>
        <form id="order-form" class="space-y-4">
            <input type="text" id="order-client" placeholder="Nombre del Cliente" class="border rounded p-2 w-full" value="${order.clientName}" required>
            <select id="order-location" class="border rounded p-2 w-full" required>
                <option value="">Seleccione Localidad</option>
                ${locationsOptions}
            </select>
            <input type="number" id="order-total" placeholder="Total" class="border rounded p-2 w-full" value="${order.total}" required min="0" step="0.01">
            <select id="order-status" class="border rounded p-2 w-full">
                <option value="Pendiente" ${order.status==='Pendiente'?'selected':''}>Pendiente</option>
                <option value="Entregado" ${order.status==='Entregado'?'selected':''}>Entregado</option>
            </select>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">${orderId?'Actualizar':'Crear'}</button>
            </div>
        </form>
    `);
    document.getElementById('order-form').onsubmit = async e=>{
        e.preventDefault();
        const clientName = document.getElementById('order-client').value.trim();
        const locationId = document.getElementById('order-location').value;
        const total = parseFloat(document.getElementById('order-total').value);
        const status = document.getElementById('order-status').value;
        if(!clientName || !locationId || total<0){ alert('Complete los campos correctamente'); return; }
        if(orderId){
            await supabase.from('orders').update({clientName, locationId, total, status}).eq('id',orderId);
        }else{
            await supabase.from('orders').insert({clientName, locationId, total, status});
        }
        closeModal();
        fetchAllData();
    };
}

// --- Inicial ---
fetchAllData();
</script>

</body>
</html>
