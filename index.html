<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>App de Pedidos</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

<div class="w-full max-w-6xl">

  <!-- Tabs -->
  <div class="mb-4 flex border-b border-gray-300">
    <button id="tab-promotions" class="px-4 py-2 font-semibold text-blue-600 border-b-2 border-blue-600">Promociones</button>
    <button id="tab-orders" class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-600">Pedidos</button>
    <button id="tab-locations" class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-600">Localidades</button>
    <button id="tab-categories" class="px-4 py-2 font-semibold text-gray-600 hover:text-blue-600">Categorías</button>
  </div>

  <!-- Content -->
  <div id="tab-content" class="bg-white rounded-lg shadow p-4">

    <!-- Promociones -->
    <div id="promotions-tab" class="tab-panel">
      <div class="flex justify-between mb-4">
        <h2 class="text-xl font-bold">Promociones</h2>
        <button onclick="showPromoModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Nueva Promoción</button>
      </div>
      <div id="promotions-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <!-- Pedidos -->
    <div id="orders-tab" class="tab-panel hidden">
      <div class="flex justify-between mb-4">
        <h2 class="text-xl font-bold">Pedidos</h2>
        <button onclick="showOrderModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Nuevo Pedido</button>
      </div>
      <div id="orders-list" class="space-y-4"></div>
    </div>

    <!-- Localidades -->
    <div id="locations-tab" class="tab-panel hidden">
      <div class="flex justify-between mb-4">
        <input type="text" id="new-location-input" placeholder="Nueva localidad" class="border p-2 rounded w-full max-w-xs">
        <button onclick="addLocation()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 ml-2">Agregar</button>
      </div>
      <ul id="locations-list" class="space-y-2"></ul>
    </div>

    <!-- Categorías -->
    <div id="categories-tab" class="tab-panel hidden">
      <div class="flex justify-between mb-4">
        <input type="text" id="new-category-input" placeholder="Nueva categoría" class="border p-2 rounded w-full max-w-xs">
        <button onclick="addCategory()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 ml-2">Agregar</button>
      </div>
      <ul id="categories-list" class="space-y-2"></ul>
    </div>

  </div>
</div>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
  <div id="modal-content" class="bg-white rounded-lg p-6 max-w-lg w-full relative"></div>
</div>

<!-- Loading -->
<div id="loading" class="fixed inset-0 bg-black bg-opacity-30 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow flex items-center space-x-2">
    <i class="fas fa-spinner fa-spin text-blue-600 text-xl"></i>
    <span>Cargando...</span>
  </div>
</div>

<script>
  // --- Supabase ---
  const supabaseUrl = 'https://ejbqlejlgprvwzrptojo.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let appState = {
    promotions: {},
    orders: {},
    locations: {},
    categories: {},
    selectedOrder: null,
    orderProducts: []
  };

  // --- Tabs ---
  const tabs = ['promotions', 'orders', 'locations', 'categories'];
  tabs.forEach(tab => {
    document.getElementById('tab-' + tab).addEventListener('click', () => {
      tabs.forEach(t => {
        document.getElementById('tab-' + t).classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        document.getElementById('tab-' + t).classList.add('text-gray-600');
        document.getElementById(t + '-tab').classList.add('hidden');
      });
      document.getElementById('tab-' + tab).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
      document.getElementById(tab + '-tab').classList.remove('hidden');
    });
  });

  // --- UI Helpers ---
  function showModal(contentHtml) {
    document.getElementById('modal-content').innerHTML = contentHtml;
    document.getElementById('modal').classList.remove('hidden');
  }
  function closeModal() {
    document.getElementById('modal').classList.add('hidden');
  }
  function showLoading(show) {
    const loading = document.getElementById('loading');
    if(show) loading.classList.remove('hidden');
    else loading.classList.add('hidden');
  }
  function showStatusMessage(msg, error=false) {
    alert(msg); // Simple alert, se puede reemplazar por Toast
  }

  // --- Fetch All Data ---
  async function fetchAllData() {
    showLoading(true);
    try {
      const { data: promotions } = await supabaseClient.from('promotions').select('*');
      const { data: orders } = await supabaseClient.from('orders').select('*');
      const { data: locations } = await supabaseClient.from('locations').select('*');
      const { data: categories } = await supabaseClient.from('categories').select('*');

      appState.promotions = {};
      promotions.forEach(p => appState.promotions[p.id] = p);

      appState.orders = {};
      orders.forEach(o => appState.orders[o.id] = o);

      appState.locations = {};
      locations.forEach(l => appState.locations[l.id] = l.name);

      appState.categories = {};
      categories.forEach(c => appState.categories[c.id] = c.name);

      renderPromotions();
      renderOrders();
      renderLocations();
      renderCategories();
    } catch (err) {
      console.error(err);
      showStatusMessage('Error cargando datos', true);
    } finally {
      showLoading(false);
    }
  }

  // --- Render Functions ---
  function renderPromotions() {
    const container = document.getElementById('promotions-list');
    container.innerHTML = '';
    Object.values(appState.promotions).forEach(p => {
      const div = document.createElement('div');
      div.className = 'bg-gray-50 p-4 rounded shadow flex flex-col justify-between';
      div.innerHTML = `
        <h3 class="font-bold">${p.name}</h3>
        <p>Precio: $${p.price}</p>
        <p>Stock: ${p.stock}</p>
        <div class="mt-2 flex space-x-2">
          <button onclick="showPromoModal('${p.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 text-xs">Editar</button>
          <button onclick="deletePromo('${p.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs">Eliminar</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function renderOrders() {
    const container = document.getElementById('orders-list');
    container.innerHTML = '';
    Object.values(appState.orders).forEach(o => {
      const div = document.createElement('div');
      div.className = `bg-white p-4 rounded shadow flex justify-between items-center ${o.status==='Entregado'?'border-l-4 border-green-500':'border-l-4 border-red-500'}`;
      const locationName = appState.locations[o.locationId] || 'Localidad desconocida';
      div.innerHTML = `
        <div>
          <h3 class="font-bold">Pedido #${o.id.substring(0,6)}</h3>
          <p>Cliente: ${o.clientName}</p>
          <p>Localidad: ${locationName}</p>
          <p class="${o.status==='Entregado'?'text-green-600':'text-red-600'}">${o.status}</p>
        </div>
        <div class="text-right">
          <p class="font-bold">$${o.total}</p>
          <div class="flex space-x-2 mt-2">
            <button onclick="showOrderModal('${o.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600 text-xs">Ver</button>
            <button onclick="toggleOrderStatus('${o.id}')" class="bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600 text-xs">${o.status==='Pendiente'?'Marcar Entregado':'Marcar Pendiente'}</button>
            <button onclick="deleteOrder('${o.id}')" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs">Eliminar</button>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function renderLocations() {
    const container = document.getElementById('locations-list');
    container.innerHTML = '';
    Object.entries(appState.locations).forEach(([id,name])=>{
      const li = document.createElement('li');
      li.className = 'flex justify-between p-2 bg-gray-50 rounded hover:bg-gray-100';
      li.innerHTML = `${name} <button onclick="deleteLocation('${id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>`;
      container.appendChild(li);
    });
  }

  function renderCategories() {
    const container = document.getElementById('categories-list');
    container.innerHTML = '';
    Object.entries(appState.categories).forEach(([id,name])=>{
      const li = document.createElement('li');
      li.className = 'flex justify-between p-2 bg-gray-50 rounded hover:bg-gray-100';
      li.innerHTML = `${name} <button onclick="deleteCategory('${id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>`;
      container.appendChild(li);
    });
  }

  // --- CRUD Functions ---
  async function showPromoModal(promoId=null){
    const p = promoId ? appState.promotions[promoId] : {};
    showModal(`
      <h3 class="text-xl font-bold mb-4">${promoId?'Editar Promoción':'Nueva Promoción'}</h3>
      <form id="promo-form" class="space-y-4">
        <input id="promo-name" type="text" placeholder="Nombre" value="${p.name||''}" class="border p-2 rounded w-full" required/>
        <input id="promo-price" type="number" placeholder="Precio" value="${p.price||''}" class="border p-2 rounded w-full" required/>
        <input id="promo-stock" type="number" placeholder="Stock" value="${p.stock||0}" class="border p-2 rounded w-full" required/>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancelar</button>
          <button type="submit" class="bg-blue-600 px-4 py-2 rounded text-white hover:bg-blue-700">Guardar</button>
        </div>
      </form>
    `);
    document.getElementById('promo-form').onsubmit = async e=>{
      e.preventDefault();
      const name = document.getElementById('promo-name').value.trim();
      const price = parseFloat(document.getElementById('promo-price').value);
      const stock = parseInt(document.getElementById('promo-stock').value);
      if(!name || isNaN(price) || isNaN(stock)){
        alert('Rellena todos los campos correctamente');
        return;
      }
      showLoading(true);
      if(promoId){
        await supabaseClient.from('promotions').update({name,price,stock}).eq('id',promoId);
      }else{
        await supabaseClient.from('promotions').insert({name,price,stock});
      }
      closeModal();
      fetchAllData();
    };
  }

  async function deletePromo(promoId){
    if(confirm('Eliminar promoción?')){
      showLoading(true);
      await supabaseClient.from('promotions').delete().eq('id',promoId);
      fetchAllData();
    }
  }

  async function addLocation(){
    const input = document.getElementById('new-location-input');
    const name = input.value.trim();
    if(!name) return;
    showLoading(true);
    await supabaseClient.from('locations').insert({name});
    input.value='';
    fetchAllData();
  }
  async function deleteLocation(id){
    if(confirm('Eliminar localidad?')){
      showLoading(true);
      await supabaseClient.from('locations').delete().eq('id',id);
      fetchAllData();
    }
  }

  async function addCategory(){
    const input = document.getElementById('new-category-input');
    const name = input.value.trim();
    if(!name) return;
    showLoading(true);
    await supabaseClient.from('categories').insert({name});
    input.value='';
    fetchAllData();
  }
  async function deleteCategory(id){
    if(confirm('Eliminar categoría?')){
      showLoading(true);
      await supabaseClient.from('categories').delete().eq('id',id);
      fetchAllData();
    }
  }

  // --- Pedidos Modal Completo ---
  async function showOrderModal(orderId=null){
    let order = orderId ? appState.orders[orderId] : {clientName:'',locationId:'',products:[],total:0,status:'Pendiente'};
    showModal(`
      <h3 class="text-xl font-bold mb-4">${orderId?'Editar Pedido':'Nuevo Pedido'}</h3>
      <form id="order-form" class="space-y-4">
        <input id="order-client" type="text" placeholder="Nombre del cliente" value="${order.clientName}" class="border p-2 rounded w-full" required/>
        <select id="order-location" class="border p-2 rounded w-full" required>
          <option value="">Selecciona localidad</option>
          ${Object.entries(appState.locations).map(([id,name])=>`<option value="${id}" ${order.locationId==id?'selected':''}>${name}</option>`).join('')}
        </select>
        <div id="order-products-container" class="space-y-2">
          ${order.products.map((p,i)=>`<div class="flex space-x-2">
            <select class="border p-2 rounded w-full product-select">${Object.values(appState.promotions).map(pr=>`<option value="${pr.id}" ${p.id==pr.id?'selected':''}>${pr.name}</option>`).join('')}</select>
            <input type="number" min="1" class="border p-2 rounded w-20 product-qty" value="${p.quantity}" required/>
            <button type="button" class="bg-red-500 text-white px-2 rounded" onclick="removeProductRow(this)">X</button>
          </div>`).join('')}
        </div>
        <button type="button" onclick="addProductRow()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Agregar Producto</button>
        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancelar</button>
          <button type="submit" class="bg-green-600 px-4 py-2 rounded text-white hover:bg-green-700">Guardar</button>
        </div>
      </form>
    `);

    function collectProducts(){
      const rows = document.querySelectorAll('#order-products-container > div');
      let products = [];
      rows.forEach(r=>{
        const prodId = r.querySelector('.product-select').value;
        const qty = parseInt(r.querySelector('.product-qty').value);
        if(prodId && qty>0) products.push({id:prodId,quantity:qty});
      });
      return products;
    }

    document.getElementById('order-form').onsubmit = async e=>{
      e.preventDefault();
      const clientName = document.getElementById('order-client').value.trim();
      const locationId = document.getElementById('order-location').value;
      const products = collectProducts();
      if(!clientName || !locationId || products.length==0){
        alert('Rellena todos los campos y agrega al menos un producto');
        return;
      }
      let total = products.reduce((sum,p)=>sum + appState.promotions[p.id].price*p.quantity,0);
      showLoading(true);
      if(orderId){
        await supabaseClient.from('orders').update({clientName,locationId,products,total}).eq('id',orderId);
      }else{
        await supabaseClient.from('orders').insert({clientName,locationId,products,total,status:'Pendiente'});
      }
      closeModal();
      fetchAllData();
    };
  }

  function addProductRow(){
    const container = document.getElementById('order-products-container');
    const div = document.createElement('div');
    div.className = 'flex space-x-2';
    div.innerHTML = `
      <select class="border p-2 rounded w-full product-select">
        ${Object.values(appState.promotions).map(p=>`<option value="${p.id}">${p.name}</option>`).join('')}
      </select>
      <input type="number" min="1" class="border p-2 rounded w-20 product-qty" value="1" required/>
      <button type="button" class="bg-red-500 text-white px-2 rounded" onclick="removeProductRow(this)">X</button>
    `;
    container.appendChild(div);
  }
  function removeProductRow(btn){ btn.parentElement.remove(); }

  async function deleteOrder(orderId){
    if(confirm('Eliminar pedido?')){
      showLoading(true);
      await supabaseClient.from('orders').delete().eq('id',orderId);
      fetchAllData();
    }
  }
  async function toggleOrderStatus(orderId){
    const order = appState.orders[orderId];
    const newStatus = order.status==='Entregado'?'Pendiente':'Entregado';
    showLoading(true);
    await supabaseClient.from('orders').update({status:newStatus}).eq('id',orderId);
    fetchAllData();
  }

  fetchAllData();
</script>

</body>
</html>
