<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>App Completa de Pedidos y Documentos</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Roboto',sans-serif; background:#f9f9f9; color:#333; display:flex; height:100vh; overflow:hidden;}
.sidebar { width:200px; background:#6a1b9a; display:flex; flex-direction:column; padding:20px;}
.sidebar button { margin-bottom:10px; padding:10px; border:none; border-radius:6px; font-weight:600; cursor:pointer; color:#fff; background:#7b1fa2;}
.sidebar button.active { background:#fff; color:#6a1b9a;}
.main { flex:1; overflow-y:auto; padding:20px;}
h1,h2{font-family:'Playfair Display',serif;}
.section { display:none; background:#fff; padding:20px; border-radius:15px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:20px;}
.item-card, .doc-item { display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background:#f4f4f4; margin-bottom:10px;}
.item-card img { width:50px;height:50px;object-fit:cover;border-radius:6px;margin-right:10px;}
button { cursor:pointer; border:none; border-radius:6px; padding:6px 10px; font-weight:600; background:#6a1b9a; color:#fff;}
button:hover{background:#7b1fa2;}
.delete-btn{background:#e53935;}
.delete-btn:hover{background:#f44336;}
#docProgressContainer{width:100%;background:#eee;border-radius:5px;margin-top:5px;}
#docProgress{width:0%;height:10px;background:green;border-radius:5px;transition:width 300ms;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:999;}
.modal-content{background:#fff;padding:20px;border-radius:10px;max-width:500px;width:100%;position:relative;}
.modal-close{position:absolute;top:10px;right:10px;cursor:pointer;font-weight:bold;}
</style>
</head>
<body>

<div class="sidebar">
  <button class="tab-btn active" data-tab="promos">Promociones</button>
  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
  <button class="tab-btn" data-tab="categorias">Categorías</button>
  <button class="tab-btn" data-tab="localidades">Localidades</button>
  <button class="tab-btn" data-tab="documentos">Documentos</button>
</div>

<div class="main">
<h1>App Completa de Pedidos y Documentos</h1>

<!-- PROMOCIONES -->
<div class="section" id="promos">
<h2>Promociones</h2>
<form id="promoForm" onsubmit="return false;">
<label>Nombre:<input type="text" id="promoNombre" required></label>
<label>Precio:<input type="number" id="promoPrecio" step="0.01" required></label>
<label>Stock:<input type="number" id="promoStock" required></label>
<label>Categoría:<select id="promoCategoria"></select></label>
<label>Imagen:<input type="file" id="promoImagen" accept="image/*"></label>
<button type="button" id="addPromoBtn">Agregar Promoción</button>
<button type="button" id="exportPromoPDFBtn">Exportar PDF</button>
</form>
<h3>Lista de Promociones</h3>
<div id="promoList"></div>
</div>

<!-- PEDIDOS -->
<div class="section" id="pedidos">
<h2>Pedidos</h2>
<form id="pedidoForm" onsubmit="return false;">
  <label>Cliente:<input type="text" id="pedidoCliente" required></label>
  <label>Localidad:<select id="pedidoLocalidad"></select></label>
  <button type="button" id="selectProductsBtn">Seleccionar Productos</button>
  <div id="selectedProductsContainer"></div>
  <button type="button" id="addOrderBtn">Agregar Pedido</button>
</form>
<h3>Lista de Pedidos</h3>
<div id="pedidoList"></div>
</div>

<!-- CATEGORÍAS -->
<div class="section" id="categorias">
<h2>Categorías de Promociones</h2>
<form id="categoriaForm" onsubmit="return false;">
<label>Nombre:<input type="text" id="categoriaNombre" required></label>
<button type="button" id="addCategoriaBtn">Agregar Categoría</button>
</form>
<h3>Lista de Categorías</h3>
<div id="categoriaList"></div>
</div>

<!-- LOCALIDADES -->
<div class="section" id="localidades">
<h2>Localidades</h2>
<form id="localidadForm" onsubmit="return false;">
<label>Nombre:<input type="text" id="localidadNombre" required></label>
<button type="button" id="addLocalidadBtn">Agregar Localidad</button>
</form>
<h3>Lista de Localidades</h3>
<div id="localidadList"></div>
</div>

<!-- DOCUMENTOS -->
<div class="section" id="documentos">
<h2>Documentos</h2>
<label>Buscar por DNI:</label>
<input type="text" id="searchDoc" placeholder="Escriba DNI...">
<input type="file" id="docFiles" multiple>
<button id="uploadDocsBtn">Subir Documentos</button>
<button id="deleteAllDocsBtn">Eliminar Todos</button>
<div id="docProgressContainer">
  <div id="docProgress"></div>
</div>
<h3>Documentos subidos:</h3>
<div id="documentsList"></div>
</div>

<!-- MODAL -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal-content" id="modalContent">
    <span class="modal-close" onclick="closeModal()">×</span>
  </div>
</div>

<script>
// -------------------- Supabase --------------------
const SUPABASE_URL='https://ejbqlejlgprvwzrptojo.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// -------------------- Helpers --------------------
function showToast(msg,d=3000){ 
  const t=document.createElement('div'); 
  t.textContent=msg; 
  Object.assign(t.style,{position:'fixed',bottom:'20px',right:'20px',background:'#6a1b9a',color:'#fff',padding:'10px 15px',borderRadius:'5px',opacity:'0.95'}); 
  document.body.appendChild(t); 
  setTimeout(()=>t.remove(),d);
}
function openModal(title,html){ 
  const modal=document.getElementById('modal'); 
  const content=document.getElementById('modalContent'); 
  content.innerHTML=`<span class="modal-close" onclick="closeModal()">×</span><h3>${title}</h3>${html}`; 
  modal.style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
async function safeGetFileUrl(fileName,bucket='private-documents'){ 
  try{
    const {data,error}=await supabase.storage.from(bucket).createSignedUrl(fileName,3600); 
    return error?null:data.signedUrl;
  }catch{return null;}
}

// -------------------- Tabs --------------------
const tabBtns=document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn=>btn.addEventListener('click',()=>{
  tabBtns.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(btn.dataset.tab).style.display='block';
}));
document.getElementById('promos').style.display='block';

// -------------------- CATEGORÍAS --------------------
async function fetchCategorias(){
  const {data,error}=await supabase.from('categorias').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('categoriaList'); container.innerHTML='';
  const select=document.getElementById('promoCategoria'); select.innerHTML='<option value="">Seleccione</option>';
  data.forEach(cat=>{
    select.innerHTML+=`<option value="${cat.id}">${cat.nombre}</option>`;
    const div=document.createElement('div'); div.className='item-card';
    div.innerHTML=`<span>${cat.nombre}</span> 
      <div>
        <button onclick="editCategoria(${cat.id},'${cat.nombre}')">Editar</button>
        <button class="delete-btn" onclick="deleteCategoria(${cat.id})">Eliminar</button>
      </div>`;
    container.appendChild(div);
  });
}
async function addCategoria(){
  const nombre=document.getElementById('categoriaNombre').value.trim();
  if(!nombre) return alert('Ingrese nombre'); 
  const {error}=await supabase.from('categorias').insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById('categoriaForm').reset();
  fetchCategorias();
}
async function editCategoria(id,nombre){
  openModal('Editar Categoría',`<input id="editCatName" value="${nombre}"><button onclick="updateCategoria(${id})">Guardar</button>`);
}
async function updateCategoria(id){
  const nombre=document.getElementById('editCatName').value.trim();
  if(!nombre) return alert('Ingrese nombre');
  const {error}=await supabase.from('categorias').update({nombre}).eq('id',id);
  if(error) return alert(error.message);
  closeModal(); fetchCategorias(); fetchPromotions();
}
async function deleteCategoria(id){ 
  if(confirm('Eliminar categoría?')){ 
    await supabase.from('categorias').delete().eq('id',id); 
    fetchCategorias(); fetchPromotions(); 
  } 
}
document.getElementById('addCategoriaBtn').addEventListener('click',addCategoria);
fetchCategorias();

// -------------------- LOCALIDADES --------------------
async function fetchLocalidades(){
  const {data,error}=await supabase.from('localidades').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('localidadList'); container.innerHTML='';
  const select=document.getElementById('pedidoLocalidad'); select.innerHTML='<option value="">Seleccione</option>';
  data.forEach(loc=>{
    select.innerHTML+=`<option value="${loc.id}">${loc.nombre}</option>`;
    const div=document.createElement('div'); div.className='item-card';
    div.innerHTML=`<span>${loc.nombre}</span> 
      <div>
        <button onclick="editLocalidad(${loc.id},'${loc.nombre}')">Editar</button>
        <button class="delete-btn" onclick="deleteLocalidad(${loc.id})">Eliminar</button>
      </div>`;
    container.appendChild(div);
  });
}
async function addLocalidad(){
  const nombre=document.getElementById('localidadNombre').value.trim();
  if(!nombre) return alert('Ingrese nombre'); 
  const {error}=await supabase.from('localidades').insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById('localidadForm').reset();
  fetchLocalidades();
}
async function editLocalidad(id,nombre){ 
  openModal('Editar Localidad',`<input id="editLocName" value="${nombre}"><button onclick="updateLocalidad(${id})">Guardar</button>`);
}
async function updateLocalidad(id){ 
  const nombre=document.getElementById('editLocName').value.trim(); 
  if(!nombre) return alert('Ingrese nombre'); 
  const {error}=await supabase.from('localidades').update({nombre}).eq('id',id); 
  if(error) return alert(error.message); 
  closeModal(); fetchLocalidades(); fetchOrders();
}
async function deleteLocalidad(id){ 
  if(confirm('Eliminar localidad?')){ 
    await supabase.from('localidades').delete().eq('id',id); 
    fetchLocalidades(); fetchOrders(); 
  }
}
document.getElementById('addLocalidadBtn').addEventListener('click',addLocalidad);
fetchLocalidades();

// -------------------- PROMOCIONES --------------------
async function fetchPromotions(){
  const {data,error}=await supabase.from('promociones').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('promoList'); container.innerHTML='';
  for(let promo of data){
    const catName=await getCategoriaName(promo.categoria_id);
    const card=document.createElement('div'); card.className='item-card';
    let imgHTML=promo.imagen?`<img src="${await safeGetFileUrl(promo.imagen,'promo_images')}">`:''; 
    card.innerHTML=`${imgHTML}<div><strong>${promo.nombre}</strong><br>$${promo.precio} - Stock: ${promo.stock} - ${catName}</div>
    <div>
      <button onclick="editPromo(${promo.id})">Editar</button>
      <button class="delete-btn" onclick="deletePromo(${promo.id})">Eliminar</button>
    </div>`;
    container.appendChild(card);
  }
}
async function getCategoriaName(id){ if(!id) return ''; const {data}=await supabase.from('categorias').select('nombre').eq('id',id).single(); return data?data.nombre:''; }
document.getElementById('addPromoBtn').addEventListener('click',async()=>{
  const nombre=document.getElementById('promoNombre').value.trim();
  const precio=parseFloat(document.getElementById('promoPrecio').value);
  const stock=parseInt(document.getElementById('promoStock').value,10);
  const categoria_id=document.getElementById('promoCategoria').value||null;
  const imagenFile=document.getElementById('promoImagen').files[0];
  if(!nombre || isNaN(precio)||isNaN(stock)) return alert('Complete campos');
  let imagePath=null;
  if(imagenFile){
    const fileName=`promo_${Date.now()}_${imagenFile.name.replaceAll(' ','_')}`;
    const {error}=await supabase.storage.from('promo_images').upload(fileName,imagenFile,{upsert:true});
    if(error) return alert(error.message);
    imagePath=fileName;
  }
  const {error}=await supabase.from('promociones').insert([{nombre,precio,stock,categoria_id,imagen:imagePath}]);
  if(error) return alert(error.message);
  document.getElementById('promoForm').reset(); fetchPromotions(); showToast('Promoción agregada');
});
async function editPromo(id){
  const {data,error}=await supabase.from('promociones').select('*').eq('id',id).single();
  if(error) return alert(error.message);
  openModal('Editar Promoción',`
    <label>Nombre:<input id="editPromoNombre" value="${data.nombre}"></label>
    <label>Precio:<input id="editPromoPrecio" type="number" step="0.01" value="${data.precio}"></label>
    <label>Stock:<input id="editPromoStock" type="number" value="${data.stock}"></label>
    <label>Categoría:<select id="editPromoCategoria"></select></label>
    <button onclick="updatePromo(${id})">Guardar</button>
  `);
  const cats=await supabase.from('categorias').select('*'); 
  const sel=document.getElementById('editPromoCategoria'); sel.innerHTML='<option value="">Seleccione</option>';
  cats.data.forEach(c=>sel.innerHTML+=`<option value="${c.id}" ${c.id===data.categoria_id?'selected':''}>${c.nombre}</option>`);
}
async function updatePromo(id){
  const nombre=document.getElementById('editPromoNombre').value.trim();
  const precio=parseFloat(document.getElementById('editPromoPrecio').value);
  const stock=parseInt(document.getElementById('editPromoStock').value,10);
  const categoria_id=document.getElementById('editPromoCategoria').value||null;
  const {error}=await supabase.from('promociones').update({nombre,precio,stock,categoria_id}).eq('id',id);
  if(error) return alert(error.message);
  closeModal(); fetchPromotions(); showToast('Promoción actualizada');
}
async function deletePromo(id){ if(confirm('Eliminar promoción?')){ await supabase.from('promociones').delete().eq('id',id); fetchPromotions(); } }
fetchPromotions();

// -------------------- PEDIDOS --------------------
let selectedProducts=[];
document.getElementById('selectProductsBtn').addEventListener('click',async()=>{
  const {data:promos,error}=await supabase.from('promociones').select('*').order('id');
  if(error) return alert(error.message);
  let html=''; promos.forEach(p=>{
    html+=`<div style="margin-bottom:5px;">
      <input type="number" min="0" max="${p.stock}" value="${getSelectedQty(p.id)}" id="prod_${p.id}" style="width:50px">
      <strong>${p.nombre}</strong> - $${p.precio} - Stock: ${p.stock}
    </div>`;
  });
  html+='<button onclick="confirmProducts()">Confirmar selección</button>';
  openModal('Seleccionar Productos',html);
});
function getSelectedQty(id){ const item=selectedProducts.find(p=>p.id===id); return item?item.cantidad:0; }
function confirmProducts(){
  const inputs=document.querySelectorAll('#modalContent input[type=number]');
  selectedProducts=[]; 
  inputs.forEach(inp=>{
    const qty=parseInt(inp.value,10);
    if(qty>0){
      const id=parseInt(inp.id.replace('prod_',''),10);
      const name=inp.parentElement.querySelector('strong').textContent;
      const price=parseFloat(inp.parentElement.textContent.match(/\$(\d+\.?\d*)/)[1]);
      selectedProducts.push({id,nombre:name,cantidad:qty,precio:price});
    }
  });
  closeModal(); renderSelectedProducts();
}
function renderSelectedProducts(){
  const container=document.getElementById('selectedProductsContainer');
  if(selectedProducts.length===0){ container.innerHTML=''; return; }
  let html='<ul>'; selectedProducts.forEach(p=>{ html+=`<li>${p.nombre} x ${p.cantidad} = $${(p.cantidad*p.precio).toFixed(2)}</li>`; }); html+='</ul>';
  container.innerHTML=html;
}
document.getElementById('addOrderBtn').addEventListener('click',addPedido);
async function addPedido(){
  const cliente=document.getElementById('pedidoCliente').value.trim();
  const localidad_id=document.getElementById('pedidoLocalidad').value||null;
  if(!cliente||selectedProducts.length===0) return alert('Complete cliente y seleccione productos');
  for(let p of selectedProducts){
    const {data}=await supabase.from('promociones').select('stock').eq('id',p.id).single();
    if(data.stock<p.cantidad) return alert(`Stock insuficiente para ${p.nombre}`);
  }
  const total=selectedProducts.reduce((sum,p)=>sum+p.precio*p.cantidad,0);
  const {error}=await supabase.from('pedidos').insert([{cliente,localidad_id,productos:selectedProducts,total}]);
  if(error) return alert(error.message);
  for(let p of selectedProducts){
    const {data}=await supabase.from('promociones').select('stock').eq('id',p.id).single();
    await supabase.from('promociones').update({stock:data.stock - p.cantidad}).eq('id',p.id);
  }
  document.getElementById('pedidoForm').reset(); selectedProducts=[]; renderSelectedProducts(); fetchOrders(); showToast('Pedido agregado');
}
async function fetchOrders(){
  const {data,error}=await supabase.from('pedidos').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('pedidoList'); container.innerHTML='';
  for(let p of data){
    let locName=''; if(p.localidad_id){ const loc=await supabase.from('localidades').select('nombre').eq('id',p.localidad_id).single(); locName=loc.data?loc.data.nombre:''; }
    const div=document.createElement('div'); div.className='item-card';
    let prodHTML='<ul>'; p.productos.forEach(pr=>{ prodHTML+=`<li>${pr.nombre} x ${pr.cantidad} = $${(pr.precio*pr.cantidad).toFixed(2)}</li>`; }); prodHTML+='</ul>';
    div.innerHTML=`<strong>${p.cliente}</strong> - ${locName}<br>${prodHTML}<strong>Total: $${p.total.toFixed(2)}</strong>
      <div>
        <button onclick="editOrder(${p.id})">Editar</button>
        <button class="delete-btn" onclick="deleteOrder(${p.id})">Eliminar</button>
      </div>`;
    container.appendChild(div);
  }
}
async function editOrder(id){
  const {data:error}=await supabase.from('pedidos').select('*').eq('id',id).single();
  if(error) return alert(error.message);
  const p=error?null:data; selectedProducts=[...p.productos];
  document.getElementById('pedidoCliente').value=p.cliente;
  document.getElementById('pedidoLocalidad').value=p.localidad_id||'';
  renderSelectedProducts(); document.getElementById('selectProductsBtn').click();
  const btn=document.getElementById('addOrderBtn'); btn.textContent='Actualizar Pedido';
  btn.onclick=async ()=>{
    const cliente=document.getElementById('pedidoCliente').value.trim();
    const localidad_id=document.getElementById('pedidoLocalidad').value||null;
    if(!cliente||selectedProducts.length===0) return alert('Complete cliente y seleccione productos');
    const {data: oldOrder}=await supabase.from('pedidos').select('*').eq('id',id).single();
    for(let oldP of oldOrder.productos){
      const {data}=await supabase.from('promociones').select('stock').eq('id',oldP.id).single();
      await supabase.from('promociones').update({stock:data.stock + oldP.cantidad}).eq('id',oldP.id);
    }
    for(let p of selectedProducts){
      const {data}=await supabase.from('promociones').select('stock').eq('id',p.id).single();
      if(data.stock<p.cantidad) return alert(`Stock insuficiente para ${p.nombre}`);
    }
    const total=selectedProducts.reduce((sum,p)=>sum+p.precio*p.cantidad,0);
    const {error}=await supabase.from('pedidos').update({cliente,localidad_id,productos:selectedProducts,total}).eq('id',id);
    if(error) return alert(error.message);
    for(let p of selectedProducts){
      const {data}=await supabase.from('promociones').select('stock').eq('id',p.id).single();
      await supabase.from('promociones').update({stock:data.stock - p.cantidad}).eq('id',p.id);
    }
    document.getElementById('pedidoForm').reset(); selectedProducts=[]; renderSelectedProducts(); btn.textContent='Agregar Pedido'; btn.onclick=addPedido; fetchOrders(); showToast('Pedido actualizado');
  };
}
async function deleteOrder(id){
  if(!confirm('Eliminar pedido?')) return;
  const {data: p}=await supabase.from('pedidos').select('*').eq('id',id).single();
  for(let prod of p.productos){
    const {data}=await supabase.from('promociones').select('stock').eq('id',prod.id).single();
    await supabase.from('promociones').update({stock:data.stock + prod.cantidad}).eq('id',prod.id);
  }
  await supabase.from('pedidos').delete().eq('id',id);
  fetchOrders();
}
fetchOrders();
</script>

</body>
</html>


