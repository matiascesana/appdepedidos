<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>App Completa — Pedidos, Promos, Docs</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto&display=swap" rel="stylesheet">

<style>
/* -----------------------
   Estilos (con mejoras de visualización)
   ----------------------- */
:root{
    --accent:#6a1b9a;
    --accent-2:#7b1fa2;
    --danger:#e53935;
    --sidebar-width: 220px; /* Variable para ancho de barra lateral */
}
*{box-sizing:border-box}

/* CAMBIO CLAVE 1: Eliminamos display:flex del body */
body{
    margin:0;
    font-family:Roboto,Arial,Helvetica,sans-serif;
    background:#f9f9f9;
    color:#222;
    min-height:100vh; /* Mantenemos la altura mínima */
}

/* CAMBIO CLAVE 2: Sidebar fija de altura completa */
.sidebar{
    position: fixed;
    top: 0;
    left: 0;
    width: var(--sidebar-width);
    background:var(--accent);
    color:#fff;
    padding:18px;
    display:flex;
    flex-direction:column;
    height: 100vh; /* Altura completa de la ventana */
    z-index: 100; /* Asegura que esté por encima del contenido */
}
.sidebar .logo{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:12px}
.sidebar button{background:transparent;border:0;color:#fff;padding:10px;border-radius:8px;text-align:left;cursor:pointer;margin-bottom:8px;font-weight:700}
.sidebar button.active{background:#fff;color:var(--accent);box-shadow:0 6px 20px rgba(0,0,0,0.08)}

/* CAMBIO CLAVE 3: El contenedor principal solo desplaza el contenido */
.main{
    /* Ya no es flex. Solo necesitamos un padding-left para evitar que el contenido
       quede debajo de la sidebar cuando no tiene position:absolute */
    padding-left: var(--sidebar-width);
}
h1,h2{font-family:'Playfair Display',serif;margin:0 0 12px 0}

/* CAMBIO CLAVE 4: Cada sección es ahora una 'página' a pantalla completa */
.section{
    display:none;
    position: absolute; /* Posicionamiento absoluto para superponer secciones */
    top: 0;
    left: var(--sidebar-width); /* Empieza después de la sidebar */
    width: calc(100% - var(--sidebar-width)); /* Ancho restante de la pantalla */
    height: 100vh; /* Altura completa de la ventana */
    overflow-y: auto; /* Permite el scroll dentro de la sección si el contenido es largo */
    background:#fff;
    padding:20px;
    border-radius:0; /* Quitamos border-radius ya que ocupa toda la pantalla */
    box-shadow:0 6px 20px rgba(0,0,0,0.06);
    margin-bottom:0;
}
.item-card,.doc-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#f4f4f4;margin-bottom:10px}
.item-card img{width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px}
label{display:block;margin:8px 0;font-size:14px}
input[type=text],input[type=number],select{padding:8px;margin-top:4px;border-radius:8px;border:1px solid #ddd;width:100%}
button{cursor:pointer;border:0;border-radius:8px;padding:8px 12px;background:var(--accent);color:#fff;font-weight:700}
button:hover{background:var(--accent-2)}
.delete-btn{background:var(--danger)}
.delete-btn:hover{background:#c62828}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal-content{background:#fff;padding:16px;border-radius:10px;max-width:860px;width:96%;max-height:86vh;overflow:auto;position:relative}
.modal-close{position:absolute;right:12px;top:8px;cursor:pointer;font-weight:700}
.table {width:100%;border-collapse:collapse;margin:8px 0}
.table th,.table td{padding:8px;border:1px solid #e6e6e6}
.small-muted{font-size:13px;color:#666}
.flex{display:flex;gap:10px;align-items:center}
.row{display:flex;gap:12px}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">App Pedidos</div>
  <button class="tab-btn active" data-tab="promos">Promociones</button>
  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
  <button class="tab-btn" data-tab="categorias">Categorías</button>
  <button class="tab-btn" data-tab="localidades">Localidades</button>
  <button class="tab-btn" data-tab="documentos">Documentos</button>
  <div style="margin-top:auto;font-size:12px;opacity:.9">Integrado · PDF catálogo · Stock</div>
</div>

<div class="main">
      <div class="section" id="promos">
    <h1>Promociones</h1>     <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
      <div style="flex:1;min-width:220px">
        <label>Nombre / Descripción
          <input id="promoNombre" type="text" placeholder="Ej: Promo de Tinturas">
        </label>
      </div>
      <div style="width:140px">
        <label>Precio
          <input id="promoPrecio" type="number" step="0.01" placeholder="0.00">
        </label>
      </div>
      <div style="width:140px">
        <label>Stock
          <input id="promoStock" type="number" placeholder="0">
        </label>
      </div>
      <div style="width:220px">
        <label>Categoría
          <select id="promoCategoria"></select>
        </label>
      </div>
     </div>

      <div style="width:220px">
        <label>Imagen (jpg/png)
          <input id="promoImagen" type="file" accept="image/*">
        </label>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:12px">
      <button id="addPromoBtn">Agregar Promoción</button>
      <button id="exportPromoPdfBtn">Exportar Catálogo PDF</button>
      <button id="refreshPromosBtn" style="background:#444">Refrescar</button>
    </div>

    <h3>Lista de Promociones</h3>
    <div id="promoList"></div>
  </div>

    <div class="section" id="pedidos">
    <h1>Pedidos</h1>     <form id="pedidoForm" onsubmit="return false;" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
      <div style="flex:1;min-width:220px">
        <label>Cliente
          <input id="pedidoCliente" type="text" placeholder="Nombre cliente">
        </label>
      </div>
      <div style="width:220px">
        <label>Localidad
          <select id="pedidoLocalidad"></select>
        </label>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button type="button" id="selectProductsBtn">Seleccionar Productos</button>
      </div>

      <div style="width:100%;margin-top:6px">
        <div id="selectedProductsContainer" class="small-muted"></div>
      </div>

      <div style="display:flex;gap:8px">
        <button type="button" id="addOrderBtn">Agregar Pedido</button>
        <button type="button" id="exportPedidosPDFBtn">Exportar Pedidos (PDF)</button>
      </div>
    </form>

    <h3>Lista de Pedidos</h3>
    <div id="pedidoList"></div>
  </div>

    <div class="section" id="categorias">
    <h2>Categorías</h2>
    <form id="categoriaForm" onsubmit="return false;" style="display:flex;gap:8px;margin-bottom:12px">
      <input id="categoriaNombre" placeholder="Nombre categoría" />
      <button id="addCategoriaBtn">Agregar Categoría</button>
    </form>
    <div id="categoriaList"></div>
  </div>

    <div class="section" id="localidades">
    <h2>Localidades</h2>
    <form id="localidadForm" onsubmit="return false;" style="display:flex;gap:8px;margin-bottom:12px">
      <input id="localidadNombre" placeholder="Nombre localidad" />
      <button id="addLocalidadBtn">Agregar Localidad</button>
    </form>
    <div id="localidadList"></div>
  </div>

    <div class="section" id="documentos">
    <h2>Documentos</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <input id="searchDoc" placeholder="Buscar por DNI">
      <input id="docFiles" type="file" multiple>
      <button id="uploadDocsBtn">Subir Documentos</button>
      <button id="deleteAllDocsBtn" class="delete-btn">Eliminar Todos</button>
    </div>

    <div id="docProgressContainer" style="width:100%;background:#eee;border-radius:6px;overflow:hidden;margin-bottom:8px;display:none">
      <div id="docProgress" style="width:0;height:8px;background:green"></div>
    </div>

    <h3>Documentos subidos</h3>
    <div id="documentsList"></div>
  </div>

</div>

<div id="modal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">×</span>
    <div id="modalInner"></div>
  </div>
</div>

<script>
/* -----------------------------------------------------
   Lógica de Navegación Exclusiva (Solución a las páginas fijas)
   ----------------------------------------------------- */

// Estado inicial: 'promos'
const initialTab = 'promos';

/**
 * Cambia la vista activa y oculta todas las demás secciones.
 * @param {string} tabId - El ID de la sección a mostrar (e.g., 'promos', 'pedidos').
 */
function changeTab(tabId) {
    // 1. Oculta TODAS las secciones para asegurar exclusividad
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
    });

    // 2. Muestra SOLO la sección seleccionada
    const activeSection = document.getElementById(tabId);
    if (activeSection) {
        activeSection.style.display = 'block';
    }

    // 3. Actualiza el estado 'active' de los botones de la sidebar
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeButton = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }

    // 4. Actualiza el título principal
    const titleMap = {
        'promos': 'Gestión de Promociones',
        'pedidos': 'Gestión de Pedidos',
        'categorias': 'Administración de Categorías',
        'localidades': 'Administración de Localidades',
        'documentos': 'Gestión de Documentos'
    };
    const mainTitle = document.querySelector('.main h1');
    if (mainTitle) {
        mainTitle.textContent = titleMap[tabId] || 'Panel de Administración';
    }
    
    // Lógica específica al cambiar a PEDIDOS
    if (tabId === 'pedidos') {
        fetchOrders(); // Asegura que los pedidos se carguen
        // Asegurar modo 'Agregar' al cambiar de tab
        document.getElementById('addOrderBtn').textContent = 'Agregar Pedido';
        document.getElementById('addOrderBtn').onclick = null; // Limpieza esencial
        editingOrderId = null;
        originalProducts = [];
        selectedProducts = [];
        document.getElementById('pedidoForm').reset();
        renderSelectedProducts();
    }
}

// 5. Asigna el evento click a todos los botones de la sidebar
document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        changeTab(tabId);
    });
});

// 6. Funciones de control del Modal (necesarias)
function openModal(title, html) {
    document.getElementById('modalInner').innerHTML = `<h3>${title}</h3>${html}`;
    document.getElementById('modal').style.display = 'flex';
}
function closeModal() {
    document.getElementById('modal').style.display = 'none';
}
// Cierra el modal al hacer click fuera
document.getElementById('modal').addEventListener('click', (e) => {
    if (e.target.id === 'modal') {
        closeModal();
    }
});

// 7. Establece la vista inicial al cargar la página
document.addEventListener('DOMContentLoaded', () => {
    changeTab(initialTab);
    fetchCategorias();
    fetchLocalidades();
    fetchPromotions();
});

/* ============================
   CONFIG: Supabase (usar tus credenciales)
   ============================ */
// Usa tus credenciales reales aquí
const SUPABASE_URL = 'https://ejbqlejlgprvwzrptojo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================
   HELPERS UI
   ============================ */
function showToast(msg, ms=3000){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style,{
        position:'fixed',right:'20px',bottom:'20px',background: 'var(--accent)', color:'#fff', padding:'10px 14px',
        borderRadius:'8px', boxShadow:'0 6px 18px rgba(0,0,0,0.12)', zIndex:9999
    });
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), ms);
}
function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

// ===================================
// UTILERÍAS GENERALES
// ===================================

async function safeGetFileUrl(fileName, bucket='promo_images'){
    if(!fileName) return null;
    try{
        const { data, error } = await supabase.storage.from(bucket).createSignedUrl(fileName, 60*60);
        return error ? null : data.signedUrl;
    }catch{return null;}
}

function groupPromosByCategory(promotions) {
    return promotions.reduce((groups, promo) => {
        // Usa el nombre de la categoría del JOIN (fetch) o el nombre guardado (data-promo/JSON)
        const categoryName = (promo.categorias && promo.categorias.nombre) || promo.categoria || 'Sin Categoría';
        if (!groups[categoryName]) {
            groups[categoryName] = [];
        }
        groups[categoryName].push(promo);
        return groups;
    }, {});
}

function simulateProgress(duration = 2000) {
    const fill = document.getElementById('progressFill');
    fill.style.width = '0%';
    
    const interval = setInterval(() => {
        let currentWidth = parseInt(fill.style.width, 10);
        if (currentWidth < 90) { 
            fill.style.width = (currentWidth + 10) + '%';
        }
    }, duration / 9); 
    
    return new Promise(resolve => setTimeout(() => {
        clearInterval(interval);
        fill.style.width = '100%';
        resolve();
    }, duration));
}

/* ============================
   CATEGORÍAS (CRUD Existente)
   ============================ */
async function fetchCategorias(){
    const { data, error } = await supabase.from('categorias').select('*').order('id');
    if(error) return console.error(error);
    const container = document.getElementById('categoriaList');
    container.innerHTML = '';
    const select = document.getElementById('promoCategoria');
    select.innerHTML = '<option value="">Sin categoría</option>';
    data.forEach(c => {
        const div = document.createElement('div');
        div.className = 'item-card';
        div.innerHTML = `<span>${escapeHtml(c.nombre)}</span>
            <div><button onclick="editCategoria(${c.id},'${escapeHtml(c.nombre)}')">Editar</button>
            <button class="delete-btn" onclick="deleteCategoria(${c.id})">Eliminar</button></div>`;
        container.appendChild(div);
        select.innerHTML += `<option value="${c.id}">${escapeHtml(c.nombre)}</option>`;
    });
}
window.addCategoria = async function(){
    const nombre = document.getElementById('categoriaNombre').value.trim();
    if(!nombre) return alert('Ingrese nombre');
    const { error } = await supabase.from('categorias').insert([{ nombre }]);
    if(error) return alert(error.message);
    document.getElementById('categoriaNombre').value = '';
    fetchCategorias();
};
window.editCategoria = function(id,nombre){
    openModal('Editar Categoría', `<input id="editCatName" value="${escapeHtml(nombre)}"><div style="margin-top:10px"><button onclick="updateCategoria(${id})">Guardar</button></div>`);
};
window.updateCategoria = async function(id){
    const nombre = document.getElementById('editCatName').value.trim();
    if(!nombre) return alert('Ingrese nombre');
    const { error } = await supabase.from('categorias').update({ nombre }).eq('id', id);
    if(error) return alert(error.message);
    closeModal(); fetchCategorias();
};
window.deleteCategoria = async function(id){
    if(!confirm('Eliminar categoría?')) return;
    await supabase.from('categorias').delete().eq('id', id);
    fetchCategorias();
};

/* ============================
   LOCALIDADES (CRUD Existente)
   ============================ */
async function fetchLocalidades(){
    const { data, error } = await supabase.from('localidades').select('*').order('id');
    if(error) return console.error(error);
    const container = document.getElementById('localidadList');
    const sel = document.getElementById('pedidoLocalidad');
    container.innerHTML = ''; sel.innerHTML = '<option value="">Seleccione</option>';
    data.forEach(l=>{
        container.innerHTML += `<div class="item-card"><span>${escapeHtml(l.nombre)}</span><div><button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')">Editar</button><button class="delete-btn" onclick="deleteLocalidad(${l.id})">Eliminar</button></div></div>`;
        sel.innerHTML += `<option value="${l.id}">${escapeHtml(l.nombre)}</option>`;
    });
}
window.addLocalidad = async function(){
    const nombre = document.getElementById('localidadNombre').value.trim();
    if(!nombre) return alert('Ingrese nombre');
    const { error } = await supabase.from('localidades').insert([{ nombre }]);
    if(error) return alert(error.message);
    document.getElementById('localidadNombre').value='';
    fetchLocalidades();
};
window.editLocalidad = function(id,nombre){
    openModal('Editar Localidad', `<input id="editLocName" value="${escapeHtml(nombre)}"><div style="margin-top:10px"><button onclick="updateLocalidad(${id})">Guardar</button></div>`);
};
window.updateLocalidad = async function(id){
    const nombre = document.getElementById('editLocName').value.trim();
    if(!nombre) return alert('Ingrese nombre');
    const { error } = await supabase.from('localidades').update({ nombre }).eq('id', id);
    if(error) return alert(error.message);
    closeModal(); fetchLocalidades();
};
window.deleteLocalidad = async function(id){
    if(!confirm('Eliminar localidad?')) return;
    await supabase.from('localidades').delete().eq('id', id);
    fetchLocalidades();
};

/* =========================================================
   PROMOCIONES (FETCH, RENDER, CRUD y Exportación)
   ========================================================= */

async function fetchPromotions(){
    console.log('👉 fetchPromotions ejecutado');
    // Consulta CLAVE: Usa 'categorias(nombre)' para el JOIN
    const { data, error } = await supabase.from('promociones').select('*, categorias(nombre)').order('id');
    if(error) return console.error(error);
    const container = document.getElementById('promoList');
    container.innerHTML = ''; 

    // Agrupar y obtener nombres de categorías
    const groupedPromos = groupPromosByCategory(data);
    const categoryNames = Object.keys(groupedPromos).sort(); 

    for(const categoryName of categoryNames){
        const promos = groupedPromos[categoryName];

        const titleDiv = document.createElement('div');
        titleDiv.innerHTML = `<h3 style="margin-top: 20px; margin-bottom: 8px;">${escapeHtml(categoryName)}</h3>`;
        container.appendChild(titleDiv);

        for(const promo of promos){
            const imgUrl = promo.imagen ? await safeGetFileUrl(promo.imagen) : (promo.imagen_url || '');
            const imgHTML = imgUrl ? `<img src="${imgUrl}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px">` : '';
            const div = document.createElement('div');
            div.className = 'item-card';
            
            // Lógica de Precios
            let precioHTML = `<strong>$${Number(promo.precio).toFixed(2)}</strong>`;
            if (promo.precio_anterior && Number(promo.precio_anterior) > Number(promo.precio)) {
                precioHTML = `<span style="text-decoration: line-through; color: #999; margin-right: 8px;">$${Number(promo.precio_anterior).toFixed(2)}</span>
                              <strong style="color: var(--danger); font-size: 1.1em;">$${Number(promo.precio).toFixed(2)}</strong>`;
            } 

            div.innerHTML = `
                <input type="checkbox" class="promo-export-check" data-promo='${JSON.stringify({
                    id: promo.id, 
                    nombre: promo.nombre, 
                    precio: promo.precio, 
                    precio_anterior: promo.precio_anterior,
                    stock: promo.stock, 
                    imgUrl: imgUrl, 
                    categoria: categoryName // Incluye el nombre de la categoría para la exportación
                })}' checked style="margin-right: 12px; transform: scale(1.4);">
                ${imgHTML}
                <div style="flex:1">
                    <strong>${escapeHtml(promo.nombre || promo.descripcion || '')}</strong>
                    <div class="small-muted">${precioHTML} &nbsp; · &nbsp; Stock: ${promo.stock ?? 0}</div>
                </div>
                <div>
                    <button onclick="editPromo(${promo.id})">Editar</button>
                    <button class="delete-btn" onclick="deletePromo(${promo.id}, '${promo.imagen || ''}')">Eliminar</button>
                </div>
            `;
            container.appendChild(div);
        }
    }
}

document.getElementById('addPromoBtn').addEventListener('click', async ()=>{
    const nombre = document.getElementById('promoNombre').value.trim();
    const precio = parseFloat(document.getElementById('promoPrecio').value);
    const precio_anterior_val = document.getElementById('promoPrecioAnterior').value;
    const precio_anterior = precio_anterior_val ? parseFloat(precio_anterior_val) : null; 
    const stock = parseInt(document.getElementById('promoStock').value,10) || 0;
    const categoria_id = document.getElementById('promoCategoria').value || null;
    const file = document.getElementById('promoImagen').files[0];
    if(!nombre || isNaN(precio)) return alert('Complete nombre y precio');

    let fileName = null;
    let publicUrl = null;

    if (file) {
        fileName = `promo_${Date.now()}_${file.name.replaceAll(' ','_')}`;
        const { error: upErr } = await supabase.storage.from('promo_images').upload(fileName, file, { upsert:true });
        if(upErr) return alert(`Error al subir imagen: ${upErr.message}`);
        publicUrl = await safeGetFileUrl(fileName);
    }
    
    const { error } = await supabase.from('promociones').insert([{ nombre, precio, precio_anterior, stock, categoria_id, imagen: fileName, imagen_url: publicUrl }]);
    if(error) return alert(`Error al guardar: ${error.message}`);
    
    document.getElementById('promoNombre').value=''; 
    document.getElementById('promoPrecio').value=''; 
    document.getElementById('promoPrecioAnterior').value='';
    document.getElementById('promoStock').value=''; 
    document.getElementById('promoImagen').value='';
    fetchPromotions(); showToast('Promoción agregada');
});

// Implementación de la Exportación a PDF (HTML2PDF.js)
async function generatePdfFromGroupedPromos(groupedPromos) {
    let contentHtml = `<div style="padding: 20px; font-family: Roboto, sans-serif;">
        <h1 style="text-align: center; color: var(--accent);">Catálogo de Promociones</h1>`;

    for (const group of groupedPromos) {
        contentHtml += `<h2 style="margin-top: 30px; border-bottom: 2px solid #ddd; padding-bottom: 5px;">${group.categoria}</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 20px;">`;

        for (const promo of group.promociones) {
            let priceText = `<strong>$${Number(promo.precio).toFixed(2)}</strong>`;
            if (promo.precio_anterior && Number(promo.precio_anterior) > Number(promo.precio)) {
                priceText = `<span style="text-decoration: line-through; color: #999;">$${Number(promo.precio_anterior).toFixed(2)}</span>
                             <strong style="color: var(--danger); font-size: 1.1em; margin-left: 10px;">$${Number(promo.precio).toFixed(2)}</strong>`;
            }

            contentHtml += `<div style="width: calc(50% - 10px); border: 1px solid #eee; padding: 10px; border-radius: 8px; display: flex; align-items: center;">
                ${promo.imgUrl ? `<img src="${promo.imgUrl}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px;">` : ''}
                <div>
                    <h4 style="margin: 0; font-size: 1.1em;">${escapeHtml(promo.nombre)}</h4>
                    <p style="margin: 5px 0 0; font-size: 0.9em;">
                        ${priceText}
                        <span style="margin-left: 15px; color: #666;">Stock: ${promo.stock ?? 0}</span>
                    </p>
                </div>
            </div>`;
        }
        contentHtml += `</div>`;
    }
    contentHtml += `</div>`;

    // Generación del PDF
    const opt = {
        margin: 10,
        filename: 'catalogo_promociones.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    // Crear un elemento temporal para la conversión
    const content = document.createElement('div');
    content.innerHTML = contentHtml;

    return html2pdf().from(content).set(opt).save();
}

document.getElementById('exportPromoPdfBtn').addEventListener('click', async () => {
    const selectedChecks = document.querySelectorAll('#promoList .promo-export-check:checked');
    const container = document.getElementById('pdfProgressBarContainer');
    
    if (selectedChecks.length === 0) {
        alert('Seleccione al menos una promoción para exportar.');
        return;
    }
    
    // MOSTRAR BARRA DE PROGRESO
    if (container) container.style.display = 'block';

    // 1. Extraer y Agrupar los datos
    const promocionesSeleccionadas = Array.from(selectedChecks).map(checkbox => {
        return JSON.parse(checkbox.dataset.promo);
    });

    const promocionesAgrupadasMap = groupPromosByCategory(promocionesSeleccionadas);
    const listaFinalParaPDF = Object.keys(promocionesAgrupadasMap).sort().map(categoria => ({
        categoria: categoria,
        promociones: promocionesAgrupadasMap[categoria]
    }));

    try {
        const progressPromise = simulateProgress(3000); 
        
        await generatePdfFromGroupedPromos(listaFinalParaPDF);

        await progressPromise; // Asegura que la barra de progreso llegue al 100%
        
        showToast('Catálogo PDF generado exitosamente.');
        
    } catch (error) {
        console.error("Error al generar el PDF:", error);
        alert("Ocurrió un error al generar el PDF. Revise la consola.");
    } finally {
        // OCULTAR BARRA DE PROGRESO
        if (container) {
            container.style.display = 'none';
            document.getElementById('progressFill').style.width = '0%';
        }
    }
});

document.getElementById('refreshPromosBtn').addEventListener('click', fetchPromotions);


/* =========================================================
   PEDIDOS (Lógica de Stock y Edición Corregida)
   ========================================================= */
let selectedProducts = []; // {id,nombre,cantidad,precio}
let editingOrderId = null;
let originalProducts = []; // Almacena stock original del pedido en edición

async function getPromoById(id){
    const { data, error } = await supabase.from('promociones').select('*').eq('id', id).single();
    if(error) throw new Error(error.message);
    return data;
}

// --- LÓGICA DE SELECCIÓN DE PRODUCTOS (Modal) ---
// (Tu lógica de selectProductsBtn, getSelectedQty, updateSubtotal, calculateTotal, confirmProducts, renderSelectedProducts es correcta y se mantiene)

function getSelectedQty(id){ const it = selectedProducts.find(x => x.id === id); return it ? it.cantidad : 0; }
function renderSelectedProducts(){
    const c = document.getElementById('selectedProductsContainer');
    if(!selectedProducts.length){ c.innerHTML = '<span class="small-muted">No hay productos seleccionados</span>'; return; }
    let html = `<table class="table"><thead><tr><th>Producto</th><th>Cantidad</th><th>Subtotal</th></tr></thead><tbody>`;
    selectedProducts.forEach(p=>{
        html += `<tr><td>${escapeHtml(p.nombre)}</td><td>${p.cantidad}</td><td>$${(p.precio*p.cantidad).toFixed(2)}</td></tr>`;
    });
    const total = selectedProducts.reduce((s,p)=>s + p.precio * p.cantidad, 0);
    html += `<tr><td colspan="2" style="text-align:right"><strong>Total:</strong></td><td>$${total.toFixed(2)}</td></tr></tbody></table>`;
    c.innerHTML = html;
}
function calculateTotal(){
    let total = 0;
    const inputs = document.querySelectorAll('#modalInner input[type=number]');
    inputs.forEach(inp=>{
        const qty = parseInt(inp.value,10) || 0;
        const price = parseFloat(inp.getAttribute('data-price')) || 0;
        total += qty * price;
    });
    return total;
}
window.updateSubtotal = function(id, price){
    const input = document.getElementById(`prod_${id}`);
    if(!input) return;
    let qty = parseInt(input.value,10) || 0;
    if(qty < 0) qty = 0;
    if(input.max){ const mx = parseInt(input.max,10); if(qty > mx) qty = mx; }
    input.value = qty;
    const sub = document.getElementById(`sub_${id}`);
    if(sub) sub.textContent = `$${(qty*price).toFixed(2)}`;
    const tot = document.getElementById('totalPedido');
    if(tot) tot.textContent = `$${calculateTotal().toFixed(2)}`;
}
window.confirmProducts = function(){
    selectedProducts = [];
    const inputs = document.querySelectorAll('#modalInner input[type=number]');
    inputs.forEach(inp=>{
        const qty = parseInt(inp.value,10) || 0;
        if(qty > 0){
            const id = parseInt(inp.id.replace('prod_',''),10);
            const row = inp.closest('tr');
            const nombre = row.cells[0].textContent;
            const precio = parseFloat(inp.getAttribute('data-price')) || 0;
            selectedProducts.push({ id, nombre, cantidad: qty, precio });
        }
    });
    closeModal(); renderSelectedProducts();
}


// --- AGREGAR PEDIDO (Handler original) ---
document.getElementById('addOrderBtn').addEventListener('click', async function addOrderHandler(){
    // Si el botón tiene un 'onclick' es porque está en modo 'Editar', no hacemos nada.
    if(this.onclick) return; 
    
    const cliente = document.getElementById('pedidoCliente').value.trim();
    const localidad_id = document.getElementById('pedidoLocalidad').value || null;
    if(!cliente || selectedProducts.length === 0) return alert('Complete cliente y seleccione productos');

    // 1. Chequear stock
    for(const p of selectedProducts){
        const promo = await getPromoById(p.id);
        if(p.cantidad > (promo.stock || 0)) return alert(`Stock insuficiente para ${p.nombre} (disponible: ${promo.stock})`);
    }

    // 2. Restar stock
    for(const p of selectedProducts){
        const promo = await getPromoById(p.id);
        const newStock = (promo.stock || 0) - p.cantidad;
        await supabase.from('promociones').update({ stock: newStock }).eq('id', p.id);
    }

    // 3. Insertar pedido
    const productosPayload = selectedProducts.map(p => ({ id: p.id, nombre: p.nombre, cantidad: p.cantidad, precio: p.precio }));
    const total = productosPayload.reduce((s,x)=>s + x.precio * x.cantidad, 0);
    const { error } = await supabase.from('pedidos').insert([{ cliente, localidad_id, productos: productosPayload, total }]);
    if(error) return alert(`Error al guardar pedido: ${error.message}`);

    // 4. Limpiar
    document.getElementById('pedidoForm').reset();
    selectedProducts = []; renderSelectedProducts();
    fetchOrders(); fetchPromotions(); showToast('Pedido agregado');
});

// --- EDICIÓN DE PEDIDO (Abre formulario) ---
window.openEditOrder = async function(id){
    const { data, error } = await supabase.from('pedidos').select('*').eq('id', id).single();
    if(error) return alert(`Error al cargar pedido: ${error.message}`);
    const order = data;

    // 1. Guardamos el stock anterior del pedido que se va a modificar (originalProducts)
    originalProducts = order.productos.map(pr => ({ id: pr.id, cantidad: pr.cantidad })); 

    // 2. Cargar pedido en formulario
    selectedProducts = order.productos.map(pr => ({ id: pr.id, nombre: pr.nombre, cantidad: pr.cantidad, precio: pr.precio }));
    document.getElementById('pedidoCliente').value = order.cliente;
    document.getElementById('pedidoLocalidad').value = order.localidad_id || '';
    renderSelectedProducts();
    editingOrderId = id;

    // 3. Cambiar botón a modo Actualizar
    showToast('Editando pedido: ajusta productos y presiona "Actualizar Pedido".');
    
    const addBtn = document.getElementById('addOrderBtn');
    addBtn.textContent = 'Actualizar Pedido';
    
    // ** SOLUCIÓN AL DOBLE DESCUENTO: Usar onclick TEMPORALMENTE **
    addBtn.onclick = async function(){ 
        await updateOrder(editingOrderId); 
        
        // Al terminar, restauramos el botón al modo "Agregar"
        addBtn.textContent = 'Agregar Pedido';
        addBtn.onclick = null; // <-- Limpiando 'onclick' permite que el 'addEventListener' original se reactive.
    };
}

// --- ACTUALIZAR PEDIDO (Guarda cambios) ---
async function updateOrder(id){
    if(!id) return alert('No hay pedido seleccionado para actualizar');
    const cliente = document.getElementById('pedidoCliente').value.trim();
    const localidad_id = document.getElementById('pedidoLocalidad').value || null;
    if(!cliente || !selectedProducts.length) return alert('Ingrese cliente y seleccione productos');

    // 1. DEVOLVER STOCK ANTERIOR (Restaurar el stock del pedido viejo)
    for(const pr of originalProducts){
        const promo = await getPromoById(pr.id);
        const newStock = (promo.stock || 0) + pr.cantidad;
        await supabase.from('promociones').update({ stock: newStock }).eq('id', pr.id);
    }
    originalProducts = []; // Limpiar variable

    // 2. Verificar stock para la nueva selección
    for(const p of selectedProducts){
        const promo = await getPromoById(p.id);
        if(p.cantidad > (promo.stock || 0)) return alert(`Stock insuficiente para ${p.nombre}`);
    }
    
    // 3. Restar stock para la nueva selección
    for(const p of selectedProducts){
        const promo = await getPromoById(p.id);
        const newStock = (promo.stock || 0) - p.cantidad;
        await supabase.from('promociones').update({ stock: newStock }).eq('id', p.id);
    }

    // 4. Update pedido record
    const payload = selectedProducts.map(p=>({ id: p.id, nombre: p.nombre, cantidad: p.cantidad, precio: p.precio }));
    const total = payload.reduce((s,x)=>s + x.precio * x.cantidad, 0);
    const { error } = await supabase.from('pedidos').update({ cliente, localidad_id, productos: payload, total }).eq('id', id);
    if(error) return alert(`Error al actualizar pedido: ${error.message}`);

    // 5. Reset
    editingOrderId = null;
    selectedProducts = []; renderSelectedProducts();
    document.getElementById('pedidoCliente').value = '';
    document.getElementById('pedidoLocalidad').value = '';
    fetchOrders(); fetchPromotions(); showToast('Pedido actualizado');
}

// --- ELIMINAR PEDIDO (Devuelve Stock) ---
window.deleteOrder = async function(id){
    if(!confirm('Eliminar pedido? Esta acción es irreversible y restaurará el stock.')) return;
    const { data, error } = await supabase.from('pedidos').select('*').eq('id', id).single();
    if(error) return alert(`Error al cargar pedido para eliminar: ${error.message}`);
    
    // Devolver stock
    if(data.productos && data.productos.length){
        for(const pr of data.productos){
            try {
                const promo = await getPromoById(pr.id);
                const newStock = (promo.stock || 0) + pr.cantidad;
                await supabase.from('promociones').update({ stock: newStock }).eq('id', pr.id);
            } catch (e) {
                console.warn(`No se pudo restaurar stock para promo ID ${pr.id}. Error: ${e.message}`);
            }
        }
    }
    
    // Eliminar pedido
    await supabase.from('pedidos').delete().eq('id', id);
    fetchOrders(); fetchPromotions(); showToast('Pedido eliminado y stock restaurado');
}

// --- FETCH and render orders ---
async function fetchOrders(){
    const { data, error } = await supabase.from('pedidos').select('*').order('id', { ascending: false });
    if(error) return console.error(error);
    const container = document.getElementById('pedidoList'); container.innerHTML = '';
    
    for(const p of data){
        const div = document.createElement('div'); div.className = 'item-card';
        let prodHTML = '<ul style="margin:6px 0;padding-left:18px;font-size:14px">';
        p.productos.forEach(pr => prodHTML += `<li>${escapeHtml(pr.nombre)} x ${pr.cantidad} = $${(pr.precio*pr.cantidad).toFixed(2)}</li>`);
        prodHTML += '</ul>';
        
        div.innerHTML = `<div style="flex:1">
                <strong>${escapeHtml(p.cliente)}</strong>
                <div class="small-muted">${p.localidad_id ? ('Localidad ID:' + p.localidad_id) : ''}</div>
                ${prodHTML}
                <strong>Total: $${Number(p.total).toFixed(2)}</strong>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px">
                <button onclick="openEditOrder(${p.id})">Editar</button>
                <button class="delete-btn" onclick="deleteOrder(${p.id})">Eliminar</button>
            </div>`;
        container.appendChild(div);
    }
}
document.getElementById('exportPedidosPDFBtn').addEventListener('click', () => {
    // Implementar exportación a PDF de Pedidos si es necesario
    alert('Funcionalidad de Exportar Pedidos (PDF) no implementada.');
});

// Enlazar el botón de Refrescar Pedidos (Añadido en el HTML de la respuesta anterior)
document.getElementById('refreshOrdersBtn').addEventListener('click', fetchOrders);
</script>

</body>
</html>

