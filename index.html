<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Negocio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <div id="loading-overlay" class="fixed inset-0 flex flex-col items-center justify-center loading-overlay z-50">
        <div id="spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        <p id="status-message" class="mt-4 text-gray-700 font-medium">Iniciando...</p>
    </div>

    <div id="app-container" class="flex flex-col flex-grow">
        <header class="bg-white shadow-md p-4 flex items-center justify-between z-10">
            <h1 class="text-2xl font-bold text-blue-600">Gestor de Negocio</h1>
            <div id="auth-status" class="text-sm text-gray-500 flex items-center space-x-2">
                <span id="user-name" class="font-medium">Usuario de Demo</span>
            </div>
            <nav id="nav-tabs" class="flex space-x-2">
                <button onclick="navigate('promotions')" id="tab-promotions" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-blue-500 text-white">Promociones</button>
                <button onclick="navigate('orders')" id="tab-orders" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200">Pedidos</button>
                <button onclick="navigate('locations')" id="tab-locations" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200">Localidades</button>
                <button onclick="navigate('categories')" id="tab-categories" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200">Categorías</button>
            </nav>
        </header>

        <main id="main-content" class="p-4 flex-grow overflow-y-auto">
            </main>
    </div>

    <div id="modal-container" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div id="modal-content" class="bg-white rounded-lg shadow-lg p-6 w-11/12 md:w-1/3">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDBRT5IUIoB2H8UwN7tkmqSkzq9Lch7yeg",
            authDomain: "url-de-pedidos.firebaseapp.com",
            projectId: "url-de-pedidos",
            storageBucket: "url-de-pedidos.firebasestorage.app",
            messagingSenderId: "180972439681",
            appId: "1:180972439681:web:f9000673e003840f572580"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global app state
        let appState = {
            userId: 'demo-user-1234', // Fixed user ID
            userName: 'Usuario de Demo',
            currentView: 'promotions',
            promotions: {},
            categories: {},
            locations: {},
            orders: {},
            selectedOrder: null,
            orderProducts: {}
        };

        const viewTemplates = {
            promotions: `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Catálogo de Promociones</h2>
                    <button onclick="showPromoModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                        <i class="fas fa-plus mr-2"></i>Nueva Promoción
                    </button>
                </div>
                <div id="promotions-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            `,
            orders: `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Pedidos</h2>
                    <button onclick="showOrderModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                        <i class="fas fa-plus mr-2"></i>Nuevo Pedido
                    </button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex justify-around flex-wrap text-center">
                    <div>
                        <p class="text-sm text-gray-500">Total General</p>
                        <p id="total-general" class="text-xl font-bold text-blue-600">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Entregados</p>
                        <p id="total-delivered" class="text-xl font-bold text-green-600">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Pendientes</p>
                        <p id="total-pending" class="text-xl font-bold text-red-600">$0.00</p>
                    </div>
                </div>
                <div id="orders-list" class="space-y-4"></div>
            `,
            locations: `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Gestión de Localidades</h2>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex mb-4">
                        <input type="text" id="new-location-input" placeholder="Nombre de la nueva localidad" class="flex-grow p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="addLocation()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">Agregar</button>
                    </div>
                    <ul id="locations-list" class="space-y-2"></ul>
                </div>
            `,
            categories: `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Gestión de Categorías</h2>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex mb-4">
                        <input type="text" id="new-category-input" placeholder="Nombre de la nueva categoría" class="flex-grow p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="addCategory()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">Agregar</button>
                    </div>
                    <ul id="categories-list" class="space-y-2"></ul>
                </div>
            `
        };

        // --- Utility Functions ---
        window.showLoading = function(show, message = 'Cargando...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            const appContainer = document.getElementById('app-container');
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('spinner');

            loadingOverlay.classList.toggle('hidden', !show);
            statusMessage.innerText = message;
            spinner.classList.toggle('hidden', !show);
            statusMessage.classList.remove('text-red-600');
            statusMessage.classList.add('text-gray-700');
        }

        window.showStatusMessage = function(message, isError = false) {
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('spinner');
            statusMessage.innerText = message;
            spinner.classList.add('hidden');
            if (isError) {
                statusMessage.classList.remove('text-gray-700');
                statusMessage.classList.add('text-red-600');
            } else {
                statusMessage.classList.remove('text-red-600');
                statusMessage.classList.add('text-gray-700');
            }
        }

        window.showModal = function(contentHtml) {
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = contentHtml;
            modalContainer.classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('modal-container').classList.add('hidden');
        }

        // --- Navigation ---
        window.navigate = function(view) {
            appState.currentView = view;
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = viewTemplates[view];
            
            // Highlight active tab
            document.querySelectorAll('#nav-tabs button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-200');
            });
            document.getElementById(`tab-${view}`).classList.remove('text-gray-700', 'hover:bg-gray-200');
            document.getElementById(`tab-${view}`).classList.add('bg-blue-500', 'text-white');

            renderView();
        }

        function renderView() {
            switch(appState.currentView) {
                case 'promotions':
                    renderPromotions();
                    break;
                case 'orders':
                    renderOrders();
                    break;
                case 'locations':
                    renderLocations();
                    break;
                case 'categories':
                    renderCategories();
                    break;
            }
        }

        // --- Data Fetching and Real-time Listeners ---
        function listenForData() {
            // Promotions Listener
            onSnapshot(collection(db, `artifacts/${app.options.appId}/users/${appState.userId}/promotions`), (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const promoData = change.doc.data();
                    const promoId = change.doc.id;
                    if (change.type === "added" || change.type === "modified") {
                        appState.promotions[promoId] = { ...promoData, id: promoId };
                    } else if (change.type === "removed") {
                        delete appState.promotions[promoId];
                    }
                });
                renderView();
            });

            // Categories Listener
            onSnapshot(collection(db, `artifacts/${app.options.appId}/users/${appState.userId}/categories`), (snapshot) => {
                appState.categories = {};
                snapshot.forEach(doc => {
                    appState.categories[doc.id] = doc.data().name;
                });
                renderView();
            });

            // Locations Listener
            onSnapshot(collection(db, `artifacts/${app.options.appId}/users/${appState.userId}/localidades`), (snapshot) => {
                appState.locations = {};
                snapshot.forEach(doc => {
                    appState.locations[doc.id] = doc.data().name;
                });
                renderView();
            });

            // Orders Listener
            onSnapshot(collection(db, `artifacts/${app.options.appId}/users/${appState.userId}/pedidos`), (snapshot) => {
                appState.orders = {};
                snapshot.docChanges().forEach(change => {
                    const orderData = change.doc.data();
                    const orderId = change.doc.id;
                    if (change.type === "added" || change.type === "modified") {
                        appState.orders[orderId] = { ...orderData, id: orderId };
                    } else if (change.type === "removed") {
                        delete appState.orders[orderId];
                    }
                });
                renderView();
            });

            showLoading(false);
        }

        // --- Render Functions ---
        function renderPromotions() {
            const listContainer = document.getElementById('promotions-list');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            const promosByCategory = Object.values(appState.promotions).reduce((acc, promo) => {
                const categoryId = promo.categoryId || 'sin-categoria';
                if (!acc[categoryId]) {
                    acc[categoryId] = { name: appState.categories[categoryId] || 'Sin Categoría', promos: [] };
                }
                acc[categoryId].promos.push(promo);
                return acc;
            }, {});

            for (const categoryId in promosByCategory) {
                const category = promosByCategory[categoryId];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'col-span-full mb-4';
                categoryDiv.innerHTML = `<h3 class="text-lg font-bold text-blue-600">${category.name}</h3>`;
                listContainer.appendChild(categoryDiv);

                category.promos.forEach(promo => {
                    const promoCard = document.createElement('div');
                    promoCard.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col items-center text-center transition-transform transform hover:scale-105';
                    
                    const promoImage = promo.image || 'https://placehold.co/150x150/d1d5db/374151?text=No+Image';
                    promoCard.innerHTML = `
                        <img src="${promoImage}" alt="${promo.name}" class="w-32 h-32 object-cover rounded-lg mb-2">
                        <div class="flex-grow w-full">
                            <h3 class="text-lg font-bold text-gray-800">${promo.name}</h3>
                            <p class="text-sm text-gray-600">${promo.stock} en stock</p>
                            ${promo.originalPrice ? `<p class="text-sm text-red-500 line-through">$${promo.originalPrice.toFixed(2)}</p>` : ''}
                            <p class="text-xl font-bold text-green-600">$${promo.price.toFixed(2)}</p>
                        </div>
                        <div class="mt-4 flex space-x-2 w-full justify-center">
                            <button onclick="showPromoModal('${promo.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition-colors text-sm">Editar</button>
                            <button onclick="deletePromo('${promo.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition-colors text-sm">Eliminar</button>
                        </div>
                    `;
                    listContainer.appendChild(promoCard);
                });
            }
        }

        function renderOrders() {
            const listContainer = document.getElementById('orders-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            let totalGeneral = 0, totalDelivered = 0, totalPending = 0;

            const sortedOrders = Object.values(appState.orders).sort((a, b) => b.id.localeCompare(a.id));

            sortedOrders.forEach(order => {
                totalGeneral += order.total;
                if (order.status === 'Entregado') totalDelivered += order.total;
                else totalPending += order.total;

                const orderCard = document.createElement('div');
                orderCard.className = `bg-white p-4 rounded-lg shadow-md flex justify-between items-center transition-shadow hover:shadow-lg ${order.status === 'Entregado' ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}`;
                
                const locationName = appState.locations[order.locationId] || 'Localidad desconocida';
                const statusColor = order.status === 'Entregado' ? 'text-green-600' : 'text-red-600';
                
                orderCard.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="font-bold text-gray-800">Pedido #${order.id.substring(0, 6)}</h3>
                        <p class="text-sm text-gray-600">Cliente: ${order.clientName}</p>
                        <p class="text-sm text-gray-600">Localidad: ${locationName}</p>
                        <p class="text-sm ${statusColor}">${order.status}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-blue-600">$${order.total.toFixed(2)}</p>
                        <div class="mt-2 flex space-x-2">
                            <button onclick="showOrderModal('${order.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-yellow-600 transition-colors">Ver</button>
                            <button onclick="toggleOrderStatus('${order.id}', '${order.status}')" class="bg-gray-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-gray-600 transition-colors">${order.status === 'Pendiente' ? 'Marcar Entregado' : 'Marcar Pendiente'}</button>
                            <button onclick="deleteOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-red-600 transition-colors">Eliminar</button>
                        </div>
                    </div>
                `;
                listContainer.appendChild(orderCard);
            });

            document.getElementById('total-general').innerText = `$${totalGeneral.toFixed(2)}`;
            document.getElementById('total-delivered').innerText = `$${totalDelivered.toFixed(2)}`;
            document.getElementById('total-pending').innerText = `$${totalPending.toFixed(2)}`;
        }

        function renderLocations() {
            const listContainer = document.getElementById('locations-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            const locationsArray = Object.keys(appState.locations).map(id => ({ id, name: appState.locations[id] }));
            locationsArray.sort((a, b) => a.name.localeCompare(b.name));

            locationsArray.forEach(location => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors';
                li.innerHTML = `
                    <span>${location.name}</span>
                    <button onclick="deleteLocation('${location.id}')" class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                listContainer.appendChild(li);
            });
        }

        function renderCategories() {
            const listContainer = document.getElementById('categories-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            const categoriesArray = Object.keys(appState.categories).map(id => ({ id, name: appState.categories[id] }));
            categoriesArray.sort((a, b) => a.name.localeCompare(b.name));
            
            categoriesArray.forEach(category => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors';
                li.innerHTML = `
                    <span>${category.name}</span>
                    <button onclick="deleteCategory('${category.id}')" class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                listContainer.appendChild(li);
            });
        }

        // --- CRUD Operations ---

        // Promotions
        window.showPromoModal = function(promoId = null) {
            const isEditing = promoId !== null;
            const promo = appState.promotions[promoId] || {};
            const categoryOptions = Object.keys(appState.categories).map(id => `<option value="${id}" ${promo.categoryId === id ? 'selected' : ''}>${appState.categories[id]}</option>`).join('');

            const modalHtml = `
                <h3 class="text-xl font-bold mb-4">${isEditing ? 'Editar Promoción' : 'Nueva Promoción'}</h3>
                <form id="promo-form" class="space-y-4">
                    <div>
                        <label for="promo-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="promo-name" value="${promo.name || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="promo-original-price" class="block text-sm font-medium text-gray-700">Precio Original</label>
                        <input type="number" id="promo-original-price" value="${promo.originalPrice || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="promo-price" class="block text-sm font-medium text-gray-700">Precio Final</label>
                        <input type="number" id="promo-price" value="${promo.price || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="promo-stock" class="block text-sm font-medium text-gray-700">Stock</label>
                        <input type="number" id="promo-stock" value="${promo.stock || 0}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="promo-category" class="block text-sm font-medium text-gray-700">Categoría</label>
                        <select id="promo-category" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Sin Categoría</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    <div>
                        <label for="promo-image" class="block text-sm font-medium text-gray-700">Imagen</label>
                        <input type="file" id="promo-image" accept="image/*" class="mt-1 block w-full text-sm">
                        ${promo.image ? `<img src="${promo.image}" class="mt-2 w-24 h-24 object-cover rounded-lg">` : ''}
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">${isEditing ? 'Guardar Cambios' : 'Crear Promoción'}</button>
                    </div>
                </form>
            `;
            showModal(modalHtml);

            document.getElementById('promo-form').onsubmit = async (e) => {
                e.preventDefault();
                await savePromo(promoId);
            };
        };
        
        window.savePromo = async function(promoId) {
    showLoading(true, 'Guardando promoción...');

    // AÑADE ESTA LÍNEA AQUÍ PARA ASEGURARTE DE QUE LA VARIABLE ESTÉ DEFINIDA
    const imageFile = document.getElementById('promo-image').files[0];

    const name = document.getElementById('promo-name').value.trim();
    const originalPriceInput = document.getElementById('promo-original-price').value;
    const priceInput = document.getElementById('promo-price').value;
    const stockInput = document.getElementById('promo-stock').value;
    const categoryId = document.getElementById('promo-category').value || null;
    let imageUrl = appState.promotions[promoId]?.image || null;

    if (!name || !priceInput || !stockInput) {
        // ... (resto del código de validación)
    }

    // El resto del código que maneja la subida de la imagen y el guardado en Firestore
    try {
        if (imageFile) {
            // ... (código para subir la imagen)
        }
        // ... (código para guardar en Firestore)
    } catch (error) {
        // ... (manejo de errores)
    } finally {
        // ... (ocultar la pantalla de carga)
    }
};
       
        window.deletePromo = async function(promoId) {
            showModal(`
                <h3 class="font-bold text-xl text-red-600 mb-2">Confirmar Eliminación</h3>
                <p class="text-gray-700 mb-4">¿Estás seguro de que quieres eliminar esta promoción?</p>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancelar</button>
                    <button onclick="confirmDeletePromo('${promoId}')" class="bg-red-500 text-white px-4 py-2 rounded-lg">Eliminar</button>
                </div>
            `);
        }
        
        window.confirmDeletePromo = async function(promoId) {
            closeModal();
            showLoading(true, 'Eliminando promoción...');
            try {
                const promoDocRef = doc(db, `artifacts/${app.options.appId}/users/${appState.userId}/promotions`, promoId);
                await deleteDoc(promoDocRef);
                showStatusMessage('Promoción eliminada con éxito.');
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Error deleting promotion:", error);
                showStatusMessage('Error al eliminar promoción. Revisa la consola.', true);
            }
        }

        // Orders
        window.showOrderModal = function(orderId = null) {
            const isEditing = orderId !== null;
            const order = appState.orders[orderId] || { products: [], total: 0 };
            appState.selectedOrder = isEditing ? order : null;
            appState.orderProducts = isEditing ? order.products.reduce((acc, p) => { acc[p.id] = p; return acc; }, {}) : {};

            const locationOptions = Object.keys(appState.locations).map(id => `<option value="${id}" ${order.locationId === id ? 'selected' : ''}>${appState.locations[id]}</option>`).join('');
            
            const promoOptions = Object.values(appState.promotions).map(p => `<option value="${p.id}">${p.name} ($${p.price.toFixed(2)})</option>`).join('');

            let modalHtml = `
                <h3 class="text-xl font-bold mb-4">${isEditing ? 'Detalles del Pedido' : 'Nuevo Pedido'}</h3>
                <form id="order-form" class="space-y-4">
                    <div>
                        <label for="order-client" class="block text-sm font-medium text-gray-700">Cliente</label>
                        <input type="text" id="order-client" value="${order.clientName || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="order-location" class="block text-sm font-medium text-gray-700">Localidad</label>
                        <select id="order-location" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Selecciona una localidad</option>
                            ${locationOptions}
                        </select>
                    </div>

                    <div class="border-t pt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Productos del Pedido</label>
                        <div class="flex space-x-2">
                            <select id="order-promo-select" class="flex-grow p-2 border border-gray-300 rounded-lg">
                                <option value="">Selecciona un producto</option>
                                ${promoOptions}
                            </select>
                            <input type="number" id="order-quantity" value="1" min="1" class="w-20 p-2 border border-gray-300 rounded-lg text-center">
                            <button type="button" onclick="addProductToOrder()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Añadir</button>
                        </div>
                        <ul id="selected-products-list" class="mt-4 space-y-2"></ul>
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <p class="text-lg font-bold">Total: <span id="order-total">$${order.total.toFixed(2)}</span></p>
                    </div>

                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Guardar Pedido</button>
                    </div>
                </form>
            `;
            showModal(modalHtml);

            renderOrderProducts();

            document.getElementById('order-form').onsubmit = async (e) => {
                e.preventDefault();
                await saveOrder(orderId);
            };
        };
        
        function renderOrderProducts() {
            const list = document.getElementById('selected-products-list');
            if (!list) return;
            list.innerHTML = '';
            let currentTotal = 0;

            for (const promoId in appState.orderProducts) {
                const product = appState.orderProducts[promoId];
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-100';
                li.innerHTML = `
                    <span>${product.name} (x${product.quantity})</span>
                    <div class="flex items-center space-x-2">
                        <span>$${(product.price * product.quantity).toFixed(2)}</span>
                        <button type="button" onclick="removeProductFromOrder('${promoId}')" class="text-red-500 hover:text-red-700 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(li);
                currentTotal += product.price * product.quantity;
            }
            document.getElementById('order-total').innerText = `$${currentTotal.toFixed(2)}`;
        }

        window.addProductToOrder = function() {
            const select = document.getElementById('order-promo-select');
            const quantityInput = document.getElementById('order-quantity');
            const promoId = select.value;
            const quantity = parseInt(quantityInput.value, 10);
            
            if (!promoId || isNaN(quantity) || quantity <= 0) {
                showModal(`
                    <h3 class="font-bold text-xl text-red-600 mb-2">Error</h3>
                    <p class="text-gray-700 mb-4">Selecciona un producto y una cantidad válida.</p>
                    <button onclick="closeModal()" class="bg-red-500 text-white px-4 py-2 rounded-lg">Aceptar</button>
                `);
                return;
            }

            const promo = appState.promotions[promoId];
            if (!promo) return;

            if (appState.orderProducts[promoId]) {
                appState.orderProducts[promoId].quantity += quantity;
            } else {
                appState.orderProducts[promoId] = {
                    id: promo.id,
                    name: promo.name,
                    price: promo.price,
                    quantity: quantity
                };
            }

            renderOrderProducts();
            quantityInput.value = 1;
        };

        window.removeProductFromOrder = function(promoId) {
            delete appState.orderProducts[promoId];
            renderOrderProducts();
        };

        async function saveOrder(orderId) {
            showLoading(true, 'Guardando pedido...');
            const clientName = document.getElementById('order-client').value.trim();
            const locationId = document.getElementById('order-location').value;
            const products = Object.values(appState.orderProducts);
            const total = products.reduce((sum, p) => sum + (p.price * p.quantity), 0);
            
            if (!clientName || !locationId || products.length === 0) {
                showModal(`
                    <h3 class="font-bold text-xl text-red-600 mb-2">Error de Validación</h3>
                    <p class="text-gray-700 mb-4">Por favor, rellena el nombre del cliente, la localidad y añade al menos un producto.</p>
                    <button onclick="closeModal()" class="bg-red-500 text-white px-4 py-2 rounded-lg">Aceptar</button>
                `);
                showLoading(false);
                return;
            }

            const orderData = {
                clientName,
                locationId,
                products,
                total,
                status: 'Pendiente',
                timestamp: new Date().toISOString()
            };

            try {
                const ordersCollectionRef = collection(db, `artifacts/${app.options.appId}/users/${appState.userId}/pedidos`);
                if (orderId) {
                    await updateDoc(doc(ordersCollectionRef, orderId), orderData);
                } else {
                    await addDoc(ordersCollectionRef, orderData);
                }
                closeModal();
                showStatusMessage('Pedido guardado con éxito.');
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Error saving order:", error);
                showStatusMessage('Error al guardar el pedido. Revisa la consola.', true);
            }
        }

        window.toggleOrderStatus = async function(orderId, currentStatus) {
            showLoading(true, 'Actualizando estado...');
            try {
                const newStatus = currentStatus === 'Pendiente' ? 'Entregado' : 'Pendiente';
                const orderDocRef = doc(db, `artifacts/${app.options.appId}/users/${appState.userId}/pedidos`, orderId);
                await updateDoc(orderDocRef, { status: newStatus });
                showStatusMessage('Estado del pedido actualizado.');
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Error updating order status:", error);
                showStatusMessage('Error al actualizar el estado. Revisa la consola.', true);
            }
        }

        window.deleteOrder = async function(orderId) {
            showModal(`
                <h3 class="font-bold text-xl text-red-600 mb-2">Confirmar Eliminación</h3>
                <p class="text-gray-700 mb-4">¿Estás seguro de que quieres eliminar este pedido?</p>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancelar</button>
                    <button onclick="confirmDeleteOrder('${orderId}')" class="bg-red-500 text-white px-4 py-2 rounded-lg">Eliminar</button>
                </div>
            `);
        }
        
        window.confirmDeleteOrder = async function(orderId) {
            closeModal();
            showLoading(true, 'Eliminando pedido...');
            try {
                const orderDocRef = doc(db, `artifacts/${app.options.appId}/users/${appState.userId}/pedidos`, orderId);
                await deleteDoc(orderDocRef);
                showStatusMessage('Pedido eliminado con éxito.');
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Error deleting order:", error);
                showStatusMessage('Error al eliminar el pedido. Revisa la consola.', true);
            }
        }
        
        // Locations
        window.addLocation = async function() {
            const newLocationInput = document.getElementById('new-location-input');
            const locationName = newLocationInput.value.trim();
            if (!locationName) return;

            showLoading(true, 'Añadiendo localidad...');
            try {
                const docRef = doc(collection(db, `artifacts/${app.options.appId}/users/${appState.userId}/localidades`));
                await setDoc(docRef, { name: locationName });
                newLocationInput.value = '';
                showStatusMessage('Localidad añadida con éxito.');
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Error adding location:", error);
                showStatusMessage('Error al añadir localidad. Revisa la consola.', true);
            }
        };

        window.deleteLocation = async function(locationId) {
            showLoading(true, 'Eliminando localidad...');
            try {
                const locationDocRef = doc(db, `artifacts/${app.options.appId}/users/${appState.userId}/localidades`, locationId);
                await deleteDoc(locationDocRef);
                showStatusMessage('Localidad eliminada con éxito.');
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Error deleting location:", error);
                showStatusMessage('Error al eliminar localidad. Revisa la consola.', true);
            }
        };
        
        // Categories
        window.addCategory = async function() {
            const newCategoryInput = document.getElementById('new-category-input');
            const categoryName = newCategoryInput.value.trim();
            if (!categoryName) return;

            showLoading(true, 'Añadiendo categoría...');
            try {
                const docRef = doc(collection(db, `artifacts/${app.options.appId}/users/${appState.userId}/categories`));
                await setDoc(docRef, { name: categoryName });
                newCategoryInput.value = '';
                showStatusMessage('Categoría añadida con éxito.');
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Error adding category:", error);
                showStatusMessage('Error al añadir categoría. Revisa la consola.', true);
            }
        };

        window.deleteCategory = async function(categoryId) {
            showLoading(true, 'Eliminando categoría...');
            try {
                const categoryDocRef = doc(db, `artifacts/${app.options.appId}/users/${appState.userId}/categories`, categoryId);
                await deleteDoc(categoryDocRef);
                showStatusMessage('Categoría eliminada con éxito.');
                setTimeout(() => showLoading(false), 2000);
            } catch (error) {
                console.error("Error deleting category:", error);
                showStatusMessage('Error al eliminar categoría. Revisa la consola.', true);
            }
        };
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            listenForData();
            navigate('promotions');
        });
    </script>
</body>
</html>



