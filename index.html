<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel Administrativo Completo</title>
    <style>
        :root {
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --accent: #ff4d4f;
            --card-bg: #fff;
            --text-muted: #555;
        }
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background: #f0f2f5; }
        .sidebar { width: 220px; background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding-top: 20px; flex-shrink: 0; transition: transform 0.3s ease; z-index: 9000; }
        .sidebar h2 { text-align: center; margin-bottom: 20px; font-size: 22px; }
        .sidebar button { background: none; border: none; color: white; text-align: left; padding: 12px 20px; cursor: pointer; font-size: 16px; width: 100%; transition: 0.2s; }
        .sidebar button:hover, .sidebar button.active { background: var(--sidebar-hover); }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .section {
  	display: none !important;}
	.section.active {
  	display: block !important;}
        h1 { margin-top: 0; margin-bottom: 15px; }
        .card { display: flex; align-items: center; gap: 15px; background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #ddd; transition: 0.3s; }
        .card:hover { box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15); }
        .card img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid #ccc; }
        .card-info { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .card-info b { font-size: 1.1em; }
        .card-price { font-size: 1em; color: var(--accent); }
        .card-price del { color: #999; margin-right: 6px; }
        .card-stock { font-size: 0.85em; color: var(--text-muted); }
        .card-actions { display: flex; flex-direction: column; gap: 6px; }
        .card-actions button { cursor: pointer; border: none; border-radius: 6px; padding: 6px 12px; font-weight: bold; transition: 0.2s; }
        .card-actions .edit-btn { background: #3498db; color: #fff; }
        .card-actions .edit-btn:hover { background: #2980b9; }
        .card-actions .delete-btn { background: var(--accent); color: #fff; }
        .card-actions .delete-btn:hover { background: #e8434f; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); justify-content: center; align-items: center; z-index: 9999; }
        #modalInner { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 1100px; max-height: 90%; overflow-y: auto; }
        input, select, button { margin-bottom: 8px; padding: 6px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; }
        button[type=submit] { background: var(--accent); color: #fff; border: none; cursor: pointer; }
        button[type=submit]:hover { background: #e8434f; }
        #menuBtn { position: absolute; left: 12px; top: 12px; background: #3498db; color: white; font-size: 22px; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; z-index: 2000; display: none; }
        .backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 8000; pointer-events: none; }
        .backdrop.show { display: block; pointer-events: auto; }
        .table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .table th, .table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: bold; }
        #appToast { position: fixed; right: 16px; bottom: 20px; background: #222; color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18); z-index: 15000; opacity: 0; transition: opacity 0.25s; }
        @media (max-width: 768px) {
            #menuBtn { display: block; }
            .card { flex-direction: column; align-items: flex-start; gap: 10px; }
            .card-info { width: 100%; flex: initial; }
            .card-actions { flex-direction: column; width: 100%; gap: 8px; }
            .card-actions button { width: 100%; padding: 10px 12px; font-size: 16px; box-sizing: border-box; }
        }
        @media (max-width: 500px) {
            #menuBtn { display: block; }
            .sidebar { transform: translateX(-100%); position: fixed; top: 0; left: 0; height: 100vh; width: 70%; padding-top: 50px; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5); }
            .sidebar.open { transform: translateX(0); }
            .content { flex: 1; padding: 8px; margin-top: 50px; }
            .sidebar h2 { display: block; text-align: center; }
            .sidebar button { text-align: left; font-size: 16px; padding: 12px 20px; }
        }

/* Busca el estilo de .promo-group-container y aj√∫stalo as√≠: */
.promo-group-container {
    display: grid;
    /* Reducimos el minmax de 220px a 180px para tarjetas m√°s peque√±as */
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
    gap: 12px; /* Reducimos el espacio entre tarjetas */
    margin-bottom: 25px; 
}


/* Ajuste de la tarjeta para que se vea bien en la cuadr√≠cula */
.promo-card {
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    /* Se elimina el width fijo: width: 200px; */ 
}

/* Estilos para el Desplegable */
.dropdown-container {
    position: relative;
    width: 100%;
}

.dropdown-menu {
    display: none; /* Inicialmente oculto */
    background: #34495e; /* Un tono un poco m√°s oscuro que el sidebar */
    width: 100%;
    padding: 5px 0;
    transition: max-height 0.3s ease-out;
    overflow: hidden;
    /* Evita que se solape con el bot√≥n de abajo visualmente */
    border-top: 1px solid rgba(0, 0, 0, 0.2); 
}

.dropdown-menu.open {
    display: block;
}

.dropdown-menu button {
    background: none;
    border: none;
    color: white;
    text-align: left;
    padding: 8px 30px; /* M√°s padding para indentar */
    cursor: pointer;
    font-size: 15px;
    width: 100%;
    transition: 0.2s;
}

.dropdown-menu button:hover, .dropdown-menu button.active {
    background: #4a677e; /* Tono de hover para el submen√∫ */
}

/* Estilos del Modal */
.modal {
    display: none; /* Oculto por defecto */
    position: fixed; /* Posicionamiento fijo */
    z-index: 1000; /* Siempre encima */
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.4); /* Fondo semi-transparente */
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto; /* 10% desde arriba y centrado */
    padding: 25px;
    border: 1px solid #888;
    width: 80%; 
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close-button:hover,
.close-button:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}

.modal-content h3 {
    border-bottom: 2px solid #ddd;
    padding-bottom: 10px;
    margin-top: 0;
}

.modal-content label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
    color: #333;
}

.modal-content input[type="number"],
.modal-content input[type="file"] {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box; /* Incluye padding y borde en el ancho/alto */
}

/* Botones */
.save-btn {
    background-color: #28a745;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
}

/* --------------------
   AJUSTE DE ALINEACI√ìN (Vertical)
   -------------------- */
.button-group {
    display: flex; 
    /* üí° Clave: Cambia la direcci√≥n del flexbox a columna (vertical) */
    flex-direction: column; 
    
    /* Centra ambos botones en el eje horizontal (opcional) */
    align-items: center; 
    
    /* Esto alinea el grupo completo a la derecha, si el contenedor es ancho (opcional) */
    justify-content: flex-end; 
    
    /* Espacio vertical entre los botones */
    gap: 10px;
    margin-bottom: 20px;
}

/* --------------------
   RESTO DE ESTILOS (Mantenidos)
   -------------------- */
/* --------------------
   AJUSTE DE ALINEACI√ìN (Vertical y a la Izquierda) üëà
   -------------------- */
.button-group {
    display: flex; 
    /* Direccion vertical (uno debajo del otro) */
    flex-direction: column; 
    
    /* üí° Clave: Esto alinea los elementos (botones) a la izquierda */
    align-items: flex-start; 
    
    /* Si tienes un contenedor grande, aseg√∫rate que el grupo est√© a la izquierda */
    justify-content: flex-start; /* Esto alinea el grupo completo a la izquierda */
    
    gap: 10px;
    margin-bottom: 20px;
}

/* --------------------
   ESTILOS BASE DEL BOT√ìN
   -------------------- */
.button {
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    /* Asegura que los botones no se estiren m√°s de un ancho razonable */
    width: 100%; 
    max-width: 250px; 
}

/* Bot√≥n AGREGAR (Primario) */
.button-primary {
    background-color: #007bff; 
    color: white; 
    border: 2px solid #007bff; 
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
}
.button-primary:hover { background-color: #0056b3; border-color: #0056b3; }
/* ... (otros estilos de hover/active) */

/* Bot√≥n EXPORTAR (Secundario) */
.button-secondary {
    background-color: transparent; 
    color: #333; 
    border: 2px solid #ccc; 
}
.button-secondary:hover { background-color: #f0f0f0; border-color: #b3b3b3; }
.button-secondary:active { transform: translateY(1px); }
.cancel-btn {
    background-color: #6c757d;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}


/* 1. Contenedor principal: organiza los elementos en fila y maneja el desbordamiento */
.category-buttons-container {
    display: flex;
    flex-wrap: wrap; /* Permite que los botones salten a la siguiente l√≠nea si no hay espacio */
    gap: 10px; /* Espacio uniforme entre todos los elementos (botones y bot√≥n de acci√≥n) */
    padding: 15px 0;
    align-items: center; /* Alinea verticalmente el bot√≥n de acci√≥n con los botones de categor√≠a */
    border-bottom: 1px solid #ddd;
    margin-bottom: 20px;
}


/* 2. Estilo base del bot√≥n de categor√≠a */
.category-button-label {
    /* Quitamos el borde inline anterior y usamos un dise√±o m√°s limpio */
    display: inline-flex;
    align-items: center;
    padding: 8px 15px;
    background-color: #f8f8f8; /* Fondo claro por defecto */
    color: #333;
    border: 1px solid #ccc;
    border-radius: 20px; /* Bordes redondeados para un aspecto moderno */
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    font-size: 14px;
    user-select: none; /* Evita selecci√≥n de texto al hacer clic */
}

/* 3. Efecto hover */
.category-button-label:hover {
    background-color: #eee;
    border-color: #aaa;
}

/* 4. Estilo de SELECCIONADO (VISTOSO) */
/* Aplicado cuando el checkbox DENTRO del label est√° marcado */
.category-checkbox:checked + label {
    /* El selector + label no funciona aqu√≠ porque el checkbox no est√° antes del label, est√° dentro. 
       Usaremos el selector padre: */
}

.category-checkbox:checked {
    /* Para ocultar el checkbox por defecto si quieres que solo se vea el color del label */
    /* display: none; */ 
}

/* Estilo para el label cuando el checkbox DENTRO est√° chequeado. */
/* Como el checkbox es el primer hijo, debemos usar un selector m√°s complejo si queremos 
   cambiar el estilo del padre. La forma m√°s sencilla es usar la clase y el selector :has() 
   (si es soportado) o cambiar ligeramente la estructura. 
   
   Por simplicidad y compatibilidad: El estilo se aplicar√° al label cuando el checkbox est√© checked. */

/* Estilo simple (si no ocultas el checkbox): */
.category-checkbox:checked + .category-button-label { /* Esto requiere que el label est√© DENTRO del input, o el checkbox est√© FUERA. */
    
}
/* La estructura actual es: <label><input type="checkbox">Texto</label>
   El CSS debe ser: */
.category-button-label:has(.category-checkbox:checked) {
    background-color: #007bff; /* Color de selecci√≥n azul vibrante */
    color: white;
    border-color: #0056b3;
}


/* Si no usas :has() (navegadores antiguos), puedes dejar el dise√±o del checkbox visible, 
   o simplificar el JavaScript para que la clase se a√±ada al label con un listener 'change'. */

/* Para el dise√±o VISTOSO, aseg√∫rate que los checkboxes por defecto sean menos intrusivos */
.category-checkbox {
    /* Estilos opcionales para checkbox */
    accent-color: #007bff;
}

/* 5. Estilo del bot√≥n principal de acci√≥n */
.action-button {
    background-color: #28a745;
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    font-weight: bold;
}

.action-button:hover {
    background-color: #1e7e34;
}



    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>


<body>


 <nav class="sidebar">
  <h2>MENU</h2>
  <ul style="list-style:none; padding:0; margin:0;">
    <li><button class="tab-btn active" data-tab="promos">Promociones</button></li>
    <li><button class="tab-btn" data-tab="pedidos">Pedidos</button></li>
    <li><button class="tab-btn" data-tab="categorias">Categor√≠as</button></li>
    <li><button class="tab-btn" data-tab="localidades">Localidades</button></li>
    <li><button class="tab-btn" data-tab="documentos">Documentos</button></li>
    <li><button class="tab-btn" data-tab="clientes">Clientes</button></li>
  </ul>
</nav>
   
    
    
<div class="content">
        <div id="promos" class="section active">
        <div style="margin-bottom:20px;">
	<div id="promoCategoriaFilter" style="margin-bottom: 50px;">
    	</div>
        </select>
        <option value="">Todas las categor√≠as</option>
        </select>
        <button id="exportPromoPDF" style="margin-left:10px;padding:6px 12px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;">Exportar 	seleccionados</button>
        </div>
        <div id="promoList" style="display:grid; grid-template-rows: repeat(auto-fill,minmax(250px,1fr)); gap:16px;"></div>
        </div>
	<div id="editPromoModal" class="modal">
    	<div class="modal-content">
        <span class="close-button" onclick="document.getElementById('editPromoModal').style.display = 'none'">&times;</span>
        <h3>Editar Promoci√≥n</h3>
        <input type="hidden" id="modalPromoId">
        <input type="hidden" id="modalOldImageName">
        
        <label for="modalImageFile">Cambiar Imagen:</label>
        <input type="file" id="modalImageFile" accept="image/*">
        <p>Imagen actual: <span id="modalCurrentImageName" style="font-style: italic;"></span></p>

        <label for="modalPrecio">Precio Actual ($):</label>
        <input type="number" id="modalPrecio" min="0" step="0.01" required>
        
        <label for="modalPrecioAnterior">Precio Anterior ($):</label>
        <input type="number" id="modalPrecioAnterior" min="0" step="0.01">
        
        <label for="modalStock">Stock (unidades):</label>
        <input type="number" id="modalStock" min="0" required>
        
        <div style="margin-top: 20px; text-align: right;">
            <button onclick="document.getElementById('editPromoModal').style.display = 'none'" class="cancel-btn">Cancelar</button>
            <button onclick="savePromotionChanges()" class="save-btn">Guardar Cambios</button>
        </div>
    </div>
</div>





        <div id="pedidos" class="section">
            <h2>Pedidos</h2>
            <form id="pedidoForm" onsubmit="return false;" 
      style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:flex-start;">
<!-- Cliente: m√°s largo -->
    <div style=""width:40%; min-width:50px; display:flex; flex-direction:column;">
        <label>Cliente</label>
        <input id="pedidoCliente" type="text" placeholder="Nombre cliente" style="width:100%;" /> <div>
	</div>
<!-- Localidad -->
    	<div style=""width:60%; min-width:180px; display:flex; flex-direction:column;">
        <label>Localidad</label>
        <select id="pedidoLocalidad" style="width:70%;"></select> <div>
	</div>
<!-- Seleccionar Productos -->
    	<div style="flex:1; min-width:180px; display:flex; flex-direction:column; justify-content:flex-start;">
        <label>Productos</label>
        <button type="button" id="selectProductsBtn" 
        style="width:80%; background-color:#4CAF50; color:white; border:none; padding:8px 0; border-radius:4px; cursor:pointer;">
        Seleccionar Productos
        </button> <div>
<!-- Productos seleccionados debajo -->
	<div style="width:100%; margin-top:6px;">
        <div id="selectedProductsContainer" class="small-muted">No hay productos seleccionados</div>
</div>
    	</div>

	<div class="button-group">
	<button type="button" id="addOrderBtn" class="button button-primary">
        + Confirmar Pedido
    	</button>
    	</div>
    	</div>
	</div>	
	<h2>Lista de Pedidos</h2>
	<div id="pedidoList"></div>
	</div>
	</div>

<div id="categorias" class="section">
	<h1>Gesti√≥n de Categor√≠as</h1>
 	<input type="text" id="categoriaNombre" placeholder="Nueva categor√≠a" />
  	<button id="addCategoriaBtn">Agregar</button>
  	<div id="categoriaList"></div>
	</div>


<!-- LOCALIDADES -->
      <div id="localidades" class="section">
      <h1>Gesti√≥n de Localidades</h1>
      <input type="text" id="localidadNombre" placeholder="Nueva localidad" />
      <button onclick="addLocalidad()">Agregar</button>
      <div id="localidadList"></div>
      </div>


<div id="documentos" class="section">
      <h1>Gesti√≥n de Documentos</h1>
      <input type="file" id="docArchivo" />
      <button id="addDocumentoBtn">Agregar Documento</button>
      <button id="fetchDocumentosBtn">Actualizar Documentos</button>
      <div id="docList" style="margin-top:18px;"></div>
      </div>



        <div id="clientes" class="section">
            <h1>Gesti√≥n de Clientes</h1>
            <form id="clienteForm" onsubmit="event.preventDefault(); addClienteRapido();" style="display:flex; gap:10px; margin-bottom: 20px; align-items:center; flex-wrap:wrap; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fff;">
                <input 
  type="text" 
  id="clienteNombre" 
  name="clienteNombre" 
  placeholder="Nombre y Apellido" required style="flex:2; min-width:150px;"/>

<select id="clienteLocalidad" name="clienteLocalidad" required style="flex:1; min-width:120px; padding:8px; border:1px solid #ccc; border-radius:6px;">
  <option value="">Seleccionar Localidad...</option>
</select>

               <input type="text" id="clienteHora" placeholder="Hora (Ej: 14:30)" style="flex: 1; min-width: 90px;" />
                <button type="submit" style="background: #27ae60; color:#fff; border:none; padding:8px 15px; flex-shrink: 0;">‚ûï Carga R√°pida</button>
            </form>
            <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;">
                <input type="text" id="clienteSearch" placeholder="Buscar por cliente..." style="flex:1;padding:6px 10px;border-radius:5px;border:1px solid #ccc;">
                <select id="clienteLocalidadFilter" style="padding:6px 12px;border-radius:5px;border:1px solid #ccc;">
                    <option value="">Todas las localidades</option>
                </select>
            </div>
            <h3>Lista de Clientes y Seguimiento</h3>
            <div id="clienteList"></div>
        </div>
    </div>
    <div id="modal" style="display:none;">
  <div id="modalInner"></div>
</div>
    <div id="appToast"></div>



<!-- === MODAL GEN√âRICO === -->
<div id="modal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
">
  <div id="modalInner" style="
    background: #fff;
    padding: 24px;
    border-radius: 12px;
    max-width: 900px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  ">
    <!-- contenido din√°mico -->
  </div>
  <button onclick="closeModal()" style="
    position: absolute;
    top: 15px;
    right: 20px;
    background: #ff4d4f;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    cursor: pointer;
    font-weight: bold;
  ">‚úñ</button>
</div>



<script>

// Funci√≥n para mostrar la secci√≥n deseada y ocultar todas las dem√°s
function navigateTo(tabName) {
    // 1. Oculta todas las secciones
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });

    // 2. Muestra la secci√≥n deseada
    const targetSection = document.getElementById(tabName);
    if (targetSection) {
        targetSection.classList.add('active');
        // ... (resto de l√≥gica del sidebar)
    }

    // 3. Actualiza el estado 'active' de los botones
    document.querySelectorAll('.sidebar .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // El bot√≥n de la pesta√±a seleccionada se activa
    const targetButton = document.querySelector(`.sidebar .tab-btn[data-tab="${tabName}"]`);
    if (targetButton) {
        targetButton.classList.add('active');
    }

    // 4. L√ìGICA CLAVE: Cerrar el desplegable de Promociones si navegamos a otra secci√≥n
    const promoSubMenu = document.getElementById('promoSubMenu');
    const promoToggleBtn = document.querySelector('.dropdown-toggle');
    

}


/* =========================================================
   Configuraci√≥n Supabase (cliente)
   ========================================================= */

/* =========================================================
   Configuraci√≥n Supabase (cliente)
   ========================================================= */
const SUPABASE_URL = "https://ejbqlejlgprvwzrptojo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================================================
   Utilidades generales
   ========================================================= */
function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
function safeText(t){ return escapeHtml(t); }
function showToast(text, tiempo = 2200) {
    let toast = document.getElementById('appToast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'appToast';
        toast.style.cssText = 'position:fixed;right:16px;bottom:20px;background:#2ecc71;color:#fff;padding:12px 18px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.3);z-index:15000;opacity:0;transition:opacity .25s;';
        document.body.appendChild(toast);
    }
    toast.innerText = text;
    toast.style.opacity = '1';
    clearTimeout(toast._to);
    toast._to = setTimeout(() => { toast.style.opacity = '0'; }, tiempo);
}
function openModal(innerHtml) {
    const inner = document.getElementById('modalInner');
    inner.innerHTML = innerHtml;
    document.getElementById('modal').style.display = 'flex';
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

/* =========================================================
   Sidebar & Navegaci√≥n entre secciones
   ========================================================= */
function toggleSidebar(){
  const sidebar = document.querySelector('.sidebar');
  const backdrop = document.getElementById('backdrop');
  sidebar.classList.toggle('open');
  backdrop.classList.toggle('show');
}

document.getElementById('menuBtn')?.addEventListener('click', toggleSidebar);

function activateSection(tab) {
  // 1. Ocultar todas las secciones
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));

  // 2. Mostrar la seleccionada
  const target = document.getElementById(tab);
  if (target) target.classList.add('active');

  // 3. Marcar bot√≥n activo
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  const button = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
  if (button) button.classList.add('active');

}

// 5. Escucha los clics de los botones del men√∫
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    activateSection(tab);
    if (window.innerWidth <= 500 && document.querySelector('.sidebar').classList.contains('open')) {
      toggleSidebar();
    }
  });
});

// Mostrar Promos por defecto
activateSection('promos');

/* =========================================================
   Variables globales
   ========================================================= */
let selectedProducts = [];
let editingOrderId = null;


/**
 * Maneja el clic en un bot√≥n de categor√≠a del submen√∫.
 */
function handleCategoryFilter() {
    const categoryId = this.dataset.categoryId;
    
    // 1. Marcar el bot√≥n activo y resetear los dem√°s
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    
    // 2. Asegurar que la secci√≥n de promos est√© activa
    document.querySelectorAll('.section').forEach((section) => section.classList.remove('active'));
    document.getElementById('promos').classList.add('active');
    
    // 3. Llamar a la funci√≥n de renderizado para cargar las promos filtradas
    // Si tienes el selector de filtro en el DOM, actualiza su valor:
    const filterSelect = document.getElementById('promoCategoriaFilter');
    if (filterSelect) filterSelect.removeEventListener('change', handlePromoFilterChange);
    
    // Llamar a la funci√≥n de renderizado (que ahora debe estar optimizada para el ID)
    renderPromosByFilter(categoryId); 
}


/* =========================================================
   Promociones: Carga Inicial de Categor√≠as en Submen√∫
   ========================================================= */

async function loadPromoSubMenu() {
    try {
        const { data: categorias = [], error: catError } = await supabase.from("categorias").select("id,nombre").order("nombre");
        if (catError) throw catError;
        
        const subMenu = document.getElementById('promoSubMenu');
        if (!subMenu) return;

        subMenu.innerHTML = ''; // Limpiar el men√∫ antes de llenarlo

        // Opci√≥n: "Ver Todas" al inicio
        const allBtn = document.createElement('button');
        allBtn.textContent = 'Todas las Promociones';
        allBtn.className = 'category-btn active'; // Activo por defecto
        allBtn.dataset.categoryId = ''; 
        allBtn.addEventListener('click', handleCategoryFilter);
        subMenu.appendChild(allBtn);

        // Botones de Categor√≠a
        categorias.forEach(c => {
            const btn = document.createElement('button');
            btn.textContent = safeText(c.nombre);
            btn.className = 'category-btn';
            btn.dataset.categoryId = c.id;
            btn.addEventListener('click', handleCategoryFilter);
            subMenu.appendChild(btn);
        });

    } catch (err) {
        console.error('loadPromoSubMenu error', err);
    }
}





// ===============================================
// === üÜï FUNCIONES DE EDICI√ìN Y MODAL üÜï ===
// ===============================================

/**
 * Abre el modal y carga los datos de la promoci√≥n seleccionada.
 * @param {number} promoId - ID de la promoci√≥n a editar.
 */
async function openEditModal(promoId) {
    const modal = document.getElementById('editPromoModal');
    if (!modal) {
        console.error("Modal 'editPromoModal' no encontrado.");
        return;
    }

    try {
        // 1. Obtener los datos de la promoci√≥n
        const { data: promo, error } = await supabase
            .from('promociones')
            .select('*')
            .eq('id', promoId)
            .maybeSingle();

        if (error || !promo) throw new Error(error?.message || 'Promoci√≥n no encontrada');

        // 2. Llenar los campos del modal
        document.getElementById('modalPromoId').value = promo.id;
        document.getElementById('modalOldImageName').value = promo.imagen || '';
        document.getElementById('modalCurrentImageName').textContent = promo.imagen || 'Sin imagen';
        
        document.getElementById('modalPrecio').value = promo.precio || 0;
        document.getElementById('modalPrecioAnterior').value = promo.precio_anterior || '';
        document.getElementById('modalStock').value = promo.stock || 0;
        
        // Limpiar el campo de archivo por si se abre de nuevo
        document.getElementById('modalImageFile').value = '';

        // 3. Mostrar el modal
        modal.style.display = 'block';

    } catch (err) {
        console.error('Error al abrir modal de edici√≥n:', err);
        alert('Error al cargar datos: ' + err.message);
    }
}

/**
 * Guarda los cambios de la promoci√≥n, maneja la carga/eliminaci√≥n de la imagen.
 */
async function savePromotionChanges() {
    const promoId = document.getElementById('modalPromoId').value;
    const oldImageName = document.getElementById('modalOldImageName').value;
    const newImageFile = document.getElementById('modalImageFile').files[0];
    const newPrecio = parseFloat(document.getElementById('modalPrecio').value);
    const newPrecioAnterior = parseFloat(document.getElementById('modalPrecioAnterior').value) || null;
    const newStock = parseInt(document.getElementById('modalStock').value) || 0;

    let newImageName = oldImageName;
    
    if (!promoId) return alert('ID de promoci√≥n no encontrado.');
    
    try {
        // 1. Manejo de la Carga de Imagen
        if (newImageFile) {
            // Generar nombre de archivo √∫nico
            const fileExtension = newImageFile.name.split('.').pop();
            const uniqueName = `${promoId}_${Date.now()}.${fileExtension}`;
            
            // Subir nuevo archivo
            const { error: uploadError } = await supabase.storage
                .from('promo_images')
                .upload(uniqueName, newImageFile, {
                    cacheControl: '3600',
                    upsert: false
                });

            if (uploadError) throw uploadError;
            
            newImageName = uniqueName;

            // 2. Eliminaci√≥n de la Imagen Anterior (si existe y es diferente)
            if (oldImageName && oldImageName !== newImageName) {
                const { error: deleteError } = await supabase.storage
                    .from('promo_images')
                    .remove([oldImageName]);
                
                if (deleteError) console.warn('Advertencia: No se pudo eliminar la imagen anterior:', deleteError);
            }
        }

        // 3. Actualizar la BD (promociones)
        const { error: updateError } = await supabase
            .from('promociones')
            .update({
                precio: newPrecio,
                precio_anterior: newPrecioAnterior,
                stock: newStock,
                imagen: newImageName 
            })
            .eq('id', promoId);

        if (updateError) throw updateError;

        alert('Promoci√≥n actualizada con √©xito!');
        document.getElementById('editPromoModal').style.display = 'none';
        
        // 4. Recargar la lista para reflejar los cambios
        const currentCategoryId = document.getElementById('promoCategoriaFilter').value;
        await renderPromosByFilter(currentCategoryId);

    } catch (err) {
        console.error('Error al guardar cambios:', err);
        alert('Error al guardar cambios: ' + err.message);
    }
}


/**
 * Muestra u oculta y actualiza la barra de progreso.
 * @param {string} containerId - ID del contenedor de la barra (e.g., 'progressBarContainer').
 * @param {number} progress - Progreso en porcentaje (0-100).
 * @param {string} text - Texto a mostrar.
 * @param {boolean} visible - Si debe ser visible.
 */
function updateProgressBar(containerId, progress, text, visible = true) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (visible) {
        // Asegurar que la barra existe dentro del contenedor (si no existe, la crea)
        let bar = container.querySelector('.progress-bar');
        let barText = container.querySelector('.progress-text');
        
        if (!bar) {
            // Estructura m√≠nima de la barra (con estilos inline para simplicidad)
            container.innerHTML = `
                <div class="progress-bar-inner" style="height: 10px; background-color: #f3f3f3; border-radius: 5px; margin-top: 5px;">
                    <div class="progress-bar" style="height: 100%; width: 0%; background-color: #007bff; border-radius: 5px; transition: width 0.3s;"></div>
                </div>
                <div class="progress-text" style="font-size: 0.8em; margin-top: 2px;"></div>
            `;
            bar = container.querySelector('.progress-bar');
            barText = container.querySelector('.progress-text');
        }

        container.style.display = 'block';
        if (bar) bar.style.width = `${progress}%`;
        if (barText) barText.textContent = text;
        
    } else {
        // Ocultar al finalizar la carga
        container.style.display = 'none';
    }
}



/* =========================================================
   Promociones: carga y render (CORREGIDO PARA AGRUPACI√ìN Y ESTILO)
   ========================================================= */

async function fetchPromos() {
    try {
        const { data: categorias = [], error: catError } = await supabase.from("categorias").select("id,nombre").order("nombre");
        if (catError) throw catError;
        
        const container = document.getElementById('promoCategoriaFilter');
        if (!container) return;
        
        // üÜï APLICAR ESTILOS DE CONTENEDOR FLEXBOX
        container.className = 'category-buttons-container';
        container.innerHTML = '';
        // ---------------------------------------------
        
        // üÜï Bot√≥n para mostrar las categor√≠as seleccionadas
        const showButton = document.createElement('button');
        showButton.textContent = 'Mostrar Seleccionadas'; // T√≠tulo m√°s corto
        showButton.id = 'btnShowSelectedCategories';
        showButton.className = 'action-button'; // Clase para estilos
        showButton.addEventListener('click', handleShowSelected);
        container.appendChild(showButton);

        // Array de opciones (se mantiene igual)
        const allOptions = [
            { id: '', nombre: 'Todas' }, 
            { id: 'sin_categoria', nombre: 'Sin Categor√≠a' },
            ...categorias.map(c => ({ id: String(c.id), nombre: c.nombre }))
        ];

        // Crear botones con checkbox para cada categor√≠a
        allOptions.forEach(c => {
            const label = document.createElement('label');
            label.className = 'category-button-label'; // Clase para el dise√±o del bot√≥n

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = c.id;
            checkbox.className = 'category-checkbox';
            checkbox.style.marginRight = '5px';
            
            // üí° Listener de Usabilidad (Desmarcar "Todas" si se selecciona otra)
            checkbox.addEventListener('change', (e) => {
                const clickedValue = e.target.value;
                const isChecked = e.target.checked;
                const todasCheckbox = document.querySelector('.category-checkbox[value=""]');

                if (clickedValue === '') {
                    if (isChecked) {
                        document.querySelectorAll('.category-checkbox:not([value=""])').forEach(cb => cb.checked = false);
                    }
                } else {
                    if (isChecked && todasCheckbox) {
                        todasCheckbox.checked = false;
                    }
                }
            });

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(c.nombre));
            container.appendChild(label);
        });

        // ... (Mensaje inicial se mantiene igual) ...
        
    } catch (err) {
        console.error('fetchPromos error', err);
    }
}


// ----------------------------------------------------
// üÜï 2. Funci√≥n para manejar la selecci√≥n m√∫ltiple
// ----------------------------------------------------

/**
 * Funci√≥n que se ejecuta al presionar "Mostrar Categor√≠as Seleccionadas".
 * Recoge todos los checkboxes marcados y llama al renderizado.
 */
function handleShowSelected() {
    const selectedIds = Array.from(document.querySelectorAll('.category-checkbox:checked'))
                            .map(cb => cb.value);
                            
    // La funci√≥n renderPromosByFilter ya est√° dise√±ada para manejar arrays de IDs
    renderPromosByFilter(selectedIds);
}

// ----------------------------------------------------
// üÜï 3. Funci√≥n para manejar el clic individual (Mostrar solo esa)
// ----------------------------------------------------

/**
 * Funci√≥n que se ejecuta al hacer click en un checkbox de categor√≠a.
 * Deselecciona los dem√°s y dispara la carga inmediata (si est√° marcada).
 * @param {Event} e - Evento de click.
 * @param {Array<string>} allCategoryIds - Todos los IDs de categor√≠a posibles.
 */
function handleCategorySingleClick(e, allCategoryIds) {
    const clickedCheckbox = e.target;
    
    // Si el usuario acaba de desmarcar, no hacemos nada m√°s que esperar a "Mostrar seleccionadas"
    if (!clickedCheckbox.checked) {
        return;
    }

    // 1. Desmarcar todos los dem√°s checkboxes
    document.querySelectorAll('.category-checkbox').forEach(cb => {
        if (cb !== clickedCheckbox) {
            cb.checked = false;
        }
    });

    // 2. Disparar el renderizado inmediatamente con la √∫nica categor√≠a seleccionada
    renderPromosByFilter([clickedCheckbox.value]);
}


/**
 * Funci√≥n manejadora que se dispara al cambiar el filtro.
 * Lee todos los valores seleccionados del men√∫ m√∫ltiple.
 */
function handlePromoFilterChange() {
    const sel = document.getElementById('promoCategoriaFilter');
    // Mapea todas las opciones seleccionadas y obtiene sus valores
    const selectedIds = Array.from(sel.options)
                            .filter(option => option.selected)
                            .map(option => option.value);
                            
    // Llama al renderizado con el array de IDs
    renderPromosByFilter(selectedIds);
}


async function renderPromosByFilter(categoryIds = []) {
    const container = document.getElementById('promoList');
    if (!container) return;

    container.innerHTML = '<p style="padding: 20px;">Cargando promociones...</p>';

    // Si no hay categor√≠as seleccionadas, muestra el mensaje de inicio
    if (categoryIds.length === 0) {
        container.innerHTML = '<p style="padding: 20px;">Selecciona una o m√°s categor√≠as para ver las promociones.</p>';
        return;
    }

    // --- 2. Obtener Datos Filtrados desde Supabase ---
    let query = supabase.from("promociones").select("*").order("id");
    
    // üÜï Ajuste de T√≠tulo
    let categoryName = 'Promociones Filtradas';

// üåü INICIALIZACI√ìN Y ASIGNACI√ìN SEGURA DE LAS VARIABLES DE CONTROL üåü
    const specificCategoryIds = categoryIds.filter(id => id !== 'sin_categoria' && id !== '');
    const isSinCategoriaSelected = categoryIds.includes('sin_categoria');
    const isTodasSelected = categoryIds.includes(''); // <-- ¬°Aqu√≠ se define!
    
    let filterApplied = false;

    if (categoryIds.length === 1) {
        const id = categoryIds[0];
        if (id === '') {
            categoryName = 'Todas las Promociones';
        } else if (id === 'sin_categoria') {
            categoryName = 'Sin Categor√≠a';
        } else {
            // Busca el nombre de la categor√≠a para un solo ID
            const { data: categoriaData } = await supabase.from("categorias").select("nombre").eq("id", id).maybeSingle();
            categoryName = categoriaData?.nombre || 'Promociones Filtradas';
        }
    } else if (categoryIds.length > 1) {
        categoryName = `M√∫ltiples Categor√≠as (${categoryIds.length} seleccionadas)`;
    }



    if (isTodasSelected) {
        // Si "Todas las categor√≠as" est√° seleccionada, no aplicamos ning√∫n filtro
        categoryName = 'Todas las Promociones';
        filterApplied = true;
    } else if (specificCategoryIds.length > 0) {
        // Filtra por m√∫ltiples IDs espec√≠ficos
        query = query.in('categoria_id', specificCategoryIds);
        categoryName = `M√∫ltiples Categor√≠as (${specificCategoryIds.length})`;
        filterApplied = true;
    } 
    
    if (isSinCategoriaSelected) {
        if (filterApplied) {
            // Si ya hay un filtro aplicado (m√∫ltiples IDs), es complicado usar 'OR' en el filtro simple.
            // Para simplificar, si seleccionas "Sin Categor√≠a" junto con otras, solo la mostramos si es la √∫nica seleccionada.
            // Si necesitas l√≥gica OR compleja, necesitar√≠as una funci√≥n o un RPC en Supabase.
            categoryName = "Categor√≠as y Sin Categor√≠a";
        } else {
            // Solo se selecciona "Sin Categor√≠a"
            query = query.is('categoria_id', null);
            categoryName = "Sin Categor√≠a";
            filterApplied = true;
        }
    }
    
    // Si no se aplic√≥ ning√∫n filtro (caso no manejado arriba), salimos.
    if (!filterApplied && specificCategoryIds.length === 0 && !isSinCategoriaSelected) {
        container.innerHTML = '<p style="padding: 20px;">Selecciona una o m√°s categor√≠as para ver las promociones.</p>';
        return;
    }

    // Ejecutar consulta
    const { data: promos = [], error: promoError } = await query;
    if (promoError) {
        console.error("Error al obtener promociones:", promoError);
        container.innerHTML = 'Error al cargar las promociones.';
        return;
    }
    
    // --- 3. Renderizado ---
    
    container.innerHTML = ''; 

    if (promos.length === 0) {
        container.innerHTML = `<p style="padding: 20px;">No hay promociones en la categor√≠a: <b>${categoryName}</b></p>`;
        return;
    }
    
    // T√≠tulo de Categor√≠a
    const catTitle = document.createElement('h2');
   catTitle.style.marginTop = "0px"; 
// Reducimos el padding o margen entre el texto y la l√≠nea (borderBottom)
catTitle.style.paddingBottom = "3px"; 
catTitle.style.marginBottom = "0"; // Asegura que no haya margen extra debajo
catTitle.style.lineHeight = "3";
catTitle.style.borderBottom = "1px solid #333";
catTitle.style.fontSize = "18px";
    container.appendChild(catTitle);
    
    // üÜï Contenedor de la Barra de Progreso
const progressBarContainer = document.createElement('div');
progressBarContainer.id = 'renderProgressBarContainer';
// üí° Aseg√∫rate de que el contenedor siguiente tambi√©n tenga un margen superior peque√±o o nulo
progressBarContainer.style.marginTop = '0px'; 
progressBarContainer.style.marginBottom = '10px'; 
container.appendChild(progressBarContainer);

    // Contenedor de la Cuadr√≠cula
    const promoContainer = document.createElement('div');
    promoContainer.className = "promo-group-container"; 
    promoContainer.style.marginTop = '0px';
    promos.sort((a,b)=>a.id-b.id);
    
    // üö® BUCLE DE RENDERIZADO üö®
    const totalPromos = promos.length; 
    let renderedCount = 0;
    
    for (const p of promos) {
        
        // L√ìGICA DE LA IMAGEN
        let imgSrc = p.imagen_url || '';
        if (p.imagen) { 
            try {
                // La operaci√≥n as√≠ncrona CR√çTICA para el progreso
                const { data: signedData } = await supabase.storage.from('promo_images').createSignedUrl(p.imagen, 3600);
                imgSrc = signedData?.signedUrl || imgSrc;
            } catch (err) { 
                console.warn('Error al obtener signedUrl para:', p.imagen, err); 
            }
        } 

        // Creaci√≥n del elemento de imagen
        const imgEl = document.createElement('img');
        imgEl.alt = p.nombre || '';
        imgEl.src = imgSrc || '';
        imgEl.crossOrigin = 'anonymous'; 
        imgEl.style.width = '100%';
        imgEl.style.height = '120px'; 
        imgEl.style.objectFit = 'cover';
        imgEl.style.borderRadius = '6px';
        imgEl.style.marginBottom = '6px';
        
        // Creaci√≥n de la tarjeta
        const div = document.createElement('div');
        div.className = 'promo-card';
        div.style.position = 'relative'; 

        // Contenido de la tarjeta
        div.innerHTML = `
            <input type="checkbox" class="promo-select" data-promo-id="${p.id}" checked>
            
            <div style="position: absolute; top: 5px; right: 5px; z-index: 10;">
                <button 
                    onclick="openEditModal(${p.id})" 
                    style="background: #007bff; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px; transition: background 0.3s;"
                    onmouseover="this.style.background='#0056b3'"
                    onmouseout="this.style.background='#007bff'"
                >
                    Editar ‚úèÔ∏è
                </button>
            </div>
            
            <b style="text-align:center;">${safeText(p.nombre || '')}</b>
            <div style="text-align:center;margin-top:4px;">
                ${p.precio_anterior && Number(p.precio_anterior) > Number(p.precio) 
                    ? `<del style="color:#888;">$${Number(p.precio_anterior).toFixed(2)}</del> <span style="color:red;font-weight:bold;">$${Number(p.precio).toFixed(2)}</span>` 
                    : `<span style="font-weight:bold;">$${Number(p.precio).toFixed(2)}</span>`}
            </div>
            
            <div style="text-align:center; margin-top: 4px; font-size: 0.9em; color: ${p.stock <= 5 ? 'red' : '#333'};">
                Stock: <b>${p.stock !== null && p.stock !== undefined ? p.stock : 'N/A'}</b>
            </div>
        `;


        // Insertar la imagen: 
        if (imgSrc) {
            div.insertBefore(imgEl, div.querySelector('b')); 
        }

        promoContainer.appendChild(div);
        
        // üåü ACTUALIZAR BARRA DE PROGRESO (Movido al final del bucle)
        renderedCount++;
        const progress = Math.round((renderedCount / totalPromos) * 100);
        updateProgressBar('renderProgressBarContainer', progress, `Cargando Promociones: ${renderedCount} de ${totalPromos}`, true);
    }
    
    container.appendChild(promoContainer);

    // üÜï OCULTAR BARRA AL TERMINAR
    updateProgressBar('renderProgressBarContainer', 100, `Carga completa (${totalPromos} promociones).`, false);
}

// Llama a fetchPromos al inicio
fetchPromos();



/* =========================================================
   Exportar promos a PDF (CORREGIDO: Consulta Supabase)
   ========================================================= */

async function exportSelectedPromos() {
    try {
        // ... (1Ô∏è‚É£ Obtener IDs seleccionados, 2Ô∏è‚É£ Traer datos completos de Supabase, 3Ô∏è‚É£ Categor√≠as, 4Ô∏è‚É£ Agrupar por categor√≠a - ESTOS PASOS SE MANTIENEN IGUAL) ...

        // 1Ô∏è‚É£ Obtener IDs seleccionados
        const selectedIds = Array.from(document.querySelectorAll('.promo-select:checked'))
            .map(cb => parseInt(cb.dataset.promoId, 10))
            .filter(id => !isNaN(id));

        if (!selectedIds.length) return alert('Seleccione al menos un producto.');

        // 2Ô∏è‚É£ Traer datos completos de Supabase
        const { data: allPromos, error: promoError } = await supabase
            .from('promociones')
            .select('*')
            .in('id', selectedIds);

        if (promoError) throw promoError;

        const selectedPromos = selectedIds
            .map(id => allPromos.find(p => p.id === id))
            .filter(Boolean);

        if (!selectedPromos.length) return alert('No se encontraron promociones.');

        // 3Ô∏è‚É£ Categor√≠as
        const { data: allCategories = [] } = await supabase.from('categorias').select('id, nombre');
        const getCategoryName = (id) => {
            if (id === null) return "Sin Categor√≠a";
            const cat = allCategories.find(c => c.id === id);
            return cat ? cat.nombre : "Categor√≠a Desconocida";
        };

        // 4Ô∏è‚É£ Agrupar por categor√≠a
        const groupedPromos = selectedPromos.reduce((acc, promo) => {
            const catId = promo.categoria_id || null;
            if (!acc[catId]) acc[catId] = { name: getCategoryName(catId), promos: [] };
            acc[catId].promos.push(promo);
            return acc;
        }, {});

        let logoImgData = null; 
        const LOGO_PATH = 'logodistribuidora.png'; // üåü RUTA DE LOGO üåü

        try {
            const { data: logoSignedData } = await supabase.storage
    .from('promo_images')  // ‚úÖ bucket correcto
    .createSignedUrl('logodistribuidora.png', 3600);
                
            if (logoSignedData?.signedUrl) {
                // Cargar y convertir el logo a Base64 para jsPDF
                const response = await fetch(logoSignedData.signedUrl);
                const blob = await response.blob();
                
                logoImgData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            }
        } catch (err) {
            console.warn('Error al cargar el logo de la empresa:', err);
        }


        // 5Ô∏è‚É£ Config PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'pt', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const marginTop = 60;
        const marginBottom = 60;
        const marginSides = 30;
        const spacingX = 15;
        const spacingY = 15;
        const cols = 2;
        const rows = 4;
        
        // El c√°lculo de la altura de la tarjeta debe usar el espacio real entre m√°rgenes
        const totalUsableHeight = pageHeight - marginTop - marginBottom; 
        const totalSpacingY = spacingY * (rows - 1);
        const cardHeight = Math.floor((totalUsableHeight - totalSpacingY) / rows);
        const usableContentWidth = pageWidth - marginSides * 2; // El ancho usable sin m√°rgenes
        const cardWidth = (usableContentWidth - spacingX * (cols - 1)) / cols;
        
        let x = marginSides;
        let y = marginTop;
        let count = 0;
        // let globalPromoIndex = 0; // Ya no es necesario si solo se usa 'count' de manera local

        const TITLE_HEIGHT = 25; // Altura estimada para el t√≠tulo de categor√≠a + espacio
        const LOGO_HEIGHT = 60; 
        const LOGO_WIDTH = 190;
	const LOGO_VERTICAL_OFFSET = 10;
        const TITLE_LOGO_AREA_HEIGHT = Math.max(TITLE_HEIGHT, LOGO_HEIGHT) + 5; // Asegurar espacio para ambos

        // 6Ô∏è‚É£ Recorrer categor√≠as
        let isFirstCategory = true;
        
        for (const catId in groupedPromos) {
            const categoryData = groupedPromos[catId];

            // üåü L√ìGICA DE POSICIONAMIENTO DE CATEGOR√çA üåü

            if (!isFirstCategory) {
                // 1. Ajustar 'y' despu√©s de la categor√≠a anterior
                // Si la √∫ltima fila de la categor√≠a anterior est√° incompleta
                const itemsInLastRow = categoryData.promos.length % cols; 
                if (itemsInLastRow !== 0) {
                     // El 'y' finaliza en la posici√≥n de la √∫ltima tarjeta dibujada. 
                     // Si no complet√≥ la fila, ya avanz√≥ a la siguiente.
                } else {
                    // Si la fila estaba completa, 'y' ya se actualiz√≥ en el ciclo interno a la posici√≥n de la siguiente fila.
                }
                
                // Forzamos el salto a la posici√≥n vertical del siguiente t√≠tulo
                y += 20; // Peque√±o espacio extra antes del nuevo t√≠tulo
            }
            
            // 2. Chequeo de salto de p√°gina antes de dibujar el t√≠tulo.
            // Si el t√≠tulo no cabe o no deja espacio para al menos 1 tarjeta: Salto de p√°gina.
            if (y + TITLE_LOGO_AREA_HEIGHT + cardHeight > pageHeight - marginBottom) {
                pdf.addPage();
                y = marginTop;
            }
            
            // 3. Dibujar T√≠tulo de Categor√≠a
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold'); // Opcional: negrita para el t√≠tulo
            pdf.text(categoryData.name, marginSides, y);
            pdf.setFont('helvetica', 'normal');

            // 4. Dibujar el Logo (margen derecho)
            if (logoImgData) {
                const logoX = pageWidth - marginSides - LOGO_WIDTH;
                // Posicionar el logo para que su parte inferior est√© justo encima de las tarjetas.
                const logoY = y - LOGO_HEIGHT + (TITLE_HEIGHT / 2) + LOGO_VERTICAL_OFFSET;
                
                pdf.addImage(
                    logoImgData, 
                    'PNG', 
                    logoX, 
                    logoY, 
                    LOGO_WIDTH, 
                    LOGO_HEIGHT
                );
            }

            // 5. Ajustar 'y' para el *contenido* de las tarjetas de la nueva categor√≠a
            y += TITLE_LOGO_AREA_HEIGHT; // Baja 'y' para el inicio de las tarjetas
            x = marginSides;
            count = 0; // Reiniciar contador de tarjetas para la posici√≥n de la categor√≠a
            
            isFirstCategory = false; // Ya no es la primera categor√≠a

            // üåü FIN L√ìGICA DE POSICIONAMIENTO DE CATEGOR√çA üåü
            
            for (const promo of categoryData.promos) {
                // ... (El bloque para generar la tarjeta con html2canvas se mantiene igual) ...
                
                const div = document.createElement('div');
                div.style.width = `${cardWidth}px`;
                div.style.height = `${cardHeight}px`;
                div.style.border = '1px solid #ddd';
                div.style.borderRadius = '6px';
                div.style.padding = '4px';
                div.style.boxSizing = 'border-box';
                div.style.textAlign = 'center';
                div.style.display = 'flex';
                div.style.flexDirection = 'column';
                div.style.justifyContent = 'flex-start';
                div.style.background = '#fff';
                div.style.overflow = 'hidden';

                // Imagen cuadrada (ajustes de la respuesta anterior)
                const img = document.createElement('img');
                img.style.width = '40%';
                img.style.height = '60%'; 
                img.style.objectFit = 'cover';
                img.style.borderRadius = '6px';
                img.style.display = 'block';
                img.style.margin = '4px auto 0 auto';
                img.crossOrigin = 'anonymous';
                let imgSrc = promo.imagen_url || '';
                if (promo.imagen) {
                    try {
                        const { data: sd } = await supabase.storage.from('promo_images').createSignedUrl(promo.imagen, 3600);
                        imgSrc = sd?.signedUrl || imgSrc;
                    } catch (err) { console.warn('signedUrl in export', err); }
                }
                img.src = imgSrc;
                div.appendChild(img);

                // Nombre
                const nameEl = document.createElement('div');
                // Nota: La funci√≥n safeText() no est√° definida, se asume que existe o se usa el nombre directo.
                nameEl.innerHTML = `<b>${promo.nombre}</b>`; 
                nameEl.style.fontSize = '9pt';
                nameEl.style.marginTop = '4px';
                nameEl.style.height = 'auto';
                nameEl.style.flex = '0';
                div.appendChild(nameEl);

                // Precio
                const priceEl = document.createElement('div');
                priceEl.innerHTML = `$${promo.precio} ${promo.precio_anterior ? `<span style="text-decoration:line-through;color:#888;">$${promo.precio_anterior}</span>` : ''}`;
                priceEl.style.fontSize = '13pt';
                priceEl.style.marginTop = '2px';
                priceEl.style.flex = '0';
                div.appendChild(priceEl);

                document.body.appendChild(div);

                // Esperar carga imagen
                if (imgSrc) {
                    await new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                }

                // html2canvas
                const canvas = await html2canvas(div, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                
                // A√±adir imagen al PDF
                pdf.addImage(imgData, 'PNG', x, y, cardWidth, cardHeight);
                document.body.removeChild(div);
                
                // üåü L√ìGICA DE AVANCE DE POSICI√ìN üåü
                
                count++; // Contador de tarjetas en la p√°gina (para las coordenadas)
                
                const isEndOfRow = count % cols === 0;
                
                if (isEndOfRow) {
                    // La fila est√° completa, chequeamos si la SIGUIENTE fila cabe
                    if (y + cardHeight + spacingY + cardHeight > pageHeight - marginBottom) {
                        // Salto de p√°gina
                        pdf.addPage();
                        x = marginSides;
                        y = marginTop;
                        count = 0; // Reiniciamos el contador de la p√°gina
                    } else {
                        // Siguiente fila en la misma p√°gina
                        x = marginSides;
                        y += cardHeight + spacingY;
                    }
                } else {
                    // La fila NO est√° completa, solo avanza 'x'.
                    x += cardWidth + spacingX;
                }
                
                // El contador que estaba aqu√≠ (count % (cols * rows)) ya es redundante
                // ya que la l√≥gica de salto de p√°gina est√° integrada en el 'if (isEndOfRow)'
                // al chequear si la siguiente tarjeta cabr√°.
            }
        }

        pdf.save('Promociones_Catalogo.pdf');

    } catch (err) {
        console.error('Error al exportar promociones:', err);
        alert('Error al exportar promociones: ' + err.message);
    }
}


document.getElementById('exportPromoPDF').addEventListener('click', exportSelectedPromos);




/* =========================================================
   PEDIDOS: L√≥gica de Persistencia y Control de Stock (CORREGIDO)
   ========================================================= */

// ==================== FUNCIONES DE CONTROL DE CANTIDAD ====================

// Genera el HTML para el control de cantidad con botones.
function renderQuantityControls(id, qty, price, stock) {
    return `
      <div style="display:flex;align-items:center;width:100px;">
        <button type="button" class="qty-btn" data-action="minus" data-id="${id}" style="background:#ddd;border:none;padding:5px 8px;cursor:pointer;border-radius:5px 0 0 5px;font-weight:bold;">‚ûñ</button>
        <input type="number" min="0" max="${stock}" value="${qty}" id="prod_${id}" data-price="${price}" data-stock-max="${stock}" style="width:40px;text-align:center;border-left:none;border-right:none;" oninput="updateSubtotal(${id}, ${price}, ${stock})">
        <button type="button" class="qty-btn" data-action="plus" data-id="${id}" style="background:#ddd;border:none;padding:5px 8px;cursor:pointer;border-radius:0 5px 5px 0;font-weight:bold;">‚ûï</button>
      </div>
    `;
}

// Agrega los event listeners a los botones de + y -
function addQuantityControlListeners() {
    // Es mejor remover y re-agregar listeners para asegurar que solo haya uno por bot√≥n
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.removeEventListener('click', handleQuantityChange);
    });
    
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', handleQuantityChange);
    });
}

function handleQuantityChange() {
    const action = this.getAttribute('data-action');
    const id = parseInt(this.getAttribute('data-id'), 10);
    const input = document.getElementById(`prod_${id}`);
    
    if (!input) return;

    // Obtenemos los datos necesarios desde el input
    const price = parseFloat(input.getAttribute('data-price')) || 0;
    const stock = parseInt(input.getAttribute('data-stock-max'), 10) || 0;
    let currentQty = parseInt(input.value, 10) || 0;

    if (action === 'plus') {
        currentQty = Math.min(stock, currentQty + 1);
    } else if (action === 'minus') {
        currentQty = Math.max(0, currentQty - 1);
    }

    input.value = currentQty;
    updateSubtotal(id, price, stock);
}


function getSelectedQty(id){ const it = selectedProducts.find(x => x.id === id); return it ? it.cantidad : 0; }

/**
 * Funci√≥n que actualiza subtotal, aplica stock y recalcula el total general.
 */
function updateSubtotal(id, price, stock){
    const input = document.getElementById(`prod_${id}`);
    if(!input) return;
    
    let qty = parseInt(input.value,10) || 0;
    
    if(qty < 0) qty = 0;
    if(stock !== undefined && qty > stock) qty = stock;
    
    input.value = qty; 
    
    const sub = document.getElementById(`sub_${id}`);
    if(sub) sub.textContent = `$${(qty*price).toFixed(2)}`;
    
    const tot = document.getElementById('totalPedido');
    if(tot) tot.textContent = `$${calculateTotal().toFixed(2)}`;
}

function calculateTotal(){
    let total = 0;
    const inputs = document.querySelectorAll('#modalInner input[type=number][data-price]');
    inputs.forEach(inp=>{
        const qty = parseInt(inp.value,10) || 0;
        const price = parseFloat(inp.getAttribute('data-price')) || 0;
        total += qty * price;
    });
    return total;
}

/**
 * FUNCI√ìN CR√çTICA PARA LA PERSISTENCIA: Actualiza la variable global selectedProducts 
 * con los valores actuales de los inputs visibles en el modal.
 */
function updateSelectedProductsFromModal() {
    const inputs = document.querySelectorAll('#modalInner input[type=number][data-price]');
    
    inputs.forEach(inp => {
        const prodId = parseInt(inp.id.replace('prod_',''), 10);
        const qty = parseInt(inp.value, 10) || 0;
        const price = parseFloat(inp.getAttribute('data-price')) || 0;
        
        const existingIndex = selectedProducts.findIndex(p => p.id === prodId);

        if (qty > 0) {
            if (existingIndex !== -1) {
                selectedProducts[existingIndex].cantidad = qty;
            } else {
                // Producto nuevo: obtener nombre del DOM
                const row = inp.closest('tr');
                const nombre = row && row.cells.length > 0 ? row.cells[0].textContent : `Producto ${prodId}`; 
                selectedProducts.push({ id: prodId, nombre: nombre, cantidad: qty, precio: price });
            }
        } else {
            // Cantidad 0: eliminar de la selecci√≥n si ya exist√≠a
            if (existingIndex !== -1) {
                selectedProducts.splice(existingIndex, 1);
            }
        }
    });
}


function confirmProducts(){
    // ‚úÖ Paso de persistencia final antes de cerrar el modal
    updateSelectedProductsFromModal(); 
    closeModal(); 
    renderSelectedProducts();
}


/* ========== MODAL DE SELECCI√ìN DE PRODUCTOS ========== */
document.getElementById('selectProductsBtn').addEventListener('click', async ()=>{
    const { data: categoriasData } = await supabase.from('categorias').select('*').order('id');
    const { data: promos } = await supabase.from('promociones').select('*').order('id'); // Consulta directa
    
    function renderFilteredPromos(categoryId = "") {
        
        // ‚ö†Ô∏è PASO CR√çTICO: Guardar el estado actual ANTES de redibujar la tabla.
        if (document.getElementById('modalInner').querySelector('table')) {
            updateSelectedProductsFromModal();
        }

        let filteredPromos = (!categoryId) ? promos : promos.filter(p => String(p.categoria_id) === String(categoryId));
        let html = `
            <div style="margin-bottom:14px;display:flex;align-items:center;gap:18px;">
                <label style="font-weight:bold;" for="filterCategoria">Filtrar por categor√≠a:</label>
                <select id="filterCategoria" style="padding:6px 12px;border-radius:5px;border:1px solid #ccc;">
                    <option value="">Todas</option>
                    ${categoriasData.map(c => `<option value="${c.id}">${safeText(c.nombre)}</option>`).join("")}
                </select>
            </div>
            <div style="overflow-x:auto;">
                <table class="table" style="min-width:700px;">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Cantidad</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        for(const p of filteredPromos){
            const qty = getSelectedQty(p.id); // Lee de la selecci√≥n global
            const stockMax = p.stock ?? 0;
            const price = Number(p.precio);

            html += `
                <tr>
                    <td>${safeText(p.nombre || p.descripcion || '')}</td>
                    <td>$${price.toFixed(2)}</td>
                    <td>${stockMax}</td>
                    <td>
                        ${renderQuantityControls(p.id, qty, price, stockMax)}
                    </td>
                    <td id="sub_${p.id}">$${(qty * price).toFixed(2)}</td>
                </tr>
            `;
        }
        html += `
                        <tr>
                            <td colspan="3" style="text-align:right"><strong>Total:</strong></td>
                            <td colspan="2" id="totalPedido">$0.00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top:18px;display:flex;justify-content:flex-end;">
                <button onclick="confirmProducts()" style="background:#3498db;color:#fff;border:none;padding:12px 24px;border-radius:7px;font-size:16px;font-weight:bold;cursor:pointer;">
                    üíæ Confirmar selecci√≥n
                </button>
            </div>
        `;
        document.getElementById('modalInner').innerHTML = `<h3 style="margin-bottom:18px;">Seleccionar Productos</h3>${html}`;
        document.getElementById("modalInner").style.maxWidth = "950px";
        document.getElementById("modalInner").style.width = "95%";
        document.getElementById("modal").style.display="flex";
        
        const filterEl = document.getElementById('filterCategoria');
        if (filterEl) {
            filterEl.value = categoryId; // Mantiene la categor√≠a seleccionada
            filterEl.addEventListener('change', function(){
                renderFilteredPromos(this.value);
            });
        }

        // Agrega listeners a los nuevos botones
        addQuantityControlListeners(); 
        
        setTimeout(()=>{ const tEl = document.getElementById('totalPedido'); if(tEl) tEl.textContent = `$${calculateTotal().toFixed(2)}` }, 40);
    }
    renderFilteredPromos();
});


function renderSelectedProducts(){
    const c = document.getElementById('selectedProductsContainer');
    if(!selectedProducts.length){ c.innerHTML = '<span class="small-muted">No hay productos seleccionados</span>'; return; }
    let html = `<table class="table"><thead><tr><th>Producto</th><th>Cantidad</th><th>Subtotal</th></tr></thead><tbody>`;
    selectedProducts.forEach(p=>{
        html += `<tr><td>${safeText(p.nombre)}</td><td>${p.cantidad}</td><td>$${(p.precio*p.cantidad).toFixed(2)}</td></tr>`;
    });
    const total = selectedProducts.reduce((s,p)=>s + p.precio * p.cantidad, 0);
    html += `<tr><td colspan="2" style="text-align:right"><strong>Total:</strong></td><td>$${total.toFixed(2)}</td></tr></tbody></table>`;
    c.innerHTML = html;
}
async function getPromoById(id){
    const { data } = await supabase.from('promociones').select('*').eq('id', id).single();
    return data;
}

/* ================== AGREGAR PEDIDO ================== */
document.getElementById('addOrderBtn').addEventListener('click', async ()=>{
    const cliente = document.getElementById('pedidoCliente').value.trim();
    const localidad_id = document.getElementById('pedidoLocalidad').value || null;
    if(!cliente || selectedProducts.length === 0) return alert('Complete cliente y seleccione productos');
    
    const promosActuales = await Promise.all(selectedProducts.map(p => getPromoById(p.id)));
    for (let i = 0; i < selectedProducts.length; i++) {
        if (selectedProducts[i].cantidad > (promosActuales[i].stock || 0)) {
            return alert(`Stock insuficiente para ${selectedProducts[i].nombre} (disponible: ${promosActuales[i].stock})`);
        }
    }
    
    // SOLO DESCONTAR STOCK UNA VEZ
    await Promise.all(selectedProducts.map((p, i) =>
        supabase.from('promociones').update({ stock: (promosActuales[i].stock || 0) - p.cantidad }).eq('id', p.id)
    ));
    
    const productosPayload = selectedProducts.map(p => ({ id: p.id, nombre: p.nombre, cantidad: p.cantidad, precio: p.precio }));
    const total = productosPayload.reduce((s,x)=>s + x.precio * x.cantidad, 0);
    const { error } = await supabase.from('pedidos').insert([{ cliente, localidad_id, productos: productosPayload, total }]);
    
    if(error) return alert(error.message);
    
    document.getElementById('pedidoForm').reset();
    selectedProducts = []; renderSelectedProducts();
    await fetchOrders();
    await fetchPromos(); // Cambiado a fetchPromos (tu funci√≥n)
    showToast('Pedido agregado');
});

/* ========== OBTENER LOCALIDAD ========== */
async function getLocalidadNombre(id) {
    if (!id) return "";
    const { data } = await supabase.from('localidades').select('*').order('id');
    return (data && data.nombre) ? data.nombre : "";
}




/* ================== LISTADO DE PEDIDOS OPTIMIZADO ================== */
let isFetchingOrders = false;

async function fetchOrders() {
    if(isFetchingOrders) return; // evita llamadas concurrentes
    isFetchingOrders = true;

    try {
        const { data: pedidos } = await supabase.from('pedidos').select('*').order('id');
        const container = document.getElementById("pedidoList");
        container.innerHTML = ""; // limpia el contenedor antes de agregar

        if (!pedidos || !pedidos.length) return;

        // Cargar localidades
        const { data: localidadesData } = await supabase.from('localidades').select('id,nombre');
        const localidadMap = {};
        localidadesData.forEach(l => { localidadMap[l.id] = l.nombre; });

        for (const p of pedidos) {
            const localidadNombre = p.localidad_id ? localidadMap[p.localidad_id] || "" : "";

            // Contenedor del pedido
            const div = document.createElement('div');
            div.className = 'item-card';
            Object.assign(div.style, {
                display: 'flex',
                alignItems: 'stretch',
                justifyContent: 'space-between',
                padding: '18px 14px',
                marginBottom: '14px',
                borderRadius: '12px',
                background: '#fff',
                boxShadow: '0 2px 12px rgba(0,0,0,0.07)',
                border: '1px solid #eee',
            });

            // Informaci√≥n del pedido
            const infoDiv = document.createElement('div');
            infoDiv.style.flex = '1';
            let prodHTML = '<ul style="margin:7px 0 10px 0;padding-left:22px;font-size:15px;">';
            p.productos.forEach(pr => {
                prodHTML += `<li>${safeText(pr.nombre)} x ${pr.cantidad} <span style="color:#3498db;">$${(pr.precio*pr.cantidad).toFixed(2)}</span></li>`;
            });
            prodHTML += '</ul>';

            infoDiv.innerHTML = `
                <strong>${safeText(p.cliente)}</strong>
                <div style="color:#888;margin-bottom:2px;">${localidadNombre ? 'Localidad: ' + safeText(localidadNombre) : ''}</div>
                ${prodHTML}
                <div style="margin-top:8px;font-weight:bold;">Total: <span style="color:#ff4d4f;">$${Number(p.total).toFixed(2)}</span></div>
            `;

            // Botones
            const actionsDiv = document.createElement('div');
            Object.assign(actionsDiv.style, { display:'flex', flexDirection:'column', gap:'10px', alignItems:'flex-end' });

            const pdfBtn = document.createElement('button');
            pdfBtn.textContent = 'üìÑ Exportar PDF';
            Object.assign(pdfBtn.style, { background:'#2ecc71', color:'#fff', border:'none', padding:'8px 18px', borderRadius:'7px', fontWeight:'bold', cursor:'pointer' });
            pdfBtn.onclick = () => exportPedidoPDF({...p, localidad_nombre: localidadNombre});

            const editBtn = document.createElement('button');
            editBtn.textContent = '‚úèÔ∏è Editar';
            Object.assign(editBtn.style, { background:'#3498db', color:'#fff', border:'none', padding:'8px 18px', borderRadius:'7px', fontWeight:'bold', cursor:'pointer' });
            editBtn.onclick = () => editOrderModal(p);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'üóëÔ∏è Eliminar';
            Object.assign(deleteBtn.style, { background:'#ff4d4f', color:'#fff', border:'none', padding:'8px 18px', borderRadius:'7px', fontWeight:'bold', cursor:'pointer' });
            deleteBtn.onclick = () => deleteOrder(p.id);

            actionsDiv.appendChild(pdfBtn);
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);

            div.appendChild(infoDiv);
            div.appendChild(actionsDiv);
            container.appendChild(div);
        }
    } catch (err) {
        console.error(err);
        showToast('Error al cargar pedidos');
    } finally {
        isFetchingOrders = false; // desbloquear flag
    }
}


/* ========== MODAL DE EDICI√ìN DE PEDIDO CON STOCK DIFERENCIAL (Mantenido el c√≥digo original) ========== */
async function editOrderModal(pedido) {
    const { data: localidades } = await supabase.from('localidades').select('*').order('id');
    const { data: productosDB } = await supabase.from('promociones').select('*').order('id');
    let productosPedido = pedido.productos.map(pr => ({ ...pr }));

    function renderModal(stockMsg = "") {
        document.getElementById("modalInner").style.maxWidth = "1200px";
        document.getElementById("modalInner").style.width = "98%";
        let productosDisponibles = productosDB.filter(pdb => !productosPedido.some(pp => pp.id === pdb.id));
        let selectHTML = `
            <div style="display:flex;align-items:flex-start;gap:10px;">
                <div style="flex:1;display:flex;flex-direction:column;gap:5px;">
                    <select id="addProductoSelect" style="margin-bottom:5px;">
                        <option value="">Agregar producto</option>
                        ${productosDisponibles.map(p=>`<option value="${p.id}">${safeText(p.nombre)} ($${Number(p.precio).toFixed(2)}, stock: ${p.stock ?? 0})</option>`).join('')}
                    </select>
                    <input type="number" id="addProductoQty" min="1" value="1" style="width:60px;" placeholder="Cant.">
                </div>
                <button type="button" id="addProductoBtn" style="background:#eee;color:#333;border:none;padding:8px 14px;border-radius:6px;font-size:17px;cursor:pointer;height:45px;align-self:flex-start;">‚ûï</button>
            </div>
        `;
        let listaHTML = `<ul id="productosPedidoList" style="margin-bottom:8px;">`;
        productosPedido.forEach((pr, idx) => {
            const prodInfo = productosDB.find(pdb => pdb.id === pr.id);
            // Stock disponible: stock actual en DB + cantidad que tiene este pedido (para que el cliente pueda aumentar)
            // Ya que el stock se devolver√° al guardar. Aqu√≠ solo queremos mostrar el stock base + la cantidad original para no bloquear aumentos si hay poco stock
            // CORRECCI√ìN: El stock disponible para *agregar* es el stock actual en DB. Si el cliente tiene 5 y el stock es 10, puede subir hasta 10+5=15.
            const stockActualDB = prodInfo ? (prodInfo.stock ?? 0) : 0;
            const stockOriginalEnPedido = pedido.productos.find(op => op.id === pr.id)?.cantidad || 0;
            const stockBase = stockActualDB + stockOriginalEnPedido;

            listaHTML += `
                <li style="margin-bottom:6px;">
                    <span style="font-weight:bold;">${safeText(pr.nombre)}</span>
                    <input type="number" min="1" max="${stockBase}" value="${pr.cantidad}" data-idx="${idx}" class="editQtyInput" style="width:45px;margin:0 6px;">
                    <span style="color:#aaa;">(stock max: ${stockBase})</span>
                    <span style="color:#3498db;">$${(pr.precio*pr.cantidad).toFixed(2)}</span>
                    <button type="button" class="deletePrBtn" data-idx="${idx}" style="background:#ff4d4f;color:#fff;border:none;padding:2px 7px;border-radius:6px;font-size:14px;cursor:pointer;margin-left:6px;">üóëÔ∏è</button>
                </li>
            `;
        });
        listaHTML += `</ul>`;
        let total = productosPedido.reduce((s,p)=>s + p.precio*p.cantidad, 0);

        openModal(
            `
            <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:18px;">
                <h2 style="margin:0;font-size:1.3em;">Editar Pedido</h2>
            </div>
            <div style="background:#f8f8f8;border-radius:12px;padding:20px 18px;box-shadow:0 2px 12px rgba(0,0,0,0.07);">
                <div style="margin-bottom:16px;">
    <label for="editPedidoCliente" style="font-weight:500;display:block;margin-bottom:4px;">Cliente</label>
    <input type="text" id="editPedidoCliente" value="${safeText(pedido.cliente)}" placeholder="Nombre del cliente">
</div>
<div style="margin-bottom:16px;">
    <label for="editPedidoLocalidad" style="font-weight:500;display:block;margin-bottom:4px;">Localidad</label>
    <select id="editPedidoLocalidad">
        <option value="">Seleccione localidad</option>
        ${localidades.map(l => `<option value="${l.id}" ${l.id === pedido.localidad_id ? 'selected' : ''}>${safeText(l.nombre)}</option>`).join('')}
    </select>
</div>
                <div style="margin-bottom:16px;">
                    <label style="font-weight:500;display:block;margin-bottom:4px;">Productos</label>
                    ${selectHTML}
                    ${listaHTML}
                    <div style="margin-top:8px;font-weight:bold;">Total: <span id="pedidoTotal" style="color:#ff4d4f;">$${total.toFixed(2)}</span></div>
                    ${stockMsg ? `<div style="color:#ff4d4f;font-weight:bold;margin-top:10px;">${stockMsg}</div>` : ""}
                </div>
                <button onclick="saveEditPedido(${pedido.id})" style="margin-top:10px;background:#3498db;color:#fff;border:none;padding:12px 20px;border-radius:7px;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:8px;">
                    üíæ Guardar cambios
                </button>
            </div>
            `
        );
        document.getElementById('addProductoBtn').onclick = function() {
            const prodId = document.getElementById('addProductoSelect').value;
            let qty = parseInt(document.getElementById('addProductoQty').value, 10) || 1;
            if(!prodId) return;
            const prodObj = productosDB.find(p=>String(p.id)===String(prodId));
            
            if(prodObj) {
                const stockDisp = prodObj.stock ?? 0;
                if(qty > stockDisp) {
                    qty = stockDisp;
                    renderModal(`El stock disponible de "${prodObj.nombre}" es ${stockDisp}.`);
                    return;
                }
                productosPedido.push({
                    id: prodObj.id,
                    nombre: prodObj.nombre,
                    cantidad: qty,
                    precio: prodObj.precio
                });
                renderModal();
            }
        };
        document.querySelectorAll('.editQtyInput').forEach(input => {
            input.onchange = function() {
                let idx = parseInt(this.getAttribute('data-idx'));
                let prodInfo = productosDB.find(pdb => pdb.id === productosPedido[idx].id);
                
                // Stock base: stock actual + cantidad original en este pedido
                const stockActualDB = prodInfo ? (prodInfo.stock ?? 0) : 0;
                const stockOriginalEnPedido = pedido.productos.find(op => op.id === productosPedido[idx].id)?.cantidad || 0;
                const stockBase = stockActualDB + stockOriginalEnPedido;

                let val = Math.max(1, parseInt(this.value, 10));
                
                if(val > stockBase) {
                    val = stockBase;
                    renderModal(`El stock m√°ximo disponible para "${productosPedido[idx].nombre}" (incluyendo el stock que est√° en este pedido) es ${stockBase}.`);
                }
                
                productosPedido[idx].cantidad = val;
                renderModal();
            };
        });
        document.querySelectorAll('.deletePrBtn').forEach(btn => {
            btn.onclick = function() {
                let idx = parseInt(this.getAttribute('data-idx'));
                productosPedido.splice(idx, 1);
                renderModal();
            };
        });
    }

    renderModal();

    window.saveEditPedido = async function(id) {
       const cliente = document.getElementById('editPedidoCliente').value.trim();
const localidad_id = document.getElementById('editPedidoLocalidad').value;
if(!cliente) return alert("Ingrese el nombre del cliente");
if(!localidad_id) return alert("Seleccione la localidad");
if(!productosPedido.length) return alert("Agregue productos");


        // --- AJUSTA EL STOCK SOLO POR LA DIFERENCIA ---
        const { data: pedidoOriginal } = await supabase.from('pedidos').select('*').eq('id', id).single();
        const productosOriginal = pedidoOriginal.productos || [];
        const mapOriginal = {};
        productosOriginal.forEach(p => mapOriginal[p.id] = p.cantidad);
        const mapNuevo = {};
        productosPedido.forEach(p => mapNuevo[p.id] = p.cantidad);

        // AJUSTE SOLO POR LA DIFERENCIA
        const allIds = new Set([...productosOriginal.map(p=>p.id), ...productosPedido.map(p=>p.id)]);
        for(const prodId of allIds) {
            const cantOriginal = mapOriginal[prodId] || 0;
            const cantNueva    = mapNuevo[prodId]    || 0;
            const dif = cantNueva - cantOriginal;
            if(dif !== 0) {
                const promo = await getPromoById(prodId);
                // Si dif > 0 (m√°s pedidos), el stock disminuye.
                // Si dif < 0 (menos pedidos), el stock aumenta.
                await supabase.from('promociones').update({ stock: (promo.stock || 0) - dif }).eq('id', prodId);
            }
        }

        const { error } = await supabase.from('pedidos').update({ cliente, localidad_id, productos: productosPedido, total }).eq('id', id);
        if(error) return alert(error.message);
        closeModal();
        await fetchOrders();
        await fetchPromos(); // Actualizar lista de promociones para reflejar stock
        showToast('Pedido actualizado');
    };
}


async function agregarPedido(pedido) {
  const { error } = await supabase.from('pedidos').insert([pedido]);
  if (error) return alert('Error al guardar pedido: ' + error.message);

  // Refrescar listado de pedidos
  fetchPedidos();

  // Refrescar listado de clientes con pedidos
  fetchClientes();

  showToast('‚úÖ Pedido agregado');
}



/* ========== ELIMINAR PEDIDO ========== */
async function deleteOrder(id){
    if(!confirm('Eliminar pedido?')) return;
    const { data } = await supabase.from('pedidos').select('*').eq('id', id).single();
    if(data.productos && data.productos.length){
        for(const pr of data.productos){
            const promo = await getPromoById(pr.id);
            const newStock = (promo.stock || 0) + pr.cantidad;
            await supabase.from('promociones').update({ stock: newStock }).eq('id', pr.id);
        }
    }
    await supabase.from('pedidos').delete().eq('id', id);
    await fetchOrders();
    await fetchPromos(); // Actualizar lista de promociones para reflejar stock
    showToast('Pedido eliminado y stock restaurado');
}


// =========================================================
// üßæ EXPORTAR PEDIDO A PDF (Corregido y mejorado)
// =========================================================

async function exportPedidoPDF(pedido) {
  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'pt', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const margin = 40;
    const logoHeight = 70;
    const logoWidth = 180;
    const lineY = margin + logoHeight + 10;

    // 1Ô∏è‚É£ Obtener logo desde Supabase Storage
    const BUCKET_NAME = 'promo_images'; // ‚úÖ CAMBI√Å si tu bucket se llama distinto
    const LOGO_PATH = 'logodistribuidora.png'; // ‚úÖ nombre exacto del archivo en Supabase
    let logoImgData = null;

    try {
      const { data: logoSignedData, error: logoErr } = await supabase.storage
        .from(BUCKET_NAME)
        .createSignedUrl(LOGO_PATH, 3600);

      if (logoErr) throw logoErr;
      if (logoSignedData?.signedUrl) {
        // Convertir logo a Base64
        const response = await fetch(logoSignedData.signedUrl);
        if (!response.ok) throw new Error("Error al descargar el logo (status " + response.status + ")");
        const blob = await response.blob();

        logoImgData = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      } else {
        console.warn("No se pudo generar la URL firmada del logo");
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è No se pudo cargar el logo de la empresa:", err.message);
      logoImgData = null;
    }

    // 2Ô∏è‚É£ Dibujar logo y encabezado
    if (logoImgData) {
      pdf.addImage(logoImgData, 'PNG', margin, margin, logoWidth, logoHeight);
    }

    pdf.setFont('helvetica', 'bold');
    pdf.setFontSize(18);
    pdf.text("Pedido de Cliente", pageWidth - margin, margin + 30, { align: 'right' });

    pdf.setLineWidth(0.5);
    pdf.line(margin, lineY, pageWidth - margin, lineY);

    // 3Ô∏è‚É£ Datos del cliente y del pedido
    pdf.setFont('helvetica', 'normal');
pdf.setFontSize(12);

let y = lineY + 30;

// Cliente
const clienteText = `Cliente: ${pedido.cliente || ''}`;
const splitCliente = pdf.splitTextToSize(clienteText, pageWidth - margin * 2);
pdf.text(splitCliente, margin, y);
y += splitCliente.length * 15; // altura de las l√≠neas del cliente

// Localidad
const localidadText = `Localidad: ${pedido.localidad || pedido.localidad_nombre || ''}`;
const splitLocalidad = pdf.splitTextToSize(localidadText, pageWidth - margin * 2);
pdf.text(splitLocalidad, margin, y);
y += splitLocalidad.length * 15; // altura de las l√≠neas de localidad

// Fecha del sistema
const fechaSistema = new Date().toLocaleString();
y += 5; // üîπ peque√±o margen extra antes de la fecha
pdf.text(`Fecha: ${fechaSistema}`, margin, y);
y += 25; // espacio antes de la tabla de productos

    // 4Ô∏è‚É£ Tabla de productos
    pdf.setFont('helvetica', 'bold');
    pdf.text("Tu Compra", margin, y);
    y += 15;
    pdf.setFont('helvetica', 'normal');

    const headers = ["Producto", "Cantidad", "Precio", "Subtotal"];
    const colWidths = [220, 80, 80, 80];
    let x = margin;

    // Dibujar encabezados de la tabla
    headers.forEach((h, i) => {
      pdf.text(h, x, y);
      x += colWidths[i];
    });
    y += 10;
    pdf.line(margin, y, pageWidth - margin, y);
    y += 15;

    let total = 0;
   pedido.productos.forEach(prod => {
  const sub = prod.cantidad * prod.precio;
  total += sub;

  const nombreWrap = pdf.splitTextToSize(String(prod.nombre), colWidths[0] - 10);

  pdf.text(nombreWrap, margin, y);
  pdf.text(String(prod.cantidad), margin + colWidths[0], y);
  pdf.text(`$${prod.precio.toFixed(2)}`, margin + colWidths[0] + colWidths[1], y);
  pdf.text(`$${sub.toFixed(2)}`, margin + colWidths[0] + colWidths[1] + colWidths[2], y);

  y += nombreWrap.length * 15 + 8; // üî• suma espacio proporcional
});

    // 5Ô∏è‚É£ Total final
    pdf.setFont('helvetica', 'bold');
    y += 10;
    pdf.line(margin, y, pageWidth - margin, y);
    y += 25;
    pdf.text(`TOTAL: $${total.toFixed(2)}`, pageWidth - margin - 100, y, { align: 'right' });

    // 6Ô∏è‚É£ Guardar PDF
    const safeName = pedido.cliente.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    pdf.save(`Pedido_${safeName}_${pedido.id || ''}.pdf`);
  } catch (err) {
    console.error("‚ùå Error al exportar pedido:", err);
    alert("Error al generar el PDF: " + err.message);
  }
}





// ================= CATEGOR√çAS =================
async function fetchCategorias() {
    try {
        const { data: categorias = [], error: catError } = await supabase.from("categorias").select("*").order("id");
        
        if (catError) {
            throw catError; 
        }
        
	const cont = document.getElementById("categoriaList");
if (!cont) return console.warn("No se encontr√≥ el contenedor de categor√≠as");


        // 1. Obtener el contenedor
        const container = document.getElementById('categoriaList');
        
        // ‚úÖ VERIFICACI√ìN CR√çTICA: Salir si el contenedor es null
        if (!container) {
            console.warn("Elemento 'categoriaList' no encontrado. La pesta√±a no est√° activa.");
            return; 
        }
        
        // L√≠nea 1183 (o similar) se ejecuta S√ìLO si 'container' existe
        container.innerHTML = ''; 
        
        for (const cat of categorias) {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div class="card-info">
                    <b>${safeText(cat.nombre)}</b>
                                   </div>
                <div class="card-actions">
                    <button class="delete-btn" onclick="deleteCategoria(${cat.id})">üóëÔ∏è Eliminar</button>
                </div>
            `;
            container.appendChild(div);
        }

    } catch (err) {
        console.error('fetchCategorias error', err.message || err);
        showToast('Error cargando categor√≠as.', 3000);
    }
}


async function addCategoria(){
  const nombre = document.getElementById("categoriaNombre").value.trim();
  if(!nombre) return alert("Ingrese nombre");
  const {error} = await supabase.from("categorias").insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById("categoriaNombre").value = "";
  fetchCategorias();
}

function editCategoria(id, nombre){
  openModal("Editar categor√≠a", `
    <div style="padding:18px 12px;">
      <input id="editCat" value="${escapeHtml(nombre)}" style="padding:10px 16px;border-radius:8px;border:1px solid #ccc;font-size:16px;">
      <button onclick="updateCategoria(${id})" style="margin-left:10px;background:#3498db;color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;font-size:16px;cursor:pointer;">Guardar</button>
    </div>
  `);
}

async function updateCategoria(id){
  const nombre = document.getElementById("editCat").value.trim();
  if(!nombre) return alert("Ingrese nombre");
  const {error} = await supabase.from("categorias").update({nombre}).eq("id",id);
  if(error) return alert(error.message);
  closeModal();
  fetchCategorias();
}

async function deleteCategoria(id){
  if(!confirm("Eliminar categor√≠a?")) return;
  await supabase.from("categorias").delete().eq("id",id);
  fetchCategorias();
}


// ================= LOCALIDADES =================
async function fetchLocalidades(){
  const { data, error } = await supabase.from("localidades").select("*").order("id");
  if(error) return console.error(error);

  // Lista para gesti√≥n
  const container = document.getElementById("localidadList");
  container.innerHTML = "";
  data.forEach(l=>{
    // Tarjeta simple con flex
    const div = document.createElement('div');
    div.className = 'item-card';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    div.style.background = '#fff';
    div.style.border = '1px solid #eee';
    div.style.borderRadius = '10px';
    div.style.padding = '12px 18px';
    div.style.marginBottom = '12px';
    div.style.boxShadow = '0 2px 12px rgba(0,0,0,0.06)';

    // Nombre
    const nombreDiv = document.createElement('div');
    nombreDiv.textContent = l.nombre;
    nombreDiv.style.fontSize = '1.08em';
    nombreDiv.style.fontWeight = '500';

    // Botones
    const btnsDiv = document.createElement('div');
    btnsDiv.style.display = 'flex';
    btnsDiv.style.gap = '14px';
    btnsDiv.innerHTML = `
      <button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')" style="background:#3498db;color:#fff;border:none;padding:7px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">‚úèÔ∏è Editar</button>
      <button onclick="deleteLocalidad(${l.id})" style="background:#ff4d4f;color:#fff;border:none;padding:7px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">üóëÔ∏è Eliminar</button>
    `;

    div.appendChild(nombreDiv);
    div.appendChild(btnsDiv);
    container.appendChild(div);
  });

  // Select en formulario de pedidos
  const sel = document.getElementById("pedidoLocalidad");
  sel.innerHTML = '<option value="">Seleccione localidad</option>';
  data.forEach(l=>{
    sel.innerHTML += `<option value="${l.id}">${escapeHtml(l.nombre)}</option>`;
  });
}

async function addLocalidad(){
  const nombre=document.getElementById("localidadNombre").value.trim(); if(!nombre) return alert("Ingrese nombre");
  const {error}=await supabase.from("localidades").insert([{nombre}]); if(error) return alert(error.message); document.getElementById("localidadNombre").value=""; fetchLocalidades();
}

function editLocalidad(id,nombre){ 
  openModal("Editar localidad", `
    <div style="padding:18px 12px;">
      <input id="editLoc" value="${escapeHtml(nombre)}" style="padding:10px 16px;border-radius:8px;border:1px solid #ccc;font-size:16px;">
      <button onclick="updateLocalidad(${id})" style="margin-left:10px;background:#3498db;color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;font-size:16px;cursor:pointer;">Guardar</button>
    </div>
  `); 
}
async function updateLocalidad(id){ 
  const nombre=document.getElementById("editLoc").value.trim(); if(!nombre) return alert("Ingrese nombre"); 
  const {error}=await supabase.from("localidades").update({nombre}).eq("id",id); 
  if(error) return alert(error.message); 
  closeModal(); fetchLocalidades(); 
}
async function deleteLocalidad(id){ 
  if(!confirm("Eliminar localidad?")) return; 
  await supabase.from("localidades").delete().eq("id",id); 
  fetchLocalidades(); 
}




// ================= CLIENTES =================

/**
 * Inserta un nuevo cliente con la carga r√°pida.
 * El DNI, Tel√©fono y Hora de Visita quedan vac√≠os.
 * El estado se establece en 'Pendiente'.
 */
/* -------------------------
   Agregar Cliente R√°pido
------------------------- */
async function addClienteRapido() {
  const nombre = document.getElementById("clienteNombre").value.trim();
  const localidad = document.getElementById("clienteLocalidad").value;
  const hora = document.getElementById("clienteHora").value.trim();

  if (!nombre || !localidad) {
    showToast("‚ö†Ô∏è Complete los campos obligatorios");
    return;
  }

  try {
    const nuevoCliente = {
      nombre_completo: nombre,
      localidad,
      hora_visita: hora || null,
      estado_visita: 'Pendiente'
    };

    const { error } = await supabase.from('clientes').insert([nuevoCliente]);
    if (error) throw error;

    document.getElementById("clienteForm").reset();
    await fetchClientes();
    showToast("‚úÖ Cliente agregado correctamente");
  } catch (err) {
    console.error("Error al agregar cliente:", err);
    showToast("‚ùå Error al agregar cliente");
  }
}


async function loadLocalidadesFilter() {
    const select = document.getElementById("clienteLocalidadFilter");
    if (!select) return;

    const { data, error } = await supabase
        .from("localidades")
        .select("nombre")
        .order("nombre", { ascending: true });

    if (error) {
        console.error("Error al cargar localidades para filtro:", error);
        return;
    }

    select.innerHTML = `<option value="">Todas las localidades</option>`;
    data.forEach(loc => {
        const opt = document.createElement("option");
        opt.value = loc.nombre;
        opt.textContent = loc.nombre;
        select.appendChild(opt);
    });
}



async function fetchClientes() {
  const searchTerm = document.getElementById('clienteSearch')?.value.toLowerCase() || '';
  const localidadFilter = document.getElementById('clienteLocalidadFilter')?.value || '';

  // 1Ô∏è‚É£ Obtener clientes
  const { data: allClientes, error: clientesError } = await supabase
    .from('clientes')
    .select('*')
    .order('localidad', { ascending: true })
    .order('estado_visita', { ascending: true })
    .order('id', { ascending: false });
  if (clientesError) return console.error(clientesError);

  // 2Ô∏è‚É£ Obtener pedidos
  const { data: allPedidos, error: pedidosError } = await supabase
    .from('pedidos')
    .select('*')
    .order('id', { ascending: false });
  if (pedidosError) return console.error(pedidosError);

  // 3Ô∏è‚É£ Filtrado por localidad y b√∫squeda
  let filteredClientes = allClientes;

  if (localidadFilter) {
    filteredClientes = filteredClientes.filter(c => c.localidad === localidadFilter);
  }

  if (searchTerm) {
    const normalize = str => str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    filteredClientes = filteredClientes.filter(c => normalize(c.nombre_completo).includes(normalize(searchTerm)));
  }

  // 4Ô∏è‚É£ Agregar pedidos a cada cliente **despu√©s de filtrar**
  filteredClientes = filteredClientes.map(cliente => {
    const pedidosCliente = allPedidos.filter(p => p.cliente_id === cliente.id);
    return { ...cliente, pedidos: pedidosCliente };
  });

  // 5Ô∏è‚É£ Renderizado (igual que antes)
  const container = document.getElementById('clienteList');
  container.innerHTML = '';

  if (!filteredClientes.length) {
    container.innerHTML = `<span style="color:#888; display:block; padding: 20px;">
      ${localidadFilter ? `No se encontraron clientes en la localidad: "${escapeHtml(localidadFilter)}".` : 'No hay clientes cargados.'}
    </span>`;
    return;
  }

  const groupedClients = filteredClientes.reduce((acc, cliente) => {
    const localidad = cliente.localidad.trim() || 'Sin Localidad';
    const estado = cliente.estado_visita;

    if (!acc[localidad]) acc[localidad] = { Pendiente: [], Visitado: [] };
    acc[localidad][estado].push(cliente);
    return acc;
  }, {});

  Object.keys(groupedClients).sort().forEach(localidad => {
    const clientesByStatus = groupedClients[localidad];

    const localidadTitle = document.createElement('h2');
    localidadTitle.textContent = escapeHtml(localidad);
    localidadTitle.style.cssText = `margin:25px 0 10px 0; padding:8px 15px; background:#3498db; color:#fff; border-radius:8px; font-size:1.3em; box-shadow:0 2px 5px rgba(0,0,0,0.2);`;
    container.appendChild(localidadTitle);

    const renderStatusGroup = (status, list) => {
      if (!list.length) return;
      const isVisitado = status === 'Visitado';
      const statusColor = isVisitado ? '#27ae60' : '#e74c3c';
      const statusText = isVisitado ? '‚úÖ VISITADOS' : '‚è≥ PENDIENTES';

      const statusSection = document.createElement('div');
      statusSection.style.marginBottom = '20px';

      const statusSubtitle = document.createElement('h3');
      statusSubtitle.textContent = `${statusText} (${list.length})`;
      statusSubtitle.style.cssText = `border-bottom:2px solid ${statusColor}; padding-bottom:5px; color:${statusColor}; margin-bottom:15px;`;
      statusSection.appendChild(statusSubtitle);

      list.forEach(cliente => {
        const bgColor = isVisitado ? '#e6f7e6' : '#fff0f0';
        const horaVisitaText = cliente.hora_visita
          ? (isNaN(new Date(cliente.hora_visita)) ? `Hora: ${escapeHtml(cliente.hora_visita)}` : new Date(cliente.hora_visita).toLocaleString())
          : 'No Agendada';

        const div = document.createElement('div');
        div.className = 'card';
        div.style.background = bgColor;
        div.style.borderLeft = `5px solid ${statusColor}`;
        div.style.padding = '10px';
        div.style.marginBottom = '8px';

        // Lista de pedidos
        const pedidosHTML = cliente.pedidos && cliente.pedidos.length
          ? `<ul style="margin:4px 0 0 15px; font-size:0.85em; color:#333;">
              ${cliente.pedidos.map(p => `<li>Pedido #${p.id} - ${escapeHtml(p.descripcion || '')} (${p.estado || 'Sin Estado'})</li>`).join('')}
            </ul>`
          : '<div style="font-size:0.85em; color:#888;">No tiene pedidos</div>';

        div.innerHTML = `
          <div class="card-info" style="flex:1; gap:4px;">
            <b>${escapeHtml(cliente.nombre_completo)}</b>
            <div style="font-size:0.9em; color:#555;">
              DNI: ${cliente.dni || 'N/A'} ¬∑ Tel√©fono: ${cliente.telefono || 'N/A'}<br>
              Visita: ${horaVisitaText}
            </div>
            ${pedidosHTML}
          </div>
          <div class="card-actions" style="min-width:170px;">
            <button class="edit-btn" onclick="openEditClienteModal(${cliente.id})">‚úèÔ∏è Editar Datos</button>
            <button class="${isVisitado ? 'edit-btn' : 'delete-btn'}" 
                    style="background:${statusColor};"
                    onclick="toggleEstadoCliente(${cliente.id}, '${isVisitado ? 'Pendiente' : 'Visitado'}')">
              ${isVisitado ? 'Marcar como Pendiente' : 'Marcar como Visitado'}
            </button>
            <button class="delete-btn" onclick="deleteCliente(${cliente.id})" style="background:#95a5a6;">üóëÔ∏è Eliminar</button>
          </div>
        `;

        statusSection.appendChild(div);
      });

      container.appendChild(statusSection);
    };

    renderStatusGroup('Pendiente', clientesByStatus.Pendiente);
    renderStatusGroup('Visitado', clientesByStatus.Visitado);
  });
}

document.getElementById('clienteSearch').addEventListener('input', fetchClientes);
document.getElementById('clienteLocalidadFilter').addEventListener('change', fetchClientes);



/* -------------------------
   Cargar Localidades en el men√∫ desplegable de Clientes
------------------------- */
async function cargarLocalidadesEnSelect() {
  try {
    const { data, error } = await supabase.from('localidades').select('*').order('nombre', { ascending: true });
    if (error) throw error;

    const select = document.getElementById('clienteLocalidad');
    select.innerHTML = '<option value="">Seleccionar Localidad...</option>';
    data.forEach(loc => {
      const option = document.createElement('option');
      option.value = loc.nombre;
      option.textContent = loc.nombre;
      select.appendChild(option);
    });
  } catch (err) {
    console.error('Error cargando localidades:', err);
  }
}



/* -------------------------
   Funci√≥n: toggleEstadoCliente
   Actualiza el estado (Pendiente / Visitado) y refresca la lista
   ------------------------- */
async function toggleEstadoCliente(id, nuevoEstado){
  try {
    if (!id) return console.warn('toggleEstadoCliente: id inv√°lido', id);
    // Confirmaci√≥n sencilla (opcional)
    if (!confirm(`¬øMarcar este cliente como "${nuevoEstado}"?`)) return;

    const { error } = await supabase
      .from('clientes')
      .update({ estado_visita: nuevoEstado })
      .eq('id', id);

    if (error) {
      console.error('Error actualizando estado:', error);
      return alert('Error al actualizar estado: ' + error.message);
    }

    // Refrescar la lista y notificar
    await fetchClientes();
    showToast(`Cliente marcado como ${nuevoEstado}`);
  } catch (err) {
    console.error('toggleEstadoCliente error', err);
    alert('Ocurri√≥ un error inesperado al actualizar el estado.');
  }
}

/* -------------------------
   Funci√≥n: showToast (si no la ten√≠as)
   Peque√±a notificaci√≥n visual
   ------------------------- */
function showToast(text, tiempo = 2200) {
  let toast = document.getElementById('appToast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'appToast';
    toast.style.cssText =
      'position:fixed;right:16px;bottom:20px;background:#222;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.18);z-index:15000;opacity:0;transition:opacity .25s;';
    document.body.appendChild(toast);
  }
  toast.textContent = text;
  toast.style.opacity = '1';
  clearTimeout(toast._to);
  toast._to = setTimeout(() => { toast.style.opacity = '0'; }, tiempo);
}

/* -------------------------
   Reemplazo recomendado de openEditClienteModal(id)
   (Usa ID para evitar colisiones con versiones que reciben el objeto)
   ------------------------- */
/* -------------------------
   Editar Cliente (Modal con Select de Localidades)
------------------------- */
async function openEditClienteModal(id) {
  const { data, error } = await supabase.from('clientes').select('*').eq('id', id).single();
  if (error || !data) {
    console.error('Cliente no encontrado', error);
    return alert('Cliente no encontrado');
  }

  const cliente = data;

  // --- CORRECCI√ìN SEGURA DE hora_visita ---
  let formattedVisita = '';
  if (cliente.hora_visita) {
    const fecha = new Date(cliente.hora_visita);
    if (!isNaN(fecha.getTime())) { // Verifica que la fecha sea v√°lida
      formattedVisita = fecha.toISOString().substring(0, 16);
    } else {
      console.warn('Hora de visita inv√°lida para cliente ID:', cliente.id);
      formattedVisita = '';
    }
  }

  openModal(
    `Editar Cliente: ${escapeHtml(cliente.nombre_completo || '')}`,
    `
      <form id="editClienteForm" style="display:flex; flex-direction:column; gap:8px;">
        <label>Nombre completo</label>
        <input type="text" id="editClienteNombre" value="${escapeHtml(cliente.nombre_completo || '')}" required>

        <label>Localidad</label>
        <select id="editClienteLocalidad">
          <option value="">Cargando localidades...</option>
        </select>

        <label>DNI</label>
        <input type="text" id="editClienteDNI" value="${escapeHtml(cliente.dni || '')}">

        <label>Tel√©fono</label>
        <input type="text" id="editClienteTelefono" value="${escapeHtml(cliente.telefono || '')}">

        <label>Hora de visita (fecha y hora)</label>
        <input type="datetime-local" id="editClienteVisita" value="${formattedVisita}">

        <label>Estado de visita</label>
        <select id="editClienteEstado">
          <option value="Pendiente" ${cliente.estado_visita === 'Pendiente' ? 'selected' : ''}>‚è≥ Pendiente</option>
          <option value="Visitado" ${cliente.estado_visita === 'Visitado' ? 'selected' : ''}>‚úÖ Visitado</option>
        </select>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button type="button" onclick="updateCliente(${cliente.id})" style="background:#3498db;color:#fff;padding:10px;border:none;border-radius:6px;cursor:pointer;">üíæ Guardar</button>
          <button type="button" onclick="closeModal()" style="background:#95a5a6;color:#fff;padding:10px;border:none;border-radius:6px;cursor:pointer;">‚úñÔ∏è Cerrar</button>
        </div>
      </form>
    `
  );

  // --- CARGA DE LOCALIDADES EN EL SELECT ---
  const select = document.getElementById("editClienteLocalidad");
  if (!select) return;

  const { data: localidades, error: locError } = await supabase.from("localidades").select("nombre").order("nombre", { ascending: true });
  if (locError) {
    console.error("Error al cargar localidades:", locError);
    select.innerHTML = `<option value="">Error al cargar</option>`;
    return;
  }

  select.innerHTML = `<option value="">Seleccionar localidad...</option>`;
  localidades.forEach(loc => {
    const opt = document.createElement("option");
    opt.value = loc.nombre;
    opt.textContent = loc.nombre;
    if (loc.nombre === cliente.localidad) opt.selected = true;
    select.appendChild(opt);
  });
}



/* -------------------------
   Reemplazo recomendado de openEditClienteModal(id)
   (Usa ID para evitar colisiones con versiones que reciben el objeto)
   ------------------------- */

/* -------------------------
   Actualizar Cliente
------------------------- */
async function updateCliente(id) {
  const nombre = document.getElementById("editClienteNombre").value.trim();
  const localidad = document.getElementById("editClienteLocalidad").value.trim();
  const dni = document.getElementById("editClienteDNI").value.trim() || null;
  const telefono = document.getElementById("editClienteTelefono").value.trim() || null;
  const visita = document.getElementById("editClienteVisita").value;
  const estado = document.getElementById("editClienteEstado").value;

  if (!nombre || !localidad) {
    return alert("El Nombre/Apellido y la Localidad son campos requeridos.");
  }

  const hora_visita = visita ? new Date(visita).toISOString() : null;

  const { error } = await supabase.from("clientes").update({
    nombre_completo: nombre,
    localidad,
    dni,
    telefono,
    hora_visita,
    estado_visita: estado
  }).eq("id", id);

  if (error) {
    console.error("Error al actualizar cliente:", error);
    return alert("Error al actualizar cliente: " + error.message);
  }

  closeModal();
  fetchClientes();
  showToast("‚úÖ Cliente actualizado con √©xito");
}



/**
 * Elimina un cliente.
 */
async function deleteCliente(id){
    if(!confirm("¬øDesea eliminar este cliente permanentemente?")) return;
    
    const { error } = await supabase.from("clientes").delete().eq("id", id);
    
    if(error) {
        console.error(error);
        return alert("Error al eliminar cliente.");
    }
    fetchClientes();
    showToast('Cliente eliminado');
}


// ================= DOCUMENTOS =================
async function addDocumento() {
  const file = document.getElementById("docArchivo").files[0];
  if (!file) return alert("Seleccione un archivo");
  const fileName = `${Date.now()}_${file.name}`;

  const { error: uploadError } = await supabase.storage.from("private-documents").upload(fileName, file);
  if (uploadError) return alert("Error al subir: " + uploadError.message);

  await supabase.from("documentos").insert([{ nombre: file.name, archivo: fileName }]);
  document.getElementById("docArchivo").value = "";
  fetchDocumentos();
}

async function fetchDocumentos() {
  const { data, error } = await supabase.from("documentos").select("*").order("created_at", { ascending: false });
  const container = document.getElementById("docList");
  container.innerHTML = "";

  if (error) {
    container.innerHTML = `<span style="color:red;">Error: ${escapeHtml(error.message)}</span>`;
    return;
  }

  if (!data?.length) {
    container.innerHTML = '<span style="color:#888;">No hay documentos subidos.</span>';
    return;
  }

  const signedDocs = await Promise.all(
    data.map(async doc => {
      let url = "#";
      if (doc.archivo) {
        const { data: urlData } = await supabase.storage.from("private-documents").createSignedUrl(doc.archivo, 60 * 60);
        url = urlData?.signedUrl || "#";
      }
      const fecha = doc.created_at ? new Date(doc.created_at).toLocaleString() : '';
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;">
          <div>
            <a href="${url}" target="_blank">${escapeHtml(doc.nombre)}</a>
            <span style="color:#888;font-size:0.97em;margin-left:8px;">${fecha}</span>
          </div>
          <button onclick="deleteDocumento(${doc.id}, '${doc.archivo}')" style="background:#ff4d4f;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-weight:bold;cursor:pointer;">Eliminar</button>
        </div>
      `;
    })
  );

  container.innerHTML = signedDocs.join("");
}

async function deleteDocumento(id, archivo) {
  if (!confirm("¬øEliminar documento?")) return;
  await supabase.storage.from("private-documents").remove([archivo]);
  await supabase.from("documentos").delete().eq("id", id);
  fetchDocumentos();
}


// === INICIALIZACI√ìN DE EVENTOS ===
document.addEventListener('DOMContentLoaded', () => {
    // Conectar todos los botones de la barra lateral
    document.querySelectorAll('.sidebar .tab-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');

            if (tabName === 'promos_menu') {
                // L√≥gica especial para el desplegable
                const subMenu = document.getElementById('promoSubMenu');
                subMenu.classList.toggle('open');
                this.classList.toggle('active', subMenu.classList.contains('open'));
            } else {
                // Navegaci√≥n normal
                navigateTo(tabName);
            }
        });
    });  
  
  fetchCategorias();
  fetchLocalidades();
  fetchPromos();
  fetchOrders();
  fetchDocumentos();
  fetchClientes();
  cargarLocalidadesEnSelect();
  loadPromoSubMenu();

  const btnDocs = document.querySelector("button[data-tab='documentos']");
  if (btnDocs) btnDocs.addEventListener("click", fetchDocumentos);

  const menuBtn = document.getElementById('menuBtn');
  if (menuBtn) menuBtn.addEventListener('click', toggleSidebar);

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (window.innerWidth <= 500 && document.querySelector('.sidebar').classList.contains('open')) {
        toggleSidebar();
      }
    });
  });
});

// Funci√≥n √∫nica para manejar el cambio de secciones
function activateSection(tab) {
  // 1. Quita 'active' de todas las secciones
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));

  // 2. Activa la secci√≥n seleccionada
  const section = document.getElementById(tab);
  if (section) section.classList.add('active');

  // 3. Actualiza el men√∫ lateral
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${tab}"]`);
  if (btn) btn.classList.add('active');

  // 4. Carga los datos espec√≠ficos seg√∫n la pesta√±a
  if (tab === 'promos') fetchPromos();
  else if (tab === 'pedidos') fetchOrders();
  else if (tab === 'categorias') fetchCategorias();
  else if (tab === 'localidades') fetchLocalidades();
  else if (tab === 'clientes') fetchClientes();
  else if (tab === 'documentos') fetchDocumentos();

}

// Asigna los eventos de clic
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.getAttribute('data-tab');
    activateSection(tab);
    if (window.innerWidth <= 500 && document.querySelector('.sidebar').classList.contains('open')) {
      toggleSidebar();
    }
  });
});

// Mostrar 'Promos' por defecto al iniciar
activateSection('promos');

</script>
</body>
</html>



