<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>App Completa de Pedidos y Documentos</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Roboto',sans-serif; background:#f9f9f9; color:#333; display:flex; height:100vh; overflow:hidden;}
.sidebar { width:200px; background:#6a1b9a; display:flex; flex-direction:column; padding:20px;}
.sidebar button { margin-bottom:10px; padding:10px; border:none; border-radius:6px; font-weight:600; cursor:pointer; color:#fff; background:#7b1fa2;}
.sidebar button.active { background:#fff; color:#6a1b9a;}
.main { flex:1; overflow-y:auto; padding:20px;}
h1,h2{font-family:'Playfair Display',serif;}
.section { display:none; background:#fff; padding:20px; border-radius:15px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:20px;}
.item-card, .doc-item { display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background:#f4f4f4; margin-bottom:10px;}
.item-card img { width:50px;height:50px;object-fit:cover;border-radius:6px;margin-right:10px;}
button { cursor:pointer; border:none; border-radius:6px; padding:6px 10px; font-weight:600; background:#6a1b9a; color:#fff;}
button:hover{background:#7b1fa2;}
.delete-btn{background:#e53935;}
.delete-btn:hover{background:#f44336;}
#docProgressContainer{width:100%;background:#eee;border-radius:5px;margin-top:5px;}
#docProgress{width:0%;height:10px;background:green;border-radius:5px;transition:width 300ms;}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:999;}
.modal-content{background:#fff;padding:20px;border-radius:10px;max-width:500px;width:100%;position:relative;}
.modal-close{position:absolute;top:10px;right:10px;cursor:pointer;font-weight:bold;}
</style>
</head>
<body>

<div class="sidebar">
  <button class="tab-btn active" data-tab="promos">Promociones</button>
  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
  <button class="tab-btn" data-tab="categorias">Categorías</button>
  <button class="tab-btn" data-tab="localidades">Localidades</button>
  <button class="tab-btn" data-tab="documentos">Documentos</button>
</div>

<div class="main">
<h1>App Completa de Pedidos y Documentos</h1>

<!-- PROMOCIONES -->
<div class="section" id="promos">
<h2>Promociones</h2>
<form id="promoForm" onsubmit="return false;">
<label>Nombre:<input type="text" id="promoNombre" required></label>
<label>Precio:<input type="number" id="promoPrecio" step="0.01" required></label>
<label>Stock:<input type="number" id="promoStock" required></label>
<label>Categoría:<select id="promoCategoria"></select></label>
<label>Imagen:<input type="file" id="promoImagen" accept="image/*"></label>
<button type="button" id="addPromoBtn">Agregar Promoción</button>
<button type="button" id="exportPromoPdfBtn">Exportar Catálogo PDF</button>
</form>
<h3>Lista de Promociones</h3>
<div id="promoList"></div>
</div>

<!-- PEDIDOS -->
<div class="section" id="pedidos">
<h2>Pedidos</h2>
<form id="pedidoForm" onsubmit="return false;">
<label>Cliente:<input type="text" id="pedidoCliente" required></label>
<label>Producto:<input type="text" id="pedidoProducto" required></label>
<label>Cantidad:<input type="number" id="pedidoCantidad" required></label>
<label>Localidad:<select id="pedidoLocalidad"></select></label>
<button type="button" id="addOrderBtn">Agregar Pedido</button>
<button type="button" id="exportPedidosPDFBtn">Exportar PDF</button>
</form>
<h3>Lista de Pedidos</h3>
<div id="pedidoList"></div>
</div>

<!-- CATEGORÍAS -->
<div class="section" id="categorias">
<h2>Categorías de Promociones</h2>
<form id="categoriaForm" onsubmit="return false;">
<label>Nombre:<input type="text" id="categoriaNombre" required></label>
<button type="button" id="addCategoriaBtn">Agregar Categoría</button>
</form>
<h3>Lista de Categorías</h3>
<div id="categoriaList"></div>
</div>

<!-- LOCALIDADES -->
<div class="section" id="localidades">
<h2>Localidades</h2>
<form id="localidadForm" onsubmit="return false;">
<label>Nombre:<input type="text" id="localidadNombre" required></label>
<button type="button" id="addLocalidadBtn">Agregar Localidad</button>
</form>
<h3>Lista de Localidades</h3>
<div id="localidadList"></div>
</div>

<!-- DOCUMENTOS -->
<div class="section" id="documentos">
<h2>Documentos</h2>
<label>Buscar por DNI:</label>
<input type="text" id="searchDoc" placeholder="Escriba DNI...">
<input type="file" id="docFiles" multiple>
<button id="uploadDocsBtn">Subir Documentos</button>
<button id="deleteAllDocsBtn">Eliminar Todos</button>
<div id="docProgressContainer">
  <div id="docProgress"></div>
</div>
<h3>Documentos subidos:</h3>
<div id="documentsList"></div>
</div>

<!-- MODAL -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal-content" id="modalContent">
    <span class="modal-close" onclick="closeModal()">×</span>
  </div>
</div>

<script>
// -------------------- Supabase --------------------
const SUPABASE_URL='https://ejbqlejlgprvwzrptojo.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// -------------------- Helpers --------------------
function showToast(msg,d=3000){ 
  const t=document.createElement('div'); 
  t.textContent=msg; 
  Object.assign(t.style,{position:'fixed',bottom:'20px',right:'20px',background:'#6a1b9a',color:'#fff',padding:'10px 15px',borderRadius:'5px',opacity:'0.95'}); 
  document.body.appendChild(t); 
  setTimeout(()=>t.remove(),d);
}
function openModal(title,html){ 
  const modal=document.getElementById('modal'); 
  const content=document.getElementById('modalContent'); 
  content.innerHTML=`<span class="modal-close" onclick="closeModal()">×</span><h3>${title}</h3>${html}`; 
  modal.style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
async function safeGetFileUrl(fileName,bucket='promo_images'){ 
  try{
    const {data,error}=await supabase.storage.from(bucket).createSignedUrl(fileName,3600); 
    return error?null:data.signedUrl;
  }catch{return null;}
}

// -------------------- Tabs --------------------
const tabBtns=document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn=>btn.addEventListener('click',()=>{
  tabBtns.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(btn.dataset.tab).style.display='block';
}));
document.getElementById('promos').style.display='block';

// -------------------- CATEGORÍAS --------------------
async function fetchCategorias(){
  const {data,error}=await supabase.from('categorias').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('categoriaList'); container.innerHTML='';
  const select=document.getElementById('promoCategoria'); select.innerHTML='<option value="">Seleccione</option>';
  data.forEach(cat=>{
    select.innerHTML+=`<option value="${cat.id}">${cat.nombre}</option>`;
    const div=document.createElement('div'); div.className='item-card';
    div.innerHTML=`<span>${cat.nombre}</span> 
      <div>
        <button onclick="editCategoria(${cat.id},'${cat.nombre}')">Editar</button>
        <button class="delete-btn" onclick="deleteCategoria(${cat.id})">Eliminar</button>
      </div>`;
    container.appendChild(div);
  });
}
async function addCategoria(){
  const nombre=document.getElementById('categoriaNombre').value.trim();
  if(!nombre) return alert('Ingrese nombre'); 
  const {error}=await supabase.from('categorias').insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById('categoriaForm').reset();
  fetchCategorias();
}
document.getElementById('addCategoriaBtn').addEventListener('click',addCategoria);
fetchCategorias();

// -------------------- LOCALIDADES --------------------
async function fetchLocalidades(){
  const {data,error}=await supabase.from('localidades').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('localidadList'); container.innerHTML='';
  const select=document.getElementById('pedidoLocalidad'); select.innerHTML='<option value="">Seleccione</option>';
  data.forEach(loc=>{
    select.innerHTML+=`<option value="${loc.id}">${loc.nombre}</option>`;
    const div=document.createElement('div'); div.className='item-card';
    div.innerHTML=`<span>${loc.nombre}</span> 
      <div>
        <button class="delete-btn" onclick="deleteLocalidad(${loc.id})">Eliminar</button>
      </div>`;
    container.appendChild(div);
  });
}
async function addLocalidad(){
  const nombre=document.getElementById('localidadNombre').value.trim();
  if(!nombre) return alert('Ingrese nombre'); 
  const {error}=await supabase.from('localidades').insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById('localidadForm').reset();
  fetchLocalidades();
}
document.getElementById('addLocalidadBtn').addEventListener('click',addLocalidad);
fetchLocalidades();

// -------------------- PROMOCIONES --------------------
async function fetchPromotions(){
  const {data,error}=await supabase.from('promociones').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('promoList'); container.innerHTML='';
  for(let promo of data){
    const imgHTML=promo.imagen?`<img src="${await safeGetFileUrl(promo.imagen)}">`:'';
    const card=document.createElement('div'); card.className='item-card';
    card.innerHTML=`${imgHTML}<div><strong>${promo.nombre}</strong><br>$${promo.precio} - Stock: ${promo.stock}</div>`;
    container.appendChild(card);
  }
}

// Exportar catálogo PDF mejorado
document.getElementById('exportPromoPdfBtn').addEventListener('click', async ()=>{
  const {data:promos,error}=await supabase.from('promociones').select('*').order('id');
  if(error) return alert(error.message);
  if(!promos.length) return alert("No hay promociones para exportar.");

  // Convertir imagenes a base64 para que aparezcan en el PDF
  async function toBase64(url){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      img.setAttribute("crossorigin","anonymous");
      img.onload=()=>{
        const canvas=document.createElement("canvas");
        canvas.width=img.width; canvas.height=img.height;
        const ctx=canvas.getContext("2d");
        ctx.drawImage(img,0,0);
        resolve(canvas.toDataURL("image/jpeg",0.95));
      };
      img.onerror=()=>resolve(null);
      img.src=url;
    });
  }

  let html = `<div style="font-family: Arial, sans-serif; width:100%;">
      <h2 style="text-align:center; margin-bottom:20px;">📖 Catálogo de Promociones</h2>`;

  for(let [i,promo] of promos.entries()){
    const url=promo.imagen?await safeGetFileUrl(promo.imagen):null;
    const img64=url?await toBase64(url):null;

    html += `
      <div style="display:flex; align-items:center; margin-bottom:20px; border:1px solid #ddd; border-radius:10px; padding:12px; page-break-inside:avoid;">
        ${img64?`<img src="${img64}" style="width:120px; height:120px; margin-right:15px; object-fit:cover; border-radius:8px; border:1px solid #ccc;">`:''}
        <div>
          <p style="margin:0; font-size:15px;"><strong>${promo.nombre}</strong></p>
          <p style="margin:6px 0; font-size:14px;">💲 <strong>$${promo.precio.toFixed(2)}</strong></p>
        </div>
      </div>`;

    // Salto de página cada 4 promociones
    if((i+1)%4===0) html+=`<div style="page-break-after:always;"></div>`;
  }

  html += '</div>';

  const opt = {
    margin:0.5,
    filename:'catalogo_promociones.pdf',
    image:{ type:'jpeg', quality:1 },
    html2canvas:{ scale:2, useCORS:true },
    jsPDF:{ unit:'in', format:'a4', orientation:'landscape' } // horizontal
  };

  html2pdf().from(html).set(opt).save();
});


// -------------------- PEDIDOS (simplificado aún) --------------------
async function fetchOrders(){
  const {data,error}=await supabase.from('pedidos').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('pedidoList'); container.innerHTML='';
  data.forEach(p=>{
    const div=document.createElement('div'); div.className='item-card';
    div.innerHTML=`<span>${p.cliente} pidió ${p.cantidad} x ${p.producto}</span>`;
    container.appendChild(div);
  });
}
document.getElementById('addOrderBtn').addEventListener('click',async()=>{
  const cliente=document.getElementById('pedidoCliente').value.trim();
  const producto=document.getElementById('pedidoProducto').value.trim();
  const cantidad=parseInt(document.getElementById('pedidoCantidad').value,10);
  if(!cliente||!producto||isNaN(cantidad)) return alert('Complete campos');
  const {error}=await supabase.from('pedidos').insert([{cliente,producto,cantidad}]);
  if(error) return alert(error.message);
  document.getElementById('pedidoForm').reset(); fetchOrders(); showToast('Pedido agregado');
});
fetchOrders();

// -------------------- DOCUMENTOS --------------------
async function fetchDocuments(filter=''){
  const {data,error}=await supabase.storage.from('private-documents').list('',{limit:200});
  if(error) return console.error(error);
  const container=document.getElementById('documentsList'); container.innerHTML='';
  for(let f of data){
    if(!f.name.includes(filter)) continue;
    const {data:urlData}=await supabase.storage.from('private-documents').createSignedUrl(f.name,3600);
    const div=document.createElement('div'); div.className='doc-item';
    div.innerHTML=`<a href="${urlData.signedUrl}" target="_blank">${f.name}</a>`;
    container.appendChild(div);
  }
}
document.getElementById('uploadDocsBtn').addEventListener('click',async()=>{
  const files=document.getElementById('docFiles').files;
  if(!files.length) return alert('Seleccione archivos');
  for(let file of files){
    const storageName=`${Date.now()}_${file.name.replaceAll(' ','_')}`;
    await supabase.storage.from('private-documents').upload(storageName,file,{upsert:true});
  }
  document.getElementById('docFiles').value=''; showToast('Documentos subidos'); fetchDocuments();
});
document.getElementById('searchDoc').addEventListener('input',(e)=>fetchDocuments(e.target.value));
fetchDocuments();

</script>
</body>
</html>

