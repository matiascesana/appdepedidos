<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>App de Pedidos y Documentos (Producción)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Roboto', sans-serif;
    padding: 30px;
    background: #f9f9f9;
    color: #333;
}
h1, h2 { font-family: 'Playfair Display', serif; }
h1 { text-align:center; margin-bottom:40px; }
.section {
    background:#fff;
    padding:25px;
    margin-bottom:40px;
    border-radius:15px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
form label { display:block; margin-bottom:10px; font-weight:500; }
form input { width:100%; padding:8px 12px; margin-top:4px; margin-bottom:15px; border-radius:6px; border:1px solid #ccc; }
button {
    background:#6a1b9a;
    color:#fff;
    padding:10px 20px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
}
button:hover { background:#7b1fa2; }
#docProgressContainer { width:100%; background:#eee; border-radius:5px; margin-top:5px; position:relative; }
#docProgress { width:0%; height:10px; background:green; border-radius:5px; transition: width 300ms ease; }
#docProgressText { position:absolute; top:0; left:50%; transform:translateX(-50%); font-size:10px; font-weight:bold; color:#fff; }
.item-card { background:#f4f4f4; padding:10px 15px; border-radius:10px; margin-bottom:10px; display:flex; align-items:center; gap:10px; transition:transform 0.2s ease, background 0.2s ease; }
.item-card:hover { background:#e8e8e8; transform:translateY(-2px); }
.item-card img { border-radius:6px; width:50px; height:50px; object-fit:cover; }
a { color:#6a1b9a; text-decoration:none; }
a:hover { text-decoration:underline; }
.doc-item { display:flex; align-items:center; justify-content:space-between; margin-bottom:5px; padding:5px 10px; border-radius:6px; background:#f4f4f4; }
.doc-item button { background:#c62828; margin-left:10px; padding:3px 8px; font-size:12px; }
.doc-item button:hover { background:#e53935; }
</style>
</head>
<body>
<h1>App de Pedidos, Promociones y Documentos</h1>

<!-- Sección Promociones -->
<div class="section">
<h2>Promociones</h2>
<form id="promoForm" onsubmit="return false;">
<label>Nombre: <input type="text" id="promoNombre" required></label>
<label>Precio: <input type="number" id="promoPrecio" step="0.01" required></label>
<label>Stock: <input type="number" id="promoStock" required></label>
<label>Imagen: <input type="file" id="promoImagen" accept="image/*"></label>
<button type="button" id="addPromoBtn">Agregar Promoción</button>
</form>
<h3>Lista de Promociones</h3>
<div id="promoList"></div>
</div>

<!-- Sección Pedidos -->
<div class="section">
<h2>Pedidos</h2>
<form id="pedidoForm" onsubmit="return false;">
<label>Cliente: <input type="text" id="pedidoCliente" required></label>
<label>Producto: <input type="text" id="pedidoProducto" required></label>
<label>Cantidad: <input type="number" id="pedidoCantidad" required></label>
<button type="button" id="addOrderBtn">Agregar Pedido</button>
</form>
<h3>Lista de Pedidos</h3>
<div id="pedidoList"></div>
</div>

<!-- Sección Documentos -->
<div class="section">
<h2>Documentos</h2>
<input type="file" id="docFiles" multiple>
<button id="uploadDocsBtn">Subir Documentos</button>
<button id="deleteAllDocsBtn" style="background:#c62828;">Eliminar Todos</button>
<div id="docProgressContainer">
    <div id="docProgress"></div>
    <div id="docProgressText">0%</div>
</div>
<h3>Documentos subidos:</h3>
<div id="documentsList"></div>
</div>

<script>
// Supabase config
const SUPABASE_URL = 'https://ejbqlejlgprvwzrptojo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Toast utility
function showToast(msg, timeout=3000){
    const toast = document.createElement('div');
    toast.textContent = msg;
    Object.assign(toast.style, {position:'fixed',bottom:'20px',right:'20px',background:'#6a1b9a',color:'#fff',padding:'10px 15px',borderRadius:'5px',opacity:'0.95'});
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), timeout);
}

// ---------- PROMOCIONES ----------
document.getElementById('addPromoBtn').addEventListener('click', addPromotion);
async function addPromotion(){
    if(!supabase) return alert('Supabase no configurado.');
    const nombre = document.getElementById('promoNombre').value.trim();
    const precio = parseFloat(document.getElementById('promoPrecio').value);
    const stock = parseInt(document.getElementById('promoStock').value,10);
    const imagenFile = document.getElementById('promoImagen').files[0];
    if(!nombre || Number.isNaN(precio) || Number.isNaN(stock)) return alert('Complete todos los campos correctamente');

    let imagePath = null;
    if(imagenFile){
        const fileName = `${Date.now()}_${imagenFile.name.replaceAll(' ','_')}`;
        const { error } = await supabase.storage.from('promo_images').upload(fileName, imagenFile, {upsert:true});
        if(error){ console.error(error); return alert('Error subiendo imagen'); }
        imagePath = fileName;
    }

    try{
        const { error } = await supabase.from('promociones').insert([{nombre, precio, stock, imagen:imagePath}]);
        if(error) throw error;
        document.getElementById('promoForm').reset();
        try{ document.getElementById('promoImagen').value = null; } catch(e){ document.getElementById('promoImagen').value=''; }
        fetchPromotions();
        showToast('Promoción agregada');
    }catch(err){ alert(err.message || 'Error'); console.error(err); }
}

async function fetchPromotions(){
    if(!supabase) return;
    const { data, error } = await supabase.from('promociones').select().limit(200);
    if(error) return console.error(error);
    const container = document.getElementById('promoList'); container.innerHTML='';
    for(let promo of data){
        const card = document.createElement('div'); card.className='item-card';
        if(promo.imagen){
            const img = document.createElement('img');
            const url = await safeGetFileUrl(promo.imagen,'promo_images');
            if(url) img.src=url; img.alt=promo.nombre||'imagen';
            card.appendChild(img);
        }
        const text = document.createElement('div');
        const title = document.createElement('strong'); title.textContent=promo.nombre||''; text.appendChild(title);
        const meta = document.createElement('div'); meta.textContent=`$${promo.precio ?? ''} - Stock: ${promo.stock ?? ''}`; text.appendChild(meta);
        card.appendChild(text);
        container.appendChild(card);
    }
}

// ---------- PEDIDOS ----------
document.getElementById('addOrderBtn').addEventListener('click', addOrder);
async function addOrder(){
    if(!supabase) return alert('Supabase no configurado.');
    const cliente=document.getElementById('pedidoCliente').value.trim();
    const producto=document.getElementById('pedidoProducto').value.trim();
    const cantidad=parseInt(document.getElementById('pedidoCantidad').value,10);
    if(!cliente || !producto || Number.isNaN(cantidad)) return alert('Complete todos los campos correctamente');
    try{
        const { error } = await supabase.from('pedidos').insert([{cliente, producto, cantidad}]);
        if(error) throw error;
        document.getElementById('pedidoForm').reset();
        fetchOrders();
        showToast('Pedido agregado');
    }catch(err){ alert(err.message||'Error'); console.error(err); }
}

async function fetchOrders(){
    if(!supabase) return;
    const { data, error } = await supabase.from('pedidos').select().limit(200);
    if(error) return console.error(error);
    const container=document.getElementById('pedidoList'); container.innerHTML='';
    for(let pedido of data){
        const card=document.createElement('div'); card.className='item-card';
        card.textContent=`${pedido.cliente} pidió ${pedido.cantidad} x ${pedido.producto}`;
        container.appendChild(card);
    }
}

// ---------- DOCUMENTOS ----------
document.getElementById('uploadDocsBtn').addEventListener('click', uploadFiles);
document.getElementById('deleteAllDocsBtn').addEventListener('click', deleteAllDocuments);

async function uploadFiles(){
    if(!supabase) return alert('Supabase no configurado.');
    const files=document.getElementById('docFiles').files;
    if(!files || files.length==0) return alert('Seleccione archivos');
    const progressElem=document.getElementById('docProgress');
    const progressText=document.getElementById('docProgressText');
    for(let i=0;i<files.length;i++){
        const file=files[i]; const fileName=`${Date.now()}_${file.name.replaceAll(' ','_')}`;
        try{
            const { error } = await supabase.storage.from('private-documents').upload(fileName,file,{upsert:true});
            if(error) throw error;
            const pct=Math.round(((i+1)/files.length)*100);
            progressElem.style.width=pct+'%'; progressText.textContent=pct+'%';
        }catch(err){ alert('Error subiendo '+file.name); progressElem.style.width='0%'; progressText.textContent='0%'; return; }
    }
    try{ document.getElementById('docFiles').value=null; } catch(e){ document.getElementById('docFiles').value=''; }
    progressElem.style.width='0%'; progressText.textContent='0%';
    showToast('Documentos subidos');
    fetchDocuments();
}

async function fetchDocuments(){
    if(!supabase) return;
    const { data, error } = await supabase.storage.from('private-documents').list('',{limit:100});
    if(error) return console.error(error);
    const container=document.getElementById('documentsList'); container.innerHTML='';
    for(let file of data){
        const div=document.createElement('div'); div.className='doc-item';
        const url=await safeGetFileUrl(file.name,'private-documents');
        const link=document.createElement('a'); link.href=url||'#'; link.target='_blank'; link.rel='noopener noreferrer'; link.textContent=file.name;
        const delBtn=document.createElement('button'); delBtn.textContent='Eliminar'; delBtn.onclick=()=>deleteDocument(file.name);
        div.appendChild(link); div.appendChild(delBtn); container.appendChild(div);
    }
}

async function deleteDocument(fileName){
    if(!supabase) return;
    if(!confirm('Eliminar este documento?')) return;
    const { error } = await supabase.storage.from('private-documents').remove([fileName]);
    if(error){ alert('Error eliminando'); console.error(error); return; }
    showToast('Documento eliminado');
    fetchDocuments();
}

async function deleteAllDocuments(){
    if(!supabase) return;
    if(!confirm('Eliminar TODOS los documentos?')) return;
    const { data, error } = await supabase.storage.from('private-documents').list('',{limit:1000});
    if(error) return console.error(error);
    const files = data.map(f=>f.name);
    if(files.length===0) return;
    const { error: delErr } = await supabase.storage.from('private-documents').remove(files);
    if(delErr){ alert('Error eliminando'); console.error(delErr); return; }
    showToast('Todos los documentos eliminados');
    fetchDocuments();
}

// ---------- HELPERS ----------
async function safeGetFileUrl(fileName,bucket='private-documents'){
    if(!supabase) return null;
    try{
        const { data, error } = await supabase.storage.from(bucket).createSignedUrl(fileName,3600);
        if(error) { console.warn(error); return null; }
        return data.signedUrl;
    }catch(err){ console.error(err); return null; }
}

// ---------- INIT ----------
(async function init(){
    if(!supabase){ showToast('Supabase SDK no configurado',5000); return; }
    try{
        await fetchPromotions();
        await fetchOrders();
        await fetchDocuments();
    }catch(err){ console.error(err); }
})();
</script>
</body>
</html>

