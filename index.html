<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Administrativo Completo</title>
<style>


:root {
  --sidebar-bg: #2c3e50;
  --sidebar-hover: #34495e;
  --accent: #ff4d4f;
  --card-bg: #fff;
  --text-muted: #555;
}


body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; background:#f0f2f5; }
.sidebar { width:220px; background:var(--sidebar-bg); color:#fff; display:flex; flex-direction:column; padding-top:20px; flex-shrink:0; }
.sidebar h2 { text-align:center; margin-bottom:20px; font-size:22px; }
.sidebar button { background:none; border:none; color:white; text-align:left; padding:12px 20px; cursor:pointer; font-size:16px; width:100%; transition:0.2s; }
.sidebar button:hover, .sidebar button.active { background:var(--sidebar-hover); }
.content { flex:1; padding:20px; overflow-y:auto; }
.section { display:none; }
.section.active { display:block; }
h1 { margin-top:0; margin-bottom:15px; }


/* Tarjetas y listas */
.card { display:flex; align-items:center; gap:15px; background:var(--card-bg); padding:15px; border-radius:10px; margin-bottom:12px; border:1px solid #ddd; transition:0.3s; }
.card:hover { box-shadow:0 6px 18px rgba(0,0,0,0.15); }
.card img { width:100px; height:100px; object-fit:cover; border-radius:10px; border:1px solid #ccc; }
.card-info { flex:1; display:flex; flex-direction:column; gap:6px; }
.card-info b { font-size:1.1em; }
.card-price { font-size:1em; color:var(--accent); }
.card-price del { color:#999; margin-right:6px; }
.card-stock { font-size:0.85em; color:var(--text-muted); }
.card-actions { display:flex; flex-direction:column; gap:6px; }
.card-actions button { cursor:pointer; border:none; border-radius:6px; padding:6px 12px; font-weight:bold; transition:0.2s; }
.card-actions .edit-btn { background:#3498db; color:#fff; }
.card-actions .edit-btn:hover { background:#2980b9; }
.card-actions .delete-btn { background:var(--accent); color:#fff; }
.card-actions .delete-btn:hover { background:#e8434f; }

/* Modal */
#modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:9999; }
#modalInner { background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:90%; overflow-y:auto; }
input, select, button { margin-bottom:8px; padding:6px; font-size:14px; border-radius:4px; border:1px solid #ccc; }
button[type=submit]{background:var(--accent); color:#fff; border:none; cursor:pointer;}
button[type=submit]:hover{background:#e8434f;}


</head>
<body>
</script>



/* ========== RESPONSIVE MEDIA QUERIES ========== */

/* --- NUEVO BOT√ìN DE MEN√ö (Oculto por defecto) --- */
#menuBtn {
    display: none; /* Oculto en escritorio */
    position: fixed;
    top: 10px;
    left: 10px;
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
    z-index: 9500; /* Sobre la sidebar */
}


/* --- ESTILOS BASE DE LA BARRA LATERAL (Escritorio) --- */
.sidebar { 
    width: 220px; 
    background: var(--sidebar-bg); 
    color: #fff; 
    display: flex; 
    flex-direction: column; 
    padding-top: 20px; 
    flex-shrink: 0; 
    transition: transform 0.3s ease; /* üëà A√±adir transici√≥n para el deslizamiento */
    z-index: 9000; /* Asegurar que est√© sobre el contenido */
}


/* --- RESPONSIVE MEDIA QUERY (M√≥vil) --- */
@media (max-width: 500px) {
    /* El bot√≥n de men√∫ solo aparece en m√≥vil */
    #menuBtn { 
        display: block; 
    }

    /* La sidebar se oculta */
    .sidebar {
        /* Deslizamos fuera de la vista */
        transform: translateX(-100%); 
        position: fixed; /* Fija en la pantalla */
        top: 0; 
        left: 0; 
        height: 100vh; /* Ocupa toda la altura */
        width: 70%; /* Ocupa 70% del ancho de la pantalla */
        padding-top: 50px; /* Espacio para que el contenido no quede pegado al top */
        flex-direction: column; /* Vuelve a ser vertical */
        box-shadow: 2px 0 10px rgba(0,0,0,0.5);
    }
    
    /* Estado "abierto" de la sidebar */
    .sidebar.open {
        transform: translateX(0); /* Deslizar a la vista */
    }

    /* El contenido ocupa todo el espacio */
    .content {
        flex: 1;
        padding: 8px; 
        margin-top: 50px; /* Para no quedar debajo del bot√≥n de men√∫ */
    }
    
    .sidebar h2 { display: block; text-align: center; }
    .sidebar button {
        text-align: left;
        font-size: 16px; 
        padding: 12px 20px;
        /* Quitamos el flex: 1 de la versi√≥n anterior para que no se repartan */
    }
    
    /* ... (mantener el resto de los estilos de tarjetas y modales para 500px) ... */
    
    /* El fondo oscuro para simular el "canvas" oculto */
.backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 8000;
    /* üí• SOLUCI√ìN 1: Ignorar el clic por defecto üí• */
    pointer-events: none; 
}
.backdrop.show { 
    display: block; 
    /* üí• SOLUCI√ìN 2: Solo interceptar clics cuando est√° visible (sidebar abierta) üí• */
    pointer-events: auto; 
}

</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>


  <div class="sidebar">
¬† 
<button id="menuBtn">‚ò∞</button>
<div id="backdrop" class="backdrop" onclick="toggleSidebar()"></div> 
    <h2>MENU</h2>
  
¬† <button class="tab-btn active" data-tab="promos">Promociones</button>
¬† <button class="tab-btn" data-tab="pedidos">Pedidos</button>
¬† <button class="tab-btn" data-tab="categorias">Categor√≠as</button>
¬† <button class="tab-btn" data-tab="localidades">Localidades</button>
¬† <button class="tab-btn" data-tab="documentos">Documentos</button>
¬† <button class="tab-btn" data-tab="clientes">Clientes</button>
</div> <div class="content">

    <!-- CLIENTES -->
    <div id="clientes" class="section">
      <h1>Gesti√≥n de Clientes</h1>
      <form id="clienteForm" onsubmit="event.preventDefault(); addClienteRapido();" style="display:flex; gap:10px; margin-bottom: 20px; align-items:center; flex-wrap:wrap; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fff;">
  <input type="text" id="clienteNombre" placeholder="Nombre y Apellido" required style="flex: 2; min-width: 150px;">
  <input type="text" id="clienteLocalidad" placeholder="Localidad" required style="flex: 1; min-width: 100px;">
  <input type="text" id="clienteHora" placeholder="Hora (Ej: 14:30)" style="flex: 1; min-width: 90px;">
  <button type="submit" style="background: #27ae60; color:#fff; border:none; padding:8px 15px; flex-shrink: 0;">‚ûï Carga R√°pida</button>
</form>
 
<h3>B√∫squeda de Clientes</h3>

<input type="text" id="clienteSearch" placeholder="üîç Buscar cliente por nombre..." 
       oninput="fetchClientes()" 
       style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 6px;">

<h3>Lista de Clientes y Seguimiento</h3><div id="clienteList">
  </div>
    
  </div>


  <!-- PROMOCIONES -->
  <div id="promos" class="section active">
    <h1>Gesti√≥n de Promociones</h1>
    <form id="promoForm" onsubmit="event.preventDefault(); addPromo();">
      <input type="text" id="promoNombre" placeholder="Nombre" required>
      <input type="number" id="promoPrecio" placeholder="Precio" step="0.01" required>
      <input type="number" id="promoPrecioAnterior" placeholder="Precio anterior" step="0.01">
      <input type="number" id="promoStock" placeholder="Stock">
      <select id="promoCategoria"></select>
      <input type="file" id="promoImagen" accept="image/*">
      <button type="submit">Agregar promoci√≥n</button>
    </form>
    <button onclick="exportPDF()">Exportar PDF</button>
    <div id="promoList"></div>
  </div>

  <!-- CATEGOR√çAS -->
  <div id="categorias" class="section">
    <h1>Gesti√≥n de Categor√≠as</h1>
    <input type="text" id="categoriaNombre" placeholder="Nueva categor√≠a">
    <button onclick="addCategoria()">Agregar</button>
    <div id="categoriaList"></div>
  </div>

  <!-- LOCALIDADES -->
  <div id="localidades" class="section">
    <h1>Gesti√≥n de Localidades</h1>
    <input type="text" id="localidadNombre" placeholder="Nueva localidad">
    <button onclick="addLocalidad()">Agregar</button>
    <div id="localidadList"></div>
  </div>

  <!-- PEDIDOS -->
  <div class="section" id="pedidos">
    <h2>Pedidos</h2>
    <form id="pedidoForm" onsubmit="return false;" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
      <div style="flex:1;min-width:220px">
        <label>Cliente
          <input id="pedidoCliente" type="text" placeholder="Nombre cliente">
        </label>
      </div>
      <div style="width:220px">
        <label>Localidad
          <select id="pedidoLocalidad"></select>
        </label>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button type="button" id="selectProductsBtn">Seleccionar Productos</button>
      </div>

      <div style="width:100%;margin-top:6px">
        <div id="selectedProductsContainer" class="small-muted"></div>
      </div>

      <div style="display:flex;gap:8px">
        <button type="button" id="addOrderBtn">Agregar Pedido</button>
        <button type="button" id="exportPedidosPDFBtn">Exportar Pedidos (PDF)</button>
      </div>
    </form>

    <h3>Lista de Pedidos</h3>
    <div id="pedidoList"></div>
  </div>


  <!-- DOCUMENTOS -->
<div id="documentos" class="section">
  <h1>Gesti√≥n de Documentos</h1>
  <input type="file" id="docArchivo">
  <button onclick="addDocumento()">Agregar Documento</button>
  <button onclick="fetchDocumentos()">Actualizar Documentos</button>
  <div id="docList" style="margin-top:18px;"></div>
</div>

</div>

<div id="modal"><div id="modalInner"></div></div>

<script>
// --- SIDEBAR / TABS --- (MODIFICADO Y DEPURADO)
console.log("Tabs JS cargado");

/* ========== MANEJO DE PESTA√ëAS Y CIERRE DE SIDEBAR EN M√ìVIL ========== */
document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', () => {
        const tab = button.getAttribute('data-tab');
        
        // 1. L√≥gica de cambio de pesta√±a (original)
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
        document.getElementById(tab).classList.add('active');

        // 2. L√≥gica de cierre de sidebar (NUEVO: Integrado)
        // Cierra la sidebar si est√° abierta y estamos en m√≥vil
        if (window.innerWidth <= 500 && document.querySelector('.sidebar').classList.contains('open')) {
            toggleSidebar(); // Esta funci√≥n ya la definiste, solo la llamamos.
        }
    });
});


// --- CONFIGURACI√ìN SUPABASE ---
const SUPABASE_URL="https://ejbqlejlgprvwzrptojo.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";
const supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// --- SIDEBAR --- (modificado para m√≥viles)
// --- DEPURACI√ìN DE TABS ---
console.log("Script tabs cargado");
document.querySelectorAll(".tab-btn").forEach(btn=>{
  ['click', 'touchstart'].forEach(ev=>{
    btn.addEventListener(ev, ()=>{
      console.log("Tab clicked:", btn.dataset.tab);
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });
});



// --- MODAL ---
function openModal(title, html){ document.getElementById("modalInner").innerHTML=`<h3>${title}</h3>${html}`; document.getElementById("modal").style.display="flex"; }
function closeModal(){ document.getElementById("modal").style.display="none"; }
document.getElementById("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });

// --- ESCAPE HTML ---
function escapeHtml(text){ var div=document.createElement("div"); div.innerText=text; return div.innerHTML; }


// ================= PROMOCIONES =================
async function fetchPromotions() {
    console.log('üëâ fetchPromotions ejecutado');

    const { data, error } = await supabase
        .from('promociones')
        .select('*, categorias(nombre)')
        .order('id');

    if (error) return console.error(error);

    const container = document.getElementById('promoList');
    container.innerHTML = '';

    // Agrupar promociones por categor√≠a
    const groupedPromos = data.reduce((groups, promo) => {
        const categoryName = promo.categorias?.nombre || 'Sin Categor√≠a';
        if (!groups[categoryName]) groups[categoryName] = [];
        groups[categoryName].push(promo);
        return groups;
    }, {});

    const categoryNames = Object.keys(groupedPromos).sort();

    for (const categoryName of categoryNames) {
        const promos = groupedPromos[categoryName];

        // T√≠tulo de categor√≠a
        const titleDiv = document.createElement('div');
        titleDiv.innerHTML = `<h3 style="margin-top: 20px; margin-bottom: 8px;">${categoryName}</h3>`;
        container.appendChild(titleDiv);

        for (const promo of promos) {
            // Obtener URL de imagen
            let imgUrl = '';
            if (promo.imagen) {
                const { data: signedData } = await supabase
                    .storage.from('promo_images')
                    .createSignedUrl(promo.imagen, 3600);
                imgUrl = signedData?.signedUrl || '';
            }

            const imgHTML = imgUrl
                ? `<img src="${imgUrl}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px">`
                : '';

            // Precio con tachado si aplica
            let precioHTML = `<strong>$${Number(promo.precio).toFixed(2)}</strong>`;
            if (promo.precio_anterior && Number(promo.precio_anterior) > Number(promo.precio)) {
                precioHTML = `<span style="text-decoration: line-through; color: #999; margin-right: 8px;">$${Number(promo.precio_anterior).toFixed(2)}</span>
                              <strong style="color: #ff4d4f; font-size: 1.1em;">$${Number(promo.precio).toFixed(2)}</strong>`;
            }

            // JSON seguro en dataset
            const div = document.createElement('div');
            div.className = 'item-card';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.marginBottom = '8px';

            div.innerHTML = `
                <input type="checkbox" class="promo-export-check" data-promo='${JSON.stringify({
                    id: promo.id,
                    nombre: promo.nombre,
                    precio: promo.precio,
                    precio_anterior: promo.precio_anterior,
                    stock: promo.stock,
                    imagen: promo.imagen,
                    categoria: categoryName
                }).replace(/'/g, "&apos;")}' checked style="margin-right: 12px; transform: scale(1.4);">
                ${imgHTML}
                <div style="flex:1">
                    <strong>${escapeHtml(promo.nombre || '')}</strong>
                    <div class="small-muted">${precioHTML} &nbsp; ¬∑ &nbsp; Stock: ${promo.stock ?? 0}</div>
                </div>
                <div>
                    <button class="edit-btn" data-promo='${JSON.stringify(promo).replace(/'/g, "&apos;")}'>Editar</button>
                    <button class="delete-btn" onclick="deletePromo(${promo.id}, '${promo.imagen || ''}')">Eliminar</button>
                </div>
            `;
            container.appendChild(div);

            // Vincular evento de edici√≥n
            div.querySelector('.edit-btn').addEventListener('click', () => editPromo(promo));
        }
    }
}

async function addPromo() {
    const nombre = document.getElementById("promoNombre").value.trim();
    const precio = document.getElementById("promoPrecio").value;
    const precio_anterior = document.getElementById("promoPrecioAnterior").value;
    const stock = document.getElementById("promoStock").value;
    const categoria = document.getElementById("promoCategoria").value;
    const file = document.getElementById("promoImagen").files[0];
    if (!nombre || !precio) return alert("Nombre y precio requeridos");

    let fileName = null;
    if (file) {
        fileName = `${Date.now()}_${file.name}`;
        await supabase.storage.from("promo_images").upload(fileName, file);
    }

    const { error } = await supabase.from("promociones").insert([{
        nombre,
        precio,
        precio_anterior: precio_anterior || null,
        stock: stock || 0,
        categoria_id: categoria,
        imagen: fileName
    }]);

    if (error) return alert(error.message);
    document.getElementById("promoForm").reset();
    fetchPromotions();
}

async function editPromo(promo){
  let imagenFinalUrl = "";
  if (promo.imagen) {
    const { data: signedData } = await supabase
      .storage.from('promo_images')
      .createSignedUrl(promo.imagen, 3600);
    imagenFinalUrl = signedData?.signedUrl || "";
  }

  openModal(
    `
    <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:18px;">
      ${imagenFinalUrl 
        ? `<img src="${imagenFinalUrl}" alt="Imagen promoci√≥n" style="width:120px;height:120px;object-fit:cover;border-radius:10px;border:1px solid #ccc;margin-bottom:10px;">` 
        : '<div style="color:#aaa;margin-bottom:10px;">Sin imagen actual</div>'}
      <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:2em;">‚úèÔ∏è</span>
        <h2 style="margin:0;">${escapeHtml(promo.nombre)}</h2>
      </div>
    </div>
    <div style="background:#f8f8f8;border-radius:12px;padding:20px 18px;box-shadow:0 2px 12px rgba(0,0,0,0.07);">
      <div style="margin-bottom:16px;">
        <label for="editNombre" style="font-weight:500;display:block;margin-bottom:4px;">Nombre de la promoci√≥n</label>
        <input type="text" id="editNombre" value="${escapeHtml(promo.nombre)}" placeholder="Ej: Combo Milanesa">
      </div>
      <div style="margin-bottom:16px;">
        <label for="editPrecio" style="font-weight:500;display:block;margin-bottom:4px;">Precio actual ($)</label>
        <input type="number" id="editPrecio" value="${promo.precio}" step="0.01" placeholder="Ej: 1200.00">
      </div>
      <div style="margin-bottom:16px;">
        <label for="editPrecioAnterior" style="font-weight:500;display:block;margin-bottom:4px;">Precio anterior ($)</label>
        <input type="number" id="editPrecioAnterior" value="${promo.precio_anterior||''}" step="0.01" placeholder="Ej: 1350.00">
      </div>
      <div style="margin-bottom:16px;">
        <label for="editStock" style="font-weight:500;display:block;margin-bottom:4px;">Stock disponible</label>
        <input type="number" id="editStock" value="${promo.stock||0}" placeholder="Ej: 15">
      </div>
      <div style="margin-bottom:16px;">
        <label for="editCategoria" style="font-weight:500;display:block;margin-bottom:4px;">Categor√≠a</label>
        <select id="editCategoria"></select>
      </div>
      <div style="margin-bottom:18px;">
        <label for="editImagen" style="font-weight:500;display:block;margin-bottom:4px;">Imagen (opcional)</label>
        <input type="file" id="editImagen">
      </div>
      <button onclick="updatePromo(${promo.id})" style="margin-top:10px;background:#3498db;color:#fff;border:none;padding:12px 20px;border-radius:7px;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:8px;">
        üíæ Guardar cambios
      </button>
    </div>
    `
  );

  // Llenar categor√≠as
  supabase.from("categorias").select("id,nombre").then(({data})=>{
    const sel=document.getElementById("editCategoria");
    sel.innerHTML="";
    data.forEach(c=>{
      sel.innerHTML+=`<option value='${c.id}' ${c.id===promo.categoria_id?'selected':''}>${escapeHtml(c.nombre)}</option>`;
    });
  });
}


async function updatePromo(id) {
    const nombre=document.getElementById("editNombre").value.trim();
    const precio=document.getElementById("editPrecio").value;
    const precio_anterior=document.getElementById("editPrecioAnterior").value;
    const stock=document.getElementById("editStock").value;
    const categoria=document.getElementById("editCategoria").value;
    const file=document.getElementById("editImagen").files[0];

    let fileName=null;
    if(file){ 
        fileName=`${Date.now()}_${file.name}`; 
        await supabase.storage.from("promo_images").upload(fileName,file); 
    }

    const updateObj={nombre,precio,precio_anterior:precio_anterior||null,stock:stock||0,categoria_id:categoria};
    if(fileName) updateObj.imagen=fileName;

    const {error}=await supabase.from("promociones").update(updateObj).eq("id",id);
    if(error) return alert(error.message); 
    closeModal(); 
    fetchPromotions();
}

async function deletePromo(id){ 
    if(!confirm("Eliminar promoci√≥n?")) return; 
    await supabase.from("promociones").delete().eq("id",id); 
    fetchPromotions(); 
}

// Convertir imagen a Base64 desde URL firmada
async function getBase64ImageFromUrl(imageUrl) {
    if(!imageUrl) return '';
    return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.src = imageUrl;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = () => resolve('');
    });
}

async function exportPDF() {
    const selectedPromos = Array.from(document.querySelectorAll(".promo-export-check"))
        .filter(chk => chk.checked)
        .map(chk => JSON.parse(chk.dataset.promo));

    if (selectedPromos.length === 0) return alert("Seleccione al menos una promoci√≥n");

    // Agrupar promociones por categor√≠a
    const grouped = selectedPromos.reduce((acc, promo) => {
        const cat = promo.categoria || 'Sin categor√≠a';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(promo);
        return acc;
    }, {});

    const container = document.createElement("div");
    container.style.width = "800px";
    container.style.fontFamily = "Arial, sans-serif";

    for (const category of Object.keys(grouped)) {
        const promos = grouped[category];
        let pageCount = 0;

        while (pageCount * 6 < promos.length) {
            const page = document.createElement("div");
            page.style.pageBreakAfter = "always";
            page.style.marginBottom = "20px";

            // T√≠tulo de categor√≠a
            const catTitle = document.createElement("h2");
            catTitle.textContent = category;
            catTitle.style.borderBottom = "2px solid #333";
            page.appendChild(catTitle);

            const slice = promos.slice(pageCount * 6, pageCount * 6 + 6);

            for (const p of slice) {
                const promoDiv = document.createElement("div");
                promoDiv.style.display = "flex";
                promoDiv.style.alignItems = "center";
                promoDiv.style.margin = "12px 0";
                promoDiv.style.padding = "10px";
                promoDiv.style.border = "1px solid #ddd";
                promoDiv.style.borderRadius = "8px";

                let imgSrc = '';
                if (p.imagen) {
                    const { data: signedData } = await supabase
                        .storage.from('promo_images')
                        .createSignedUrl(p.imagen, 3600);
                    imgSrc = await getBase64ImageFromUrl(signedData?.signedUrl);
                }

                const img = document.createElement("img");
                img.style.width = "100px";
                img.style.height = "100px";
                img.style.objectFit = "cover";
                img.style.borderRadius = "8px";
                img.style.marginRight = "12px";
                img.src = imgSrc;
                promoDiv.appendChild(img);

                const info = document.createElement("div");
                info.innerHTML = `
                    <b>${escapeHtml(p.nombre)}</b><br>
                    ${p.precio_anterior && Number(p.precio_anterior) > Number(p.precio)
                        ? `<del>$${Number(p.precio_anterior).toFixed(2)}</del> <span style="color: red; font-weight:bold;">$${Number(p.precio).toFixed(2)}</span>`
                        : `<span style="font-weight:bold;">$${Number(p.precio).toFixed(2)}</span>`}<br>
                    Stock: ${p.stock || 0}<br>
                    Categor√≠a: ${escapeHtml(category)}
                `;
                promoDiv.appendChild(info);
                page.appendChild(promoDiv);
            }

            container.appendChild(page);
            pageCount++;
        }
    }

    html2pdf().from(container).set({
        margin: [20, 20, 20, 20],
        filename: "promociones_catalogo.pdf",
        html2canvas: { scale: 2, logging: false, dpi: 300, letterRendering: true },
        jsPDF: { unit: "pt", format: "a4", orientation: "portrait" }
    }).save();
}

// ================= CATEGOR√çAS =================
async function fetchCategorias(){
  const { data, error } = await supabase.from("categorias").select("*").order("id");
  if(error) return console.error(error);
  const container = document.getElementById("categoriaList");
  container.innerHTML = "";
  data.forEach(c => {
    const div = document.createElement("div");
    div.className = 'item-card';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    div.style.background = '#fff';
    div.style.border = '1px solid #eee';
    div.style.borderRadius = '10px';
    div.style.padding = '12px 18px';
    div.style.marginBottom = '12px';
    div.style.boxShadow = '0 2px 12px rgba(0,0,0,0.06)';

    const nombreDiv = document.createElement('div');
    nombreDiv.textContent = c.nombre;
    nombreDiv.style.fontSize = '1.08em';
    nombreDiv.style.fontWeight = '500';

    const btnsDiv = document.createElement('div');
    btnsDiv.style.display = 'flex';
    btnsDiv.style.gap = '14px';
    btnsDiv.innerHTML = `
      <button onclick="editCategoria(${c.id},'${escapeHtml(c.nombre)}')" style="background:#3498db;color:#fff;border:none;padding:7px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">‚úèÔ∏è Editar</button>
      <button onclick="deleteCategoria(${c.id})" style="background:#ff4d4f;color:#fff;border:none;padding:7px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">üóëÔ∏è Eliminar</button>
    `;

    div.appendChild(nombreDiv);
    div.appendChild(btnsDiv);
    container.appendChild(div);
  });

  // Select en formulario de promociones
  const sel = document.getElementById("promoCategoria");
  sel.innerHTML = '<option value="">Sin categor√≠a</option>';
  data.forEach(c => {
    sel.innerHTML += `<option value="${c.id}">${escapeHtml(c.nombre)}</option>`;
  });
}

async function addCategoria(){
  const nombre = document.getElementById("categoriaNombre").value.trim();
  if(!nombre) return alert("Ingrese nombre");
  const {error} = await supabase.from("categorias").insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById("categoriaNombre").value = "";
  fetchCategorias();
}

function editCategoria(id, nombre){
  openModal("Editar categor√≠a", `
    <div style="padding:18px 12px;">
      <input id="editCat" value="${escapeHtml(nombre)}" style="padding:10px 16px;border-radius:8px;border:1px solid #ccc;font-size:16px;">
      <button onclick="updateCategoria(${id})" style="margin-left:10px;background:#3498db;color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;font-size:16px;cursor:pointer;">Guardar</button>
    </div>
  `);
}

async function updateCategoria(id){
  const nombre = document.getElementById("editCat").value.trim();
  if(!nombre) return alert("Ingrese nombre");
  const {error} = await supabase.from("categorias").update({nombre}).eq("id",id);
  if(error) return alert(error.message);
  closeModal();
  fetchCategorias();
}

async function deleteCategoria(id){
  if(!confirm("Eliminar categor√≠a?")) return;
  await supabase.from("categorias").delete().eq("id",id);
  fetchCategorias();
}


// ================= LOCALIDADES =================
async function fetchLocalidades(){
  const { data, error } = await supabase.from("localidades").select("*").order("id");
  if(error) return console.error(error);

  // Lista para gesti√≥n
  const container = document.getElementById("localidadList");
  container.innerHTML = "";
  data.forEach(l=>{
    // Tarjeta simple con flex
    const div = document.createElement('div');
    div.className = 'item-card';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    div.style.background = '#fff';
    div.style.border = '1px solid #eee';
    div.style.borderRadius = '10px';
    div.style.padding = '12px 18px';
    div.style.marginBottom = '12px';
    div.style.boxShadow = '0 2px 12px rgba(0,0,0,0.06)';

    // Nombre
    const nombreDiv = document.createElement('div');
    nombreDiv.textContent = l.nombre;
    nombreDiv.style.fontSize = '1.08em';
    nombreDiv.style.fontWeight = '500';

    // Botones
    const btnsDiv = document.createElement('div');
    btnsDiv.style.display = 'flex';
    btnsDiv.style.gap = '14px';
    btnsDiv.innerHTML = `
      <button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')" style="background:#3498db;color:#fff;border:none;padding:7px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">‚úèÔ∏è Editar</button>
      <button onclick="deleteLocalidad(${l.id})" style="background:#ff4d4f;color:#fff;border:none;padding:7px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">üóëÔ∏è Eliminar</button>
    `;

    div.appendChild(nombreDiv);
    div.appendChild(btnsDiv);
    container.appendChild(div);
  });

  // Select en formulario de pedidos
  const sel = document.getElementById("pedidoLocalidad");
  sel.innerHTML = '<option value="">Seleccione localidad</option>';
  data.forEach(l=>{
    sel.innerHTML += `<option value="${l.id}">${escapeHtml(l.nombre)}</option>`;
  });
}

async function addLocalidad(){
  const nombre=document.getElementById("localidadNombre").value.trim(); if(!nombre) return alert("Ingrese nombre");
  const {error}=await supabase.from("localidades").insert([{nombre}]); if(error) return alert(error.message); document.getElementById("localidadNombre").value=""; fetchLocalidades();
}

function editLocalidad(id,nombre){ 
  openModal("Editar localidad", `
    <div style="padding:18px 12px;">
      <input id="editLoc" value="${escapeHtml(nombre)}" style="padding:10px 16px;border-radius:8px;border:1px solid #ccc;font-size:16px;">
      <button onclick="updateLocalidad(${id})" style="margin-left:10px;background:#3498db;color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;font-size:16px;cursor:pointer;">Guardar</button>
    </div>
  `); 
}
async function updateLocalidad(id){ 
  const nombre=document.getElementById("editLoc").value.trim(); if(!nombre) return alert("Ingrese nombre"); 
  const {error}=await supabase.from("localidades").update({nombre}).eq("id",id); 
  if(error) return alert(error.message); 
  closeModal(); fetchLocalidades(); 
}
async function deleteLocalidad(id){ 
  if(!confirm("Eliminar localidad?")) return; 
  await supabase.from("localidades").delete().eq("id",id); 
  fetchLocalidades(); 
}





// ================= PEDIDOS =================
/* ============================
   PEDIDOS
   - selecci√≥n m√∫ltiple desde modal tipo tabla
   - control stock antes de guardar
   - edici√≥n: devuelve stock anterior, aplica nuevo
   - eliminaci√≥n: devuelve stock
   ============================ */

// ================= PEDIDOS =================
let selectedProducts = [];
let editingOrderId = null;

/* ========== MODAL DE SELECCI√ìN DE PRODUCTOS ========== */
document.getElementById('selectProductsBtn').addEventListener('click', async ()=>{
  const { data: categoriasData } = await supabase.from('categorias').select('*').order('id');
  const { data: promos } = await supabase.from('promociones').select('*').order('id');
  function renderFilteredPromos(categoryId = "") {
    let filteredPromos = (!categoryId) ? promos : promos.filter(p => String(p.categoria_id) === String(categoryId));
    let html = `
      <div style="margin-bottom:14px;display:flex;align-items:center;gap:18px;">
        <label style="font-weight:bold;" for="filterCategoria">Filtrar por categor√≠a:</label>
        <select id="filterCategoria" style="padding:6px 12px;border-radius:5px;border:1px solid #ccc;">
          <option value="">Todas</option>
          ${categoriasData.map(c => `<option value="${c.id}">${escapeHtml(c.nombre)}</option>`).join("")}
        </select>
      </div>
      <div style="overflow-x:auto;">
        <table class="table" style="min-width:700px;">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Precio</th>
              <th>Stock</th>
              <th>Cantidad</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
    `;
    for(const p of filteredPromos){
      const qty = getSelectedQty(p.id);
      html += `
        <tr>
          <td>${escapeHtml(p.nombre || p.descripcion || '')}</td>
          <td>$${Number(p.precio).toFixed(2)}</td>
          <td>${p.stock ?? 0}</td>
          <td>
            <input type="number" min="0" max="${p.stock ?? 0}" value="${qty}" id="prod_${p.id}" data-price="${Number(p.precio)}" style="width:80px" oninput="updateSubtotal(${p.id}, ${Number(p.precio)}, ${p.stock ?? 0})">
          </td>
          <td id="sub_${p.id}">$${(qty * Number(p.precio)).toFixed(2)}</td>
        </tr>
      `;
    }
    html += `
          <tr>
            <td colspan="3" style="text-align:right"><strong>Total:</strong></td>
            <td colspan="2" id="totalPedido">$0.00</td>
          </tr>
          </tbody>
        </table>
      </div>
      <div style="margin-top:18px;display:flex;justify-content:flex-end;">
        <button onclick="confirmProducts()" style="background:#3498db;color:#fff;border:none;padding:12px 24px;border-radius:7px;font-size:16px;font-weight:bold;cursor:pointer;">
          üíæ Confirmar selecci√≥n
        </button>
      </div>
    `;
    document.getElementById('modalInner').innerHTML = `<h3 style="margin-bottom:18px;">Seleccionar Productos</h3>${html}`;
    document.getElementById("modalInner").style.maxWidth = "950px";
    document.getElementById("modalInner").style.width = "95%";
    document.getElementById("modal").style.display="flex";
    document.getElementById('filterCategoria').addEventListener('change', function(){
      renderFilteredPromos(this.value);
    });
    setTimeout(()=>{ const tEl = document.getElementById('totalPedido'); if(tEl) tEl.textContent = `$${calculateTotal().toFixed(2)}` }, 40);
  }
  renderFilteredPromos();
});

function getSelectedQty(id){ const it = selectedProducts.find(x => x.id === id); return it ? it.cantidad : 0; }
function updateSubtotal(id, price, stock){
  const input = document.getElementById(`prod_${id}`);
  if(!input) return;
  let qty = parseInt(input.value,10) || 0;
  if(qty < 0) qty = 0;
  if(stock !== undefined && qty > stock) qty = stock;
  input.value = qty;
  const sub = document.getElementById(`sub_${id}`);
  if(sub) sub.textContent = `$${(qty*price).toFixed(2)}`;
  const tot = document.getElementById('totalPedido');
  if(tot) tot.textContent = `$${calculateTotal().toFixed(2)}`;
}
function calculateTotal(){
  let total = 0;
  const inputs = document.querySelectorAll('#modalInner input[type=number]');
  inputs.forEach(inp=>{
    const id = parseInt(inp.id.replace('prod_',''),10);
    const qty = parseInt(inp.value,10) || 0;
    const price = parseFloat(inp.getAttribute('data-price')) || 0;
    total += qty * price;
  });
  return total;
}
function confirmProducts(){
  selectedProducts = [];
  const inputs = document.querySelectorAll('#modalInner input[type=number]');
  inputs.forEach(inp=>{
    const qty = parseInt(inp.value,10) || 0;
    if(qty > 0){
      const id = parseInt(inp.id.replace('prod_',''),10);
      const row = inp.closest('tr');
      const nombre = row.cells[0].textContent;
      const precio = parseFloat(row.cells[1].textContent.replace('$','')) || 0;
      selectedProducts.push({ id, nombre, cantidad: qty, precio });
    }
  });
  closeModal(); renderSelectedProducts();
}
function renderSelectedProducts(){
  const c = document.getElementById('selectedProductsContainer');
  if(!selectedProducts.length){ c.innerHTML = '<span class="small-muted">No hay productos seleccionados</span>'; return; }
  let html = `<table class="table"><thead><tr><th>Producto</th><th>Cantidad</th><th>Subtotal</th></tr></thead><tbody>`;
  selectedProducts.forEach(p=>{
    html += `<tr><td>${escapeHtml(p.nombre)}</td><td>${p.cantidad}</td><td>$${(p.precio*p.cantidad).toFixed(2)}</td></tr>`;
  });
  const total = selectedProducts.reduce((s,p)=>s + p.precio * p.cantidad, 0);
  html += `<tr><td colspan="2" style="text-align:right"><strong>Total:</strong></td><td>$${total.toFixed(2)}</td></tr></tbody></table>`;
  c.innerHTML = html;
}
async function getPromoById(id){
  const { data } = await supabase.from('promociones').select('*').eq('id', id).single();
  return data;
}

/* ================== AGREGAR PEDIDO ================== */
document.getElementById('addOrderBtn').addEventListener('click', async ()=>{
  const cliente = document.getElementById('pedidoCliente').value.trim();
  const localidad_id = document.getElementById('pedidoLocalidad').value || null;
  if(!cliente || selectedProducts.length === 0) return alert('Complete cliente y seleccione productos');
  const promosActuales = await Promise.all(selectedProducts.map(p => getPromoById(p.id)));
  for (let i = 0; i < selectedProducts.length; i++) {
      if (selectedProducts[i].cantidad > (promosActuales[i].stock || 0)) {
          return alert(`Stock insuficiente para ${selectedProducts[i].nombre} (disponible: ${promosActuales[i].stock})`);
      }
  }
  // SOLO DESCONTAR STOCK UNA VEZ
  await Promise.all(selectedProducts.map((p, i) =>
      supabase.from('promociones').update({ stock: (promosActuales[i].stock || 0) - p.cantidad }).eq('id', p.id)
  ));
  const productosPayload = selectedProducts.map(p => ({ id: p.id, nombre: p.nombre, cantidad: p.cantidad, precio: p.precio }));
  const total = productosPayload.reduce((s,x)=>s + x.precio * x.cantidad, 0);
  const { error } = await supabase.from('pedidos').insert([{ cliente, localidad_id, productos: productosPayload, total }]);
  if(error) return alert(error.message);
  document.getElementById('pedidoForm').reset();
  selectedProducts = []; renderSelectedProducts();
  await fetchOrders();
  await fetchPromotions();
  showToast('Pedido agregado');
});

/* ========== OBTENER LOCALIDAD ========== */
async function getLocalidadNombre(id) {
  if (!id) return "";
  const { data } = await supabase.from('localidades').select('nombre').eq('id', id).single();
  return (data && data.nombre) ? data.nombre : "";
}

/* ================== LISTADO DE PEDIDOS ================== */
async function fetchOrders(){
  const { data } = await supabase.from('pedidos').select('*').order('id');
  const container = document.getElementById('pedidoList');
  container.innerHTML = '';
  for(const p of data){
    let localidadNombre = "";
    if (p.localidad_id) {
      localidadNombre = await getLocalidadNombre(p.localidad_id);
    }
    const div = document.createElement('div'); 
    div.className = 'item-card';
    div.style.display = 'flex';
    div.style.alignItems = 'stretch';
    div.style.justifyContent = 'space-between';
    div.style.padding = '18px 14px';
    div.style.marginBottom = '14px';
    div.style.borderRadius = '12px';
    div.style.background = '#fff';
    div.style.boxShadow = '0 2px 12px rgba(0,0,0,0.07)';
    div.style.border = '1px solid #eee';
    let prodHTML = '<ul style="margin:7px 0 10px 0;padding-left:22px;font-size:15px;">';
    p.productos.forEach(pr => prodHTML += `<li>${escapeHtml(pr.nombre)} <span style="color:#888;">x ${pr.cantidad}</span> <span style="color:#3498db;">$${(pr.precio*pr.cantidad).toFixed(2)}</span></li>`);
    prodHTML += '</ul>';
    const infoDiv = document.createElement('div');
    infoDiv.style.flex = '1';
    infoDiv.innerHTML = `
      <strong style="font-size:1.18em;">${escapeHtml(p.cliente)}</strong>
      <div class="small-muted" style="color:#888;margin-bottom:2px;">${localidadNombre ? 'Localidad: ' + escapeHtml(localidadNombre) : ''}</div>
      ${prodHTML}
      <div style="margin-top:8px;font-weight:bold;font-size:1.08em;">Total: <span style="color:#ff4d4f;">$${Number(p.total).toFixed(2)}</span></div>
    `;
    const actionsDiv = document.createElement('div');
    actionsDiv.style.display = 'flex';
    actionsDiv.style.flexDirection = 'column';
    actionsDiv.style.justifyContent = 'center';
    actionsDiv.style.alignItems = 'flex-end';
    actionsDiv.style.gap = '10px';
    actionsDiv.innerHTML = `
      <button onclick='editOrderModal(${JSON.stringify(p)})' style="background:#3498db;color:#fff;border:none;padding:8px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;margin-bottom:2px;">‚úèÔ∏è Editar</button>
      <button class="delete-btn" onclick="deleteOrder(${p.id})" style="background:#ff4d4f;color:#fff;border:none;padding:8px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">üóëÔ∏è Eliminar</button>
    `;
    div.appendChild(infoDiv);
    div.appendChild(actionsDiv);
    container.appendChild(div);
  }
}

/* ========== MODAL DE EDICI√ìN DE PEDIDO CON STOCK DIFERENCIAL ========== */
async function editOrderModal(pedido) {
  const { data: localidades } = await supabase.from('localidades').select('*').order('id');
  const { data: productosDB } = await supabase.from('promociones').select('*').order('id');
  let productosPedido = pedido.productos.map(pr => ({ ...pr }));

  function renderModal(stockMsg = "") {
    document.getElementById("modalInner").style.maxWidth = "1200px";
    document.getElementById("modalInner").style.width = "98%";
    let productosDisponibles = productosDB.filter(pdb => !productosPedido.some(pp => pp.id === pdb.id));
    let selectHTML = `
      <div style="display:flex;align-items:flex-start;gap:10px;">
        <div style="flex:1;display:flex;flex-direction:column;gap:5px;">
          <select id="addProductoSelect" style="margin-bottom:5px;">
            <option value="">Agregar producto</option>
            ${productosDisponibles.map(p=>`<option value="${p.id}">${escapeHtml(p.nombre)} ($${Number(p.precio).toFixed(2)}, stock: ${p.stock ?? 0})</option>`).join('')}
          </select>
          <input type="number" id="addProductoQty" min="1" value="1" style="width:60px;" placeholder="Cant.">
        </div>
        <button type="button" id="addProductoBtn" style="background:#eee;color:#333;border:none;padding:8px 14px;border-radius:6px;font-size:17px;cursor:pointer;height:45px;align-self:flex-start;">‚ûï</button>
      </div>
    `;
    let listaHTML = `<ul id="productosPedidoList" style="margin-bottom:8px;">`;
    productosPedido.forEach((pr, idx) => {
      const prodInfo = productosDB.find(pdb => pdb.id === pr.id);
      const stockDisp = prodInfo ? (prodInfo.stock ?? 0) : 0;
      listaHTML += `
        <li style="margin-bottom:6px;">
          <span style="font-weight:bold;">${escapeHtml(pr.nombre)}</span>
          <input type="number" min="1" max="${stockDisp}" value="${pr.cantidad}" data-idx="${idx}" class="editQtyInput" style="width:45px;margin:0 6px;">
          <span style="color:#aaa;">(stock: ${stockDisp})</span>
          <span style="color:#3498db;">$${(pr.precio*pr.cantidad).toFixed(2)}</span>
          <button type="button" class="deletePrBtn" data-idx="${idx}" style="background:#ff4d4f;color:#fff;border:none;padding:2px 7px;border-radius:6px;font-size:14px;cursor:pointer;margin-left:6px;">üóëÔ∏è</button>
        </li>
      `;
    });
    listaHTML += `</ul>`;
    let total = productosPedido.reduce((s,p)=>s + p.precio*p.cantidad, 0);

    openModal(
      `
      <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:18px;">
        <h2 style="margin:0;font-size:1.3em;">Editar Pedido</h2>
      </div>
      <div style="background:#f8f8f8;border-radius:12px;padding:20px 18px;box-shadow:0 2px 12px rgba(0,0,0,0.07);">
        <div style="margin-bottom:16px;">
          <label for="editPedidoCliente" style="font-weight:500;display:block;margin-bottom:4px;">Cliente</label>
          <input type="text" id="editPedidoCliente" value="${escapeHtml(pedido.cliente)}" placeholder="Nombre del cliente">
        </div>
        <div style="margin-bottom:16px;">
          <label for="editPedidoLocalidad" style="font-weight:500;display:block;margin-bottom:4px;">Localidad</label>
          <select id="editPedidoLocalidad">
            <option value="">Seleccione localidad</option>
            ${localidades.map(l => `<option value="${l.id}" ${l.id === pedido.localidad_id ? 'selected' : ''}>${escapeHtml(l.nombre)}</option>`).join('')}
          </select>
        </div>
        <div style="margin-bottom:16px;">
          <label style="font-weight:500;display:block;margin-bottom:4px;">Productos</label>
          ${selectHTML}
          ${listaHTML}
          <div style="margin-top:8px;font-weight:bold;">Total: <span id="pedidoTotal" style="color:#ff4d4f;">$${total.toFixed(2)}</span></div>
          ${stockMsg ? `<div style="color:#ff4d4f;font-weight:bold;margin-top:10px;">${stockMsg}</div>` : ""}
        </div>
        <button onclick="saveEditPedido(${pedido.id})" style="margin-top:10px;background:#3498db;color:#fff;border:none;padding:12px 20px;border-radius:7px;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:8px;">
          üíæ Guardar cambios
        </button>
      </div>
      `
    );
    document.getElementById('addProductoBtn').onclick = function() {
      const prodId = document.getElementById('addProductoSelect').value;
      let qty = parseInt(document.getElementById('addProductoQty').value, 10) || 1;
      if(!prodId) return;
      const prodObj = productosDB.find(p=>String(p.id)===String(prodId));
      if(prodObj) {
        if(qty > prodObj.stock) {
          qty = prodObj.stock;
          renderModal(`El stock disponible de "${prodObj.nombre}" es ${prodObj.stock}.`);
          return;
        }
        productosPedido.push({
          id: prodObj.id,
          nombre: prodObj.nombre,
          cantidad: qty,
          precio: prodObj.precio
        });
        renderModal();
      }
    };
    document.querySelectorAll('.editQtyInput').forEach(input => {
      input.onchange = function() {
        let idx = parseInt(this.getAttribute('data-idx'));
        let prodInfo = productosDB.find(pdb => pdb.id === productosPedido[idx].id);
        let stockDisp = prodInfo ? (prodInfo.stock ?? 0) : 0;
        let val = Math.max(1, Math.min(parseInt(this.value, 10), stockDisp));
        if(parseInt(this.value, 10) > stockDisp) {
          renderModal(`El stock disponible de "${productosPedido[idx].nombre}" es ${stockDisp}.`);
          return;
        }
        productosPedido[idx].cantidad = val;
        renderModal();
      };
    });
    document.querySelectorAll('.deletePrBtn').forEach(btn => {
      btn.onclick = function() {
        let idx = parseInt(this.getAttribute('data-idx'));
        productosPedido.splice(idx, 1);
        renderModal();
      };
    });
  }

  renderModal();

  window.saveEditPedido = async function(id) {
    const cliente = document.getElementById('editPedidoCliente').value.trim();
    const localidad_id = document.getElementById('editPedidoLocalidad').value || null;
    if(!cliente || !localidad_id || !productosPedido.length) return alert('Complete todos los campos y agregue productos');
    const total = productosPedido.reduce((s,x)=>s + x.precio * x.cantidad, 0);

    // --- AJUSTA EL STOCK SOLO POR LA DIFERENCIA ---
    const { data: pedidoOriginal } = await supabase.from('pedidos').select('*').eq('id', id).single();
    const productosOriginal = pedidoOriginal.productos || [];
    const mapOriginal = {};
    productosOriginal.forEach(p => mapOriginal[p.id] = p.cantidad);
    const mapNuevo = {};
    productosPedido.forEach(p => mapNuevo[p.id] = p.cantidad);

    // AJUSTE SOLO POR LA DIFERENCIA
    const allIds = new Set([...productosOriginal.map(p=>p.id), ...productosPedido.map(p=>p.id)]);
    for(const prodId of allIds) {
      const cantOriginal = mapOriginal[prodId] || 0;
      const cantNueva    = mapNuevo[prodId]    || 0;
      const dif = cantNueva - cantOriginal;
      if(dif !== 0) {
        const promo = await getPromoById(prodId);
        await supabase.from('promociones').update({ stock: (promo.stock || 0) - dif }).eq('id', prodId);
      }
    }

    const { error } = await supabase.from('pedidos').update({ cliente, localidad_id, productos: productosPedido, total }).eq('id', id);
    if(error) return alert(error.message);
    closeModal();
    await fetchOrders();
    showToast('Pedido actualizado');
  };
}

/* ========== ELIMINAR PEDIDO ========== */
async function deleteOrder(id){
  if(!confirm('Eliminar pedido?')) return;
  const { data } = await supabase.from('pedidos').select('*').eq('id', id).single();
  if(data.productos && data.productos.length){
    for(const pr of data.productos){
      const promo = await getPromoById(pr.id);
      const newStock = (promo.stock || 0) + pr.cantidad;
      await supabase.from('promociones').update({ stock: newStock }).eq('id', pr.id);
    }
  }
  await supabase.from('pedidos').delete().eq('id', id);
  await fetchOrders();
  await fetchPromotions();
  showToast('Pedido eliminado y stock restaurado');
}

// ================= CLIENTES =================

/**
 * Inserta un nuevo cliente con la carga r√°pida.
 * El DNI, Tel√©fono y Hora de Visita quedan vac√≠os.
 * El estado se establece en 'Pendiente'.
 */
async function addClienteRapido() {
    const nombre = document.getElementById("clienteNombre").value.trim();
    const localidad = document.getElementById("clienteLocalidad").value.trim();
    const hora = document.getElementById("clienteHora").value.trim(); // üí• Capturamos la hora üí•

    if (!nombre || !localidad) {
        return alert("El Nombre/Apellido y la Localidad son campos requeridos.");
    }
    
    // Si se proporciona la hora, creamos un timestamp con una fecha gen√©rica (hoy)
    // para guardarlo en el campo 'hora_visita' (tipo timestamptz en Supabase)
    let hora_visita_supabase = null;
    if (hora) {
        // Obtenemos la fecha de hoy, y la combinamos con la hora ingresada
        const today = new Date().toISOString().substring(0, 10); // YYYY-MM-DD
        try {
            // Intentamos crear un objeto Date con la fecha de hoy y la hora
            hora_visita_supabase = new Date(`${today}T${hora}:00`).toISOString();
        } catch (e) {
            console.warn("Formato de hora no v√°lido, se guarda N/A");
            // Si el formato es malo (ej: '3:00' en lugar de '03:00'), Supabase lo manejar√° como un string,
            // pero para evitar errores en la DB, lo dejaremos en null si falla la conversi√≥n local.
            // Para simplicidad, pasaremos la cadena de texto de la hora.
            // NOTA: Para solo guardar la hora, lo mejor es usar un campo de TEXTO en la DB.
        }
    }

    // Insertar con el campo hora_visita
    const { error } = await supabase.from("clientes").insert([{
        nombre_completo: nombre,
        localidad: localidad,
        estado_visita: 'Pendiente',
        // üí• Lo guardamos como TEXTO (hora) si no pudimos convertir a timestamp üí•
        hora_visita: hora_visita_supabase || hora || null 
    }]);

    if (error) {
        console.error("Error al guardar cliente:", error);
        return alert("Error al guardar cliente: " + error.message);
    }

    document.getElementById("clienteForm").reset();
    alert("Cliente cargado como Pendiente de Visita.");
    fetchClientes(); // Recarga la lista
}


/**
 * Obtiene, filtra, ordena y agrupa la lista de clientes.
 */
async function fetchClientes() {
    // Obtener el valor del campo de b√∫squeda y normalizarlo a min√∫sculas
    const searchTerm = document.getElementById('clienteSearch').value.toLowerCase();
    
    // Obtener todos los datos ordenados
    const { data: allClientes, error } = await supabase
        .from('clientes')
        .select('*')
        // Ordena primero por Localidad (alfab√©tico)
        .order('localidad', { ascending: true })
        // Luego por Estado (Pendiente primero, Visitado despu√©s)
        .order('estado_visita', { ascending: true }) 
        // Finalmente por ID para que los nuevos salgan arriba dentro de cada grupo
        .order('id', { ascending: false });

    if (error) return console.error(error);

    // 1. FILTRADO POR NOMBRE
    let filteredClientes = allClientes;
    if (searchTerm) {
        filteredClientes = allClientes.filter(cliente => 
            cliente.nombre_completo.toLowerCase().includes(searchTerm)
        );
    }
    
    const container = document.getElementById('clienteList');
    container.innerHTML = '';
    
    if (filteredClientes.length === 0) {
        container.innerHTML = `<span style="color:#888; display:block; padding: 20px;">
          ${searchTerm ? `No se encontraron clientes con el nombre: "${escapeHtml(searchTerm)}".` : 'No hay clientes cargados.'}
        </span>`;
        return;
    }

    // 2. AGRUPAMIENTO POR LOCALIDAD Y ESTADO
    const groupedClients = filteredClientes.reduce((acc, cliente) => {
        const localidad = cliente.localidad.trim() || 'Sin Localidad';
        const estado = cliente.estado_visita; // 'Pendiente' o 'Visitado'

        if (!acc[localidad]) {
            acc[localidad] = { Pendiente: [], Visitado: [] };
        }
        acc[localidad][estado].push(cliente);
        return acc;
    }, {});

    // 3. RENDERIZADO AGRUPADO
    
    let lastLocalidad = null;
    
    // Recorrer las localidades ordenadas alfab√©ticamente
    const orderedLocalidades = Object.keys(groupedClients).sort();

    orderedLocalidades.forEach(localidad => {
        const clientesByStatus = groupedClients[localidad];

        // T√≠tulo Separador por Localidad
        const localidadTitle = document.createElement('h2');
        localidadTitle.textContent = escapeHtml(localidad);
        localidadTitle.style.cssText = `
            margin: 25px 0 10px 0; 
            padding: 8px 15px; 
            background: #3498db; 
            color: #fff; 
            border-radius: 8px; 
            font-size: 1.3em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        `;
        container.appendChild(localidadTitle);
        
        // Funci√≥n para renderizar el grupo (Pendiente o Visitado)
        const renderStatusGroup = (status, list) => {
            if (list.length === 0) return;

            const statusSection = document.createElement('div');
            statusSection.style.marginBottom = '20px';
            
            // Subt√≠tulo por Estado (Pendiente o Visitado)
            const isVisitado = status === 'Visitado';
            const statusColor = isVisitado ? '#27ae60' : '#e74c3c';
            const statusText = isVisitado ? '‚úÖ VISITADOS' : '‚è≥ PENDIENTES';
            
            const statusSubtitle = document.createElement('h3');
            statusSubtitle.textContent = `${statusText} (${list.length})`;
            statusSubtitle.style.cssText = `
                border-bottom: 2px solid ${statusColor}; 
                padding-bottom: 5px; 
                color: ${statusColor}; 
                margin-bottom: 15px;
            `;
            statusSection.appendChild(statusSubtitle);
            
            list.forEach(cliente => {
                const bgColor = isVisitado ? '#e6f7e6' : '#fff0f0';
                
                // Mostrar la hora de visita, que ahora puede ser una fecha (ISO) o texto (simple)
                const horaVisitaText = cliente.hora_visita 
                    ? (isNaN(new Date(cliente.hora_visita))
                        ? `Hora: ${escapeHtml(cliente.hora_visita)}`
                        : new Date(cliente.hora_visita).toLocaleString())
                    : 'No Agendada';

                const div = document.createElement('div');
                div.className = 'card';
                div.style.background = bgColor;
                div.style.borderLeft = `5px solid ${statusColor}`;

                div.innerHTML = `
                    <div class="card-info" style="flex:1; gap:4px;">
                        <b>${escapeHtml(cliente.nombre_completo)}</b>
                        <div style="font-size: 0.9em; color: #555;">
                            DNI: ${cliente.dni || 'N/A'} ¬∑ Tel√©fono: ${cliente.telefono || 'N/A'}<br>
                            Visita: ${horaVisitaText}
                        </div>
                    </div>
                    <div class="card-actions" style="min-width: 170px;">
                        <button class="edit-btn" onclick="openEditClienteModal(${cliente.id})">‚úèÔ∏è Editar Datos</button>
                        <button class="${isVisitado ? 'edit-btn' : 'delete-btn'}" 
                                style="background:${statusColor};"
                                onclick="toggleEstadoCliente(${cliente.id}, '${isVisitado ? 'Pendiente' : 'Visitado'}')">
                            ${isVisitado ? 'Marcar como Pendiente' : 'Marcar como Visitado'}
                        </button>
                        <button class="delete-btn" onclick="deleteCliente(${cliente.id})" style="background:#95a5a6;">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                statusSection.appendChild(div);
            });
            container.appendChild(statusSection);
        };
        
        // 4. Renderizar por Estado (Pendientes primero)
        renderStatusGroup('Pendiente', clientesByStatus.Pendiente);
        renderStatusGroup('Visitado', clientesByStatus.Visitado);
    });
}


/**
 * Abre el modal para editar todos los campos del cliente.
 */
async function openEditClienteModal(id) {
    const { data, error } = await supabase.from('clientes').select('*').eq('id', id).single();
    if (error || !data) return console.error("Cliente no encontrado", error);

    const cliente = data;
    // Formatear la fecha para el input datetime-local
    const formattedVisita = cliente.hora_visita ? new Date(cliente.hora_visita).toISOString().substring(0, 16) : '';

    openModal(
        `Editar Cliente: ${escapeHtml(cliente.nombre_completo)}`,
        `
        <form id="editClienteForm" style="display:flex; flex-direction:column; gap:8px;">
            <label for="editClienteNombre">Nombre Completo:</label>
            <input type="text" id="editClienteNombre" value="${escapeHtml(cliente.nombre_completo || '')}" required>

            <label for="editClienteLocalidad">Localidad:</label>
            <input type="text" id="editClienteLocalidad" value="${escapeHtml(cliente.localidad || '')}" required>

            <label for="editClienteDNI">DNI/Identificaci√≥n:</label>
            <input type="text" id="editClienteDNI" value="${escapeHtml(cliente.dni || '')}">

            <label for="editClienteTelefono">Tel√©fono:</label>
            <input type="text" id="editClienteTelefono" value="${escapeHtml(cliente.telefono || '')}">

            <label for="editClienteVisita">Hora de Visita (Fecha y Hora):</label>
            <input type="datetime-local" id="editClienteVisita" value="${formattedVisita}">

            <label for="editClienteEstado">Estado de Visita:</label>
            <select id="editClienteEstado">
                <option value="Pendiente" ${cliente.estado_visita === 'Pendiente' ? 'selected' : ''}>‚è≥ Pendiente de Visita</option>
                <option value="Visitado" ${cliente.estado_visita === 'Visitado' ? 'selected' : ''}>‚úÖ Visitado</option>
            </select>
            
            <button type="button" onclick="updateCliente(${cliente.id})" style="margin-top:15px; background:#3498db; color:#fff; padding:10px;">üíæ Guardar Cambios</button>
        </form>
        `
    );
}

/**
 * Funci√≥n final para actualizar todos los campos del cliente.
 */
async function updateCliente(id) {
    const nombre = document.getElementById("editClienteNombre").value.trim();
    const localidad = document.getElementById("editClienteLocalidad").value.trim();
    const dni = document.getElementById("editClienteDNI").value.trim() || null;
    const telefono = document.getElementById("editClienteTelefono").value.trim() || null;
    const visita = document.getElementById("editClienteVisita").value;
    const estado = document.getElementById("editClienteEstado").value;

    // Convertir a formato ISO si existe para Supabase
    const hora_visita = visita ? new Date(visita).toISOString() : null;

    if (!nombre || !localidad) {
        return alert("El Nombre/Apellido y la Localidad son campos requeridos.");
    }

    const { error } = await supabase.from("clientes")
        .update({
            nombre_completo: nombre,
            localidad,
            dni,
            telefono,
            hora_visita,
            estado_visita: estado
        })
        .eq("id", id);

    if (error) {
        console.error("Error al actualizar cliente:", error);
        return alert("Error al actualizar cliente: " + error.message);
    }

    closeModal();
    fetchClientes();
    showToast("Cliente actualizado con √©xito ‚úÖ");
}

/**
 * Elimina un cliente.
 */
async function deleteCliente(id){
    if(!confirm("¬øDesea eliminar este cliente permanentemente?")) return;
    
    const { error } = await supabase.from("clientes").delete().eq("id", id);
    
    if(error) {
        console.error(error);
        return alert("Error al eliminar cliente.");
    }
    fetchClientes();
    showToast('Cliente eliminado');
}


// ================= DOCUMENTOS =================
// Subir documento al bucket y guardar referencia
async function addDocumento() {
  const file = document.getElementById("docArchivo").files[0];
  if (!file) return alert("Seleccione un archivo");
  const fileName = `${Date.now()}_${file.name}`;
  const { error: uploadError } = await supabase.storage.from("private-documents").upload(fileName, file);
  if (uploadError) {
    alert("Error al subir: " + uploadError.message);
    return;
  }
  await supabase.from("documentos").insert([{ nombre: file.name, archivo: fileName }]);
  document.getElementById("docArchivo").value = "";
  fetchDocumentos();
}

// Mostrar listado de documentos
async function fetchDocumentos() {
  const { data, error } = await supabase.from("documentos").select("*").order("created_at", { ascending: false });
  const container = document.getElementById("docList");
  container.innerHTML = "";

  if (error) {
    container.innerHTML = `<span style="color:red;">Error: ${escapeHtml(error.message)}</span>`;
    return;
  }

  if (!data || data.length === 0) {
    container.innerHTML = '<span style="color:#888;">No hay documentos subidos.</span>';
    return;
  }

  for (const doc of data) {
    let url = "";
    if (doc.archivo) {
      const { data: urlData } = await supabase.storage.from("private-documents").createSignedUrl(doc.archivo, 60 * 60);
      url = urlData?.signedUrl || "#";
    }
    const fecha = doc.created_at ? new Date(doc.created_at).toLocaleString() : '';
    container.innerHTML += `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;">
        <div>
          <a href="${url}" target="_blank">${escapeHtml(doc.nombre)}</a>
          <span style="color:#888;font-size:0.97em;margin-left:8px;">${fecha}</span>
        </div>
        <button onclick="deleteDocumento(${doc.id}, '${doc.archivo}')" style="background:#ff4d4f;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-weight:bold;cursor:pointer;">Eliminar</button>
      </div>
    `;
  }
}

// Eliminar documento
async function deleteDocumento(id, archivo) {
  if (!confirm("¬øEliminar documento?")) return;
  await supabase.storage.from("private-documents").remove([archivo]);
  await supabase.from("documentos").delete().eq("id", id);
  fetchDocumentos();
}

// Mostrar documentos al entrar en la pesta√±a
document.querySelector("button[data-tab='documentos']").addEventListener("click", fetchDocumentos);

// --- INICIALIZACI√ìN ---
fetchCategorias(); fetchLocalidades(); fetchPromotions(); fetchOrders(); fetchDocumentos(); fetchClientes();

/* ========== FUNCI√ìN PARA DESLIZAR SIDEBAR EN M√ìVIL ========== */
function toggleSidebar() {
    const sidebar = document.querySelector('.sidebar');
    const backdrop = document.getElementById('backdrop');
    
    sidebar.classList.toggle('open');
    backdrop.classList.toggle('show');
}

// üí• Asignar la funci√≥n al nuevo bot√≥n de men√∫ üí•
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('menuBtn').addEventListener('click', toggleSidebar);
    
    // Asignar el cierre de la sidebar tambi√©n al hacer clic en un bot√≥n de pesta√±a
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Cierra la sidebar si est√° abierta y estamos en m√≥vil
            if (window.innerWidth <= 500 && document.querySelector('.sidebar').classList.contains('open')) {
                toggleSidebar();
            }
        });
    });
});


</script>

</body>
</html>
