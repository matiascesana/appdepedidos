<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel Administrativo Completo</title>
    <style>
        :root {
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --accent: #ff4d4f;
            --card-bg: #fff;
            --text-muted: #555;
        }
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background: #f0f2f5; }
        .sidebar { width: 220px; background: var(--sidebar-bg); color: #fff; display: flex; flex-direction: column; padding-top: 20px; flex-shrink: 0; transition: transform 0.3s ease; z-index: 9000; }
        .sidebar h2 { text-align: center; margin-bottom: 20px; font-size: 22px; }
        .sidebar button { background: none; border: none; color: white; text-align: left; padding: 12px 20px; cursor: pointer; font-size: 16px; width: 100%; transition: 0.2s; }
        .sidebar button:hover, .sidebar button.active { background: var(--sidebar-hover); }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .section {
  	display: none !important;}
	.section.active {
  	display: block !important;}
        h1 { margin-top: 0; margin-bottom: 15px; }
        .card { display: flex; align-items: center; gap: 15px; background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 12px; border: 1px solid #ddd; transition: 0.3s; }
        .card:hover { box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15); }
        .card img { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; border: 1px solid #ccc; }
        .card-info { flex: 1; display: flex; flex-direction: column; gap: 6px; }
        .card-info b { font-size: 1.1em; }
        .card-price { font-size: 1em; color: var(--accent); }
        .card-price del { color: #999; margin-right: 6px; }
        .card-stock { font-size: 0.85em; color: var(--text-muted); }
        .card-actions { display: flex; flex-direction: column; gap: 6px; }
        .card-actions button { cursor: pointer; border: none; border-radius: 6px; padding: 6px 12px; font-weight: bold; transition: 0.2s; }
        .card-actions .edit-btn { background: #3498db; color: #fff; }
        .card-actions .edit-btn:hover { background: #2980b9; }
        .card-actions .delete-btn { background: var(--accent); color: #fff; }
        .card-actions .delete-btn:hover { background: #e8434f; }
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); justify-content: center; align-items: center; z-index: 9999; }
        #modalInner { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 1100px; max-height: 90%; overflow-y: auto; }
        input, select, button { margin-bottom: 8px; padding: 6px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; }
        button[type=submit] { background: var(--accent); color: #fff; border: none; cursor: pointer; }
        button[type=submit]:hover { background: #e8434f; }
        #menuBtn { position: absolute; left: 12px; top: 12px; background: #3498db; color: white; font-size: 22px; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; z-index: 2000; display: none; }
        .backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 8000; pointer-events: none; }
        .backdrop.show { display: block; pointer-events: auto; }
        .table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .table th, .table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #f8f9fa; font-weight: bold; }
        #appToast { position: fixed; right: 16px; bottom: 20px; background: #222; color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18); z-index: 15000; opacity: 0; transition: opacity 0.25s; }
        @media (max-width: 768px) {
            #menuBtn { display: block; }
            .card { flex-direction: column; align-items: flex-start; gap: 10px; }
            .card-info { width: 100%; flex: initial; }
            .card-actions { flex-direction: column; width: 100%; gap: 8px; }
            .card-actions button { width: 100%; padding: 10px 12px; font-size: 16px; box-sizing: border-box; }
        }
        @media (max-width: 500px) {
            #menuBtn { display: block; }
            .sidebar { transform: translateX(-100%); position: fixed; top: 0; left: 0; height: 100vh; width: 70%; padding-top: 50px; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5); }
            .sidebar.open { transform: translateX(0); }
            .content { flex: 1; padding: 8px; margin-top: 50px; }
            .sidebar h2 { display: block; text-align: center; }
            .sidebar button { text-align: left; font-size: 16px; padding: 12px 20px; }
        }

/* Busca el estilo de .promo-group-container y aj√∫stalo as√≠: */
.promo-group-container {
    display: grid;
    /* Reducimos el minmax de 220px a 180px para tarjetas m√°s peque√±as */
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
    gap: 12px; /* Reducimos el espacio entre tarjetas */
    margin-bottom: 25px; 
}


/* Ajuste de la tarjeta para que se vea bien en la cuadr√≠cula */
.promo-card {
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    /* Se elimina el width fijo: width: 200px; */ 
}

/* Estilos para el Desplegable */
.dropdown-container {
    position: relative;
    width: 100%;
}

.dropdown-menu {
    display: none; /* Inicialmente oculto */
    background: #34495e; /* Un tono un poco m√°s oscuro que el sidebar */
    width: 100%;
    padding: 5px 0;
    transition: max-height 0.3s ease-out;
    overflow: hidden;
    /* Evita que se solape con el bot√≥n de abajo visualmente */
    border-top: 1px solid rgba(0, 0, 0, 0.2); 
}

.dropdown-menu.open {
    display: block;
}

.dropdown-menu button {
    background: none;
    border: none;
    color: white;
    text-align: left;
    padding: 8px 30px; /* M√°s padding para indentar */
    cursor: pointer;
    font-size: 15px;
    width: 100%;
    transition: 0.2s;
}

.dropdown-menu button:hover, .dropdown-menu button.active {
    background: #4a677e; /* Tono de hover para el submen√∫ */
}

/* Estilos del Modal */
.modal {
    display: none; /* Oculto por defecto */
    position: fixed; /* Posicionamiento fijo */
    z-index: 1000; /* Siempre encima */
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.4); /* Fondo semi-transparente */
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto; /* 10% desde arriba y centrado */
    padding: 25px;
    border: 1px solid #888;
    width: 80%; 
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close-button:hover,
.close-button:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}

.modal-content h3 {
    border-bottom: 2px solid #ddd;
    padding-bottom: 10px;
    margin-top: 0;
}

.modal-content label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
    color: #333;
}

.modal-content input[type="number"],
.modal-content input[type="file"] {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    display: inline-block;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box; /* Incluye padding y borde en el ancho/alto */
}

/* Botones */
.save-btn {
    background-color: #28a745;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
}



<div id="tiendaCliente">
    <h2>Tienda</h2>
    <div id="productosContainer" class="productos-container"></div>
    <div class="pedido-footer">
    <button onclick="confirmarPedido()">Confirmar Pedido</button>
    </div>
</div>


<div id="resumenCarrito" style="padding: 15px; border: 1px solid #ccc; border-radius: 8px;">
    
    <h4>üõí Mi Pedido (<span id="carritoCount">0</span>)</h4>
    
    <div id="carritoLista" style="margin-bottom: 10px;">
        <span class="text-muted">No hay productos seleccionados</span>
    </div>

    <hr style="border: none; border-top: 1px dashed #ddd;">

    <p style="margin-top:8px; font-weight:bold;">
        Total: 
        <span id="carritoTotal" style="float: right;">$0.00</span>
    </p>

    <button onclick="abrirModalPedido()" style="width: 100%; margin-top: 15px;">
        Confirmar y Enviar Pedido
    </button>
</div>







<div id="carritoModal">
    <h3>Mi Pedido</h3>
    
   
    <div class="modal-content">
    <h3>Confirmar Pedido</h3>
    <label>Nombre:</label>
    <input id="modalClienteNombre" type="text" placeholder="Nombre completo">
    
    <label>Localidad:</label>
    <select id="modalLocalidadSelect"></select>
    
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
      <button id="cancelarPedidoBtn" onclick="document.getElementById('pedidoModal').style.display='none'">Cancelar</button>
    </div>
  </div>
</div>





.categorias-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 16px;
}
.categoria-btn {
  padding: 8px 14px;
  border: none;
  background: #3498db;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
}
.categoria-btn:hover {
  background: #2980b9;
}

#productosContainer {
    /* 1. Activa Flexbox para colocar los hijos uno al lado del otro */
    display: flex; 
    
    /* 2. Permite que las tarjetas salten a una nueva l√≠nea si no hay espacio */
    flex-wrap: wrap;
    
    /* 3. Distribuye el espacio entre las tarjetas */
    justify-content: flex-start; /* O usa 'space-around' o 'space-between' */
    
    /* 4. Opcional: a√±ade un poco de separaci√≥n entre los elementos */
    gap: 20px; /* Espacio horizontal y vertical entre las tarjetas */
    
    /* 5. Opcional: padding interno para que no queden pegadas al borde del contenedor */
    padding: 20px;
}

/* Regla para la tarjeta individual, asegurando que tiene un ancho m√≠nimo */
.promo-card {
    /* Asegura que la tarjeta no sea m√°s ancha que su contenedor (por ejemplo, 200px) */
    width: 200px; 
    
    /* Permite que la tarjeta se encoja si es necesario (cuando no hay espacio) */
    flex-shrink: 1; 
    
    /* M√≠nimo ancho para evitar que se aplaste demasiado */
    min-width: 180px; 
    
    /* ... (resto de tus estilos de promo-card) */
}


.promo-card img {
  width: 100%;
  border-radius: 8px;
  margin-bottom: 8px;
}

.qty-control {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-top: 5px;
}
.qty-btn {
  padding: 4px 10px;
  font-size: 18px;
  background: #eee;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.qty-btn:hover {
  background: #ccc;
}

.carrito-resumen {
  margin-top: 24px;
  background: #f8f8f8;
  border-radius: 10px;
  padding: 16px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.carrito-lista table {
  width: 100%;
  border-collapse: collapse;
}
.carrito-lista td, .carrito-lista th {
  padding: 6px;
  border-bottom: 1px solid #ddd;
}
.carrito-total {
  font-weight: bold;
  margin-top: 8px;
  text-align: right;
}

.btn-confirmar {
  width: 100%;
  padding: 10px;
  background: #27ae60;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 10px;
}
.btn-confirmar:hover {
  background: #219150;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  z-index: 1000;
}
.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  width: 320px;
  margin: 100px auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.btn {
  background: #3498db;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
}
.btn-cancel {
  background: #e74c3c;
  color: #fff;
}


.promo-img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 5px;
    margin-bottom: 5px;
}





/* --------------------
   AJUSTE DE ALINEACI√ìN (Vertical)
   -------------------- */
.button-group {
    display: flex; 
    /* üí° Clave: Cambia la direcci√≥n del flexbox a columna (vertical) */
    flex-direction: column; 
    
    /* Centra ambos botones en el eje horizontal (opcional) */
    align-items: center; 
    
    /* Esto alinea el grupo completo a la derecha, si el contenedor es ancho (opcional) */
    justify-content: flex-end; 
    
    /* Espacio vertical entre los botones */
    gap: 10px;
    margin-bottom: 20px;
}

/* --------------------
   RESTO DE ESTILOS (Mantenidos)
   -------------------- */
/* --------------------
   AJUSTE DE ALINEACI√ìN (Vertical y a la Izquierda) üëà
   -------------------- */
.button-group {
    display: flex; 
    /* Direccion vertical (uno debajo del otro) */
    flex-direction: column; 
    
    /* üí° Clave: Esto alinea los elementos (botones) a la izquierda */
    align-items: flex-start; 
    
    /* Si tienes un contenedor grande, aseg√∫rate que el grupo est√© a la izquierda */
    justify-content: flex-start; /* Esto alinea el grupo completo a la izquierda */
    
    gap: 10px;
    margin-bottom: 20px;
}

/* --------------------
   ESTILOS BASE DEL BOT√ìN
   -------------------- */
.button {
    padding: 10px 15px;
    border-radius: 5px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
    /* Asegura que los botones no se estiren m√°s de un ancho razonable */
    width: 100%; 
    max-width: 250px; 
}

/* Bot√≥n AGREGAR (Primario) */
.button-primary {
    background-color: #007bff; 
    color: white; 
    border: 2px solid #007bff; 
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
}
.button-primary:hover { background-color: #0056b3; border-color: #0056b3; }
/* ... (otros estilos de hover/active) */

/* Bot√≥n EXPORTAR (Secundario) */
.button-secondary {
    background-color: transparent; 
    color: #333; 
    border: 2px solid #ccc; 
}
.button-secondary:hover { background-color: #f0f0f0; border-color: #b3b3b3; }
.button-secondary:active { transform: translateY(1px); }
.cancel-btn {
    background-color: #6c757d;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}


/* 1. Contenedor principal: organiza los elementos en fila y maneja el desbordamiento */
.category-buttons-container {
    display: flex;
    flex-wrap: wrap; /* Permite que los botones salten a la siguiente l√≠nea si no hay espacio */
    gap: 10px; /* Espacio uniforme entre todos los elementos (botones y bot√≥n de acci√≥n) */
    padding: 15px 0;
    align-items: center; /* Alinea verticalmente el bot√≥n de acci√≥n con los botones de categor√≠a */
    border-bottom: 1px solid #ddd;
    margin-bottom: 20px;
}


/* 2. Estilo base del bot√≥n de categor√≠a */
.category-button-label {
    /* Quitamos el borde inline anterior y usamos un dise√±o m√°s limpio */
    display: inline-flex;
    align-items: center;
    padding: 8px 15px;
    background-color: #f8f8f8; /* Fondo claro por defecto */
    color: #333;
    border: 1px solid #ccc;
    border-radius: 20px; /* Bordes redondeados para un aspecto moderno */
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    font-size: 14px;
    user-select: none; /* Evita selecci√≥n de texto al hacer clic */
}

/* 3. Efecto hover */
.category-button-label:hover {
    background-color: #eee;
    border-color: #aaa;
}

/* 4. Estilo de SELECCIONADO (VISTOSO) */
/* Aplicado cuando el checkbox DENTRO del label est√° marcado */
.category-checkbox:checked + label {
    /* El selector + label no funciona aqu√≠ porque el checkbox no est√° antes del label, est√° dentro. 
       Usaremos el selector padre: */
}

.category-checkbox:checked {
    /* Para ocultar el checkbox por defecto si quieres que solo se vea el color del label */
    /* display: none; */ 
}

/* Estilo para el label cuando el checkbox DENTRO est√° chequeado. */
/* Como el checkbox es el primer hijo, debemos usar un selector m√°s complejo si queremos 
   cambiar el estilo del padre. La forma m√°s sencilla es usar la clase y el selector :has() 
   (si es soportado) o cambiar ligeramente la estructura. 
   
   Por simplicidad y compatibilidad: El estilo se aplicar√° al label cuando el checkbox est√© checked. */

/* Estilo simple (si no ocultas el checkbox): */
.category-checkbox:checked + .category-button-label { /* Esto requiere que el label est√© DENTRO del input, o el checkbox est√© FUERA. */
    
}
/* La estructura actual es: <label><input type="checkbox">Texto</label>
   El CSS debe ser: */
.category-button-label:has(.category-checkbox:checked) {
    background-color: #007bff; /* Color de selecci√≥n azul vibrante */
    color: white;
    border-color: #0056b3;
}


/* Si no usas :has() (navegadores antiguos), puedes dejar el dise√±o del checkbox visible, 
   o simplificar el JavaScript para que la clase se a√±ada al label con un listener 'change'. */

/* Para el dise√±o VISTOSO, aseg√∫rate que los checkboxes por defecto sean menos intrusivos */
.category-checkbox {
    /* Estilos opcionales para checkbox */
    accent-color: #007bff;
}

/* 5. Estilo del bot√≥n principal de acci√≥n */
.action-button {
    background-color: #28a745;
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.2s;
    font-weight: bold;
}

.action-button:hover {
    background-color: #1e7e34;
}



    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>


<body> 	


 <nav class="sidebar">
  <h2>MENU</h2>
  <ul style="list-style:none; padding:0; margin:0;">
    <li><button class="tab-btn" data-tab="pedidos">Pedidos</button></li>
    <li><button class="tab-btn" data-tab="pedidosArchivados">Pedidos Archivados</button></li>
    <li><button class="tab-btn active" data-tab="promos">Promociones</button></li>
    
    <li><button class="tab-btn" data-tab="reporteVentas">Reporte de Ventas</button></li>
    <li><button class="tab-btn" data-tab="categorias">Categor√≠as</button></li>
    <li><button class="tab-btn" data-tab="localidades">Localidades</button></li>
    <li><button class="tab-btn" data-tab="documentos">Documentos</button></li>
  </ul>
</nav>
   
    
    
<div class="content">
<!-- üîπ Agregar este bot√≥n junto al de Exportar -->
<div>
<button id="addPromoBtn" 
  style="margin-left:10px;padding:6px 12px;background:#2ecc71;color:#fff;
  border:none;border-radius:6px;cursor:pointer;">
  ‚ûï Nueva Promoci√≥n
</div>
        <div id="promos" class="section active">
        <div style="margin-bottom:20px;">
	<div id="promoCategoriaFilter" style="margin-bottom: 50px;">
    	</div>
        </select>
        <option value="">Todas las categor√≠as</option>
        </select>
        <button id="exportPromoPDF" style="margin-left:10px;padding:6px 12px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;">Exportar 	seleccionados</button>
        </div>
        <div id="promoList" style="display:grid; grid-template-rows: repeat(auto-fill,minmax(250px,1fr)); gap:16px;"></div>
        </div>
	<div id="editPromoModal" class="modal">
    	<div class="modal-content">
        <span class="close-button" onclick="document.getElementById('editPromoModal').style.display = 'none'">&times;</span>
        <h3>Editar Promoci√≥n</h3>
        <input type="hidden" id="modalPromoId">
        <input type="hidden" id="modalOldImageName">
        <label for="modalNombre">Nombre de la Promoci√≥n</label>
	<input type="text" id="modalNombre" required>
        <label for="modalImageFile">Cambiar Imagen:</label>
        <input type="file" id="modalImageFile" accept="image/*">
        <p>Imagen actual: <span id="modalCurrentImageName" style="font-style: italic;"></span></p>
<div class="form-group">
    <label for="modalCategoria">Categor√≠a actual:</label>
    <select id="modalCategoria" class="form-control">
        <option value="">Cargando categor√≠as...</option>
    </select>
</div>

        <label for="modalPrecio">Precio Actual ($):</label>
        <input type="number" id="modalPrecio" min="0" step="0.01" required>
        
        <label for="modalPrecioAnterior">Precio Anterior ($):</label>
        <input type="number" id="modalPrecioAnterior" min="0" step="0.01">
        
        <label for="modalStock">Stock (unidades):</label>
        <input type="number" id="modalStock" min="0" required>


   
        <div style="margin-top: 20px; text-align: right;">
            <button onclick="document.getElementById('editPromoModal').style.display = 'none'" class="cancel-btn">Cancelar</button>
            <button onclick="savePromotionChanges()" class="save-btn">Guardar Cambios</button>
        </div>
    </div>
</div>



<section id="categorias" class="section">
  <h2 style="margin-bottom:15px;">Categor√≠as</h2>

  <button id="addCategoriaBtn"
      style="padding:6px 12px;background:#2ecc71;color:#fff;border:none;border-radius:6px;margin-bottom:15px;">
      ‚ûï Nueva Categor√≠a
  </button>

  <div id="categoriaList"></div>
</section>         





        <div id="pedidos" class="section">
            <h2>Pedidos</h2>
<div id="totalesPedidosBox" style="margin-bottom:15px;"></div>
            <form id="pedidoForm" onsubmit="return false;" 
      style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:flex-start;">
<!-- Cliente: m√°s largo -->
    <div style=""width:40%; min-width:50px; display:flex; flex-direction:column;">
        <label>Cliente</label>
        <input id="pedidoCliente" type="text" placeholder="Nombre cliente" style="width:500px;" /> <div>
	</div>
<!-- DNI -->
	<div style="width:30%; min-width:180px; display:flex; flex-direction:column;">
  <label>DNI</label>
  <input id="pedidoDni" type="text" placeholder="Documento del cliente" style="width:500px;" />
</div>
<!-- Localidad -->
    	<div style=""width:30%; min-width:180px; display:flex; flex-direction:column;">
        <label>Localidad</label>
        <select id="pedidoLocalidad" style="width:500px;"></select> <div>
	</div>
<!-- Seleccionar Productos -->
    	<div style="flex:1; min-width:180px; display:flex; flex-direction:column; justify-content:flex-start;">
        <label>Productos</label>
        <button type="button" id="selectProductsBtn" 
        style="width:300px; background-color:#4CAF50; color:white; border:none; padding:8px 0; border-radius:4px; cursor:pointer;">
        Seleccionar Productos
        </button> <div>
<!-- Productos seleccionados debajo -->
	<div style="width:100%; margin-top:6px;">
        <div id="selectedProductsContainer" class="small-muted">No hay productos seleccionados</div>
</div>
    	</div>

	<div class="button-group">
	<button type="button" id="addOrderBtn" class="button button-primary">
        + Confirmar Pedido
    	</button>
    	</div>
    	</div>
	</div>	
<div id="pedidos" class="tab-content" data-section="pedidos">
    <h2>Pedidos Activos</h2>

    <div style="margin-bottom: 20px; padding: 10px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <label for="orderSearch" style="display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50;">Buscar Cliente:</label>
        <input 
            type="text" 
            id="orderSearch" 
            placeholder="Escriba nombre, apellido o DNI del cliente..." 
            oninput="debounceFetchOrders()"
            style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em;"
        >
    </div>
    <div id="totalesPedidos"></div>
    <div id="pedidoList">
        </div>
</div>

	<h2>Lista de Pedidos</h2>
	<div id="pedidoList"></div>
	<div id="botonArchivarMesActual" style="margin-top:25px; text-align: right;">
    <button id="archiveButton" onclick="archiveCurrentMonthOrders()" class="action-button" style="background-color: #f39c12; padding: 10px 20px;">
        üì¶ Archivar Pedidos del Mes Actual
    </button>
</div>
	</div>
	</div>

<section id="pedidosArchivados" class="section" style="display:none;">
    <h2>Pedidos Archivados</h2>

    <div id="buscadorArchivados" style="margin-bottom:20px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        
        <input type="text" id="archiveSearchTerm" placeholder="Buscar por Nombre, Apellido o DNI" 
               style="padding:8px; border-radius:4px; border:1px solid #ccc; flex-grow: 1; min-width: 200px;">
        
        <label for="archiveMonth" style="font-weight:bold;">Mes:</label>
        <select id="archiveMonth" style="padding:8px; border-radius:4px; border:1px solid #ccc;"></select>
        
        <label for="archiveYear" style="font-weight:bold;">A√±o:</label>
        <select id="archiveYear" style="padding:8px; border-radius:4px; border:1px solid #ccc;"></select>
        
        <button id="searchArchivedBtn" class="button button-primary" onclick="fetchArchivedOrders()" style="padding:8px 15px; margin-left:10px;">
            üîç Buscar
        </button>
    </div>
    
    <div id="listadoArchivados"></div>
</section>





<!-- üîπ Modal de imagen ampliada -->
<div id="imageModal" 
     style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.85); justify-content:center; align-items:center;">
  <img id="modalImage" 
       src="" 
       alt="Imagen de promoci√≥n" 
       style="max-width:90%; max-height:90%; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.5);">
</div>




</section>

<section id="reporteVentas" class="section">
    <h2>üìà Reporte de Ventas por Producto</h2>
    <p style="color:#555;">Muestra la cantidad total vendida de cada producto a trav√©s de los pedidos activos. Use esta informaci√≥n para planificar sus pedidos de reposici√≥n de stock.</p>
    
    <div style="margin-bottom: 15px; text-align: right;">
        <button onclick="exportSalesPDF()" 
                style="padding: 8px 15px; border: none; border-radius: 6px; background: #c0392b; color: white; cursor: pointer; font-weight: bold;">
            ‚¨áÔ∏è Exportar PDF
        </button>
    </div>
    <div id="salesReportContainer" style="margin-top:20px;">
        <p>Cargando datos de ventas...</p>
    </div>
</section>



<div id="imageModal" 
     style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%;




<div id="categoriasContainer" class="section">
	<h1>Gesti√≥n de Categor√≠as</h1>
 	
  	<button id="addCategoriaBtn">Agregar</button>
  	<div id="categoriaList"></div>
	</div>


<!-- LOCALIDADES -->
      <div id="localidades" class="section">
      <h1>Gesti√≥n de Localidades</h1>
      <input type="text" id="localidadNombre" placeholder="Nueva localidad" />
      <button onclick="addLocalidad()">Agregar</button>
      <div id="localidadList"></div>
      </div>


<div id="documentos" class="section">
      <h1>Gesti√≥n de Documentos</h1>
      <input type="file" id="docArchivo" />
      <button id="addDocumentoBtn">Agregar Documento</button>
      <button id="fetchDocumentosBtn">Actualizar Documentos</button>
      <div id="docList" style="margin-top:18px;"></div>
      </div>



       


<!-- Contenedor de categor√≠as y promociones -->
<div id="categoriasContainer"></div>
<div id="productosContainer"></div>

    <div id="productosContainer"></div> <!-- Aqu√≠ van las categor√≠as y productos -->
    </div>
</div>


<div id="pedidoModal" class="modal">
  <div class="modal-content">
    <h3>Confirmar Pedido</h3>
    <label>Nombre:</label>
    <input id="modalClienteNombre" type="text" placeholder="Nombre completo">
    <label>DNI:</label>
<input id="modalClienteDni" type="text" placeholder="Documento del cliente">
    <label>Localidad:</label>
    <select id="modalLocalidadSelect"></select>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
      <button onclick="cerrarModalPedido()">Cancelar</button>
<button onclick="confirmarPedido()">Confirmar Pedido</button>
    </div>
  </div>
</div>


<!-- === MODAL GEN√âRICO === -->
<div id="modal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 2000;
">
  <div id="modalInner" style="
    background: #fff;
    padding: 24px;
    border-radius: 12px;
    max-width: 900px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  ">
    <!-- contenido din√°mico -->
  </div>
  <button onclick="closeModal()" style="
    position: absolute;
    top: 15px;
    right: 20px;
    background: #ff4d4f;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    cursor: pointer;
    font-weight: bold;
  ">‚úñ</button>
</div>





<!-- Modal Medios de Pago -->
<div id="modalPago" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:white;padding:25px;border-radius:10px;max-width:500px;width:90%;text-align:left;">
    <h3>Registrar Medios de Pago</h3>
    <div id="listaPagos"></div>
 Total: $<span id="pagoTotal">0.00</span>
    <button onclick="agregarMedioPago()" 
      style="margin:10px 0;background:#2ecc71;color:white;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;">
      + Agregar m√©todo
    </button>
    <hr>
    <p><b>Total pedido:</b> $<span id="totalPedido"></span></p>
    <p><b>Total abonado:</b> $<span id="totalPagado">0.00</span></p>
    <p><b>Saldo pendiente:</b> $<span id="saldoPendiente">0.00</span></p>
    <p><b>Estado del Pedido:</b> $<span id="estadoPedido">Pendiente</span></p>
    <div style="text-align:right;margin-top:15px;">
      <button onclick="cerrarModalPago()" style="padding:8px 12px;">Cancelar</button>
      <button onclick="guardarPagosPedido()" 
        style="padding:8px 12px;background:#3498db;color:white;border:none;border-radius:6px;">Guardar</button>
    </div>
  </div>
</div>



<div id="addPromoModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close-button" onclick="document.getElementById('addPromoModal').style.display='none'">&times;</span>
    <h3>Nueva Promoci√≥n</h3>

    <label for="newPromoNombre">Nombre de la promoci√≥n:</label>
   <input type="text" id="newPromoNombre" placeholder="Nombre" />

    <label for="newPromoPrecio">Precio ($):</label>
    <input type="number" id="newPromoPrecio" min="0" step="0.01" />
<label for="newPromoPrecioAnterior">Precio anterior ($):</label>
<input type="number" id="newPromoPrecioAnterior" min="0" step="0.01">
    <label for="newPromoStock">Stock (unidades):</label>
    <input type="number" id="newPromoStock" name="stock" min="0">
    <label for="newPromoCategoria">Categor√≠a:</label>
    <select id="newPromoCategoria"></select>

    <label for="newPromoImagen">Imagen:</label>
    <input type="file" id="newPromoImagen" accept="image/*">

    <div style="margin-top: 20px; text-align: right;">
      <button onclick="document.getElementById('addPromoModal').style.display='none'" class="cancel-btn">Cancelar</button>
      <button onclick="guardarNuevaPromo()" class="save-btn">Guardar</button>
    </div>
  </div>
</div>



<script>




document.getElementById("addPromoBtn").addEventListener("click", async () => {
  // Cargar categor√≠as para el select
  const { data: categorias } = await supabase.from("categorias").select("id,nombre").order("nombre");
  const select = document.getElementById("newPromoCategoria");
  select.innerHTML = categorias.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('');
  document.getElementById("addPromoModal").style.display = "block";
});

async function guardarNuevaPromo() {
  const nombre = document.getElementById("newPromoNombre").value.trim();
  const precio = parseFloat(document.getElementById("newPromoPrecio").value);
const precio_anterior = parseFloat(document.getElementById("newPromoPrecioAnterior").value) || null;
  const stock = parseInt(document.getElementById("newPromoStock").value);
  const categoria_id = document.getElementById("newPromoCategoria").value || null;
  const file = document.getElementById("newPromoImagen").files[0];

  if (!nombre || isNaN(precio) || isNaN(stock)) {
    alert("Completa todos los campos obligatorios.");
    return;
  }

  let imagenPath = null;
  if (file) {
    const fileName = `promo_${Date.now()}_${file.name}`;
    const { error: uploadError } = await supabase.storage.from("promo_images").upload(fileName, file);
    if (uploadError) return alert("Error al subir la imagen: " + uploadError.message);
    imagenPath = fileName;
  }



  const { error } = await supabase.from("promociones").insert([{ nombre, precio, precio_anterior, stock, categoria_id, imagen: imagenPath }]);
  if (error) return alert("Error al guardar: " + error.message);

  document.getElementById("addPromoModal").style.display = "none";
  showToast("‚úÖ Promoci√≥n agregada correctamente");
  fetchPromos(); // Refrescar lista
}

// üîπ Limpiar campos para cargar una nueva promo
  document.getElementById("newPromoNombre").value = "";
  document.getElementById("newPromoPrecio").value = "";
  document.getElementById("newPromoPrecioAnterior").value = "";
  document.getElementById("newPromoStock").value = "";
  document.getElementById("newPromoCategoria").selectedIndex = 0;
  document.getElementById("newPromoImagen").value = "";



// Funci√≥n para mostrar la secci√≥n deseada y ocultar todas las dem√°s
function navigateTo(tabName) {
    // 1. Oculta todas las secciones
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });

    // 2. Muestra la secci√≥n deseada
    const targetSection = document.getElementById(tabName);
    if (targetSection) {
        targetSection.classList.add('active');
        // ... (resto de l√≥gica del sidebar)
    }

    // 3. Actualiza el estado 'active' de los botones
    document.querySelectorAll('.sidebar .tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // El bot√≥n de la pesta√±a seleccionada se activa
    const targetButton = document.querySelector(`.sidebar .tab-btn[data-tab="${tabName}"]`);
    if (targetButton) {
        targetButton.classList.add('active');
    }

    // 4. L√ìGICA CLAVE: Cerrar el desplegable de Promociones si navegamos a otra secci√≥n
    const promoSubMenu = document.getElementById('promoSubMenu');
    const promoToggleBtn = document.querySelector('.dropdown-toggle');
    

}


// üîπ Mostrar imagen en grande
function mostrarImagenPromo(url) {
  const modal = document.getElementById("imageModal");
  const img = document.getElementById("modalImage");
  img.src = url;
  modal.style.display = "flex";
}

// üîπ Cerrar modal al hacer clic en cualquier parte oscura o en la imagen
document.getElementById("imageModal").addEventListener("click", () => {
  document.getElementById("imageModal").style.display = "none";
  document.getElementById("modalImage").src = "";
});




/* =========================================================
   Configuraci√≥n Supabase (cliente)
   ========================================================= */
const SUPABASE_URL = "https://ejbqlejlgprvwzrptojo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let availableCategorias = [];



// --- NUEVA FUNCI√ìN: Carga todas las categor√≠as disponibles ---
async function fetchAvailableCategorias() {
    try {
        const { data: categorias = [], error } = await supabase
            .from("categorias")
            .select("id, nombre") // Solo necesitamos ID y nombre
            .order("nombre", { ascending: true });
        
        if (error) throw error;
        
        availableCategorias = categorias; // Almacenamos la lista completa
        
    } catch (err) {
        console.error('Error cargando categor√≠as disponibles:', err);
    }
}


// --- NUEVA FUNCI√ìN: Llena el <select> en el modal ---
function populateCategoriaSelect(selectedCategoryId) {
    const select = document.getElementById('modalCategoria');
    if (!select) return;

    // 1. Limpiar y a√±adir opci√≥n por defecto
    select.innerHTML = '<option value="" disabled selected>Seleccione una categor√≠a</option>';
    
    if (availableCategorias.length === 0) {
        select.innerHTML += '<option value="">No hay categor√≠as disponibles</option>';
        return;
    }

    // 2. Inyectar las opciones
    availableCategorias.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = cat.nombre;
        
        // CR√çTICO: Seleccionar la categor√≠a actual de la promoci√≥n
        // Usamos == para manejar la posible diferencia entre string/number en los IDs.
        if (cat.id == selectedCategoryId) { 
            option.selected = true;
        }
        select.appendChild(option);
    });
}

/**
 * Funci√≥n auxiliar para obtener el valor de un elemento de forma segura.
 * Si el elemento no existe (es null), retorna null.
 */
const getSafeValue = (id) => {
    const element = document.getElementById(id);
    if (!element) {
        // En un entorno de producci√≥n, puede comentar esta advertencia.
        console.warn(`Elemento ${id} no encontrado. Asumiendo valor nulo.`);
        return null;
    }
    return element.value;
};


// ----------------------------------------------------------------------

/**
 * Guarda los cambios de la promoci√≥n, maneja la carga/eliminaci√≥n de la imagen.
 */
async function savePromotionChanges() {
    
    // ================= 1. OBTENER VALORES DE FORMA SEGURA =================
    
    // ‚ö†Ô∏è CR√çTICO: Usamos getSafeValue para prevenir el TypeError.
    const promoId = getSafeValue('modalPromoId');
    const oldImageName = getSafeValue('modalOldImageName');
    
    // Archivo de imagen se maneja diferente (files[0])
    const newImageFileElement = document.getElementById('modalImageFile');
    const newImageFile = newImageFileElement && newImageFileElement.files ? newImageFileElement.files[0] : null;

    // Obtener el resto de los valores de forma segura
    const newNombre = getSafeValue('modalNombre');
    const newPrecioStr = getSafeValue('modalPrecio');
    const newPrecioAnteriorStr = getSafeValue('modalPrecioAnterior');
    const newStockStr = getSafeValue('modalStock');
    
    // L√≥gica para Categor√≠a (ya robusta)
    const categoriaElement = document.getElementById('modalCategoria');
    let newCategoriaId = null;

    if (categoriaElement) {
        newCategoriaId = categoriaElement.value;
        // Si el valor es una cadena vac√≠a (opci√≥n por defecto sin valor), lo establecemos a null.
        if (newCategoriaId === "") newCategoriaId = null;
    }
    
    // ================= 2. VALIDACI√ìN Y PARSEO =================

    let newImageName = oldImageName;
    
    if (!promoId) return alert('Error: ID de promoci√≥n no encontrado. No se puede guardar.');
    
    // Parseo: Usamos || '0' o || '' para garantizar que parseFloat/parseInt no fallen con null.
    const newPrecio = parseFloat(newPrecioStr || '0');
    const newPrecioAnterior = parseFloat(newPrecioAnteriorStr || '0');
    const newStock = parseInt(newStockStr || '0') || 0;
    
    // ID del contenedor de la barra de progreso (Aseg√∫rese de que exista en su HTML)
    const progressBarContainerId = 'uploadProgressBarContainer'; 

    try {
        // 3. Manejo de la carga de imagen
        if (newImageFile) {
            // Se asume la existencia de updateProgressBar
            updateProgressBar(progressBarContainerId, 10, 'Iniciando carga de imagen...', true); 

            const fileExtension = newImageFile.name.split('.').pop();
            const uniqueName = `${promoId}_${Date.now()}.${fileExtension}`;

            const { error: uploadError } = await supabase.storage
                .from('promo_images')
                .upload(uniqueName, newImageFile, {
                    cacheControl: '3600',
                    upsert: false
                });
                
            updateProgressBar(progressBarContainerId, 50, 'Imagen cargada. Actualizando BBDD...');

            if (uploadError) throw uploadError;

            newImageName = uniqueName;

            // Eliminar la imagen anterior si existe
            if (oldImageName && oldImageName !== newImageName) {
                const { error: deleteError } = await supabase.storage
                    .from('promo_images')
                    .remove([oldImageName]);
                if (deleteError) console.warn('No se pudo eliminar la imagen anterior:', deleteError);
            }
        }
        
        updateProgressBar(progressBarContainerId, newImageFile ? 70 : 70, 'Actualizando registros...');


        // 4. Actualizar la base de datos
        const { error: updateError } = await supabase
            .from('promociones')
            .update({
                nombre: newNombre,
                precio: newPrecio,
                // Si el precio anterior es 0 o NaN (vac√≠o), guardamos null
                precio_anterior: isNaN(newPrecioAnterior) || newPrecioAnterior === 0 ? null : newPrecioAnterior, 
                stock: newStock,
                imagen: newImageName,
                categoria_id: newCategoriaId // ¬°Campo corregido!
            })
            .eq('id', promoId);

        if (updateError) throw updateError;
        
        updateProgressBar(progressBarContainerId, 100, 'Actualizaci√≥n completada!', true);

        alert('‚úÖ Promoci√≥n actualizada con √©xito!');
        document.getElementById('editPromoModal').style.display = 'none';

        // 5. Recargar la lista para reflejar cambios
        // Se asume la existencia de renderPromosByFilter
        const currentCategoryId = document.getElementById('promoCategoriaFilter').value; 
        await renderPromosByFilter(currentCategoryId);

    } catch (err) {
        console.error('Error al guardar cambios:', err);
        alert('Error al guardar cambios: ' + err.message);
    } finally {
        // Ocultar la barra de progreso al finalizar
        updateProgressBar(progressBarContainerId, 0, '', false);
    }
}




/* =========================================================
   Utilidades generales
   ========================================================= */
function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
function safeText(t){ return escapeHtml(t); }
function showToast(text, tiempo = 2200) {
    let toast = document.getElementById('appToast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'appToast';
        toast.style.cssText = 'position:fixed;right:16px;bottom:20px;background:#2ecc71;color:#fff;padding:12px 18px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.3);z-index:15000;opacity:0;transition:opacity .25s;';
        document.body.appendChild(toast);
    }
    toast.innerText = text;
    toast.style.opacity = '1';
    clearTimeout(toast._to);
    toast._to = setTimeout(() => { toast.style.opacity = '0'; }, tiempo);
}
function openModal(innerHtml) {
    const inner = document.getElementById('modalInner');
    inner.innerHTML = innerHtml;
    document.getElementById('modal').style.display = 'flex';
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

/* =========================================================
   Sidebar & Navegaci√≥n entre secciones
   ========================================================= */
function toggleSidebar(){
  const sidebar = document.querySelector('.sidebar');
  const backdrop = document.getElementById('backdrop');
  sidebar.classList.toggle('open');
  backdrop.classList.toggle('show');
}

document.getElementById('menuBtn')?.addEventListener('click', toggleSidebar);


// La funci√≥n de limpieza que debes haber definido:
function limpiarContenedoresTienda() {
    const categoriasCont = document.getElementById('categoriasContainer');
    const productosCont = document.getElementById('productosContainer');

    if (categoriasCont) categoriasCont.innerHTML = ''; 
    if (productosCont) productosCont.innerHTML = ''; 
}


// Funci√≥n √∫nica para manejar el cambio de secciones
function activateSection(tab) {
  
  // üí• PASO 1: Si no vamos a la tienda, limpiamos sus elementos inyectados üí•
  if (tab !== 'clienteTienda') {
      limpiarContenedoresTienda();
  }

// === üí° NUEVA L√ìGICA: MANEJO DE VISIBILIDAD DEL BOT√ìN "AGREGAR PROMOCI√ìN" ===
  const addPromoBtn = document.getElementById('addPromoBtn');

  // 1. Ocultar el bot√≥n por defecto para todas las secciones
  if (addPromoBtn) {
      addPromoBtn.style.display = 'none';
  }
  
  // 2. Mostrar el bot√≥n S√ìLO si la pesta√±a es 'promos'
  if (tab === 'promos') {
      if (addPromoBtn) {
          addPromoBtn.style.display = 'block'; 
          // O 'inline-block' si as√≠ lo deseas, pero 'block' suele funcionar para botones.
      }
  }

    
  // 2. Quita 'active' de todas las secciones
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));

  // 3. Activa la secci√≥n seleccionada
  const section = document.getElementById(tab);
  if (section) section.classList.add('active');
  
  // 4. Carga los datos espec√≠ficos
  if (tab === 'promos') fetchPromos();  
  else if (tab === 'pedidos') fetchOrders();
  else if (tab === 'categorias') fetchCategorias();
  else if (tab === 'clienteTienda') cargarTiendaCliente();
  else if (tab === 'reporteVentas') fetchSalesData(); 
}



// Asigna los eventos de clic (versi√≥n CORRECTA)
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.getAttribute('data-tab');
    // activar la pesta√±a indicada por el data-tab del bot√≥n
    activateSection(tab);

    // cerrar sidebar en m√≥viles si estaba abierto
    if (window.innerWidth <= 500 && document.querySelector('.sidebar').classList.contains('open')) {
      toggleSidebar();
    }
  });
});



// Mostrar Promos por defecto
activateSection('promos');

/* =========================================================
   Variables globales
   ========================================================= */
let selectedProducts = [];
let editingOrderId = null;
let promociones = [];
let categorias = [];
let localidadSeleccionada = null; // Para la confirmaci√≥n del pedido
// Variables espec√≠ficas de la tienda cliente
let carritoCliente = [];
let promocionesGlobal = []; // Contiene todas las promos de la categor√≠a actual
let categoriaTiendaActual = null;
let lastOrdersScrollPosition = 0;


// Variable para controlar el retraso de la b√∫squeda (debounce)
let debounceTimer;

function debounceFetchOrders() {
    // Limpia el temporizador anterior para reiniciar la cuenta regresiva
    clearTimeout(debounceTimer);
    
    // Establece un nuevo temporizador que llamar√° a fetchOrders despu√©s de 300ms
    // si el usuario no sigue escribiendo.
    debounceTimer = setTimeout(fetchOrders, 300); 
}

// üí• NUEVA VARIABLE GLOBAL PARA CANTIDAD TEMPORAL EN TARJETA üí•
let cantidadesLocales = {};




/**
 * Maneja el clic en un bot√≥n de categor√≠a del submen√∫.
 */
function handleCategoryFilter() {
    const categoryId = this.dataset.categoryId;
    
    // 1. Marcar el bot√≥n activo y resetear los dem√°s
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    
    // 2. Asegurar que la secci√≥n de promos est√© activa
    document.querySelectorAll('.section').forEach((section) => section.classList.remove('active'));
    document.getElementById('promos').classList.add('active');
    
    // 3. Llamar a la funci√≥n de renderizado para cargar las promos filtradas
    // Si tienes el selector de filtro en el DOM, actualiza su valor:
    const filterSelect = document.getElementById('promoCategoriaFilter');
    if (filterSelect) filterSelect.removeEventListener('change', handlePromoFilterChange);
    
    // Llamar a la funci√≥n de renderizado (que ahora debe estar optimizada para el ID)
    renderPromosByFilter(categoryId); 
}


/* =========================================================
   Promociones: Carga Inicial de Categor√≠as en Submen√∫
   ========================================================= */

async function loadPromoSubMenu() {
    try {
        const { data: categorias = [], error: catError } = await supabase.from("categorias").select("id,nombre").order("nombre");
        if (catError) throw catError;
        
        const subMenu = document.getElementById('promoSubMenu');
        if (!subMenu) return;

        subMenu.innerHTML = ''; // Limpiar el men√∫ antes de llenarlo

        // Opci√≥n: "Ver Todas" al inicio
        const allBtn = document.createElement('button');
        allBtn.textContent = 'Todas las Promociones';
        allBtn.className = 'category-btn active'; // Activo por defecto
        allBtn.dataset.categoryId = ''; 
        allBtn.addEventListener('click', handleCategoryFilter);
        subMenu.appendChild(allBtn);

        // Botones de Categor√≠a
        categorias.forEach(c => {
            const btn = document.createElement('button');
            btn.textContent = safeText(c.nombre);
            btn.className = 'category-btn';
            btn.dataset.categoryId = c.id;
            btn.addEventListener('click', handleCategoryFilter);
            subMenu.appendChild(btn);
        });

    } catch (err) {
        console.error('loadPromoSubMenu error', err);
    }
}




/**
 * Carga las categor√≠as existentes en el select del modal.
 * @param {string|null} selectedId - ID de categor√≠a actualmente seleccionada (si hay).
 */
async function loadCategoriesIntoModal(selectedId = null) {
    const select = document.getElementById('modalCategoria');
    if (!select) return;

    try {
        const { data: categorias, error } = await supabase
            .from('categorias')
            .select('id, nombre')
            .order('nombre', { ascending: true });

        if (error) throw error;

        // Limpiar el select
        select.innerHTML = '';

        // Rellenar con opciones
        categorias.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.nombre;
            if (selectedId && parseInt(selectedId) === cat.id) {
                option.selected = true;
            }
            select.appendChild(option);
        });

    } catch (err) {
        console.error('Error al cargar categor√≠as:', err);
        select.innerHTML = '<option value="">Error al cargar</option>';
    }
}



// ===============================================
// === üÜï FUNCIONES DE EDICI√ìN Y MODAL üÜï ===
// ===============================================



/**
 * Abre el modal y carga los datos de la promoci√≥n seleccionada.
 * @param {number} promoId - ID de la promoci√≥n a editar.
 */
async function openEditModal(promoId) {
    const modal = document.getElementById('editPromoModal');
    if (!modal) {
        console.error("Modal 'editPromoModal' no encontrado.");
        return;
    }

    try {
        // 1. Obtener los datos de la promoci√≥n
        const { data: promo, error } = await supabase
            .from('promociones')
            .select('*')
            .eq('id', promoId)
            .maybeSingle();

        if (error || !promo) throw new Error(error?.message || 'Promoci√≥n no encontrada');
        
        // üí° CR√çTICO: Asegurarse de que las categor√≠as disponibles est√©n cargadas
        // (Esto es clave si el DOMContentLoaded fall√≥ o si se lleg√≥ aqu√≠ primero)
        if (availableCategorias.length === 0) {
            await fetchAvailableCategorias(); 
        }

        // 2. Llenar los campos del modal
        document.getElementById('modalPromoId').value = promo.id;
        document.getElementById('modalOldImageName').value = promo.imagen || '';
        document.getElementById('modalCurrentImageName').textContent = promo.imagen || 'Sin imagen';
        document.getElementById('modalNombre').value = promo.nombre || ''; 
        document.getElementById('modalPrecio').value = promo.precio || 0;
        document.getElementById('modalPrecioAnterior').value = promo.precio_anterior || '';
        document.getElementById('modalStock').value = promo.stock || 0;

        // 3. üéØ CORRECCI√ìN: Llenar el <select> y seleccionar la opci√≥n actual
        // Reemplazamos 'loadCategoriesIntoModal' por su funci√≥n 'populateCategoriaSelect'.
        populateCategoriaSelect(promo.categoria_id); 
        
        // Ya no necesita este c√≥digo, pues populateCategoriaSelect ya selecciona el valor
        /*
        const catSelect = document.getElementById('modalCategoria');
        if (catSelect && promo.categoria_id) {
            catSelect.value = promo.categoria_id;
        }
        */

        // Limpiar campo de archivo
        document.getElementById('modalImageFile').value = '';

        // 4. Mostrar el modal
        modal.style.display = 'block';

    } catch (err) {
        console.error('Error al abrir modal de edici√≥n:', err);
        alert('Error al cargar datos: ' + err.message);
    }
}






// ----------------------------------------------------------------------

/**
 * Muestra u oculta y actualiza la barra de progreso.
 * @param {string} containerId - ID del contenedor de la barra (e.g., 'progressBarContainer').
 * @param {number} progress - Progreso en porcentaje (0-100).
 * @param {string} text - Texto a mostrar.
 * @param {boolean} visible - Si debe ser visible.
 */
function updateProgressBar(containerId, progress, text, visible = true) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (visible) {
        // Asegurar que la barra existe dentro del contenedor (si no existe, la crea)
        let bar = container.querySelector('.progress-bar');
        let barText = container.querySelector('.progress-text');
        
        if (!bar) {
            // Estructura m√≠nima de la barra (con estilos inline para simplicidad)
            container.innerHTML = `
                <div class="progress-bar-inner" style="height: 10px; background-color: #f3f3f3; border-radius: 5px; margin-top: 5px;">
                    <div class="progress-bar" style="height: 100%; width: 0%; background-color: #007bff; border-radius: 5px; transition: width 0.3s;"></div>
                </div>
                <div class="progress-text" style="font-size: 0.8em; margin-top: 2px;"></div>
            `;
            bar = container.querySelector('.progress-bar');
            barText = container.querySelector('.progress-text');
        }

        container.style.display = 'block';
        if (bar) bar.style.width = `${progress}%`;
        if (barText) barText.textContent = text;
        
    } else {
        // Ocultar al finalizar la carga
        container.style.display = 'none';
    }
}


/* =========================================================
   Promociones: carga y render (CORREGIDO PARA AGRUPACI√ìN Y ESTILO)
   ========================================================= */

async function fetchPromos() {
    try {
        const { data: categorias = [], error: catError } = await supabase.from("categorias").select("id,nombre").order("nombre");
        if (catError) throw catError;
        
        const container = document.getElementById('promoCategoriaFilter');
        if (!container) return;
        
        // üÜï APLICAR ESTILOS DE CONTENEDOR FLEXBOX
        container.className = 'category-buttons-container';
        container.innerHTML = '';
        // ---------------------------------------------
        
        // üÜï Bot√≥n para mostrar las categor√≠as seleccionadas
        const showButton = document.createElement('button');
        showButton.textContent = 'Mostrar Seleccionadas'; // T√≠tulo m√°s corto
        showButton.id = 'btnShowSelectedCategories';
        showButton.className = 'action-button'; // Clase para estilos
        showButton.addEventListener('click', handleShowSelected);
        container.appendChild(showButton);

        // Array de opciones (se mantiene igual)
        const allOptions = [
            { id: '', nombre: 'Todas' }, 
            { id: 'sin_categoria', nombre: 'Sin Categor√≠a' },
            ...categorias.map(c => ({ id: String(c.id), nombre: c.nombre }))
        ];

        // Crear botones con checkbox para cada categor√≠a
        allOptions.forEach(c => {
            const label = document.createElement('label');
            label.className = 'category-button-label'; // Clase para el dise√±o del bot√≥n

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = c.id;
            checkbox.className = 'category-checkbox';
            checkbox.style.marginRight = '5px';
            
            // üí° Listener de Usabilidad (Desmarcar "Todas" si se selecciona otra)
            checkbox.addEventListener('change', (e) => {
                const clickedValue = e.target.value;
                const isChecked = e.target.checked;
                const todasCheckbox = document.querySelector('.category-checkbox[value=""]');

                if (clickedValue === '') {
                    if (isChecked) {
                        document.querySelectorAll('.category-checkbox:not([value=""])').forEach(cb => cb.checked = false);
                    }
                } else {
                    if (isChecked && todasCheckbox) {
                        todasCheckbox.checked = false;
                    }
                }
            });

            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(c.nombre));
            container.appendChild(label);
        });

        // ... (Mensaje inicial se mantiene igual) ...
        
    } catch (err) {
        console.error('fetchPromos error', err);
    }
}


// ----------------------------------------------------
// üÜï 2. Funci√≥n para manejar la selecci√≥n m√∫ltiple
// ----------------------------------------------------

function handleShowSelected() {
    const selectedIds = Array.from(document.querySelectorAll('.category-checkbox:checked'))
                            .map(cb => cb.value);
    renderPromosByFilter(selectedIds);
}

// ----------------------------------------------------
// üÜï 3. Funci√≥n para manejar el clic individual (Mostrar solo esa)
// ----------------------------------------------------

function handleCategorySingleClick(e, allCategoryIds) {
    const clickedCheckbox = e.target;
    if (!clickedCheckbox.checked) return;

    document.querySelectorAll('.category-checkbox').forEach(cb => {
        if (cb !== clickedCheckbox) cb.checked = false;
    });

    renderPromosByFilter([clickedCheckbox.value]);
}

function handlePromoFilterChange() {
    const sel = document.getElementById('promoCategoriaFilter');
    const selectedIds = Array.from(sel.options)
                            .filter(option => option.selected)
                            .map(option => option.value);
    renderPromosByFilter(selectedIds);
}


async function renderPromosByFilter(categoryIds = []) {
    const container = document.getElementById('promoList');
    if (!container) return;

    container.innerHTML = '<p style="padding: 20px;">Cargando promociones...</p>';

    if (categoryIds.length === 0) {
        container.innerHTML = '<p style="padding: 20px;">Selecciona una o m√°s categor√≠as para ver las promociones.</p>';
        return;
    }

    let query = supabase.from("promociones").select("*").order("id");
    let categoryName = 'Promociones Filtradas';

    const specificCategoryIds = categoryIds.filter(id => id !== 'sin_categoria' && id !== '');
    const isSinCategoriaSelected = categoryIds.includes('sin_categoria');
    const isTodasSelected = categoryIds.includes('');
    let filterApplied = false;

    if (categoryIds.length === 1) {
        const id = categoryIds[0];
        if (id === '') {
            categoryName = 'Todas las Promociones';
        } else if (id === 'sin_categoria') {
            categoryName = 'Sin Categor√≠a';
        } else {
            const { data: categoriaData } = await supabase.from("categorias").select("nombre").eq("id", id).maybeSingle();
            categoryName = categoriaData?.nombre || 'Promociones Filtradas';
        }
    } else if (categoryIds.length > 1) {
        categoryName = `M√∫ltiples Categor√≠as (${categoryIds.length} seleccionadas)`;
    }

    if (isTodasSelected) {
        categoryName = 'Todas las Promociones';
        filterApplied = true;
    } else if (specificCategoryIds.length > 0) {
        query = query.in('categoria_id', specificCategoryIds);
        categoryName = `M√∫ltiples Categor√≠as (${specificCategoryIds.length})`;
        filterApplied = true;
    } 
    
    if (isSinCategoriaSelected) {
        if (filterApplied) {
            categoryName = "Categor√≠as y Sin Categor√≠a";
        } else {
            query = query.is('categoria_id', null);
            categoryName = "Sin Categor√≠a";
            filterApplied = true;
        }
    }
    
    if (!filterApplied && specificCategoryIds.length === 0 && !isSinCategoriaSelected) {
        container.innerHTML = '<p style="padding: 20px;">Selecciona una o m√°s categor√≠as para ver las promociones.</p>';
        return;
    }

    const { data: promos = [], error: promoError } = await query;
    if (promoError) {
        console.error("Error al obtener promociones:", promoError);
        container.innerHTML = 'Error al cargar las promociones.';
        return;
    }
    
    container.innerHTML = ''; 

    if (promos.length === 0) {
        container.innerHTML = `<p style="padding: 20px;">No hay promociones en la categor√≠a: <b>${categoryName}</b></p>`;
        return;
    }
    
    // ‚úÖ Correcci√≥n 1: agregar texto al t√≠tulo
    const catTitle = document.createElement('h2');
    catTitle.textContent = categoryName;
    catTitle.style.marginTop = "0px"; 
    catTitle.style.paddingBottom = "3px"; 
    catTitle.style.marginBottom = "0"; 
    catTitle.style.lineHeight = "3";
    catTitle.style.borderBottom = "1px solid #333";
    catTitle.style.fontSize = "18px";
    container.appendChild(catTitle);
    
    // ‚úÖ Correcci√≥n 3: ID √∫nico para la barra de progreso
    const progressBarContainer = document.createElement('div');
    progressBarContainer.id = `renderProgressBarContainer_${Date.now()}`;
    progressBarContainer.style.marginTop = '0px'; 
    progressBarContainer.style.marginBottom = '10px'; 
    container.appendChild(progressBarContainer);

    const promoContainer = document.createElement('div');
    promoContainer.className = "promo-group-container"; 
    promoContainer.style.marginTop = '0px';
    promos.sort((a,b)=>a.id-b.id);
    
    const totalPromos = promos.length; 
    let renderedCount = 0;
    
    for (const p of promos) {
        // ‚úÖ Correcci√≥n 2: obtener URL p√∫blica sin generar signedUrl por cada una
        let imgSrc = p.imagen_url || '';
        if (p.imagen) { 
            try {
                const { data: publicData } = supabase.storage.from('promo_images').getPublicUrl(p.imagen);
                imgSrc = publicData?.publicUrl || imgSrc;
            } catch (err) { 
                console.warn('Error al obtener URL p√∫blica para:', p.imagen, err); 
            }
        } 

        const imgEl = document.createElement('img');
        imgEl.alt = p.nombre || '';
        imgEl.src = imgSrc || '';
	imgEl.crossOrigin = 'anonymous';
        imgEl.style.width = '80%';
        imgEl.style.height = '100px'; 
        imgEl.style.objectFit = 'contain';
        imgEl.style.borderRadius = '6px';
        imgEl.style.marginBottom = '6px';

        
        const div = document.createElement('div');
        div.className = 'promo-card';
        div.style.position = 'relative'; 

        div.innerHTML = `
    <input type="checkbox" class="promo-select" data-promo-id="${p.id}" checked>

    <!-- Botones flotantes (EDITAR + ELIMINAR) -->
    <div style="
        position: absolute; 
        top: 5px; 
        right: 5px; 
        z-index: 10; 
        display: flex; 
        flex-direction: column; 
        align-items: flex-end; 
        gap: 4px;
    ">
        <button 
            onclick="openEditModal(${p.id})" 
            style="background: #007bff; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px; transition: background 0.3s;"
            onmouseover="this.style.background='#0056b3'"
            onmouseout="this.style.background='#007bff'"
            type="button"
        >
            Editar ‚úèÔ∏è
        </button>
        <button 
            onclick="deletePromo(${p.id})" 
            style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 10px; transition: background 0.3s;"
            onmouseover="this.style.background='#a71d2a'"
            onmouseout="this.style.background='#dc3545'"
            type="button"
        >
            Eliminar üóëÔ∏è
        </button>
    </div>

    <!-- Contenido de la tarjeta -->
    <div style="text-align:center; margin-top: 10px;">
        <b>${safeText(p.nombre || '')}</b>
    </div>

    <div style="text-align:center; margin-top:4px;">
        ${
            p.precio_anterior && Number(p.precio_anterior) > Number(p.precio)
                ? `<del style="color:#888;">$${Number(p.precio_anterior).toFixed(2)}</del> 
                   <span style="color:red;font-weight:bold;">$${Number(p.precio).toFixed(2)}</span>`
                : `<span style="font-weight:bold;">$${Number(p.precio).toFixed(2)}</span>`
        }
    </div>

    <div style="text-align:center; margin-top:4px; font-size:0.9em; color:${p.stock <= 5 ? 'red' : '#333'};">
        Stock: <b>${p.stock !== null && p.stock !== undefined ? p.stock : 'N/A'}</b>
    </div>
`;


        if (imgSrc) {
    const nameElement = div.querySelector('b');
    if (nameElement && nameElement.parentNode) {
        nameElement.parentNode.parentNode.insertBefore(imgEl, nameElement.parentNode);
    } else {
        div.insertBefore(imgEl, div.firstChild);
    }
}

 

        promoContainer.appendChild(div);
        
        renderedCount++;
        const progress = Math.round((renderedCount / totalPromos) * 100);
        updateProgressBar(progressBarContainer.id, progress, `Cargando Promociones: ${renderedCount} de ${totalPromos}`, true);
    }
    
    container.appendChild(promoContainer);
    updateProgressBar(progressBarContainer.id, 100, `Carga completa (${totalPromos} promociones).`, false);
}

fetchPromos();

// =========================================================
// üóëÔ∏è Eliminar promoci√≥n individual + imagen del storage
// =========================================================
async function deletePromo(promoId) {
    if (!confirm('¬øSeguro que deseas eliminar esta promoci√≥n?')) return;
    
    try {
        // 1Ô∏è‚É£ Traer primero la promoci√≥n para saber si tiene imagen
        const { data: promoData, error: fetchError } = await supabase
            .from('promociones')
            .select('imagen')
            .eq('id', promoId)
            .maybeSingle();

        if (fetchError) throw fetchError;

        // 2Ô∏è‚É£ Si tiene imagen, eliminarla del bucket
        if (promoData?.imagen) {
            try {
                const { error: imgDelError } = await supabase.storage
                    .from('promo_images')
                    .remove([promoData.imagen]);

                if (imgDelError) console.warn('‚ö†Ô∏è No se pudo eliminar imagen:', imgDelError.message);
            } catch (err) {
                console.warn('Error al intentar eliminar imagen del storage:', err);
            }
        }

        // 3Ô∏è‚É£ Eliminar promoci√≥n
        const { error: deleteError } = await supabase
            .from('promociones')
            .delete()
            .eq('id', promoId);
        if (deleteError) throw deleteError;

        alert('‚úÖ Promoci√≥n eliminada correctamente.');

        // 4Ô∏è‚É£ Recargar vista
        const selectedIds = Array.from(document.querySelectorAll('.category-checkbox:checked')).map(cb => cb.value);
        renderPromosByFilter(selectedIds);

    } catch (err) {
        console.error('‚ùå Error al eliminar la promoci√≥n:', err);
        alert('Error al eliminar la promoci√≥n: ' + err.message);
    }
}


/* =========================================================
   Exportar promos a PDF (CORREGIDO: Consulta Supabase)
   ========================================================= */

async function exportSelectedPromos() {
    try {
        // ... (1Ô∏è‚É£ Obtener IDs seleccionados, 2Ô∏è‚É£ Traer datos completos de Supabase, 3Ô∏è‚É£ Categor√≠as, 4Ô∏è‚É£ Agrupar por categor√≠a - ESTOS PASOS SE MANTIENEN IGUAL) ...

        // 1Ô∏è‚É£ Obtener IDs seleccionados
        const selectedIds = Array.from(document.querySelectorAll('.promo-select:checked'))
            .map(cb => parseInt(cb.dataset.promoId, 10))
            .filter(id => !isNaN(id));

        if (!selectedIds.length) return alert('Seleccione al menos un producto.');

        // 2Ô∏è‚É£ Traer datos completos de Supabase
        const { data: allPromos, error: promoError } = await supabase
            .from('promociones')
            .select('*')
            .in('id', selectedIds);

        if (promoError) throw promoError;

        const selectedPromos = selectedIds
            .map(id => allPromos.find(p => p.id === id))
            .filter(Boolean);

        if (!selectedPromos.length) return alert('No se encontraron promociones.');

        // 3Ô∏è‚É£ Categor√≠as
        const { data: allCategories = [] } = await supabase.from('categorias').select('id, nombre');
        const getCategoryName = (id) => {
            if (id === null) return "Sin Categor√≠a";
            const cat = allCategories.find(c => c.id === id);
            return cat ? cat.nombre : "Categor√≠a Desconocida";
        };

        // 4Ô∏è‚É£ Agrupar por categor√≠a
        const groupedPromos = selectedPromos.reduce((acc, promo) => {
            const catId = promo.categoria_id || null;
            if (!acc[catId]) acc[catId] = { name: getCategoryName(catId), promos: [] };
            acc[catId].promos.push(promo);
            return acc;
        }, {});

        let logoImgData = null; 
        const LOGO_PATH = 'logodistribuidora.png'; // üåü RUTA DE LOGO üåü

        try {
            const { data: logoSignedData } = await supabase.storage
    .from('promo_images')  // ‚úÖ bucket correcto
    .createSignedUrl('logodistribuidora.png', 3600);
                
            if (logoSignedData?.signedUrl) {
                // Cargar y convertir el logo a Base64 para jsPDF
                const response = await fetch(logoSignedData.signedUrl);
                const blob = await response.blob();
                
                logoImgData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(blob);
                });
            }
        } catch (err) {
            console.warn('Error al cargar el logo de la empresa:', err);
        }


        // 5Ô∏è‚É£ Config PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'pt', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const marginTop = 60;
        const marginBottom = 60;
        const marginSides = 30;
        const spacingX = 15;
        const spacingY = 15;
        const cols = 2;
        const rows = 4;
        
        // El c√°lculo de la altura de la tarjeta debe usar el espacio real entre m√°rgenes
        const totalUsableHeight = pageHeight - marginTop - marginBottom; 
        const totalSpacingY = spacingY * (rows - 1);
        const cardHeight = Math.floor((totalUsableHeight - totalSpacingY) / rows);
        const usableContentWidth = pageWidth - marginSides * 2; // El ancho usable sin m√°rgenes
        const cardWidth = (usableContentWidth - spacingX * (cols - 1)) / cols;
        
        let x = marginSides;
        let y = marginTop;
        let count = 0;
        // let globalPromoIndex = 0; // Ya no es necesario si solo se usa 'count' de manera local

        const TITLE_HEIGHT = 25; // Altura estimada para el t√≠tulo de categor√≠a + espacio
        const LOGO_HEIGHT = 60; 
        const LOGO_WIDTH = 200;
	const LOGO_VERTICAL_OFFSET = 10;
        const TITLE_LOGO_AREA_HEIGHT = Math.max(TITLE_HEIGHT, LOGO_HEIGHT) + 5; // Asegurar espacio para ambos

        // 6Ô∏è‚É£ Recorrer categor√≠as
        let isFirstCategory = true;
        
        for (const catId in groupedPromos) {
            const categoryData = groupedPromos[catId];

            // üåü L√ìGICA DE POSICIONAMIENTO DE CATEGOR√çA üåü

            if (!isFirstCategory) {
                // 1. Ajustar 'y' despu√©s de la categor√≠a anterior
                // Si la √∫ltima fila de la categor√≠a anterior est√° incompleta
                const itemsInLastRow = categoryData.promos.length % cols; 
                if (itemsInLastRow !== 0) {
                     // El 'y' finaliza en la posici√≥n de la √∫ltima tarjeta dibujada. 
                     // Si no complet√≥ la fila, ya avanz√≥ a la siguiente.
                } else {
                    // Si la fila estaba completa, 'y' ya se actualiz√≥ en el ciclo interno a la posici√≥n de la siguiente fila.
                }
                
                // Forzamos el salto a la posici√≥n vertical del siguiente t√≠tulo
                y += 20; // Peque√±o espacio extra antes del nuevo t√≠tulo
            }
            
            // 2. Chequeo de salto de p√°gina antes de dibujar el t√≠tulo.
            // Si el t√≠tulo no cabe o no deja espacio para al menos 1 tarjeta: Salto de p√°gina.
            if (y + TITLE_LOGO_AREA_HEIGHT + cardHeight > pageHeight - marginBottom) {
                pdf.addPage();
                y = marginTop;
            }
            
            // 3. Dibujar T√≠tulo de Categor√≠a
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold'); // Opcional: negrita para el t√≠tulo
            pdf.text(categoryData.name, marginSides, y);
            pdf.setFont('helvetica', 'normal');

            // 4. Dibujar el Logo (margen derecho)
            if (logoImgData) {
                const logoX = pageWidth - marginSides - LOGO_WIDTH;
                // Posicionar el logo para que su parte inferior est√© justo encima de las tarjetas.
                const logoY = y - LOGO_HEIGHT + (TITLE_HEIGHT / 2) + LOGO_VERTICAL_OFFSET;
                
                pdf.addImage(
                    logoImgData, 
                    'PNG', 
                    logoX, 
                    logoY, 
                    LOGO_WIDTH, 
                    LOGO_HEIGHT
                );
            }

            // 5. Ajustar 'y' para el *contenido* de las tarjetas de la nueva categor√≠a
            y += TITLE_LOGO_AREA_HEIGHT; // Baja 'y' para el inicio de las tarjetas
            x = marginSides;
            count = 0; // Reiniciar contador de tarjetas para la posici√≥n de la categor√≠a
            
            isFirstCategory = false; // Ya no es la primera categor√≠a

            // üåü FIN L√ìGICA DE POSICIONAMIENTO DE CATEGOR√çA üåü
            
            for (const promo of categoryData.promos) {
                // ... (El bloque para generar la tarjeta con html2canvas se mantiene igual) ...
                
                const div = document.createElement('div');
                div.style.width = `${cardWidth}px`;
                div.style.height = `${cardHeight}px`;
                div.style.border = '1px solid #ddd';
                div.style.borderRadius = '6px';
                div.style.padding = '4px';
                div.style.boxSizing = 'border-box';
                div.style.textAlign = 'center';
                div.style.display = 'flex';
                div.style.flexDirection = 'column';
                div.style.justifyContent = 'flex-start';
                div.style.background = '#fff';
                div.style.overflow = 'hidden';

               // Imagen cuadrada para el PDF
const img = document.createElement('img');
img.style.width = '40%';
img.style.height = '60%';
img.style.objectFit = 'contain'; // üîπ Ahora se ve completa
img.style.borderRadius = '6px';
img.style.display = 'block';
img.style.margin = '4px auto 0 auto';
img.crossOrigin = 'anonymous';
img.style.cursor = "pointer";
img.onclick = () => mostrarImagenPromo(promo.imagen_url);

let imgSrc = promo.imagen_url || '';
if (promo.imagen) {
    try {
        const { data: sd } = await supabase.storage
            .from('promo_images')
            .createSignedUrl(promo.imagen, 3600);
        imgSrc = sd?.signedUrl || imgSrc;
    } catch (err) {
        console.warn('signedUrl in export', err);
    }
}
img.src = imgSrc;
div.appendChild(img);

// Esperar carga imagen (solo para html2canvas)
if (imgSrc) {
    await new Promise(resolve => {
        img.onload = resolve;
        img.onerror = resolve;
    });
}



                // Nombre
                const nameEl = document.createElement('div');
                // Nota: La funci√≥n safeText() no est√° definida, se asume que existe o se usa el nombre directo.
                nameEl.innerHTML = `<b>${promo.nombre}</b>`; 
                nameEl.style.fontSize = '9pt';
                nameEl.style.marginTop = '4px';
                nameEl.style.height = 'auto';
                nameEl.style.flex = '0';
                div.appendChild(nameEl);

                // Precio
                const priceEl = document.createElement('div');
                priceEl.innerHTML = `$${promo.precio} ${promo.precio_anterior ? `<span style="text-decoration:line-through;color:#888;">$${promo.precio_anterior}</span>` : ''}`;
                priceEl.style.fontSize = '13pt';
                priceEl.style.marginTop = '2px';
                priceEl.style.flex = '0';
                div.appendChild(priceEl);

                document.body.appendChild(div);

               
                // html2canvas
                const canvas = await html2canvas(div, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                
                // A√±adir imagen al PDF
                pdf.addImage(imgData, 'PNG', x, y, cardWidth, cardHeight);
                document.body.removeChild(div);
                
                // üåü L√ìGICA DE AVANCE DE POSICI√ìN üåü
                
                count++; // Contador de tarjetas en la p√°gina (para las coordenadas)
                
                const isEndOfRow = count % cols === 0;
                
                if (isEndOfRow) {
                    // La fila est√° completa, chequeamos si la SIGUIENTE fila cabe
                    if (y + cardHeight + spacingY + cardHeight > pageHeight - marginBottom) {
                        // Salto de p√°gina
                        pdf.addPage();
                        x = marginSides;
                        y = marginTop;
                        count = 0; // Reiniciamos el contador de la p√°gina
                    } else {
                        // Siguiente fila en la misma p√°gina
                        x = marginSides;
                        y += cardHeight + spacingY;
                    }
                } else {
                    // La fila NO est√° completa, solo avanza 'x'.
                    x += cardWidth + spacingX;
                }
                
                // El contador que estaba aqu√≠ (count % (cols * rows)) ya es redundante
                // ya que la l√≥gica de salto de p√°gina est√° integrada en el 'if (isEndOfRow)'
                // al chequear si la siguiente tarjeta cabr√°.
            }
        }

        pdf.save('Promociones_Catalogo.pdf');

    } catch (err) {
        console.error('Error al exportar promociones:', err);
        alert('Error al exportar promociones: ' + err.message);
    }
}


document.getElementById('exportPromoPDF').addEventListener('click', exportSelectedPromos);




/* =========================================================
   PEDIDOS: L√≥gica de Persistencia y Control de Stock (CORREGIDO)
   ========================================================= */

// ==================== FUNCIONES DE CONTROL DE CANTIDAD ====================

// Genera el HTML para el control de cantidad con botones.
function renderQuantityControls(id, qty, price, stock) {
    return `
      <div style="display:flex;align-items:center;width:100px;">
        <button type="button" class="qty-btn" data-action="minus" data-id="${id}" style="background:#ddd;border:none;padding:5px 8px;cursor:pointer;border-radius:5px 0 0 5px;font-weight:bold;">‚ûñ</button>
        <input type="number" min="0" max="${stock}" value="${qty}" id="prod_${id}" data-price="${price}" data-stock-max="${stock}" style="width:40px;text-align:center;border-left:none;border-right:none;" oninput="updateSubtotal(${id}, ${price}, ${stock})">
        <button type="button" class="qty-btn" data-action="plus" data-id="${id}" style="background:#ddd;border:none;padding:5px 8px;cursor:pointer;border-radius:0 5px 5px 0;font-weight:bold;">‚ûï</button>
      </div>
    `;
}

// Agrega los event listeners a los botones de + y -
function addQuantityControlListeners() {
    // Es mejor remover y re-agregar listeners para asegurar que solo haya uno por bot√≥n
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.removeEventListener('click', handleQuantityChange);
    });
    
    document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', handleQuantityChange);
    });
}

function handleQuantityChange() {
    const action = this.getAttribute('data-action');
    const id = parseInt(this.getAttribute('data-id'), 10);
    const input = document.getElementById(`prod_${id}`);
    
    if (!input) return;

    // Obtenemos los datos necesarios desde el input
    const price = parseFloat(input.getAttribute('data-price')) || 0;
    const stock = parseInt(input.getAttribute('data-stock-max'), 10) || 0;
    let currentQty = parseInt(input.value, 10) || 0;

    if (action === 'plus') {
        currentQty = Math.min(stock, currentQty + 1);
    } else if (action === 'minus') {
        currentQty = Math.max(0, currentQty - 1);
    }

    input.value = currentQty;
    updateSubtotal(id, price, stock);
}


function getSelectedQty(id){ const it = selectedProducts.find(x => x.id === id); return it ? it.cantidad : 0; }

/**
 * Funci√≥n que actualiza subtotal, aplica stock y recalcula el total general.
 */
function updateSubtotal(id, price, stock){
    const input = document.getElementById(`prod_${id}`);
    if(!input) return;
    
    let qty = parseInt(input.value,10) || 0;
    
    if(qty < 0) qty = 0;
    if(stock !== undefined && qty > stock) qty = stock;
    
    input.value = qty; 
    
    const sub = document.getElementById(`sub_${id}`);
    if(sub) sub.textContent = `$${(qty*price).toFixed(2)}`;
    
    const tot = document.getElementById('totalPedido');
    if(tot) tot.textContent = `$${calculateTotal().toFixed(2)}`;
}

function calculateTotal(){
    let total = 0;
    const inputs = document.querySelectorAll('#modalInner input[type=number][data-price]');
    inputs.forEach(inp=>{
        const qty = parseInt(inp.value,10) || 0;
        const price = parseFloat(inp.getAttribute('data-price')) || 0;
        total += qty * price;
    });
    return total;
}

/**
 * FUNCI√ìN CR√çTICA PARA LA PERSISTENCIA: Actualiza la variable global selectedProducts 
 * con los valores actuales de los inputs visibles en el modal.
 */
function updateSelectedProductsFromModal() {
    const inputs = document.querySelectorAll('#modalInner input[type=number][data-price]');
    
    inputs.forEach(inp => {
        const prodId = parseInt(inp.id.replace('prod_',''), 10);
        const qty = parseInt(inp.value, 10) || 0;
        const price = parseFloat(inp.getAttribute('data-price')) || 0;
        
        const existingIndex = selectedProducts.findIndex(p => p.id === prodId);

        if (qty > 0) {
            if (existingIndex !== -1) {
                selectedProducts[existingIndex].cantidad = qty;
            } else {
                // Producto nuevo: obtener nombre del DOM
                const row = inp.closest('tr');
                const nombre = row && row.cells.length > 0 ? row.cells[0].textContent : `Producto ${prodId}`; 
                selectedProducts.push({ id: prodId, nombre: nombre, cantidad: qty, precio: price });
            }
        } else {
            // Cantidad 0: eliminar de la selecci√≥n si ya exist√≠a
            if (existingIndex !== -1) {
                selectedProducts.splice(existingIndex, 1);
            }
        }
    });
}


function confirmProducts(){
    // ‚úÖ Paso de persistencia final antes de cerrar el modal
    updateSelectedProductsFromModal(); 
    closeModal(); 
    renderSelectedProducts();
}


/* ========== MODAL DE SELECCI√ìN DE PRODUCTOS ========== */
document.getElementById('selectProductsBtn').addEventListener('click', async ()=>{
    const { data: categoriasData } = await supabase.from('categorias').select('*').order('id');
    const { data: promos } = await supabase.from('promociones').select('*').order('id'); // Consulta directa
    
    function renderFilteredPromos(categoryId = "") {
    // Guarda el estado actual antes de redibujar
    const modalInner = document.getElementById('modalInner');
    if (modalInner.querySelector('table')) {
        updateSelectedProductsFromModal();
    }

    let filteredPromos = (!categoryId)
        ? promos
        : promos.filter(p => String(p.categoria_id) === String(categoryId));

    let html = `
        <div style="
            display:flex;
            justify-content:space-between;
            align-items:center;
            background:#f9fafb;
            padding:16px 22px;
            border-bottom:1px solid #ddd;
            border-radius:12px 12px 0 0;
        ">
            <button id="closeModalBtn" 
                style="
                    background:none;
                    border:none;
                    color:#555;
                    font-size:18px;
                    font-weight:bold;
                    cursor:pointer;
                    transition:0.2s;
                "
                onmouseover="this.style.color='#000'"
                onmouseout="this.style.color='#555'"
            >
                ‚ùå Cerrar
            </button>

            <h3 style="margin:0;font-size:20px;font-weight:600;color:#2c3e50;text-align:center;flex:1;">
                üõçÔ∏è Seleccionar Productos
            </h3>

            <button onclick="confirmProducts()" 
                style="
                    background:#3498db;
                    color:#fff;
                    border:none;
                    padding:10px 22px;
                    border-radius:8px;
                    font-size:15px;
                    font-weight:600;
                    cursor:pointer;
                    transition:0.2s;
                "
                onmouseover="this.style.background='#2980b9'"
                onmouseout="this.style.background='#3498db'"
            >
                üíæ Confirmar selecci√≥n
            </button>
        </div>

        <div style="
            display:flex;
            align-items:center;
            gap:14px;
            margin:18px 0;
            flex-wrap:wrap;
        ">
            <label style="font-weight:600;color:#333;">Filtrar por categor√≠a:</label>
            <select id="filterCategoria" 
                style="
                    padding:8px 14px;
                    border-radius:8px;
                    border:1px solid #ccc;
                    min-width:200px;
                    background:#fff;
                ">
                <option value="">Todas</option>
                ${categoriasData.map(c => `<option value="${c.id}">${safeText(c.nombre)}</option>`).join("")}
            </select>
        </div>

        <div style="
            overflow-y:auto;
            max-height:70vh;
            border:1px solid #ddd;
            border-radius:10px;
            background:#fff;
        ">
            <table style="
                width:100%;
                border-collapse:collapse;
                font-size:15px;
            ">
                <thead style="background:#ecf0f1;">
                    <tr>
                        <th style="padding:10px;text-align:left;">Producto</th>
                        <th style="padding:10px;text-align:right;">Precio</th>
                        <th style="padding:10px;text-align:center;">Stock</th>
                        <th style="padding:10px;text-align:center;">Cantidad</th>
                        <th style="padding:10px;text-align:right;">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
    `;

    for (const p of filteredPromos) {
        const qty = getSelectedQty(p.id);
        const stockMax = p.stock ?? 0;
        const price = Number(p.precio);

        html += `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px;">${safeText(p.nombre || p.descripcion || '')}</td>
                <td style="padding:10px;text-align:right;">$${price.toFixed(2)}</td>
                <td style="padding:10px;text-align:center;">${stockMax}</td>
                <td style="padding:10px;text-align:center;">
                    ${renderQuantityControls(p.id, qty, price, stockMax)}
                </td>
                <td id="sub_${p.id}" style="padding:10px;text-align:right;">
                    $${(qty * price).toFixed(2)}
                </td>
            </tr>
        `;
    }

    html += `
                <tr style="background:#fafafa;">
                    <td colspan="4" style="text-align:right;padding:12px 10px;font-weight:600;">Total:</td>
                    <td id="totalPedido" style="text-align:right;padding:12px 10px;font-weight:700;color:#27ae60;">$0.00</td>
                </tr>
            </tbody>
        </table>
        </div>
    `;

    // Aplicar al modal
    modalInner.innerHTML = html;
    modalInner.style.maxWidth = "1100px";
    modalInner.style.width = "95%";
    modalInner.style.background = "#fdfdfd";
    modalInner.style.borderRadius = "12px";
    modalInner.style.boxShadow = "0 6px 20px rgba(0,0,0,0.15)";
    modalInner.style.padding = "20px";
    modalInner.style.position = "relative";

    const modal = document.getElementById("modal");
    modal.style.display = "flex";
    modal.style.justifyContent = "center";
    modal.style.alignItems = "center";
    modal.style.background = "rgba(0,0,0,0.45)";
    modal.style.zIndex = "9999";

    // Filtro por categor√≠a
    const filterEl = document.getElementById('filterCategoria');
    if (filterEl) {
        filterEl.value = categoryId;
        filterEl.addEventListener('change', function(){
            renderFilteredPromos(this.value);
        });
    }

    // Bot√≥n para cerrar el modal (sin confirmar)
    const closeBtn = document.getElementById('closeModalBtn');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            modal.style.display = "none";
        });
    }

    // Listeners de cantidad y total
    addQuantityControlListeners();
    setTimeout(() => {
        const tEl = document.getElementById('totalPedido');
        if (tEl) tEl.textContent = `$${calculateTotal().toFixed(2)}`;
    }, 40);
}


    renderFilteredPromos();
});


function renderSelectedProducts(){
    const c = document.getElementById('selectedProductsContainer');
    if(!selectedProducts.length){ c.innerHTML = '<span class="small-muted">No hay productos seleccionados</span>'; return; }
    let html = `<table class="table"><thead><tr><th>Producto</th><th>Cantidad</th><th>Subtotal</th></tr></thead><tbody>`;
    selectedProducts.forEach(p=>{
        html += `<tr><td>${safeText(p.nombre)}</td><td>${p.cantidad}</td><td>$${(p.precio*p.cantidad).toFixed(2)}</td></tr>`;
    });
    const total = selectedProducts.reduce((s,p)=>s + p.precio * p.cantidad, 0);
    html += `<tr><td colspan="2" style="text-align:right"><strong>Total:</strong></td><td>$${total.toFixed(2)}</td></tr></tbody></table>`;
    c.innerHTML = html;
}
async function getPromoById(id){
    const { data } = await supabase.from('promociones').select('*').eq('id', id).single();
    return data;
}

/* ================== AGREGAR PEDIDO ================== */
document.getElementById('addOrderBtn').addEventListener('click', async ()=>{
    const cliente = document.getElementById('pedidoCliente').value.trim();
    const localidad_id = document.getElementById('pedidoLocalidad').value || null;
    if(!cliente || selectedProducts.length === 0) return alert('Complete cliente y seleccione productos');
    
    const promosActuales = await Promise.all(selectedProducts.map(p => getPromoById(p.id)));
    for (let i = 0; i < selectedProducts.length; i++) {
        if (selectedProducts[i].cantidad > (promosActuales[i].stock || 0)) {
            return alert(`Stock insuficiente para ${selectedProducts[i].nombre} (disponible: ${promosActuales[i].stock})`);
        }
    }
    
    // SOLO DESCONTAR STOCK UNA VEZ
    await Promise.all(selectedProducts.map((p, i) =>
        supabase.from('promociones').update({ stock: (promosActuales[i].stock || 0) - p.cantidad }).eq('id', p.id)
    ));
    
    const productosPayload = selectedProducts.map(p => ({ id: p.id, nombre: p.nombre, cantidad: p.cantidad, precio: p.precio }));
    const total = productosPayload.reduce((s,x)=>s + x.precio * x.cantidad, 0);
    const { error } = await supabase.from('pedidos').insert([{ cliente, localidad_id, dni, productos: productosPayload, total }]);
    
    if(error) return alert(error.message);
    
    document.getElementById('pedidoForm').reset();
    selectedProducts = []; renderSelectedProducts();
    await fetchOrders();
    await fetchPromos(); // Cambiado a fetchPromos (tu funci√≥n)
    showToast('Pedido agregado');
});

/* ========== OBTENER LOCALIDAD ========== */
async function getLocalidadNombre(id) {
    if (!id) return "";
    const { data } = await supabase.from('localidades').select('*').order('id');
    return (data && data.nombre) ? data.nombre : "";
}




/* ================== LISTADO DE PEDIDOS OPTIMIZADO CON ESTADO ================== */
let isFetchingOrders = false;
let pedidoSeleccionado = null;
let pagosActuales = [];


async function fetchOrders() {
¬† if (isFetchingOrders) return;
¬† isFetchingOrders = true;

¬†try {
¬† ¬† const container = document.getElementById("pedidoList");
    
    // üí° IDENTIFICAR EL ELEMENTO DE SCROLL
    const scrollTarget = document.querySelector('.content') || document.documentElement;

    // üí° Obtener t√©rmino de b√∫squeda
    const searchInput = document.getElementById("orderSearch");
    const searchTerm = searchInput ? searchInput.value.trim() : "";

    // PASO 1: GUARDAR o RESETEAR la posici√≥n de scroll
    // Si hay b√∫squeda, forzamos a 0. Si no, mantenemos la posici√≥n.
    lastOrdersScrollPosition = searchTerm ? 0 : scrollTarget.scrollTop;
    
¬† ¬† container.innerHTML = ""; 
    // üí° IMPORTANTE: Limpiamos el contenedor de totales/resultados al inicio de CADA llamada
    document.getElementById("totalesPedidos").innerHTML = ""; 

¬† ¬† // 1Ô∏è‚É£ Construir la consulta base
    let query = supabase
¬† ¬† ¬† ¬† .from("pedidos")
¬† ¬† ¬† ¬† .select("*")
¬† ¬† ¬† ¬† .eq("archivado", false)
¬† ¬† ¬† ¬† .order("id", { ascending: true });
    
    // üí° Aplicar filtro de b√∫squeda si hay un t√©rmino
    if (searchTerm) {
        // Usamos 'ilike' (case-insensitive LIKE) para buscar el t√©rmino en los campos 'cliente' o 'dni'.
        query = query.or(`cliente.ilike.%${searchTerm}%,dni.ilike.%${searchTerm}%`);
    }

    // 2Ô∏è‚É£ Ejecutar la consulta
    const { data: pedidos, error: pedidosError } = await query;
    
    if (pedidosError) throw pedidosError;


    // üí° Mostrar totales o resultados
    if (searchTerm) {
        // Mostrar mensaje de resultados si hay b√∫squeda
        document.getElementById("totalesPedidos").innerHTML = `
            <p style="color:#2980b9; font-weight:bold;">Mostrando ${pedidos.length} resultados para "${safeText(searchTerm)}".</p>
        `;
    } else {
        // Mostrar totales normales si no hay b√∫squeda (el campo est√° vac√≠o)
        renderPedidosTotales(pedidos);
    }
    // -----------------------------------------------------

¬† ¬† if (!pedidos?.length) {
        let mensaje = searchTerm 
            ? `<p style="color:#888;">No se encontraron pedidos con el t√©rmino "${safeText(searchTerm)}".</p>`
            : `<p style="color:#888;">No hay pedidos cargados.</p>`;
        
        container.innerHTML = mensaje;
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† // 2Ô∏è‚É£ Cargar localidades
¬† ¬† const { data: localidadesData, error: locError } = await supabase
¬† ¬† ¬† .from("localidades")
¬† ¬† ¬† .select("id, nombre");

¬† ¬† if (locError) throw locError;
¬† ¬† const localidadMap = {};
¬† ¬† localidadesData.forEach(l => (localidadMap[l.id] = l.nombre));

¬† ¬† // 3Ô∏è‚É£ Agrupar pedidos por localidad
    const pedidosPorLocalidad = {};
    const grupoPrincipal = searchTerm ? "Resultados de B√∫squeda" : null;

¬† ¬† pedidos.forEach(p => {
¬† ¬† ¬† const nombreLocalidad = searchTerm 
        ? grupoPrincipal
        : (p.localidad_id ? localidadMap[p.localidad_id] || "Sin Localidad" : "Sin Localidad");
        
¬† ¬† ¬† if (!p.estado) p.estado = "pendiente";
¬† ¬† ¬† if (!pedidosPorLocalidad[nombreLocalidad])
¬† ¬† ¬† ¬† pedidosPorLocalidad[nombreLocalidad] = [];
¬† ¬† ¬† pedidosPorLocalidad[nombreLocalidad].push(p);
¬† ¬† });

¬† ¬† // 4Ô∏è‚É£ Ordenar las localidades
¬† ¬† const localidadesOrdenadas = Object.keys(pedidosPorLocalidad).sort((a, b) =>
¬† ¬† ¬† a.localeCompare(b, "es", { sensitivity: "base" })
¬† ¬† );

¬† ¬† // 5Ô∏è‚É£ Renderizar
¬† ¬† for (const localidad of localidadesOrdenadas) {
¬† ¬† ¬† const pedidosDeLocalidad = pedidosPorLocalidad[localidad];

¬† ¬† ¬† pedidosDeLocalidad.sort((a, b) => {
¬† ¬† ¬† ¬† if (a.estado !== b.estado)
¬† ¬† ¬† ¬† ¬† return a.estado === "pendiente" ? -1 : 1;
¬† ¬† ¬† ¬† return (a.cliente || "").localeCompare(b.cliente || "", "es", { sensitivity: "base" });
¬† ¬† ¬† });

¬† ¬† ¬† // T√≠tulo
¬† ¬† ¬† const titulo = document.createElement("h2");
¬† ¬† ¬† titulo.textContent = `${localidad}`;
¬† ¬† ¬† Object.assign(titulo.style, {
¬† ¬† ¬† ¬† marginTop: "25px",
¬† ¬† ¬† ¬† marginBottom: "10px",
¬† ¬† ¬† ¬† padding: "8px 14px",
¬† ¬† ¬† ¬† background: searchTerm ? "#f39c12" : "#3498db", // T√≠tulo naranja para b√∫squeda
¬† ¬† ¬† ¬† color: "#fff",
¬† ¬† ¬† ¬† borderRadius: "8px",
¬† ¬† ¬† ¬† fontSize: "1.2em",
¬† ¬† ¬† ¬† boxShadow: "0 2px 6px rgba(0,0,0,0.15)",
¬† ¬† ¬† });
¬† ¬† ¬† container.appendChild(titulo);

¬† ¬† ¬† // Tarjetas
¬† ¬† ¬† for (const p of pedidosDeLocalidad) {
¬† ¬† ¬† ¬† const div = document.createElement("div");
¬† ¬† ¬† ¬† Object.assign(div.style, {
¬† ¬† ¬† ¬† ¬† display: "flex",
¬† ¬† ¬† ¬† ¬† alignItems: "stretch",
¬† ¬† ¬† ¬† ¬† justifyContent: "space-between",
¬† ¬† ¬† ¬† ¬† padding: "18px 14px",
¬† ¬† ¬† ¬† ¬† marginBottom: "14px",
¬† ¬† ¬† ¬† ¬† borderRadius: "12px",
¬† ¬† ¬† ¬† ¬† background: "#fff",
¬† ¬† ¬† ¬† ¬† boxShadow: "0 2px 12px rgba(0,0,0,0.07)",
¬† ¬† ¬† ¬† ¬† border: "1px solid #eee",
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† // üßæ Info
¬† ¬† ¬† ¬† const infoDiv = document.createElement("div");
¬† ¬† ¬† ¬† infoDiv.style.flex = "1";

¬† ¬† ¬† ¬† let prodHTML = '<ul style="margin:7px 0 10px 0;padding-left:22px;font-size:15px;">';
¬† ¬† ¬† ¬† p.productos.forEach(pr => {
¬† ¬† ¬† ¬† ¬† prodHTML += `<li>${safeText(pr.nombre)} x ${pr.cantidad} <span style="color:#3498db;">$${(pr.precio * pr.cantidad).toFixed(2)}</span></li>`;
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† prodHTML += "</ul>";

¬† ¬† ¬† ¬† // üí∞ Mostrar pagos si existen
¬† ¬† ¬† ¬† let pagosHTML = "";
¬† ¬† ¬† ¬† if (p.pagos && p.pagos.length > 0) {
¬† ¬† ¬† ¬† ¬† pagosHTML = `
¬† ¬† ¬† ¬† ¬† ¬† <div style="margin-top:8px;background:#f8f9fa;padding:8px;border-radius:6px;">
¬† ¬† ¬† ¬† ¬† ¬† ¬† <b>üí≥ Pagos:</b><br>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ${p.pagos
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† .map(pg => `- ${pg.metodo}${pg.destinatario ? ` (${pg.destinatario})` : ""}: $${pg.monto.toFixed(2)}`)
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† .join("<br>")}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ${p.saldo_pendiente > 0
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ? `<br><b style="color:#e74c3c;">Saldo pendiente: $${p.saldo_pendiente.toFixed(2)}</b>`
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† : ""}
¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† `;
¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† infoDiv.innerHTML = `
¬† ¬† ¬† ¬† ¬† <strong>${safeText(p.cliente)}</strong>
¬† ¬† ¬† ¬† ¬† <div style="color:#888;margin-bottom:2px;">Localidad: ${safeText(localidad)}</div>
¬† ¬† ¬† ¬† ¬† ${prodHTML}
¬† ¬† ¬† ¬† ¬† <div style="margin-top:8px;font-weight:bold;">Total: <span style="color:#ff4d4f;">$${Number(p.total).toFixed(2)}</span></div>
¬† ¬† ¬† ¬† ¬† ${pagosHTML}
¬† ¬† ¬† ¬† `;

¬† ¬† ¬† ¬† // üéõÔ∏è Botones
¬† ¬† ¬† ¬† const actionsDiv = document.createElement("div");
¬† ¬† ¬† ¬† Object.assign(actionsDiv.style, {
¬† ¬† ¬† ¬† ¬† display: "flex",
¬† ¬† ¬† ¬† ¬† flexDirection: "column",
¬† ¬† ¬† ¬† ¬† gap: "10px",
¬† ¬† ¬† ¬† ¬† alignItems: "flex-end",
¬† ¬† ¬† ¬† });

¬† ¬† ¬† ¬† const pdfBtn = document.createElement("button");
¬† ¬† ¬† ¬† pdfBtn.textContent = "üìÑ Exportar PDF";
¬† ¬† ¬† ¬† Object.assign(pdfBtn.style, {
¬† ¬† ¬† ¬† ¬† background: "#2ecc71",
¬† ¬† ¬† ¬† ¬† color: "#fff",
¬† ¬† ¬† ¬† ¬† border: "none",
¬† ¬† ¬† ¬† ¬† padding: "8px 18px",
¬† ¬† ¬† ¬† ¬† borderRadius: "7px",
¬† ¬† ¬† ¬† ¬† fontWeight: "bold",
¬† ¬† ¬† ¬† ¬† cursor: "pointer",
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† pdfBtn.onclick = () => exportPedidoPDF({ ...p, localidad_nombre: localidad });

¬† ¬† ¬† ¬† const editBtn = document.createElement("button");
¬† ¬† ¬† ¬† editBtn.textContent = "‚úèÔ∏è Editar";
¬† ¬† ¬† ¬† Object.assign(editBtn.style, {
¬† ¬† ¬† ¬† ¬† background: "#3498db",
¬† ¬† ¬† ¬† ¬† color: "#fff",
¬† ¬† ¬† ¬† ¬† border: "none",
¬† ¬† ¬† ¬† ¬† padding: "8px 18px",
¬† ¬† ¬† ¬† ¬† borderRadius: "7px",
¬† ¬† ¬† ¬† ¬† fontWeight: "bold",
¬† ¬† ¬† ¬† ¬† cursor: "pointer",
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† editBtn.onclick = () => editOrderModal(p);

¬† ¬† ¬† ¬† const deleteBtn = document.createElement("button");
¬† ¬† ¬† ¬† deleteBtn.textContent = "üóëÔ∏è Eliminar";
¬† ¬† ¬† ¬† Object.assign(deleteBtn.style, {
¬† ¬† ¬† ¬† ¬† background: "#ff4d4f",
¬† ¬† ¬† ¬† ¬† color: "#fff",
¬† ¬† ¬† ¬† ¬† border: "none",
¬† ¬† ¬† ¬† ¬† padding: "8px 18px",
¬† ¬† ¬† ¬† ¬† borderRadius: "7px",
¬† ¬† ¬† ¬† ¬† fontWeight: "bold",
¬† ¬† ¬† ¬† ¬† cursor: "pointer",
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† deleteBtn.onclick = () => deleteOrder(p.id);

¬† ¬† ¬† ¬† // üí∞ Bot√≥n Medios de Pago
¬† ¬† ¬† ¬† const pagoBtn = document.createElement("button");
¬† ¬† ¬† ¬† pagoBtn.textContent = "üí∞ Medios de Pago";
¬† ¬† ¬† ¬† Object.assign(pagoBtn.style, {
¬† ¬† ¬† ¬† ¬† background: "#27ae60",
¬† ¬† ¬† ¬† ¬† color: "#fff",
¬† ¬† ¬† ¬† ¬† border: "none",
¬† ¬† ¬† ¬† ¬† padding: "8px 18px",
¬† ¬† ¬† ¬† ¬† borderRadius: "7px",
¬† ¬† ¬† ¬† ¬† fontWeight: "bold",
¬† ¬† ¬† ¬† ¬† cursor: "pointer",
¬† ¬† ¬† ¬† ¬† width: "300px",
¬† ¬† ¬† ¬† ¬† textAlign: "center",
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† pagoBtn.onclick = () => abrirModalPago(p);

¬† ¬† ¬† ¬† // üîπ Bot√≥n Estado
¬† ¬† ¬† ¬† const estadoBtn = document.createElement("button");
¬† ¬† ¬† ¬† estadoBtn.textContent = p.estado === "entregado" ? "Entregado" : "Pendiente";
¬† ¬† ¬† ¬† Object.assign(estadoBtn.style, {
¬† ¬† ¬† ¬† ¬† background: p.estado === "entregado" ? "#ff4d4f" : "#2ecc71",
¬† ¬† ¬† ¬† ¬† color: "#fff",
¬† ¬† ¬† ¬† ¬† border: "none",
¬† ¬† ¬† ¬† ¬† padding: "8px 18px",
¬† ¬† ¬† ¬† ¬† borderRadius: "7px",
¬† ¬† ¬† ¬† ¬† fontWeight: "bold",
¬† ¬† ¬† ¬† ¬† cursor: "pointer",
¬† ¬† ¬† ¬† ¬† width: "300px",
¬† ¬† ¬† ¬† ¬† textAlign: "center",
¬† ¬† ¬† ¬† ¬† marginTop: "10px",
¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† estadoBtn.onclick = async () => {
¬† ¬† ¬† ¬† ¬† p.estado = p.estado === "entregado" ? "pendiente" : "entregado";
¬† ¬† ¬† ¬† ¬† const { error } = await supabase.from("pedidos").update({ estado: p.estado }).eq("id", p.id);
¬† ¬† ¬† ¬† ¬† if (error) return alert(error.message);
¬† ¬† ¬† ¬† ¬† fetchOrders();
¬† ¬† ¬† ¬† };
        
        // üì¶ Bot√≥n Archivar Individual
        const archiveIndividualBtn = document.createElement("button");
        archiveIndividualBtn.textContent = "üì¶ Archivar";
        Object.assign(archiveIndividualBtn.style, {
            background: "#95a5a6", // Color gris suave para archivar
            color: "#fff",
            border: "none",
            padding: "8px 18px",
            borderRadius: "7px",
            fontWeight: "bold",
            cursor: "pointer",
            width: "300px",
            textAlign: "center",
        });
        archiveIndividualBtn.onclick = () => archiveIndividualOrder(p.id);


¬† ¬† ¬† ¬† actionsDiv.append(pdfBtn, editBtn, deleteBtn, pagoBtn, estadoBtn, archiveIndividualBtn);
¬† ¬† ¬† ¬† div.append(infoDiv, actionsDiv);
¬† ¬† ¬† ¬† container.appendChild(div);
¬† ¬† ¬† }
¬† ¬† }
    
    // PASO 2: RESTAURAR la posici√≥n de scroll
    setTimeout(() => {
        // Restaurar scroll usando la posici√≥n guardada
        scrollTarget.scrollTop = lastOrdersScrollPosition;
    }, 0); 

¬† } catch (err) {
¬† ¬† console.error(err);
¬† ¬† showToast("Error al cargar pedidos");
¬† } finally {
¬† ¬† isFetchingOrders = false;
¬† }
}



/**
 * Calcula y renderiza el total de ventas y la discriminaci√≥n de pagos
 * solo para los pedidos NO archivados.
 * @param {Array} pedidos - Lista de pedidos activos.
 */
function renderPedidosTotales(pedidos) {
    let totalVentas = 0;
    let totalEfectivo = 0;
    let totalTransferencias = 0;

    // Solo considerar pedidos activos para el resumen
    const pedidosActivos = pedidos.filter(p => !p.archivado);

    pedidosActivos.forEach(pedido => {
        // Suma de todas las ventas (Total de Pedido)
        totalVentas += pedido.total || 0;

        // Suma de pagos discriminando efectivo y transferencia
        if (pedido.pagos && Array.isArray(pedido.pagos)) {
            pedido.pagos.forEach(pago => {
                if (pago.metodo === 'Efectivo') {
                    totalEfectivo += pago.monto || 0;
                } else if (pago.metodo === 'Transferencia') {
                    totalTransferencias += pago.monto || 0;
                }
            });
        }
    });

    const totalesHTML = `
        <div style="background:#ecf0f1; padding:15px; border-radius:8px; display:flex; gap:20px; flex-wrap:wrap; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #ccc;">
            <div style="flex:1; min-width:200px; padding:10px; background:#e8f0f3; border-radius:6px; border-left: 5px solid #ff4d4f;">
                <h4 style="margin:0 0 5px 0; color:#2c3e50;">üí∞ Total de Ventas (Pedidos)</h4>
                <p style="font-size:1.8em; font-weight:bold; color:#ff4d4f; margin:0;">$${totalVentas.toFixed(2)}</p>
            </div>
            
            <div style="flex:1; min-width:200px; padding:10px; background:#f5f5f5; border-radius:6px; border-left: 5px solid #3498db;">
                <h4 style="margin:0 0 5px 0; color:#555;">Recibido en Pagos</h4>
                <p style="font-size:1.5em; font-weight:bold; color:#3498db; margin:0;">$${(totalEfectivo + totalTransferencias).toFixed(2)}</p>
                <div style="font-size:0.9em; margin-top:5px;">
                    Efectivo: <span style="font-weight:bold; float:right;">$${totalEfectivo.toFixed(2)}</span><br>
                    Transferencia: <span style="font-weight:bold; float:right;">$${totalTransferencias.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;

    document.getElementById('totalesPedidosBox').innerHTML = totalesHTML;
}





/**
 * Archiva un pedido individual por su ID y refresca la lista de pedidos activos.
 * @param {number} orderId - El ID del pedido a archivar.
 */
async function archiveIndividualOrder(orderId) {
    if (!confirm(`¬øEst√° seguro de que desea archivar el Pedido #${orderId}? Ya no se ver√° en la lista activa.`)) {
        return;
    }

    try {
        showToast(`Archivando Pedido #${orderId}...`);
        
        // 1. Actualizar el estado 'archivado' a true en Supabase
        const { error: updateError } = await supabase
            .from("pedidos")
            .update({ archivado: true })
            .eq("id", orderId); 

        if (updateError) throw updateError;

        // 2. Refrescar la lista de pedidos activos (el pedido archivado desaparecer√°)
        await fetchOrders(); 
        
        showToast(`‚úÖ Pedido #${orderId} archivado correctamente.`, 3500);

    } catch (err) {
        console.error("Error al archivar pedido individual:", err);
        showToast("‚ùå Error al archivar pedido: " + err.message, 5000);
    }
}




// Variable para almacenar la lista de meses para el select
const meses = [
    { value: 1, name: 'Enero' }, { value: 2, name: 'Febrero' }, { value: 3, name: 'Marzo' }, 
    { value: 4, name: 'Abril' }, { value: 5, name: 'Mayo' }, { value: 6, name: 'Junio' }, 
    { value: 7, name: 'Julio' }, { value: 8, name: 'Agosto' }, { value: 9, name: 'Septiembre' }, 
    { value: 10, name: 'Octubre' }, { value: 11, name: 'Noviembre' }, { value: 12, name: 'Diciembre' }
];

/**
 * Rellena los selectores de mes y a√±o con valores relevantes.
 */
function setupArchiveFilters() {
    const monthSelect = document.getElementById('archiveMonth');
    const yearSelect = document.getElementById('archiveYear');
    
    // Si los elementos no existen (e.g., estamos en otra pesta√±a), salir
    if (!monthSelect || !yearSelect) return; 
    
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // 1-based
    const currentYear = now.getFullYear();

    // Rellenar meses
    monthSelect.innerHTML = meses.map(m => 
        `<option value="${m.value}" ${m.value === currentMonth ? 'selected' : ''}>${m.name}</option>`
    ).join('');

    // Rellenar a√±os (√∫ltimos 3 a√±os y el actual)
    yearSelect.innerHTML = '';
    for (let y = currentYear; y >= currentYear - 3; y--) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        if (y === currentYear) option.selected = true;
        yearSelect.appendChild(option);
    }
}

/**
 * Busca y muestra los pedidos archivados para el mes, a√±o y t√©rmino de b√∫squeda seleccionados.
 * Incluye un bot√≥n para desarchivar pedidos individualmente.
 */
async function fetchArchivedOrders() {
    const month = document.getElementById('archiveMonth').value;
    const year = document.getElementById('archiveYear').value;
    const searchTerm = document.getElementById('archiveSearchTerm').value.trim(); // Captura el t√©rmino de b√∫squeda
    const container = document.getElementById("listadoArchivados");
    container.innerHTML = "Cargando pedidos archivados...";

    // Verifica que el mes y el a√±o est√©n seleccionados
    if (!month || !year) {
        container.innerHTML = `<p style="color:#e74c3c;">Seleccione un mes y un a√±o para buscar.</p>`;
        return;
    }
    
    try {
        // Calcular el rango de fechas (Inicio del mes y fin del mes)
        const firstDayOfMonth = new Date(year, month - 1, 1).toISOString();
        const firstDayOfNextMonth = new Date(year, month, 1).toISOString();

        // 1. Consulta base a Supabase: Filtrar por archivados y rango de fecha
        let query = supabase
            .from("pedidos")
            .select("*")
            .eq("archivado", true) // Solo los archivados
            .gte('created_at', firstDayOfMonth) 
            .lt('created_at', firstDayOfNextMonth);
            
        // 2. Aplicar filtro de b√∫squeda si se proporcion√≥ un t√©rmino
        if (searchTerm) {
            // Usamos 'ilike' para b√∫squeda insensible a may√∫sculas/min√∫sculas.
            query = query.or(`cliente.ilike.%${searchTerm}%,dni.ilike.%${searchTerm}%`);
        }

        // 3. Ejecutar la consulta
        const { data: pedidos, error: pedidosError } = await query
            .order("id", { ascending: false });

        if (pedidosError) throw pedidosError;

        // 4. Manejar caso de no resultados
        if (!pedidos?.length) {
            container.innerHTML = `<p style="color:#888;">No se encontraron pedidos archivados para ${meses[month-1].name} de ${year} ${searchTerm ? `con el t√©rmino "${searchTerm}"` : ""}.</p>`;
            return;
        }

        container.innerHTML = '';
        
        // 5. Inicializar variables para el resumen de totales del mes archivado
        let totalVentasMes = 0;
        let totalPagadoMes = 0;

        // Agregar el resumen de Totales del mes archivado al inicio
        const resumenHTML = `
            <div style="margin-bottom:20px; padding:15px; background:#fff; border-radius:8px; border-left: 5px solid #2980b9; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                <h3 style="margin:0 0 10px 0;">Resumen ${meses[month-1].name} / ${year}</h3>
                <div id="resumenTotalesArchivados"></div>
            </div>
        `;
        container.insertAdjacentHTML('afterbegin', resumenHTML);
        const resumenDiv = document.getElementById("resumenTotalesArchivados");


        // 6. Renderizar la lista de pedidos archivados
        for (const p of pedidos) {
            // Calcular totales para el resumen
            totalVentasMes += p.total || 0;
            // Sumar pagos registrados
            const totalPagos = (p.pagos || []).reduce((sum, pago) => sum + (pago.monto || 0), 0);
            totalPagadoMes += totalPagos;
            
            // Suponiendo que tienes una funci√≥n getLocalidadNombre definida
            const localidad = await getLocalidadNombre(p.localidad_id);
            
            const div = document.createElement("div");
            Object.assign(div.style, { 
                display: "flex", 
                flexDirection: "column",
                padding: "18px 14px", 
                marginBottom: "14px", 
                borderRadius: "12px", 
                background: "#f8f8f8", 
                boxShadow: "0 2px 12px rgba(0,0,0,0.07)", 
                border: "1px solid #ddd",
            }); 
            
            let prodHTML = '<ul style="margin:7px 0 10px 0;padding-left:22px;font-size:15px;">';
            // Suponiendo que tienes una funci√≥n safeText definida
            p.productos.forEach(pr => { 
                prodHTML += `<li>${safeText(pr.nombre)} x ${pr.cantidad} <span style="color:#3498db;">$${(pr.precio * pr.cantidad).toFixed(2)}</span></li>`;
            }); 
            prodHTML += "</ul>";

            let pagosHTML = "";
            if (p.pagos && p.pagos.length > 0) {
                pagosHTML = `
                    <div style="margin-top:8px;background:#eef;padding:8px;border-radius:6px;">
                        <b>üí≥ Pagos Registrados:</b><br> 
                        ${p.pagos
                            .map(pg => `- ${pg.metodo}${pg.destinatario ? ` (${pg.destinatario})` : ""}: $${pg.monto.toFixed(2)}`)
                            .join("<br>")}
                        ${p.saldo_pendiente > 0 ? `<br><b style="color:#e74c3c;">Saldo pendiente: $${p.saldo_pendiente.toFixed(2)}</b>` : ""}
                    </div>
                `;
            }
            
            const estadoTexto = p.estado === 'Completado' ? '‚úÖ Completado' : p.saldo_pendiente > 0 ? '‚ö†Ô∏è Pendiente de Pago' : '‚è≥ Pendiente';
            
            div.innerHTML = ` 
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <strong>Pedido #${p.id} - ${safeText(p.cliente)}</strong> 
                        <div style="color:#888;margin-bottom:2px;">DNI: ${safeText(p.dni || 'N/A')}</div>
                        <div style="color:#888;margin-bottom:2px;">Localidad: ${safeText(localidad)}</div>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-weight:bold; font-size:1.2em; color:#2c3e50;">Total: $${Number(p.total || 0).toFixed(2)}</span>
                        <div style="font-size:0.9em; color:${p.saldo_pendiente > 0 ? '#e74c3c' : '#27ae60'};">${estadoTexto}</div>
                    </div>
                </div>
                ${prodHTML} 
                ${pagosHTML}
                
                <div style="margin-top:10px; border-top:1px solid #ddd; padding-top:10px; display:flex; justify-content:flex-end; gap: 10px;">
                    
                    <button class="button-secondary" onclick='exportPedidoPDF(${JSON.stringify(p).replace(/"/g, '&quot;')})'
                        style="padding: 6px 12px; font-size: 13px; border: 1px solid #3498db; color: #3498db; background: none;">
                        üìÑ Ver PDF
                    </button>
                    
                    <button class="button-primary" onclick='unarchiveOrder(${p.id})'
                        style="padding: 6px 12px; font-size: 13px; background: #27ae60; color: white; border: none;">
                        üîÑ Desarchivar
                    </button>
                    
                </div>
            `;
            container.appendChild(div);
        }
        
        // 7. Actualizar resumen de totales
        resumenDiv.innerHTML = `
            <p style="margin:5px 0;"><strong>Ventas Totales:</strong> <span style="float:right; font-weight:bold; color:#ff4d4f;">$${totalVentasMes.toFixed(2)}</span></p>
            <p style="margin:5px 0;"><strong>Total Pagado:</strong> <span style="float:right; font-weight:bold; color:#3498db;">$${totalPagadoMes.toFixed(2)}</span></p>
            <hr style="border:none; border-top:1px dashed #ccc;">
            <p style="margin:5px 0;"><strong>Saldo Pendiente:</strong> <span style="float:right; font-weight:bold; color:#e74c3c;">$${(totalVentasMes - totalPagadoMes).toFixed(2)}</span></p>
        `;

        
    } catch (err) {
        console.error("Error al cargar pedidos archivados:", err);
        container.innerHTML = `<p style="color:#e74c3c;">Error al cargar pedidos: ${err.message}</p>`;
    }
}





/**
 * Desarchiva un pedido individual por su ID, movi√©ndolo a la lista activa de pedidos.
 * @param {number} orderId - El ID del pedido a desarchivar.
 */
async function unarchiveOrder(orderId) {
    if (!confirm(`¬øEst√° seguro de que desea DESARCHIVAR el Pedido #${orderId}? Volver√° a la lista de pedidos activos.`)) {
        return;
    }

    try {
        showToast(`Desarchivando Pedido #${orderId}...`);
        
        // 1. Actualizar el estado 'archivado' a false en Supabase
        const { error: updateError } = await supabase
            .from("pedidos")
            .update({ archivado: false })
            .eq("id", orderId); 

        if (updateError) throw updateError;

        // 2. Refrescar la lista de pedidos activos (fetchOrders) para que aparezca all√≠
        await fetchOrders(); 
        
        // 3. Refrescar la lista de archivados (fetchArchivedOrders) para que desaparezca de aqu√≠
        await fetchArchivedOrders(); 

        showToast(`‚úÖ Pedido #${orderId} desarchivado correctamente.`, 3500);

    } catch (err) {
        console.error("Error al desarchivar pedido:", err);
        showToast("‚ùå Error al desarchivar pedido: " + err.message, 5000);
    }
}





function abrirModalPago(pedido) {
  pedidoSeleccionado = pedido;
  pagosActuales = pedido.pagos || [];

  // Mostrar datos del pedido
  document.getElementById("totalPedido").textContent = Number(pedido.total || 0).toFixed(2);
  document.getElementById("estadoPedido").textContent = pedido.estado || "Pendiente";

  // Limpiar lista de pagos
  const lista = document.getElementById("listaPagos");
  lista.innerHTML = "";

  // Crear filas existentes o una vac√≠a
  if (pagosActuales.length > 0) {
    pagosActuales.forEach((p, i) => crearFilaPago(i, p.metodo, p.monto, p.destinatario));
  } else {
    crearFilaPago(0);
  }

  // Recalcular totales
  recalcularPagos();

  // Mostrar modal
  document.getElementById("modalPago").style.display = "block";
}


function recalcularPagos() {
  const lista = document.getElementById("listaPagos");
  let totalPagos = 0;

  lista.querySelectorAll(".fila-pago").forEach(fila => {
    const montoInput = fila.querySelector('input[placeholder="Monto"]');
    const monto = montoInput ? parseFloat(montoInput.value) || 0 : 0;
    totalPagos += monto;
  });

  document.getElementById("totalPagado").textContent = totalPagos.toFixed(2);

  const totalPedido = Number(pedidoSeleccionado.total || 0);
  const saldoPendiente = Math.max(0, totalPedido - totalPagos);
  document.getElementById("saldoPendiente").textContent = saldoPendiente.toFixed(2);
}



function cerrarModalPago() {
  const modal = document.getElementById("modalPago");
  if (modal) {
    modal.style.display = "none";
  }
}



function crearFilaPago(index, metodo = '', monto = 0, destinatario = '') {
  const lista = document.getElementById("listaPagos");

  const fila = document.createElement("div");
  fila.className = "fila-pago";
  fila.style.display = "flex";
  fila.style.gap = "10px";
  fila.style.marginBottom = "8px";
  fila.style.alignItems = "center";

  // Select m√©todo de pago
  const selectMetodo = document.createElement("select");
  const opciones = ["Transferencia", "Efectivo"];
  opciones.forEach(op => {
    const option = document.createElement("option");
    option.value = op;
    option.textContent = op;
    if (op === metodo) option.selected = true;
    selectMetodo.appendChild(option);
  });

  // Input monto
  const inputMonto = document.createElement("input");
  inputMonto.type = "number";
  inputMonto.placeholder = "Monto";
  inputMonto.value = monto;
  inputMonto.min = 0;
  inputMonto.step = "0.01";
  inputMonto.oninput = recalcularPagos; // recalcular al cambiar

  // Input destinatario
  const inputDest = document.createElement("input");
  inputDest.type = "text";
  inputDest.placeholder = "Destinatario";
  inputDest.value = destinatario;

  // Bot√≥n eliminar
  const btnEliminar = document.createElement("button");
  btnEliminar.textContent = "‚ùå";
  btnEliminar.onclick = () => {
    lista.removeChild(fila);
    recalcularPagos();
  };

  fila.append(selectMetodo, inputMonto, inputDest, btnEliminar);
  lista.appendChild(fila);
}


function agregarMedioPago() {
  // Llama a la funci√≥n que crea una fila de pago vac√≠a
  crearFilaPago(); 
  
  // Opcional: enfocar el input de monto de la nueva fila para mejor UX
  const nuevaFila = document.getElementById("listaPagos").lastElementChild;
  const inputMonto = nuevaFila ? nuevaFila.querySelector('input[placeholder="Monto"]') : null;
  if (inputMonto) {
    inputMonto.focus();
  }
}


async function guardarPagosPedido() {
  if (!pedidoSeleccionado) return alert("No hay pedido seleccionado");

  const lista = document.getElementById("listaPagos");
  const pagos = [];

  lista.querySelectorAll(".fila-pago").forEach(fila => {
    const metodoSelect = fila.querySelector("select");
    const metodo = metodoSelect ? metodoSelect.value : "";

    const montoInput = fila.querySelector('input[placeholder="Monto"]');
    const monto = montoInput ? parseFloat(montoInput.value) || 0 : 0;

    const destInput = fila.querySelector('input[placeholder="Destinatario"]');
    const destinatario = destInput ? destInput.value : "";

    if (metodo && monto > 0) {
      pagos.push({ metodo, monto, destinatario });
    }
  });

  const totalPagos = pagos.reduce((sum, p) => sum + p.monto, 0);
  const saldo_pendiente = Math.max(0, pedidoSeleccionado.total - totalPagos);

  // Guardar en Supabase
  const { error } = await supabase
    .from("pedidos")
    .update({ pagos, saldo_pendiente })
    .eq("id", pedidoSeleccionado.id);

  if (error) return alert("Error al guardar pagos: " + error.message);

  // Cerrar modal y refrescar
  cerrarModalPago();
  fetchOrders();
  alert("Pagos guardados correctamente");
}






/* ========== MODAL DE EDICI√ìN DE PEDIDO CON VALIDACI√ìN MANUAL ========== */
async function editOrderModal(pedido) {
    const { data: localidades } = await supabase.from('localidades').select('*').order('id');
    const { data: productosDB } = await supabase.from('promociones').select('*').order('id');
    const { data: categorias } = await supabase.from('categorias').select('*').order('id');

    // Clonamos los productos del pedido para edici√≥n y garantizamos campo descuento
    let productosPedido = (pedido.productos || []).map(pr => ({ ...pr, descuento: pr.descuento || 0 }));
    // Variable persistente dentro del modal para el descuento general
    let descuentoGeneral = typeof pedido.descuento_general !== 'undefined' ? pedido.descuento_general : 0;

    function renderModal(stockMsg = "") {
        document.getElementById("modalInner").style.maxWidth = "min(90vw, 500px)"; 
¬† ¬† document.getElementById("modalInner").style.width = "90vw";

        // Lista de productos en el pedido
        let listaHTML = `<ul id="productosPedidoList" style="margin-bottom:8px;">`;
        productosPedido.forEach((pr, idx) => {
            const prodInfo = productosDB.find(pdb => pdb.id === pr.id);
            const stockActualDB = prodInfo ? (prodInfo.stock ?? 0) : 0;
            const stockOriginal = (pedido.productos || []).find(op => op.id === pr.id)?.cantidad || 0;
            const stockBase = stockActualDB + stockOriginal;

            listaHTML += `
                <li style="margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;background:#fafafa;padding:6px 10px;border-radius:8px;">
                    <span style="font-weight:bold;flex:1;">${safeText(pr.nombre)}</span>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <button class="qtyMinus" data-idx="${idx}" style="background:#ddd;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;">‚àí</button>
                        <input type="number" min="1" max="${stockBase}" value="${pr.cantidad}" data-idx="${idx}" class="editQtyInput" style="width:50px;text-align:center;">
                        <button class="qtyPlus" data-idx="${idx}" style="background:#ddd;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;">+</button>
                        <input type="number" min="0" max="100" value="${pr.descuento || 0}" 
                               class="editDescuentoInput" data-idx="${idx}" style="width:50px;text-align:center;" placeholder="% Desc">
                    </div>
                    <span style="color:#888;">(stock: ${stockBase})</span>
                    <span style="color:#3498db;font-weight:bold;">$${(pr.precio * pr.cantidad * (1 - (pr.descuento || 0)/100)).toFixed(2)}</span>
                    <button type="button" class="deletePrBtn" data-idx="${idx}" style="background:#ff4d4f;color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;">üóëÔ∏è</button>
                </li>
            `;
        });
        listaHTML += `</ul>`;

        // Calculamos total: primero descuentos por producto, luego descuento general
        const totalSinDescuento = productosPedido.reduce((s, p) =>
            s + p.precio * p.cantidad * (1 - (p.descuento || 0) / 100), 0
        );
        const totalConDescuento = totalSinDescuento * (1 - (descuentoGeneral || 0) / 100);

        // Abrimos modal con todo el HTML (manteniendo estilo / estructura)
        openModal(`
            <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:18px;">
                <h2 style="margin:0;font-size:1.3em;">Editar Pedido</h2>
            </div>
            <div style="background:#f8f8f8;border-radius:12px;padding:20px;box-shadow:0 2px 12px rgba(0,0,0,0.07);max-height:85vh;overflow-y:auto;">
                <div style="margin-bottom:16px;">
                    <label style="font-weight:500;display:block;margin-bottom:4px;">Cliente</label>
                    <input type="text" id="editPedidoCliente" value="${safeText(pedido.cliente)}" placeholder="Nombre del cliente" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-weight:500;display:block;margin-bottom:4px;">DNI</label>
                    <input type="text" id="editPedidoDni" value="${safeText(pedido.dni || '')}" placeholder="Ingrese DNI" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-weight:500;display:block;margin-bottom:4px;">Localidad</label>
                    <select id="editPedidoLocalidad" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                        <option value="">Seleccione localidad</option>
                        ${localidades.map(l => `<option value="${l.id}" ${l.id === pedido.localidad_id ? 'selected' : ''}>${safeText(l.nombre)}</option>`).join('')}
                    </select>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-weight:500;display:block;margin-bottom:4px;">Productos</label>
                    <button type="button" id="openProductSelector" style="background:#eee;color:#333;border:none;padding:10px 14px;border-radius:6px;font-size:16px;cursor:pointer;margin-bottom:10px;">
                        ‚ûï Agregar productos
                    </button>
                    ${listaHTML}
                    <div style="margin-bottom:16px;">
                        <label style="font-weight:500;display:block;margin-bottom:4px;">Descuento general (%)</label>
                        <input type="number" id="editDescuentoGeneral" value="${descuentoGeneral}" min="0" max="100" step="0.01"
                               style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;">
                    </div>
                    <div style="margin-top:8px;font-weight:bold;">Total: <span id="pedidoTotal" style="color:#ff4d4f;">$${totalConDescuento.toFixed(2)}</span></div>
                    ${stockMsg ? `<div style="color:#ff4d4f;font-weight:bold;margin-top:10px;">${stockMsg}</div>` : ""}
                </div>
                <button id="saveEditPedidoBtn" style="margin-top:10px;background:#3498db;color:#fff;border:none;padding:12px 20px;border-radius:7px;font-size:16px;font-weight:bold;cursor:pointer;">
                    üíæ Guardar cambios
                </button>
            </div>
        `);

        // ---- IMPORTANT: don't re-run renderModal from this input; only update total ----
        const descuentoInput = document.getElementById("editDescuentoGeneral");
        if (descuentoInput) {
            descuentoInput.oninput = (e) => {
                let val = parseFloat(e.target.value);
                if (isNaN(val)) val = 0;
                if (val < 0) val = 0;
                if (val > 100) val = 100;
                descuentoGeneral = val;

                // Recalcular total sin re-renderizar todo el modal
                const totalSinDesc = productosPedido.reduce((s, p) =>
                    s + p.precio * p.cantidad * (1 - (p.descuento || 0) / 100), 0
                );
                const totalConDesc = totalSinDesc * (1 - descuentoGeneral / 100);
                const totalSpan = document.getElementById("pedidoTotal");
                if (totalSpan) totalSpan.textContent = `$${totalConDesc.toFixed(2)}`;
            };
        }

        // Abrir submodal para agregar productos
        const openSelectorBtn = document.getElementById("openProductSelector");
        if (openSelectorBtn) openSelectorBtn.onclick = () => openSubModal();

        // Botones + y ‚àí por producto
        document.querySelectorAll('.qtyPlus').forEach(btn => {
            btn.onclick = () => {
                const idx = parseInt(btn.dataset.idx, 10);
                const prodInfo = productosDB.find(pdb => pdb.id === productosPedido[idx].id);
                const stockDB = prodInfo ? (prodInfo.stock ?? 0) : 0;
                const stockOriginal = (pedido.productos || []).find(op => op.id === productosPedido[idx].id)?.cantidad || 0;
                const stockBase = stockDB + stockOriginal;
                if (productosPedido[idx].cantidad < stockBase) {
                    productosPedido[idx].cantidad++;
                    renderModal();
                } else {
                    renderModal(`Stock m√°ximo para "${productosPedido[idx].nombre}" es ${stockBase}.`);
                }
            };
        });
        document.querySelectorAll('.qtyMinus').forEach(btn => {
            btn.onclick = () => {
                const idx = parseInt(btn.dataset.idx, 10);
                if (productosPedido[idx].cantidad > 1) {
                    productosPedido[idx].cantidad--;
                    renderModal();
                }
            };
        });
        // input cantidad
        document.querySelectorAll('.editQtyInput').forEach(input => {
            input.onchange = () => {
                const idx = parseInt(input.dataset.idx, 10);
                const prodInfo = productosDB.find(pdb => pdb.id === productosPedido[idx].id);
                const stockDB = prodInfo ? (prodInfo.stock ?? 0) : 0;
                const stockOriginal = (pedido.productos || []).find(op => op.id === productosPedido[idx].id)?.cantidad || 0;
                const stockBase = stockDB + stockOriginal;
                let val = Math.max(1, parseInt(input.value, 10) || 1);
                if (val > stockBase) val = stockBase;
                productosPedido[idx].cantidad = val;
                renderModal();
            };
        });
        // input descuento por producto
        document.querySelectorAll('.editDescuentoInput').forEach(input => {
            input.onchange = () => {
                const idx = parseInt(input.dataset.idx, 10);
                let val = parseFloat(input.value);
                if (isNaN(val)) val = 0;
                if (val < 0) val = 0;
                if (val > 100) val = 100;
                productosPedido[idx].descuento = val;
                renderModal();
            };
        });
        // eliminar producto
        document.querySelectorAll('.deletePrBtn').forEach(btn => {
            btn.onclick = () => {
                const idx = parseInt(btn.dataset.idx, 10);
                productosPedido.splice(idx, 1);
                renderModal();
            };
        });

        // Guardar cambios con validaci√≥n manual
        const saveBtn = document.getElementById('saveEditPedidoBtn');
        if (saveBtn) {
            saveBtn.onclick = () => {
                const cliente = document.getElementById('editPedidoCliente').value.trim();
                const dni = document.getElementById('editPedidoDni').value.trim();
                const localidad_id = document.getElementById('editPedidoLocalidad').value;

                if (!cliente) return alert("Ingrese el nombre del cliente");
                if (!dni) return alert("Ingrese el DNI del cliente");
                if (!localidad_id) return alert("Seleccione la localidad");
                if (!productosPedido.length) return alert("Agregue productos");

                // Antes de llamar al save, asignamos el descuento general al pedido (persistente en la variable)
                pedido.descuento_general = descuentoGeneral;

                saveEditPedido(pedido.id, productosPedido, dni);
            };
        }
    }

    // Submodal de selecci√≥n de productos (igual que antes)
    async function openSubModal() {
        let html = `
            <div style="display:flex;flex-direction:column;gap:12px;max-height:80vh;overflow:auto;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <select id="filtroCategoria" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;">
                        <option value="">Todas las categor√≠as</option>
                        ${categorias.map(c => `<option value="${c.id}">${safeText(c.nombre)}</option>`).join('')}
                    </select>
                    <input type="text" id="buscadorProducto" placeholder="Buscar producto..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;">
                </div>
                <div id="listaProductosSubModal"></div>
            </div>
        `;
        openModal(html);

        const lista = document.getElementById('listaProductosSubModal');
        function renderProductos(filtro = "", cat = "") {
            let filtrados = productosDB.filter(p =>
                (!cat || p.categoria_id == cat) &&
                (p.nombre.toLowerCase().includes(filtro.toLowerCase()))
            );
            lista.innerHTML = filtrados.map(p => `
                <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding:6px 0;">
                    <span>${safeText(p.nombre)} ($${p.precio}, stock: ${p.stock ?? 0})</span>
                    <button class="addProdBtn" data-id="${p.id}" style="background:#eee;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">Agregar</button>
                </div>
            `).join('');
            document.querySelectorAll('.addProdBtn').forEach(btn => {
                btn.onclick = () => {
                    const prod = productosDB.find(p => p.id == btn.dataset.id);
                    if (!productosPedido.some(pp => pp.id == prod.id)) {
                        // mantenemos estructura original, a√±adimos campo descuento por defecto 0
                        productosPedido.push({ id: prod.id, nombre: prod.nombre, cantidad: 1, precio: prod.precio, descuento: 0 });
                        closeModal();
                        renderModal();
                    }
                };
            });
        }
        renderProductos();

        const buscador = document.getElementById('buscadorProducto');
        const filtro = document.getElementById('filtroCategoria');
        if (buscador) buscador.oninput = e => renderProductos(e.target.value, filtro ? filtro.value : "");
        if (filtro) filtro.onchange = e => renderProductos(buscador ? buscador.value : "", e.target.value);
    }

    // Guardado con ajuste de stock (igual que antes) ‚Äî ahora guarda descuento_general y recalcula total correctamente
    window.saveEditPedido = async function(id, nuevosProductos, dni) {
        const cliente = document.getElementById('editPedidoCliente').value.trim();
        const localidad_id = document.getElementById('editPedidoLocalidad').value;

        // Obtener pedido original para restaurar/ajustar stock
        const { data: pedidoOriginal } = await supabase.from('pedidos').select('*').eq('id', id).single();
        const productosOriginal = pedidoOriginal.productos || [];
        const mapOriginal = {};
        productosOriginal.forEach(p => mapOriginal[p.id] = p.cantidad);
        const mapNuevo = {};
        nuevosProductos.forEach(p => mapNuevo[p.id] = p.cantidad);
        const allIds = new Set([...productosOriginal.map(p => p.id), ...nuevosProductos.map(p => p.id)]);

        for (const prodId of allIds) {
            const cantOriginal = mapOriginal[prodId] || 0;
            const cantNueva = mapNuevo[prodId] || 0;
            const dif = cantNueva - cantOriginal;
            if (dif !== 0) {
                const { data: promo } = await supabase.from('promociones').select('*').eq('id', prodId).single();
                await supabase.from('promociones').update({ stock: (promo.stock || 0) - dif }).eq('id', prodId);
            }
        }

        // Recalcular total considerando descuentos por producto y descuento general
        const totalSinDescuento = nuevosProductos.reduce((s, p) =>
            s + p.precio * p.cantidad * (1 - (p.descuento || 0) / 100), 0
        );
        const totalConDescuento = totalSinDescuento * (1 - (descuentoGeneral || 0) / 100);

        // Guardar en supabase incluyendo descuento_general
        const { error } = await supabase.from('pedidos').update({
            cliente,
            dni,
            localidad_id,
            productos: nuevosProductos,
            total: totalConDescuento,
            descuento_general: descuentoGeneral
        }).eq('id', id);

        if (error) return alert(error.message);

        closeModal();
        await fetchOrders();
        await fetchPromos();
        showToast('Pedido actualizado correctamente');
    };

    // Render inicial
    renderModal();
}


/* ========== ELIMINAR PEDIDO ========== */
async function deleteOrder(id){
    if(!confirm('Eliminar pedido?')) return;
    const { data } = await supabase.from('pedidos').select('*').eq('id', id).single();
    if(data.productos && data.productos.length){
        for(const pr of data.productos){
            const promo = await getPromoById(pr.id);
            const newStock = (promo.stock || 0) + pr.cantidad;
            await supabase.from('promociones').update({ stock: newStock }).eq('id', pr.id);
        }
    }
    await supabase.from('pedidos').delete().eq('id', id);
    await fetchOrders();
    await fetchPromos(); // Actualizar lista de promociones para reflejar stock
    showToast('Pedido eliminado y stock restaurado');
}


// =========================================================
// üßæ EXPORTAR PEDIDO A PDF (Versi√≥n estable tipo descargarPDF)
// =========================================================

async function exportPedidoPDF(pedido) {
    try {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) throw new Error("jsPDF no est√° cargado. Aseg√∫rate de incluir jspdf.umd.min.js y jspdf.plugin.autotable.min.js");

        const doc = new jsPDF("p", "mm", "a4");
        const pageWidth = doc.internal.pageSize.getWidth();
        const marginX = 15;
        const contentWidth = pageWidth - (marginX * 2);

        // ==============================
        // üîπ Datos del pedido y cliente
        // ==============================
        const nombreCliente = (pedido.cliente || "Sin nombre").trim();
        const localidad = (pedido.localidad || pedido.localidad_nombre || "Sin localidad").trim();
        const dni = (pedido.dni || "Sin DNI").trim();
        const fecha = new Date().toLocaleString("es-AR");

        if (!pedido.productos || pedido.productos.length === 0) {
            alert("El pedido no contiene productos para generar el PDF.");
            return;
        }

        // ==============================
        // üí∞ Calcular productos, descuentos y totales
        // ==============================
        let ahorroTotal = 0;        // ahorro por promociones
        let descuentoTotal = 0;     // descuentos individuales

        const productos = pedido.productos.map(p => {
            const precioActual = p.precio || 0;
            const cantidad = p.cantidad || 0;
            const descuento = p.descuento || 0;
            const precioConDescuento = precioActual * (1 - descuento / 100);
            const subtotal = precioConDescuento * cantidad;

            const subtotalSinDescuento = precioActual * cantidad;
            descuentoTotal += subtotalSinDescuento - subtotal;

            // calcular ahorro por promo (precio anterior - actual)
            let ahorroPromo = 0;
            if (p.precio_anterior && p.precio_anterior > precioActual) {
                ahorroPromo = (p.precio_anterior - precioActual) * cantidad;
                ahorroTotal += ahorroPromo;
            }

            return [
                p.nombre || "Sin nombre",
                cantidad,
                p.precio_anterior && p.precio_anterior > precioActual ? `$${p.precio_anterior.toFixed(2)}` : "-",
                `$${precioActual.toFixed(2)}`,
                `$${subtotal.toFixed(2)}`
            ];
        });

        const totalSinDescuento = pedido.productos.reduce((acc, p) => acc + (p.precio || 0) * (p.cantidad || 0), 0);
        const descuentoGeneral = pedido.descuento_general || 0;
        const totalConDescuentoGeneral = totalSinDescuento * (1 - descuentoGeneral / 100);
        const totalFinal = totalConDescuentoGeneral - descuentoTotal;

        const totalPagos = (pedido.pagos || []).reduce((sum, p) => sum + (p.monto || 0), 0);
        const saldoPendiente = Math.max(0, totalFinal - totalPagos);

        // ==============================
        // üñºÔ∏è Cargar logo desde Supabase
        // ==============================
        const logoURL = "https://ejbqlejlgprvwzrptojo.supabase.co/storage/v1/object/public/promo_images/logodistribuidora.png";
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = logoURL;

        const generarContenidoYGuardar = (startY) => {
            let currentY = startY;

            // ==============================
            // üßæ Encabezado
            // ==============================
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Pedido de Cliente", pageWidth / 2, currentY, { align: "center" });
            currentY += 15;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Cliente: ${nombreCliente}`, marginX, currentY); currentY += 8;
            doc.text(`DNI: ${dni}`, marginX, currentY); currentY += 8;
            doc.text(`Localidad: ${localidad}`, marginX, currentY); currentY += 8;
            doc.text(`Fecha: ${fecha}`, marginX, currentY); currentY += 8;

            // ==============================
            // üì¶ Tabla de productos
            // ==============================
            doc.autoTable({
                startY: currentY + 5,
                head: [["Producto", "Cantidad", "Precio Ant.", "Precio Actual", "Subtotal"]],
                body: productos,
                styles: { fontSize: 10, cellPadding: 3, overflow: 'linebreak' },
                headStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: "bold" },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { cellWidth: 20, halign: "center" },
                    2: { cellWidth: 30, halign: "right" },
                    3: { cellWidth: 30, halign: "right" },
                    4: { cellWidth: 30, halign: "right" },
                },
                tableWidth: contentWidth,
                margin: { left: marginX, right: marginX },
            });

            let finalY = doc.lastAutoTable.finalY;

            // ==============================
            // üí≥ Pagos realizados
            // ==============================
            if (pedido.pagos && pedido.pagos.length > 0) {
                const pagosTabla = pedido.pagos.map(pg => [
                    pg.metodo || "-",
                    pg.destinatario || "-",
                    pg.monto ? `$${pg.monto.toFixed(2)}` : "$0.00"
                ]);

                finalY += 10;
                doc.setFont("helvetica", "bold");
                doc.setFontSize(13);
                doc.text("Pagos Realizados", marginX, finalY);

                doc.autoTable({
                    startY: finalY + 5,
                    head: [["M√©todo", "Destinatario", "Monto"]],
                    body: pagosTabla,
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: "bold" },
                    columnStyles: {
                        0: { cellWidth: 60 },
                        1: { cellWidth: 80 },
                        2: { cellWidth: 40, halign: "right" },
                    },
                    tableWidth: "wrap",
                    margin: { left: marginX, right: marginX },
                });
                finalY = doc.lastAutoTable.finalY;
            }

            // ==============================
            // üßÆ Totales
            // ==============================
            const totalX = pageWidth - marginX;

            finalY += 10;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(`Total del Pedido: $${totalSinDescuento.toFixed(2)}`, totalX, finalY, { align: "right" });
            finalY += 8;
            if (descuentoGeneral > 0) {
                doc.text(`Descuento general (${descuentoGeneral.toFixed(2)}%): -$${(totalSinDescuento * descuentoGeneral / 100).toFixed(2)}`, totalX, finalY, { align: "right" });
                finalY += 8;
            }
            doc.text(`Pagado: $${totalPagos.toFixed(2)}`, totalX, finalY, { align: "right" });
            finalY += 8;
            doc.text(`Saldo pendiente: $${saldoPendiente.toFixed(2)}`, totalX, finalY, { align: "right" });

            // ==============================
            // üí¨ L√≠neas finales con descuentos
            // ==============================
            const descuentoAplicadoTotal = (totalSinDescuento - totalFinal) > 0 ? (totalSinDescuento - totalFinal) : 0;

            finalY += 12;
            doc.setFontSize(12);
            doc.setTextColor(0, 102, 204); // Azul suave
            if (ahorroTotal > 0) {
                doc.text(`Suma de ahorro con promociones: $${ahorroTotal.toFixed(2)}`, marginX, finalY);
                finalY += 7;
            }
            if (descuentoAplicadoTotal > 0) {
                doc.text(`Se le aplic√≥ un descuento de: $${descuentoAplicadoTotal.toFixed(2)}`, marginX, finalY);
            }
            doc.setTextColor(0, 0, 0);

            // ==============================
            // üíæ Guardar PDF
            // ==============================
            const safeName = nombreCliente.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            const fechaArchivo = new Date().toISOString().split('T')[0];
            doc.save(`Pedido_${safeName}_${fechaArchivo}.pdf`);
        };

        // ==============================
        // üñºÔ∏è Carga del logo
        // ==============================
        img.onload = () => {
            const logoWidth = 110;
            const logoHeight = 35;
            const logoX = (pageWidth - logoWidth) / 2;
            const startYAfterLogo = 55;
            doc.addImage(img, 'PNG', logoX, 10, logoWidth, logoHeight);
            generarContenidoYGuardar(startYAfterLogo);
        };

        img.onerror = () => {
            console.warn("‚ö†Ô∏è No se pudo cargar el logo, generando PDF sin imagen.");
            generarContenidoYGuardar(20);
        };

        if (img.complete) img.onload();

    } catch (err) {
        console.error("‚ùå Error al generar el PDF:", err);
        alert("Error al generar el PDF: " + err.message);
    }
}








/* ========================================================= Utilidades Faltantes ========================================================= */

// üí• FUNCIONES FALTANTES A√ëADIDAS üí•

// 1. Placeholder para showToast (Puedes personalizarla con un div modal si lo deseas)
function showToast(message, duration = 3000) {
    console.log("TOAST:", message);
    alert(message); // Usamos alert temporalmente para evitar el error
}

// 2. Placeholder para safeText (Simplemente devuelve el texto para evitar el error)
function safeText(text) {
    return String(text);
}

// 3. Placeholder de funci√≥n de navegaci√≥n (Para evitar errores en la estructura)
function navigateTo(section) {
    console.log("Navegando a:", section);
    // document.getElementById(section).classList.add('active'); // L√≥gica real de activaci√≥n
}





// ================= CATEGOR√çAS =================

async function fetchCategorias() {
    try {
        // 1. Obtener datos de Supabase
        const { data: categorias = [], error: catError } = await supabase
            .from("categorias")
            .select("*")
           .order("nombre", { ascending: true });


        if (catError) throw catError; 
        
        const container = document.getElementById('categoriaList');
        
        // 2. Verificaci√≥n Cr√≠tica: ¬øExiste el contenedor en el DOM?
        if (!container) {
            console.warn("Elemento 'categoriaList' no encontrado. Aseg√∫rate de que la pesta√±a de categor√≠as est√© activa.");
            return; 
        }
        
        // 3. Limpiar el contenedor antes de renderizar
        container.innerHTML = ''; 
        
        // 4. Renderizar cada categor√≠a
        for (const cat of categorias) {
            const div = document.createElement('div');
            div.className = 'card';
            div.dataset.catId = cat.id;

            // info
            const info = document.createElement('div');
            info.className = 'card-info';
            info.style = 'font-size: 14px; color: #555; font-weight: normal;';
            info.textContent = cat.nombre;

            // acciones
            const actions = document.createElement('div');
            actions.className = 'card-actions';

            const editBtn = document.createElement('button');
            editBtn.textContent = '‚úèÔ∏è';
            editBtn.addEventListener('click', () => editCategoria(cat.id, cat.nombre));

            const delBtn = document.createElement('button');
            delBtn.textContent = 'üóëÔ∏è';
            delBtn.addEventListener('click', () => deleteCategoria(cat.id));

            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            div.appendChild(info);
            div.appendChild(actions);
            container.appendChild(div);
        }

    } catch (err) {
        console.error('fetchCategorias error', err.message || err);
        showToast ? showToast('Error cargando categor√≠as.', 3000) : alert('Error cargando categor√≠as: ' + (err.message || err));
    }
}



// ================= AGREGAR NUEVA CATEGOR√çA =================

document.getElementById("addCategoriaBtn")?.addEventListener("click", () => {
    const nombre = prompt("Ingrese el nombre de la nueva categor√≠a:");

    if (nombre && nombre.trim() !== "") {
        guardarNuevaCategoria(nombre.trim());
    } else {
        alert("Debes ingresar un nombre v√°lido para la categor√≠a.");
    }
});


// Funci√≥n para guardar la nueva categor√≠a en Supabase
async function guardarNuevaCategoria(nombre) {
    try {
        const { error } = await supabase
            .from("categorias")
            .insert([{ nombre }]);

        if (error) throw error;

        alert("‚úÖ Categor√≠a agregada correctamente");
        fetchCategorias(); // vuelve a cargar la lista de categor√≠as (si existe)
    } catch (err) {
        alert("Error al agregar categor√≠a: " + err.message);
    }
}



// ----------------- EDITAR CATEGOR√çA (versi√≥n robusta) -----------------
function editCategoria(id, nombre) {
    const nombreSeguro = escapeHtml(nombre);

    // Creamos el HTML completo del modal (t√≠tulo incluido)
    const modalHtml = `
        <div style="padding: 18px 12px; width: 100%;">
            <h3 style="margin-top: 0; margin-bottom: 12px; font-size: 18px; color: #333;">
                Editar categor√≠a
            </h3>

            <div style="display: flex; gap: 10px; align-items: center; width: 100%;">
                <input 
                    id="editCat" 
                    type="text" 
                    value="${nombreSeguro}" 
                    placeholder="Escriba el nuevo nombre"
                    style="
                        flex-grow: 1; 
                        padding: 10px 16px;
                        border-radius: 8px;
                        border: 1px solid #ccc;
                        font-size: 16px;
                    "
                >
                <button 
                    onclick="updateCategoria(${id})" 
                    style="
                        background: #3498db;
                        color: #fff;
                        border: none;
                        padding: 10px 18px;
                        border-radius: 8px;
                        font-weight: bold;
                        font-size: 16px;
                        cursor: pointer;
                        white-space: nowrap;
                    "
                >
                    Guardar
                </button>
            </div>
        </div>
    `;

    openModal(modalHtml);

    // Enfocar el input tras abrir el modal
    setTimeout(() => {
        document.getElementById('editCat')?.focus();
    }, 150);
}




// ================= ELIMINAR CATEGOR√çA =================

async function deleteCategoria(id) {
    if (!confirm("¬øSeguro que quer√©s eliminar esta categor√≠a?")) return;

    try {
        // verificar si hay promociones usando esa categor√≠a
        const { data: promosRelacionadas, error: checkError } = await supabase
            .from("promociones")
            .select("id, nombre")
            .eq("categoria_id", id);

        if (checkError) throw checkError;

        if (promosRelacionadas.length > 0) {
            alert(`‚ö†Ô∏è No se puede eliminar esta categor√≠a porque est√° asociada a ${promosRelacionadas.length} promoci√≥n(es).`);
            return;
        }

        const { error } = await supabase.from("categorias").delete().eq("id", id);
        if (error) throw error;

        alert("‚úÖ Categor√≠a eliminada correctamente");
        fetchCategorias();
    } catch (err) {
        alert("Error al eliminar categor√≠a: " + err.message);
    }
}



// ================= ACTUALIZAR CATEGOR√çA =================

async function updateCategoria(id) {
    const inputElement = document.getElementById("editCat");
    if (!inputElement) {
        return console.error("No se encontr√≥ el campo de edici√≥n (#editCat).");
    }
    
    const nuevoNombre = inputElement.value.trim();

    if (!nuevoNombre) {
        alert("El nombre de la categor√≠a no puede estar vac√≠o.");
        return;
    }

    try {
        if (typeof closeModal === 'function') {
            closeModal(); 
        } else {
            console.warn("Funci√≥n closeModal() no definida. El modal debe cerrarse manualmente.");
        }
        
        const { error } = await supabase
            .from("categorias")
            .update({ nombre: nuevoNombre })
            .eq("id", id);

        if (error) throw error;

        alert("‚úÖ Categor√≠a actualizada correctamente.");
        fetchCategorias(); 

    } catch (err) {
        console.error("Error al actualizar categor√≠a:", err);
        alert("Error al actualizar categor√≠a: " + (err.message || 'Error desconocido'));
    }
}



// ================= FUNCIONES DE SEGURIDAD =================

function safeText(str) {
    if (typeof str !== 'string') return '';
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}


function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}




// ================= LOCALIDADES =================
async function fetchLocalidades(){
  const { data, error } = await supabase.from("localidades").select("*").order("id");
  if(error) return console.error(error);

  // Lista para gesti√≥n
  const container = document.getElementById("localidadList");
  container.innerHTML = "";
  data.forEach(l=>{
    // Tarjeta simple con flex
    const div = document.createElement('div');
    div.className = 'item-card';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    div.style.background = '#fff';
    div.style.border = '1px solid #eee';
    div.style.borderRadius = '10px';
    div.style.padding = '12px 18px';
    div.style.marginBottom = '12px';
    div.style.boxShadow = '0 2px 12px rgba(0,0,0,0.06)';

    // Nombre
    const nombreDiv = document.createElement('div');
    nombreDiv.textContent = l.nombre;
    nombreDiv.style.fontSize = '1.08em';
    nombreDiv.style.fontWeight = '500';

    // Botones
    const btnsDiv = document.createElement('div');
    btnsDiv.style.display = 'flex';
    btnsDiv.style.gap = '14px';
    btnsDiv.innerHTML = `
      <button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')" style="background:#3498db;color:#fff;border:none;padding:7px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">‚úèÔ∏è Editar</button>
      <button onclick="deleteLocalidad(${l.id})" style="background:#ff4d4f;color:#fff;border:none;padding:7px 18px;border-radius:7px;font-weight:bold;font-size:15px;cursor:pointer;">üóëÔ∏è Eliminar</button>
    `;

    div.appendChild(nombreDiv);
    div.appendChild(btnsDiv);
    container.appendChild(div);
  });

  // Select en formulario de pedidos
  const sel = document.getElementById("pedidoLocalidad");
  sel.innerHTML = '<option value="">Seleccione localidad</option>';
  data.forEach(l=>{
    sel.innerHTML += `<option value="${l.id}">${escapeHtml(l.nombre)}</option>`;
  });
}

async function addLocalidad(){
  const nombre=document.getElementById("localidadNombre").value.trim(); if(!nombre) return alert("Ingrese nombre");
  const {error}=await supabase.from("localidades").insert([{nombre}]); if(error) return alert(error.message); document.getElementById("localidadNombre").value=""; fetchLocalidades();
}

function editLocalidad(id,nombre){ 
  openModal("Editar localidad", `
    <div style="padding:18px 12px;">
      <input id="editLoc" value="${escapeHtml(nombre)}" style="padding:10px 16px;border-radius:8px;border:1px solid #ccc;font-size:16px;">
      <button onclick="updateLocalidad(${id})" style="margin-left:10px;background:#3498db;color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:bold;font-size:16px;cursor:pointer;">Guardar</button>
    </div>
  `); 
}
async function updateLocalidad(id){ 
  const nombre=document.getElementById("editLoc").value.trim(); if(!nombre) return alert("Ingrese nombre"); 
  const {error}=await supabase.from("localidades").update({nombre}).eq("id",id); 
  if(error) return alert(error.message); 
  closeModal(); fetchLocalidades(); 
}
async function deleteLocalidad(id){ 
  if(!confirm("Eliminar localidad?")) return; 
  await supabase.from("localidades").delete().eq("id",id); 
  fetchLocalidades(); 
}





// ================= DOCUMENTOS =================
async function addDocumento() {
  const file = document.getElementById("docArchivo").files[0];
  if (!file) return alert("Seleccione un archivo");
  const fileName = `${Date.now()}_${file.name}`;

  const { error: uploadError } = await supabase.storage.from("private-documents").upload(fileName, file);
  if (uploadError) return alert("Error al subir: " + uploadError.message);

  await supabase.from("documentos").insert([{ nombre: file.name, archivo: fileName }]);
  document.getElementById("docArchivo").value = "";
  fetchDocumentos();
}

async function fetchDocumentos() {
  const { data, error } = await supabase.from("documentos").select("*").order("created_at", { ascending: false });
  const container = document.getElementById("docList");
  container.innerHTML = "";

  if (error) {
    container.innerHTML = `<span style="color:red;">Error: ${escapeHtml(error.message)}</span>`;
    return;
  }

  if (!data?.length) {
    container.innerHTML = '<span style="color:#888;">No hay documentos subidos.</span>';
    return;
  }

  const signedDocs = await Promise.all(
    data.map(async doc => {
      let url = "#";
      if (doc.archivo) {
        const { data: urlData } = await supabase.storage.from("private-documents").createSignedUrl(doc.archivo, 60 * 60);
        url = urlData?.signedUrl || "#";
      }
      const fecha = doc.created_at ? new Date(doc.created_at).toLocaleString() : '';
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;">
          <div>
            <a href="${url}" target="_blank">${escapeHtml(doc.nombre)}</a>
            <span style="color:#888;font-size:0.97em;margin-left:8px;">${fecha}</span>
          </div>
          <button onclick="deleteDocumento(${doc.id}, '${doc.archivo}')" style="background:#ff4d4f;color:#fff;border:none;padding:7px 12px;border-radius:6px;font-weight:bold;cursor:pointer;">Eliminar</button>
        </div>

      `;
    })
  );

  container.innerHTML = signedDocs.join("");
}

async function deleteDocumento(id, archivo) {
  if (!confirm("¬øEliminar documento?")) return;
  await supabase.storage.from("private-documents").remove([archivo]);
  await supabase.from("documentos").delete().eq("id", id);
  fetchDocumentos();
}






// === INICIALIZACI√ìN DE EVENTOS ===


document.addEventListener('DOMContentLoaded', async () => {
    // Conexiones de botones (Esto est√° bien y se mantiene)
    document.querySelectorAll('.sidebar .tab-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');

            if (tabName === 'promos_menu') {
                const subMenu = document.getElementById('promoSubMenu');
                subMenu.classList.toggle('open');
                this.classList.toggle('active', subMenu.classList.contains('open'));
            } else {
                // Navegaci√≥n normal: Llama a activateSection, que tambi√©n limpia
                activateSection(tabName); 
            }
        });
    });



    // 2. üí• SOLUCI√ìN: Forzar la activaci√≥n de la secci√≥n por defecto ('promos') üí•
    //    Esto dispara:
    //    a) El CSS para ocultar la secci√≥n 'clienteTienda'.
    //    b) La llamada a limpiarContenedoresTienda() dentro de activateSection.
    activateSection('promos'); 
    
    // 3. Cargar el resto de los datos (estos fetch ya NO deber√≠an estar en el DCL, 
    //    sino solo en la funci√≥n activateSection para cada pesta√±a, pero se mantienen 
    //    aqu√≠ para evitar otros errores de "not defined" si los usas al inicio)
  
    fetchLocalidades();
    fetchPromos(); 
    fetchOrders(); 
    fetchDocumentos();
    loadPromoSubMenu();
  setupArchiveFilters();



  const btnDocs = document.querySelector("button[data-tab='documentos']");
  if (btnDocs) btnDocs.addEventListener("click", fetchDocumentos);

  const menuBtn = document.getElementById('menuBtn');
  if (menuBtn) menuBtn.addEventListener('click', toggleSidebar);

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (window.innerWidth <= 500 && document.querySelector('.sidebar').classList.contains('open')) {
        toggleSidebar();
      }
    });
  });
});



// Asigna los eventos de clic
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.getAttribute('data-tab');
    activateSection('promos');
    if (window.innerWidth <= 500 && document.querySelector('.sidebar').classList.contains('open')) {
      toggleSidebar();
    }
  });
});




/* =========================================================
   NUEVA L√ìGICA DE REPORTE DE VENTAS
   ========================================================= */

let allPromos = []; // Variable global para almacenar todas las promociones/stock
let allCategories = [];




/**
 * Obtiene todas las promociones para mapear IDs a nombres, stock y categor√≠as.
 */
async function fetchAllPromos() {
    if (allPromos.length > 0) return; // Ya cargado
    
    await fetchAllCategories(); // Asegura que las categor√≠as est√©n cargadas
    
    console.log('Cargando todas las promociones...');
    // Se asume que 'promociones' tiene una columna 'categoria_id'
    const { data, error } = await supabase.from('promociones').select('id, nombre, stock, categoria_id'); 
    
    if (error) {
        console.error('Error al cargar todas las promociones:', error);
        return;
    }
    
    // Mapear el nombre de la categor√≠a a cada promoci√≥n
    allPromos = data.map(promo => {
        const category = allCategories.find(c => c.id === promo.categoria_id);
        promo.categoria_nombre = category ? category.nombre : 'Sin Categor√≠a';
        return promo;
    });
    console.log(`${allPromos.length} promociones cargadas.`);
}






/**
 * Obtiene los datos de ventas DE PEDIDOS ACTIVOS, los agrupa por categor√≠a y los muestra.
 */
async function fetchSalesData() {
    const container = document.getElementById('salesReportContainer');
    container.innerHTML = '<p>Obteniendo datos de pedidos...</p>';

    // 1. Cargar todas las promociones (incluyendo la categor√≠a)
    await fetchAllPromos();
    
    // 2. Obtener SOLO los pedidos activos
    const { data: orders, error: ordersError } = await supabase
        .from('pedidos')
        .select('productos') 
        .eq('archivado', false); 

    if (ordersError) {
        console.error('Error al obtener pedidos para el reporte:', ordersError);
        container.innerHTML = `<p style="color:#ff4d4f;">Error al cargar los pedidos: ${ordersError.message}</p>`;
        return;
    }
    
    if (!orders || orders.length === 0) {
        container.innerHTML = '<p>No se encontraron pedidos activos.</p>';
        return;
    }

    // 3. Agregar las ventas por producto
    const salesMap = new Map(); 
    
    orders.forEach(order => {
        if (order.productos && Array.isArray(order.productos)) {
            order.productos.forEach(product => {
                const prodId = product.id;
                const qty = parseInt(product.cantidad, 10) || 0; 
                
                if (prodId && qty > 0) {
                    const currentTotal = salesMap.get(prodId) || 0;
                    salesMap.set(prodId, currentTotal + qty);
                }
            });
        }
    });

    // 4. Mapear los datos de ventas con nombre, stock y CATEGOR√çA
    const reportData = [];
    salesMap.forEach((totalSold, prodId) => {
        const promo = allPromos.find(p => p.id === prodId);
        const stockActual = promo ? (promo.stock ?? 0) : 'N/A';
        
        reportData.push({
            nombre: promo ? promo.nombre : `ID Desconocido (${prodId})`,
            stock: stockActual,
            vendido: totalSold,
            // NUEVO: A√±adir categor√≠a para la agrupaci√≥n
            categoria: promo ? promo.categoria_nombre : 'Sin Categor√≠a', 
        });
    });
    
    // 5. ORDENAR: Primero por Categor√≠a (A-Z), luego por Nombre (A-Z)
    reportData.sort((a, b) => {
        const catA = a.categoria.toUpperCase();
        const catB = b.categoria.toUpperCase();
        
        if (catA < catB) return -1;
        if (catA > catB) return 1;
        
        // Si las categor√≠as son iguales, ordena por nombre del producto
        const nameA = a.nombre.toUpperCase();
        const nameB = b.nombre.toUpperCase();
        
        if (nameA < nameB) return -1;
        if (nameA > nameB) return 1;
        return 0;
    });
    
    // **Almacenar datos en global para la exportaci√≥n a PDF**
    window.currentReportData = reportData; 

    // 6. Renderizar la tabla
    renderSalesReportTable(container, reportData);
}






/**
 * Obtiene todas las categor√≠as para mapear IDs a nombres.
 */
async function fetchAllCategories() {
    console.log('Cargando todas las categor√≠as...');
    const { data, error } = await supabase.from('categorias').select('id, nombre'); 
    if (error) {
        console.error('Error al cargar todas las categor√≠as:', error);
        return;
    }
    allCategories = data;
}






/**
 * Renderiza la tabla de reporte de ventas, agrupada por categor√≠a, en una sola tabla
 * con filas separadoras para las categor√≠as, imitando la estructura del PDF.
 */
function renderSalesReportTable(container, data) {
    if (data.length === 0) {
        container.innerHTML = '<p>No se encontraron ventas de productos.</p>';
        return;
    }
    
    // Inicia una sola tabla para todo el reporte
    let html = `
        <table class="table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #ccc;">
                    <th style="width: 60%;">Producto</th>
                    <th style="width: 20%; text-align:center;">Vendido Total</th>
                    <th style="width: 20%; text-align:center;">Stock Actual</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let currentCategory = '';
    
    data.forEach(item => {
        const isLowStock = item.stock !== 'N/A' && item.stock < item.vendido;

        // 1. Fila de Encabezado de Categor√≠a (si la categor√≠a cambia)
        if (item.categoria !== currentCategory) {
            currentCategory = item.categoria;
            
            // Fila especial para la categor√≠a que ocupa 3 columnas (colspan="3")
            // Esto replica la fila de encabezado que ves en el PDF.
            html += `
                <tr>
                    <td colspan="3" style="background: #eaf3f8; font-weight: bold; padding: 8px 10px; border-top: 2px solid #3498db; color: #2c3e50;">
                        Categor√≠a: ${currentCategory}
                    </td>
                </tr>
            `;
        }

        // 2. Fila de Producto
        html += `
            <tr>
                <td>${item.nombre}</td>
                <td style="text-align:center;">${item.vendido}</td>
                <td style="text-align:center; color:${isLowStock ? '#ff4d4f' : '#2ecc71'};">${item.stock}</td>
            </tr>
        `;
    });

    // Cierra la tabla
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}







/**
 * Exporta el reporte de ventas actual a un archivo PDF, incluyendo agrupaciones por categor√≠a.
 */
function exportSalesPDF() {
    const data = window.currentReportData;
    if (!data || data.length === 0) {
        showToast('No hay datos para exportar.');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    // T√≠tulo y Fecha
    doc.setFontSize(18);
    doc.text("Reporte de Ventas de Productos (Activos)", 14, 20);
    doc.setFontSize(10);
    doc.text(`Fecha del Reporte: ${new Date().toLocaleDateString()}`, 14, 27);
    
    // Preparar datos para AutoTable
    const finalData = [];
    let currentCategory = '';
    
    // Agrupar y formatear los datos para el PDF
    data.forEach(item => {
        // Si la categor√≠a cambia, inserta una fila de encabezado de categor√≠a
        if (item.categoria !== currentCategory) {
            currentCategory = item.categoria;
            // Fila de encabezado de categor√≠a (se extiende por las 3 columnas)
            finalData.push([{ 
                content: `Categor√≠a: ${currentCategory}`, 
                colSpan: 3, 
                styles: { 
                    fillColor: [236, 240, 241], // Gris claro
                    fontStyle: 'bold', 
                    halign: 'left',
                    textColor: [52, 73, 94]
                } 
            }]);
        }
        // Fila de producto
        finalData.push([item.nombre, item.vendido, item.stock]);
    });


    const headers = [
        ["Producto", "Vendido Total", "Stock Actual"]
    ];
    
    // Generar la tabla
    doc.autoTable({
        head: headers,
        body: finalData, // Usamos los datos formateados
        startY: 35,
        styles: {
            fontSize: 10,
            cellPadding: 3,
            valign: 'middle',
            lineWidth: 0.1,
            lineColor: [200, 200, 200]
        },
        headStyles: {
            fillColor: [44, 62, 80], 
            textColor: 255,
            fontStyle: 'bold',
            halign: 'center'
        },
        columnStyles: {
            0: { halign: 'left' },
            1: { halign: 'center' },
            2: { halign: 'center' },
        }
    });

    // Guardar el archivo
    doc.save(`Reporte_Ventas_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`);
    showToast('PDF de reporte de ventas generado.');
}



</script>
</body>
</html>


