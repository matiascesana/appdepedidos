<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Administrativo Completo</title>
<style>
:root {
  --sidebar-bg: #2c3e50;
  --sidebar-hover: #34495e;
  --accent: #ff4d4f;
  --card-bg: #fff;
  --text-muted: #555;
}
body { margin:0; font-family:Arial,sans-serif; display:flex; height:100vh; background:#f0f2f5; }
.sidebar { width:220px; background:var(--sidebar-bg); color:#fff; display:flex; flex-direction:column; padding-top:20px; flex-shrink:0; }
.sidebar h2 { text-align:center; margin-bottom:20px; font-size:22px; }
.sidebar button { background:none; border:none; color:white; text-align:left; padding:12px 20px; cursor:pointer; font-size:16px; width:100%; transition:0.2s; }
.sidebar button:hover, .sidebar button.active { background:var(--sidebar-hover); }
.content { flex:1; padding:20px; overflow-y:auto; }
.section { display:none; }
.section.active { display:block; }
h1 { margin-top:0; margin-bottom:15px; }

/* Tarjetas y listas */
.card { display:flex; align-items:center; gap:15px; background:var(--card-bg); padding:15px; border-radius:10px; margin-bottom:12px; border:1px solid #ddd; transition:0.3s; }
.card:hover { box-shadow:0 6px 18px rgba(0,0,0,0.15); }
.card img { width:100px; height:100px; object-fit:cover; border-radius:10px; border:1px solid #ccc; }
.card-info { flex:1; display:flex; flex-direction:column; gap:6px; }
.card-info b { font-size:1.1em; }
.card-price { font-size:1em; color:var(--accent); }
.card-price del { color:#999; margin-right:6px; }
.card-stock { font-size:0.85em; color:var(--text-muted); }
.card-actions { display:flex; flex-direction:column; gap:6px; }
.card-actions button { cursor:pointer; border:none; border-radius:6px; padding:6px 12px; font-weight:bold; transition:0.2s; }
.card-actions .edit-btn { background:#3498db; color:#fff; }
.card-actions .edit-btn:hover { background:#2980b9; }
.card-actions .delete-btn { background:var(--accent); color:#fff; }
.card-actions .delete-btn:hover { background:#e8434f; }

/* Modal */
#modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index:9999; }
#modalInner { background:white; padding:20px; border-radius:8px; width:90%; max-width:500px; max-height:90%; overflow-y:auto; }
input, select, button { margin-bottom:8px; padding:6px; font-size:14px; border-radius:4px; border:1px solid #ccc; }
button[type=submit]{background:var(--accent); color:#fff; border:none; cursor:pointer;}
button[type=submit]:hover{background:#e8434f;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<div class="sidebar">
  <h2>Admin</h2>
  <button class="tab-btn active" data-tab="promos">Promociones</button>
  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
  <button class="tab-btn" data-tab="categorias">Categor칤as</button>
  <button class="tab-btn" data-tab="localidades">Localidades</button>
  <button class="tab-btn" data-tab="documentos">Documentos</button>
</div>

<div class="content">

  <!-- PROMOCIONES -->
  <div id="promos" class="section active">
    <h1>Gesti칩n de Promociones</h1>
    <form id="promoForm" onsubmit="event.preventDefault(); addPromo();">
      <input type="text" id="promoNombre" placeholder="Nombre" required>
      <input type="number" id="promoPrecio" placeholder="Precio" step="0.01" required>
      <input type="number" id="promoPrecioAnterior" placeholder="Precio anterior" step="0.01">
      <input type="number" id="promoStock" placeholder="Stock">
      <select id="promoCategoria"></select>
      <input type="file" id="promoImagen" accept="image/*">
      <button type="submit">Agregar promoci칩n</button>
    </form>
    <button onclick="exportPDF()">Exportar PDF</button>
    <div id="promoList"></div>
  </div>

  <!-- CATEGOR칈AS -->
  <div id="categorias" class="section">
    <h1>Gesti칩n de Categor칤as</h1>
    <input type="text" id="categoriaNombre" placeholder="Nueva categor칤a">
    <button onclick="addCategoria()">Agregar</button>
    <div id="categoriaList"></div>
  </div>

  <!-- LOCALIDADES -->
  <div id="localidades" class="section">
    <h1>Gesti칩n de Localidades</h1>
    <input type="text" id="localidadNombre" placeholder="Nueva localidad">
    <button onclick="addLocalidad()">Agregar</button>
    <div id="localidadList"></div>
  </div>

  <!-- PEDIDOS -->
  <div id="pedidos" class="section">
    <h1>Gesti칩n de Pedidos</h1>
    <button onclick="fetchPedidos()">Actualizar Pedidos</button>
    <div id="pedidoList"></div>
  </div>

  <!-- DOCUMENTOS -->
  <div id="documentos" class="section">
    <h1>Gesti칩n de Documentos</h1>
    <input type="text" id="docNombre" placeholder="Nombre del documento">
    <input type="file" id="docArchivo">
    <button onclick="addDocumento()">Agregar Documento</button>
    <button onclick="fetchDocumentos()">Actualizar Documentos</button>
    <div id="docList"></div>
  </div>

</div>

<div id="modal"><div id="modalInner"></div></div>

<script>
// --- CONFIGURACI칍N SUPABASE ---
const SUPABASE_URL="https://ejbqlejlgprvwzrptojo.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";
const supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// --- SIDEBAR ---
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// --- MODAL ---
function openModal(title, html){ document.getElementById("modalInner").innerHTML=`<h3>${title}</h3>${html}`; document.getElementById("modal").style.display="flex"; }
function closeModal(){ document.getElementById("modal").style.display="none"; }
document.getElementById("modal").addEventListener("click",(e)=>{ if(e.target.id==="modal") closeModal(); });

// --- ESCAPE HTML ---
function escapeHtml(text){ var div=document.createElement("div"); div.innerText=text; return div.innerHTML; }

// ================= PROMOCIONES =================
async function fetchPromotions() {
    console.log('游녤 fetchPromotions ejecutado');

    // Consulta con JOIN para obtener el nombre de la categor칤a
    const { data, error } = await supabase.from('promociones').select('*, categorias(nombre)').order('id');
    if (error) return console.error(error);

    const container = document.getElementById('promoList');
    container.innerHTML = '';

    // Agrupar promociones por categor칤a
    const groupedPromos = data.reduce((groups, promo) => {
        const categoryName = promo.categorias?.nombre || promo.categoria || 'Sin Categor칤a';
        if (!groups[categoryName]) groups[categoryName] = [];
        groups[categoryName].push(promo);
        return groups;
    }, {});

    const categoryNames = Object.keys(groupedPromos).sort();

    for (const categoryName of categoryNames) {
        const promos = groupedPromos[categoryName];

        // T칤tulo de categor칤a
        const titleDiv = document.createElement('div');
        titleDiv.innerHTML = `<h3 style="margin-top: 20px; margin-bottom: 8px;">${categoryName}</h3>`;
        container.appendChild(titleDiv);

        for (const promo of promos) {
            // Obtener URL de imagen
            let imgUrl = '';
            if (promo.imagen) {
                const { data: signedData, error: imgError } = await supabase.storage.from('promo_images').createSignedUrl(promo.imagen, 60 * 60);
                imgUrl = signedData?.signedUrl || '';
            } else if (promo.imagen_url) {
                imgUrl = promo.imagen_url;
            }

            const imgHTML = imgUrl
                ? `<img src="${imgUrl}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px">`
                : '';

            // Precio con tachado si aplica
            let precioHTML = `<strong>$${Number(promo.precio).toFixed(2)}</strong>`;
            if (promo.precio_anterior && Number(promo.precio_anterior) > Number(promo.precio)) {
                precioHTML = `<span style="text-decoration: line-through; color: #999; margin-right: 8px;">$${Number(promo.precio_anterior).toFixed(2)}</span>
                              <strong style="color: #ff4d4f; font-size: 1.1em;">$${Number(promo.precio).toFixed(2)}</strong>`;
            }

            // JSON seguro para checkbox
            const promoData = JSON.stringify({
                id: promo.id,
                nombre: promo.nombre,
                precio: promo.precio,
                precio_anterior: promo.precio_anterior,
                stock: promo.stock,
                imagen_url: imgUrl,
                categoria: categoryName
            }).replace(/'/g, "&apos;"); // Escapa comillas simples

            const div = document.createElement('div');
            div.className = 'item-card';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.marginBottom = '8px';

            div.innerHTML = `
                <input type="checkbox" class="promo-export-check" data-promo='${promoData}' checked style="margin-right: 12px; transform: scale(1.4);">
                ${imgHTML}
                <div style="flex:1">
                    <strong>${escapeHtml(promo.nombre || '')}</strong>
                    <div class="small-muted">${precioHTML} &nbsp; 췅 &nbsp; Stock: ${promo.stock ?? 0}</div>
                </div>
                <div>
                    <button onclick="editPromo(${promo.id})">Editar</button>
                    <button class="delete-btn" onclick="deletePromo(${promo.id}, '${promo.imagen || ''}')">Eliminar</button>
                </div>
            `;
            container.appendChild(div);
        }
    }
}

async function addPromo(){
  const nombre=document.getElementById("promoNombre").value.trim();
  const precio=document.getElementById("promoPrecio").value;
  const precio_anterior=document.getElementById("promoPrecioAnterior").value;
  const stock=document.getElementById("promoStock").value;
  const categoria=document.getElementById("promoCategoria").value;
  const file=document.getElementById("promoImagen").files[0];
  if(!nombre || !precio) return alert("Nombre y precio requeridos");
  let fileName=null;
  if(file){ fileName=`${Date.now()}_${file.name}`; await supabase.storage.from("promo_images").upload(fileName,file); }
  const { error }=await supabase.from("promociones").insert([{nombre,precio,precio_anterior:precio_anterior||null,stock:stock||0,categoria_id:categoria,imagen_url:fileName}]);
  if(error) return alert(error.message);
  document.getElementById("promoForm").reset(); fetchPromotions();
}

function editPromo(promo){
  openModal("Editar promoci칩n",`
    <input type="text" id="editNombre" value="${escapeHtml(promo.nombre)}" placeholder="Nombre">
    <input type="number" id="editPrecio" value="${promo.precio}" step="0.01" placeholder="Precio">
    <input type="number" id="editPrecioAnterior" value="${promo.precio_anterior||''}" step="0.01" placeholder="Precio anterior">
    <input type="number" id="editStock" value="${promo.stock||0}" placeholder="Stock">
    <select id="editCategoria"></select>
    <input type="file" id="editImagen">
    <button onclick="updatePromo(${promo.id})">Guardar</button>
  `);
  // Llenar categor칤as
  supabase.from("categorias").select("id,nombre").then(({data})=>{
    const sel=document.getElementById("editCategoria"); sel.innerHTML=""; data.forEach(c=>{ sel.innerHTML+=`<option value='${c.id}' ${c.id===promo.categoria_id?'selected':''}>${escapeHtml(c.nombre)}</option>`; });
  });
}

async function updatePromo(id){
  const nombre=document.getElementById("editNombre").value.trim();
  const precio=document.getElementById("editPrecio").value;
  const precio_anterior=document.getElementById("editPrecioAnterior").value;
  const stock=document.getElementById("editStock").value;
  const categoria=document.getElementById("editCategoria").value;
  const file=document.getElementById("editImagen").files[0];
  let fileName=null;
  if(file){ fileName=`${Date.now()}_${file.name}`; await supabase.storage.from("promo_images").upload(fileName,file); }
  const updateObj={nombre,precio,precio_anterior:precio_anterior||null,stock:stock||0,categoria_id:categoria};
  if(fileName) updateObj.imagen_url=fileName;
  const {error}=await supabase.from("promociones").update(updateObj).eq("id",id);
  if(error) return alert(error.message); closeModal(); fetchPromotions();
}

async function deletePromo(id){ if(!confirm("Eliminar promoci칩n?")) return; await supabase.from("promociones").delete().eq("id",id); fetchPromotions(); }

// Funci칩n auxiliar para convertir imagen remota a Base64
async function getBase64ImageFromUrl(imageUrl) {
    if(!imageUrl) return '';
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous'; // importante para Supabase
        img.src = imageUrl;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/png'));
        };
        img.onerror = err => resolve(''); // si falla, devuelve vac칤o
    });
}

async function exportPDF() {
    const selectedPromos = Array.from(document.querySelectorAll(".promo-export-check"))
        .filter(chk => chk.checked)
        .map(chk => JSON.parse(chk.dataset.promo));

    if (selectedPromos.length === 0) return alert("Seleccione al menos una promoci칩n");

    // Agrupar promociones por categor칤a
    const grouped = selectedPromos.reduce((acc, promo) => {
        const cat = promo.categoria || 'Sin categor칤a';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(promo);
        return acc;
    }, {});

    const container = document.createElement("div");
    container.style.width = "800px";
    container.style.fontFamily = "Arial, sans-serif";

    for (const category of Object.keys(grouped)) {
        const promos = grouped[category];
        let pageCount = 0;

        while (pageCount * 6 < promos.length) {
            const page = document.createElement("div");
            page.style.pageBreakAfter = "always";
            page.style.marginBottom = "20px";

            // T칤tulo de categor칤a
            const catTitle = document.createElement("h2");
            catTitle.textContent = category;
            catTitle.style.borderBottom = "2px solid #333";
            catTitle.style.paddingBottom = "6px";
            page.appendChild(catTitle);

            const slice = promos.slice(pageCount * 6, pageCount * 6 + 6);

            // Convertir im치genes a Base64 para cada promoci칩n
            for (const p of slice) {
                const promoDiv = document.createElement("div");
                promoDiv.style.display = "flex";
                promoDiv.style.alignItems = "center";
                promoDiv.style.margin = "12px 0";
                promoDiv.style.padding = "10px";
                promoDiv.style.border = "1px solid #ddd";
                promoDiv.style.borderRadius = "8px";
                promoDiv.style.boxShadow = "0 3px 8px rgba(0,0,0,0.1)";

                let imgSrc = '';
                if (p.imagen_url) {
                    // Convertir URL de Supabase a Base64
                    imgSrc = await getBase64ImageFromUrl(p.imagen_url);
                }

                const img = document.createElement("img");
                img.style.width = "100px";
                img.style.height = "100px";
                img.style.objectFit = "cover";
                img.style.borderRadius = "8px";
                img.style.marginRight = "12px";
                img.src = imgSrc;
                promoDiv.appendChild(img);

                const info = document.createElement("div");
                info.innerHTML = `
                    <b>${escapeHtml(p.nombre)}</b><br>
                    ${p.precio_anterior && Number(p.precio_anterior) > Number(p.precio)
                        ? `<del>$${Number(p.precio_anterior).toFixed(2)}</del> <span style="color: red; font-weight:bold;">$${Number(p.precio).toFixed(2)}</span>`
                        : `<span style="font-weight:bold;">$${Number(p.precio).toFixed(2)}</span>`}<br>
                    Stock: ${p.stock || 0}<br>
                    Categor칤a: ${escapeHtml(category)}
                `;
                promoDiv.appendChild(info);
                page.appendChild(promoDiv);
            }

            container.appendChild(page);
            pageCount++;
        }
    }

    html2pdf().from(container).set({
        margin: [20, 20, 20, 20],
        filename: "promociones_catalogo.pdf",
        html2canvas: { scale: 2, logging: false, dpi: 300, letterRendering: true },
        jsPDF: { unit: "pt", format: "a4", orientation: "portrait" }
    }).save();
}


// ================= CATEGOR칈AS =================
async function fetchCategorias(){
  const { data,error }=await supabase.from("categorias").select("*").order("id");
  if(error) return console.error(error);
  const container=document.getElementById("categoriaList"); container.innerHTML="";
  const sel=document.getElementById("promoCategoria"); sel.innerHTML='<option value="">Sin categor칤a</option>';
  data.forEach(c=>{
    const div=document.createElement("div"); div.innerHTML=`${escapeHtml(c.nombre)} <button onclick="editCategoria(${c.id},'${escapeHtml(c.nombre)}')">Editar</button> <button onclick="deleteCategoria(${c.id})">Eliminar</button>`; container.appendChild(div);
    sel.innerHTML+=`<option value="${c.id}">${escapeHtml(c.nombre)}</option>`;
  });
}

async function addCategoria(){
  const nombre=document.getElementById("categoriaNombre").value.trim(); if(!nombre) return alert("Ingrese nombre");
  const {error}=await supabase.from("categorias").insert([{nombre}]); if(error) return alert(error.message);
  document.getElementById("categoriaNombre").value=""; fetchCategorias();
}

function editCategoria(id,nombre){
  openModal("Editar categor칤a", `<input id="editCat" value="${escapeHtml(nombre)}"><button onclick="updateCategoria(${id})">Guardar</button>`);
}

async function updateCategoria(id){
  const nombre=document.getElementById("editCat").value.trim(); if(!nombre) return alert("Ingrese nombre");
  const {error}=await supabase.from("categorias").update({nombre}).eq("id",id); if(error) return alert(error.message); closeModal(); fetchCategorias();
}

async function deleteCategoria(id){ if(!confirm("Eliminar categor칤a?")) return; await supabase.from("categorias").delete().eq("id",id); fetchCategorias(); }

// ================= LOCALIDADES =================
async function fetchLocalidades(){
  const { data,error }=await supabase.from("localidades").select("*").order("id");
  if(error) return console.error(error);
  const container=document.getElementById("localidadList"); container.innerHTML="";
  data.forEach(l=>{ container.innerHTML+=`${escapeHtml(l.nombre)} <button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')">Editar</button> <button onclick="deleteLocalidad(${l.id})">Eliminar</button><br>`; });
}

async function addLocalidad(){
  const nombre=document.getElementById("localidadNombre").value.trim(); if(!nombre) return alert("Ingrese nombre");
  const {error}=await supabase.from("localidades").insert([{nombre}]); if(error) return alert(error.message); document.getElementById("localidadNombre").value=""; fetchLocalidades();
}

function editLocalidad(id,nombre){ openModal("Editar localidad", `<input id="editLoc" value="${escapeHtml(nombre)}"><button onclick="updateLocalidad(${id})">Guardar</button>`); }
async function updateLocalidad(id){ const nombre=document.getElementById("editLoc").value.trim(); if(!nombre) return alert("Ingrese nombre"); const {error}=await supabase.from("localidades").update({nombre}).eq("id",id); if(error) return alert(error.message); closeModal(); fetchLocalidades(); }
async function deleteLocalidad(id){ if(!confirm("Eliminar localidad?")) return; await supabase.from("localidades").delete().eq("id",id); fetchLocalidades(); }

// ================= PEDIDOS =================
async function fetchPedidos(){
  const { data, error } = await supabase.from("pedidos")
    .select("id,cliente,total,productos,localidad_id,localidades(nombre)")
    .order("id",{ascending:false});
  if(error){ console.error(error); return; }
  const container=document.getElementById("pedidoList"); container.innerHTML="";
  data.forEach(p=>{
    const div=document.createElement("div"); div.className="card";
    let productosHTML="";
    try{
      const prods = typeof p.productos==="string"?JSON.parse(p.productos):p.productos;
      if(Array.isArray(prods)) productosHTML="<ul>"+prods.map(pr=>`<li>${pr.nombre||pr.producto} x${pr.cantidad||1}</li>`).join("")+"</ul>";
      else productosHTML=p.productos||"";
    }catch(e){ productosHTML=p.productos||""; }
    div.innerHTML=`<b>Cliente:</b> ${escapeHtml(p.cliente||'')} <br>
                   <b>Total:</b> $${p.total||0} <br>
                   <b>Localidad:</b> ${escapeHtml(p.localidades?.nombre||'')} <br>
                   <b>Productos:</b> ${productosHTML}`;
    container.appendChild(div);
  });
}

// ================= DOCUMENTOS =================
async function fetchDocumentos(){
  const { data, error } = await supabase.from("documentos").select("*").order("id",{ascending:false});
  if(error){ console.error(error); return; }
  const container=document.getElementById("docList"); container.innerHTML="";
  data.forEach(d=>{
    const a=document.createElement("a");
    a.href=supabase.storage.from("docs").getPublicUrl(d.archivo).data.publicUrl;
    a.target="_blank"; a.textContent=d.nombre;
    container.appendChild(a); container.appendChild(document.createElement("br"));
  });
}

async function addDocumento(){
  const nombre=document.getElementById("docNombre").value.trim();
  const file=document.getElementById("docArchivo").files[0];
  if(!nombre || !file) return alert("Nombre y archivo");
  const fileName=`${Date.now()}_${file.name}`;
  const {error}=await supabase.storage.from("docs").upload(fileName,file);
  if(error) return alert(error.message);
  await supabase.from("documentos").insert([{nombre,archivo:fileName}]);
  document.getElementById("docNombre").value=""; document.getElementById("docArchivo").value="";
  fetchDocumentos();
}

// --- INICIALIZACI칍N ---
fetchCategorias(); fetchLocalidades(); fetchPromotions(); fetchPedidos(); fetchDocumentos();
</script>

</body>
</html>
