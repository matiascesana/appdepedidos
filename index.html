<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>App de Pedidos Completa</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        input, button { margin: 5px 0; padding: 8px; }
        .section { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 10px; }
        label { display: block; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Gestión Completa de Pedidos</h1>

    <!-- Sección de Categorías -->
    <div class="section">
        <h2>Agregar Categoría</h2>
        <input type="text" id="categoryName" placeholder="Nombre de categoría">
        <button onclick="addCategory()">Agregar Categoría</button>
        <h3>Categorías existentes:</h3>
        <ul id="categoryList"></ul>
    </div>

    <!-- Sección de Productos -->
    <div class="section">
        <h2>Agregar Producto</h2>
        <input type="text" id="productName" placeholder="Nombre de producto">
        <input type="number" id="productPrice" placeholder="Precio">
        <input type="file" id="productImage" multiple>
        <button onclick="addProduct()">Agregar Producto</button>
        <h3>Productos existentes:</h3>
        <ul id="productList"></ul>
    </div>

    <!-- Sección de Documentos -->
    <div class="section">
        <h2>Subir Documentos</h2>
        <input type="file" id="docFiles" multiple>
        <button onclick="uploadFiles()">Subir Archivos</button>
        <h3>Documentos subidos:</h3>
        <ul id="documentList"></ul>
    </div>

    <!-- Sección PDF -->
    <div class="section">
        <h2>Generar PDF</h2>
        <button onclick="generatePDF()">Generar PDF de prueba</button>
    </div>

    <script>
        // ----------------- Inicialización Supabase -----------------
        const SUPABASE_URL = 'TU_SUPABASE_URL';
        const SUPABASE_KEY = 'TU_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ----------------- Categorías -----------------
        async function addCategory() {
            const name = document.getElementById('categoryName').value;
            if (!name) return alert('Ingrese un nombre de categoría');

            const { data, error } = await supabase
                .from('categorias')
                .insert([{ nombre: name }]);

            if (error) {
                console.error(error);
                alert('Error al agregar categoría');
            } else {
                alert('Categoría agregada');
                document.getElementById('categoryName').value = '';
                fetchCategories();
            }
        }

        async function fetchCategories() {
            const { data, error } = await supabase.from('categorias').select('*');
            if (error) return console.error(error);

            const list = document.getElementById('categoryList');
            list.innerHTML = '';
            data.forEach(cat => {
                const li = document.createElement('li');
                li.textContent = `ID: ${cat.id} - ${cat.nombre}`;
                list.appendChild(li);
            });
        }

        // ----------------- Productos -----------------
        async function addProduct() {
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const files = document.getElementById('productImage').files;

            if (!name || !price || files.length === 0) return alert('Complete todos los campos');

            // Subir imágenes al storage
            const uploadedUrls = [];
            for (let file of files) {
                const { data, error } = await supabase
                    .storage
                    .from('productos')
                    .upload(file.name, file, { upsert: true });

                if (error) {
                    console.error(error);
                    alert('Error al subir imagen: ' + file.name);
                    return;
                } else {
                    const url = `${SUPABASE_URL}/storage/v1/object/public/productos/${file.name}`;
                    uploadedUrls.push(url);
                }
            }

            // Insertar producto en DB
            const { data, error } = await supabase
                .from('productos')
                .insert([{ nombre: name, precio: price, imagen: uploadedUrls.join(',') }]);

            if (error) {
                console.error(error);
                alert('Error al agregar producto');
            } else {
                alert('Producto agregado');
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productImage').value = '';
                fetchProducts();
            }
        }

        async function fetchProducts() {
            const { data, error } = await supabase.from('productos').select('*');
            if (error) return console.error(error);

            const list = document.getElementById('productList');
            list.innerHTML = '';
            data.forEach(prod => {
                const li = document.createElement('li');
                li.innerHTML = `ID: ${prod.id} - ${prod.nombre} - $${prod.precio} <br> Imagen: ${prod.imagen}`;
                list.appendChild(li);
            });
        }

        // ----------------- Documentos -----------------
        async function uploadFiles() {
            const files = document.getElementById('docFiles').files;
            if (files.length === 0) return alert('Seleccione archivos');

            for (let file of files) {
                const { data, error } = await supabase
                    .storage
                    .from('documentos')
                    .upload(file.name, file, { upsert: true });

                if (error) {
                    console.error(error);
                    alert('Error al subir archivo: ' + file.name);
                }
            }

            alert('Archivos subidos correctamente');
            document.getElementById('docFiles').value = '';
            fetchDocuments();
        }

        async function fetchDocuments() {
            const { data, error } = await supabase
                .storage
                .from('documentos')
                .list('');

            if (error) return console.error(error);

            const list = document.getElementById('documentList');
            list.innerHTML = '';
            data.forEach(doc => {
                const li = document.createElement('li');
                li.textContent = doc.name;
                list.appendChild(li);
            });
        }

        // ----------------- PDF -----------------
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text('Listado de Productos', 10, 10);

            fetchProductsForPDF(doc);
        }

        async function fetchProductsForPDF(doc) {
            const { data, error } = await supabase.from('productos').select('*');
            if (error) return console.error(error);

            let y = 20;
            data.forEach(prod => {
                doc.text(`ID: ${prod.id} - ${prod.nombre} - $${prod.precio}`, 10, y);
                y += 10;
            });

            doc.save('productos.pdf');
        }

        // ----------------- Inicializar listas -----------------
        fetchCategories();
        fetchProducts();
        fetchDocuments();

    </script>
</body>
</html>



