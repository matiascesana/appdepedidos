<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Negocio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

    <div id="loading-overlay" class="fixed inset-0 flex flex-col items-center justify-center loading-overlay z-50">
        <div id="spinner" class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        <p id="status-message" class="mt-4 text-gray-700 font-medium">Iniciando...</p>
    </div>

    <div id="auth-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-100 p-4 z-40 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">Gestor de Negocio</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email-input" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="email-input" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700">Contraseña</label>
                    <input type="password" id="password-input" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <button type="button" id="login-btn" class="w-full bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md font-bold">
                    Iniciar Sesión
                </button>
                <div class="text-center mt-4">
                    <p class="text-sm text-gray-600">¿No tienes una cuenta?</p>
                    <button type="button" id="register-btn" class="text-blue-600 font-bold hover:underline transition-colors mt-1">
                        Regístrate
                    </button>
                </div>
            </form>
            <p id="auth-error-message" class="text-red-500 text-sm mt-4 text-center hidden"></p>
        </div>
    </div>

    <div id="app-container" class="flex flex-col flex-grow hidden">
        <header class="bg-white shadow-md p-4 flex items-center justify-between z-10">
            <h1 class="text-2xl font-bold text-blue-600">Gestor de Negocio</h1>
            <div id="auth-status" class="text-sm text-gray-500 flex items-center space-x-2">
                <span id="user-name" class="font-medium"></span>
                <button onclick="signOutUser()" class="text-red-500 hover:text-red-700 transition-colors text-lg" title="Cerrar sesión">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
            <nav id="nav-tabs" class="flex space-x-2">
                <button onclick="navigate('promotions')" id="tab-promotions" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-blue-500 text-white">Promociones</button>
                <button onclick="navigate('orders')" id="tab-orders" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200">Pedidos</button>
                <button onclick="navigate('locations')" id="tab-locations" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200">Localidades</button>
                <button onclick="navigate('categories')" id="tab-categories" class="px-4 py-2 rounded-lg text-sm font-medium transition-colors text-gray-700 hover:bg-gray-200">Categorías</button>
            </nav>
        </header>

        <main id="main-content" class="p-4 flex-grow overflow-y-auto">
        </main>
    </div>

    <div id="modal-container" class="fixed inset-0 flex items-center justify-center z-50 hidden modal-overlay">
        <div id="modal-content" class="bg-white rounded-lg shadow-lg p-6 w-11/12 md:w-1/3">
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const SUPABASE_URL = 'https://ejbqlejlgprvwzrptojo.supabase.co'; // Make sure this is also correct
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8'; // Paste your key here
        const supabase = createClient(supabaseUrl, supabaseKey)
        
        // Global app state
        let appState = {
            userId: null,
            userName: null,
            currentView: 'promotions',
            promotions: {},
            categories: {},
            locations: {},
            orders: {},
            selectedOrder: null,
            orderProducts: []
        };
        
        // --- Utility Functions ---
        const viewTemplates = {
            promotions: `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Catálogo de Promociones</h2>
                    <button onclick="showPromoModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                        <i class="fas fa-plus mr-2"></i>Nueva Promoción
                    </button>
                </div>
                <div id="promotions-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            `,
            orders: `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Pedidos</h2>
                    <button onclick="showOrderModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-md">
                        <i class="fas fa-plus mr-2"></i>Nuevo Pedido
                    </button>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex justify-around flex-wrap text-center">
                    <div>
                        <p class="text-sm text-gray-500">Total General</p>
                        <p id="total-general" class="text-xl font-bold text-blue-600">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Entregados</p>
                        <p id="total-delivered" class="text-xl font-bold text-green-600">$0.00</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Pendientes</p>
                        <p id="total-pending" class="text-xl font-bold text-red-600">$0.00</p>
                    </div>
                </div>
                <div id="orders-list" class="space-y-4"></div>
            `,
            locations: `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Gestión de Localidades</h2>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex mb-4">
                        <input type="text" id="new-location-input" placeholder="Nombre de la nueva localidad" class="flex-grow p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="addLocation()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">Agregar</button>
                    </div>
                    <ul id="locations-list" class="space-y-2"></ul>
                </div>
            `,
            categories: `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Gestión de Categorías</h2>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex mb-4">
                        <input type="text" id="new-category-input" placeholder="Nombre de la nueva categoría" class="flex-grow p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="addCategory()" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md">Agregar</button>
                    </div>
                    <ul id="categories-list" class="space-y-2"></ul>
                </div>
            `
        };

        window.showLoading = function(show, message = 'Cargando...') {
            const loadingOverlay = document.getElementById('loading-overlay');
            const appContainer = document.getElementById('app-container');
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('spinner');

            loadingOverlay.classList.toggle('hidden', !show);
            appContainer.classList.toggle('hidden', show);
            statusMessage.innerText = message;
            spinner.classList.toggle('hidden', !show);
            statusMessage.classList.remove('text-red-600');
            statusMessage.classList.add('text-gray-700');
        };

        window.showStatusMessage = function(message, isError = false) {
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('spinner');
            statusMessage.innerText = message;
            spinner.classList.add('hidden');
            if (isError) {
                statusMessage.classList.remove('text-gray-700');
                statusMessage.classList.add('text-red-600');
            } else {
                statusMessage.classList.remove('text-red-600');
                statusMessage.classList.add('text-gray-700');
            }
        };

        window.showModal = function(contentHtml) {
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = contentHtml;
            modalContainer.classList.remove('hidden');
        };

        window.closeModal = function() {
            document.getElementById('modal-container').classList.add('hidden');
        };

        // --- Navigation ---
        window.navigate = function(view) {
            appState.currentView = view;
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = viewTemplates[view];
            
            // Highlight active tab
            document.querySelectorAll('#nav-tabs button').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('text-gray-700', 'hover:bg-gray-200');
            });
            document.getElementById(`tab-${view}`).classList.remove('text-gray-700', 'hover:bg-gray-200');
            document.getElementById(`tab-${view}`).classList.add('bg-blue-500', 'text-white');

            renderView();
        };

        function renderView() {
            switch(appState.currentView) {
                case 'promotions':
                    renderPromotions();
                    break;
                case 'orders':
                    renderOrders();
                    break;
                case 'locations':
                    renderLocations();
                    break;
                case 'categories':
                    renderCategories();
                    break;
            }
        }

        // --- Authentication ---
        const authForm = document.getElementById('auth-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const authErrorMessage = document.getElementById('auth-error-message');

        function showAuthError(message) {
            authErrorMessage.innerText = message;
            authErrorMessage.classList.remove('hidden');
        }

        function hideAuthError() {
            authErrorMessage.classList.add('hidden');
        }
        
        loginBtn.addEventListener('click', async () => {
            hideAuthError();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) {
                showAuthError("Por favor, ingresa tu correo y contraseña.");
                return;
            }
            try {
                showLoading(true, 'Iniciando sesión...');
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
            } catch (error) {
                console.error("Error al iniciar sesión:", error.message);
                let message = "Error al iniciar sesión. Intenta de nuevo.";
                if (error.message.includes('Invalid login credentials')) {
                    message = "Correo o contraseña incorrectos.";
                }
                showStatusMessage(message, true);
                setTimeout(() => showLoading(false), 3000);
            }
        });

        registerBtn.addEventListener('click', async () => {
            hideAuthError();
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) {
                showAuthError("Por favor, ingresa un correo y contraseña para registrarte.");
                return;
            }
            try {
                showLoading(true, 'Registrando...');
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                showStatusMessage('Registro exitoso. Revisa tu correo para confirmar.');
                setTimeout(() => showLoading(false), 3000);
            } catch (error) {
                console.error("Error al registrar:", error.message);
                let message = "Error al registrar. Intenta de nuevo.";
                if (error.message.includes('Email already registered')) {
                    message = "Este correo ya está registrado.";
                }
                showStatusMessage(message, true);
                setTimeout(() => showLoading(false), 3000);
            }
        });

        window.signOutUser = async function() {
            showLoading(true, 'Cerrando sesión...');
            const { error } = await supabase.auth.signOut();
            if (error) console.error("Error al cerrar sesión:", error.message);
            showLoading(false);
        };
        
        // --- Database Schema Initialization ---
        async function initializeSupabaseSchema() {
            const sql = `
                -- Create tables if they don't exist
                CREATE TABLE IF NOT EXISTS public.promotions (
                    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                    name text NOT NULL,
                    original_price double precision,
                    price double precision NOT NULL,
                    stock integer NOT NULL,
                    image text,
                    category_id uuid,
                    user_id uuid NOT NULL,
                    created_at timestamp with time zone DEFAULT now()
                );

                CREATE TABLE IF NOT EXISTS public.categories (
                    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                    name text NOT NULL,
                    user_id uuid NOT NULL
                );
                
                CREATE TABLE IF NOT EXISTS public.locations (
                    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                    name text NOT NULL,
                    user_id uuid NOT NULL
                );
                
                CREATE TABLE IF NOT EXISTS public.orders (
                    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                    client_name text NOT NULL,
                    client_phone text,
                    location_id uuid,
                    total double precision NOT NULL,
                    status text NOT NULL DEFAULT 'Pendiente',
                    user_id uuid NOT NULL,
                    created_at timestamp with time zone DEFAULT now(),
                    updated_at timestamp with time zone DEFAULT now()
                );
                
                CREATE TABLE IF NOT EXISTS public.order_products (
                    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
                    order_id uuid REFERENCES public.orders(id) ON DELETE CASCADE,
                    promo_id uuid,
                    quantity integer NOT NULL,
                    price double precision NOT NULL
                );

                -- Enable RLS for all tables
                ALTER TABLE public.promotions ENABLE ROW LEVEL SECURITY;
                ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
                ALTER TABLE public.locations ENABLE ROW LEVEL SECURITY;
                ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
                ALTER TABLE public.order_products ENABLE ROW LEVEL SECURITY;

                -- Create RLS policies
                -- Promotions
                DROP POLICY IF EXISTS "Allow all users to read promotions" ON public.promotions;
                DROP POLICY IF EXISTS "Allow user to manage their own promotions" ON public.promotions;
                CREATE POLICY "Allow all users to read promotions" ON public.promotions FOR SELECT TO authenticated USING ( true );
                CREATE POLICY "Allow user to manage their own promotions" ON public.promotions FOR ALL TO authenticated USING ( auth.uid() = user_id );

                -- Categories
                DROP POLICY IF EXISTS "Allow all users to read categories" ON public.categories;
                DROP POLICY IF EXISTS "Allow user to manage their own categories" ON public.categories;
                CREATE POLICY "Allow all users to read categories" ON public.categories FOR SELECT TO authenticated USING ( true );
                CREATE POLICY "Allow user to manage their own categories" ON public.categories FOR ALL TO authenticated USING ( auth.uid() = user_id );

                -- Locations
                DROP POLICY IF EXISTS "Allow all users to read locations" ON public.locations;
                DROP POLICY IF EXISTS "Allow user to manage their own locations" ON public.locations;
                CREATE POLICY "Allow all users to read locations" ON public.locations FOR SELECT TO authenticated USING ( true );
                CREATE POLICY "Allow user to manage their own locations" ON public.locations FOR ALL TO authenticated USING ( auth.uid() = user_id );

                -- Orders
                DROP POLICY IF EXISTS "Allow user to read their own orders" ON public.orders;
                DROP POLICY IF EXISTS "Allow user to manage their own orders" ON public.orders;
                CREATE POLICY "Allow user to read their own orders" ON public.orders FOR SELECT TO authenticated USING ( auth.uid() = user_id );
                CREATE POLICY "Allow user to manage their own orders" ON public.orders FOR ALL TO authenticated USING ( auth.uid() = user_id );

                -- Order Products
                DROP POLICY IF EXISTS "Allow user to read their order products" ON public.order_products;
                DROP POLICY IF EXISTS "Allow user to manage their order products" ON public.order_products;
                CREATE POLICY "Allow user to read their order products" ON public.order_products FOR SELECT TO authenticated USING ( auth.uid() = (SELECT user_id FROM public.orders WHERE orders.id = order_id) );
                CREATE POLICY "Allow user to manage their order products" ON public.order_products FOR ALL TO authenticated USING ( auth.uid() = (SELECT user_id FROM public.orders WHERE orders.id = order_id) );

                -- Storage Bucket and Policies (optional, but recommended)
                -- CREATE BUCKET IF NOT EXISTS promo_images WITH public AS false;
                -- CREATE POLICY IF NOT EXISTS "Allow authenticated users to upload and read their files" ON storage.objects
                -- FOR ALL
                -- TO authenticated
                -- USING (auth.uid() = owner);
            `;

            try {
                // Try to get data from a table. If the table doesn't exist, it will throw a '42P01' error.
                const { error } = await supabase.from('promotions').select('id').limit(1);
                
                if (error && error.code === '42P01') {
                    showStatusMessage('Configurando la base de datos por primera vez. Esto puede tardar unos segundos...');
                    
                    // We must create a new function in Supabase's SQL editor to run a batch of SQL queries.
                    // This is a more robust way to run schema migrations from the client.
                    // Go to the SQL editor in Supabase and run this once:
                    //
                    // CREATE OR REPLACE FUNCTION public.execute_sql(sql_query text)
                    // RETURNS void
                    // LANGUAGE plpgsql
                    // SECURITY DEFINER
                    // AS $$
                    // BEGIN
                    //   EXECUTE sql_query;
                    // END;
                    // $$;
                    //
                    // GRANT EXECUTE ON FUNCTION public.execute_sql(text) TO authenticated;
                    
                    // After creating the above function, call it from here:
                    const { error: queryError } = await supabase.rpc('execute_sql', { sql_query: sql });
                    
                    if (queryError) {
                        console.error('Error al ejecutar script SQL:', queryError);
                        throw queryError;
                    }
                    
                    showStatusMessage('Base de datos configurada. ¡Listo para usar!');
                }
            } catch (e) {
                console.error("Error al inicializar la base de datos:", e);
                showStatusMessage('Error crítico al configurar la base de datos. Verifique la consola de Supabase.', true);
            }
        }

        supabase.auth.onAuthStateChange(async (event, session) => {
            const authScreen = document.getElementById('auth-screen');
            const appContainer = document.getElementById('app-container');
            
            if (session) {
                appState.userId = session.user.id;
                appState.userName = session.user.email;
                document.getElementById('user-name').innerText = appState.userName;
                authScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');

                // Initialize database schema on login
                await initializeSupabaseSchema();

                // Start listening for data changes
                listenForData();
                navigate(appState.currentView);
            } else {
                appState.userId = null;
                appState.userName = null;
                authScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                showLoading(false);
            }
        });

        // --- Data Fetching and Real-time Listeners ---
        function listenForData() {
            if (!appState.userId) return;

            // Promotions Listener
            supabase.from('promotions').on('*', payload => { fetchPromotions(); }).subscribe();

            // Categories Listener
            supabase.from('categories').on('*', payload => { fetchCategories(); }).subscribe();

            // Locations Listener
            supabase.from('locations').on('*', payload => { fetchLocations(); }).subscribe();

            // Orders Listener
            supabase.from('orders').on('*', payload => { fetchOrders(); }).subscribe();

            fetchPromotions();
            fetchCategories();
            fetchLocations();
            fetchOrders();
            showLoading(false);
        }

        async function fetchPromotions() {
            const { data, error } = await supabase.from('promotions').select('*');
            if (error) { console.error("Error fetching promotions:", error); return; }
            appState.promotions = data.reduce((acc, promo) => { acc[promo.id] = promo; return acc; }, {});
            renderView();
        }

        async function fetchCategories() {
            const { data, error } = await supabase.from('categories').select('*');
            if (error) { console.error("Error fetching categories:", error); return; }
            appState.categories = data.reduce((acc, cat) => { acc[cat.id] = cat.name; return acc; }, {});
            renderView();
        }

        async function fetchLocations() {
            const { data, error } = await supabase.from('locations').select('*');
            if (error) { console.error("Error fetching locations:", error); return; }
            appState.locations = data.reduce((acc, loc) => { acc[loc.id] = loc.name; return acc; }, {});
            renderView();
        }
        
        async function fetchOrders() {
            const { data, error } = await supabase.from('orders').select('*');
            if (error) { console.error("Error fetching orders:", error); return; }
            appState.orders = data.reduce((acc, order) => { acc[order.id] = order; return acc; }, {});
            renderView();
        }

        // --- Render Functions (Same as before) ---
        function renderPromotions() {
            const listContainer = document.getElementById('promotions-list');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            const promosByCategory = Object.values(appState.promotions).reduce((acc, promo) => {
                const categoryId = promo.category_id || 'sin-categoria';
                if (!acc[categoryId]) {
                    acc[categoryId] = { name: appState.categories[categoryId] || 'Sin Categoría', promos: [] };
                }
                acc[categoryId].promos.push(promo);
                return acc;
            }, {});

            for (const categoryId in promosByCategory) {
                const category = promosByCategory[categoryId];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'col-span-full mb-4';
                categoryDiv.innerHTML = `<h3 class="text-lg font-bold text-blue-600">${category.name}</h3>`;
                listContainer.appendChild(categoryDiv);

                category.promos.forEach(promo => {
                    const promoCard = document.createElement('div');
                    promoCard.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col items-center text-center transition-transform transform hover:scale-105';
                    
                    const promoImage = promo.image || 'https://placehold.co/150x150/d1d5db/374151?text=No+Image';
                    promoCard.innerHTML = `
                        <img src="${promoImage}" alt="${promo.name}" class="w-32 h-32 object-cover rounded-lg mb-2">
                        <div class="flex-grow w-full">
                            <h3 class="text-lg font-bold text-gray-800">${promo.name}</h3>
                            <p class="text-sm text-gray-600">${promo.stock} en stock</p>
                            ${promo.original_price ? `<p class="text-sm text-red-500 line-through">$${promo.original_price.toFixed(2)}</p>` : ''}
                            <p class="text-xl font-bold text-green-600">$${promo.price.toFixed(2)}</p>
                        </div>
                        <div class="mt-4 flex space-x-2 w-full justify-center">
                            <button onclick="showPromoModal('${promo.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition-colors text-sm">Editar</button>
                            <button onclick="deletePromo('${promo.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition-colors text-sm">Eliminar</button>
                        </div>
                    `;
                    listContainer.appendChild(promoCard);
                });
            }
        }

        function renderOrders() {
            const listContainer = document.getElementById('orders-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            let totalGeneral = 0, totalDelivered = 0, totalPending = 0;

            const sortedOrders = Object.values(appState.orders).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            sortedOrders.forEach(order => {
                totalGeneral += order.total;
                if (order.status === 'Entregado') totalDelivered += order.total;
                else totalPending += order.total;

                const orderCard = document.createElement('div');
                orderCard.className = `bg-white p-4 rounded-lg shadow-md flex justify-between items-center transition-shadow hover:shadow-lg ${order.status === 'Entregado' ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}`;
                
                const locationName = appState.locations[order.location_id] || 'Localidad desconocida';
                const statusColor = order.status === 'Entregado' ? 'text-green-600' : 'text-red-600';
                
                orderCard.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="font-bold text-gray-800">Pedido #${order.id.substring(0, 6)}</h3>
                        <p class="text-sm text-gray-600">Cliente: ${order.client_name}</p>
                        <p class="text-sm text-gray-600">Localidad: ${locationName}</p>
                        <p class="text-sm ${statusColor}">${order.status}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-blue-600">$${order.total.toFixed(2)}</p>
                        <div class="mt-2 flex space-x-2">
                            <button onclick="showOrderModal('${order.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-yellow-600 transition-colors">Ver</button>
                            <button onclick="toggleOrderStatus('${order.id}', '${order.status}')" class="bg-gray-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-gray-600 transition-colors">${order.status === 'Pendiente' ? 'Marcar Entregado' : 'Marcar Pendiente'}</button>
                            <button onclick="deleteOrder('${order.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs hover:bg-red-600 transition-colors">Eliminar</button>
                        </div>
                    </div>
                `;
                listContainer.appendChild(orderCard);
            });

            document.getElementById('total-general').innerText = `$${totalGeneral.toFixed(2)}`;
            document.getElementById('total-delivered').innerText = `$${totalDelivered.toFixed(2)}`;
            document.getElementById('total-pending').innerText = `$${totalPending.toFixed(2)}`;
        }

        function renderLocations() {
            const listContainer = document.getElementById('locations-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            const locationsArray = Object.keys(appState.locations).map(id => ({ id, name: appState.locations[id] }));
            locationsArray.sort((a, b) => a.name.localeCompare(b.name));

            locationsArray.forEach(location => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors';
                    li.innerHTML = `
                        <span>${location.name}</span>
                        <button onclick="deleteLocation('${location.id}')" class="text-red-500 hover:text-red-700 transition-colors">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    listContainer.appendChild(li);
                });
        }

        function renderCategories() {
            const listContainer = document.getElementById('categories-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';
            const categoriesArray = Object.keys(appState.categories).map(id => ({ id, name: appState.categories[id] }));
            categoriesArray.sort((a, b) => a.name.localeCompare(b.name));
            
            categoriesArray.forEach(category => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors';
                li.innerHTML = `
                    <span>${category.name}</span>
                    <button onclick="deleteCategory('${category.id}')" class="text-red-500 hover:text-red-700 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                listContainer.appendChild(li);
            });
        }
        
        // --- CRUD Operations ---

        // Promotions
        window.showPromoModal = async function(promoId = null) {
            const isEditing = promoId !== null;
            const promo = appState.promotions[promoId] || {};
            const { data: categoriesData, error: categoriesError } = await supabase.from('categories').select('*');
            if (categoriesError) {
                console.error('Error fetching categories:', categoriesError);
                return;
            }
            const categoryOptions = categoriesData.map(cat => `<option value="${cat.id}" ${promo.category_id === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('');

            const modalHtml = `
                <h3 class="text-xl font-bold mb-4">${isEditing ? 'Editar Promoción' : 'Nueva Promoción'}</h3>
                <form id="promo-form" class="space-y-4">
                    <div>
                        <label for="promo-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                        <input type="text" id="promo-name" value="${promo.name || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="promo-original-price" class="block text-sm font-medium text-gray-700">Precio Original</label>
                        <input type="number" id="promo-original-price" value="${promo.original_price || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="promo-price" class="block text-sm font-medium text-gray-700">Precio Final</label>
                        <input type="number" id="promo-price" value="${promo.price || ''}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="promo-stock" class="block text-sm font-medium text-gray-700">Stock</label>
                        <input type="number" id="promo-stock" value="${promo.stock || 0}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="promo-category" class="block text-sm font-medium text-gray-700">Categoría</label>
                        <select id="promo-category" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Sin Categoría</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    <div>
                        <label for="promo-image" class="block text-sm font-medium text-gray-700">Imagen</label>
                        <input type="file" id="promo-image" accept="image/*" class="mt-1 block w-full text-sm">
                        ${promo.image ? `<img src="${promo.image}" class="mt-2 w-24 h-24 object-cover rounded-lg">` : ''}
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">${isEditing ? 'Guardar Cambios' : 'Crear Promoción'}</button>
                    </div>
                </form>
            `;
            showModal(modalHtml);

            document.getElementById('promo-form').onsubmit = async (e) => {
                e.preventDefault();
                await savePromo(promoId);
            };
        };

        window.savePromo = async function(promoId) {
            showLoading(true, 'Guardando promoción...');
            
            const imageFile = document.getElementById('promo-image').files[0];

            const name = document.getElementById('promo-name').value.trim();
            const originalPriceInput = document.getElementById('promo-original-price').value;
            const priceInput = document.getElementById('promo-price').value;
            const stockInput = document.getElementById('promo-stock').value;
            const categoryId = document.getElementById('promo-category').value || null;
            let imageUrl = appState.promotions[promoId]?.image || null;

            if (!name || !priceInput || !stockInput) {
                showModal(`
                    <h3 class="font-bold text-xl text-red-600 mb-2">Error de Validación</h3>
                    <p class="text-gray-700 mb-4">Por favor, rellena todos los campos obligatorios.</p>
                    <button onclick="closeModal()" class="bg-red-500 text-white px-4 py-2 rounded-lg">Aceptar</button>
                `);
                showLoading(false);
                return;
            }

            const originalPrice = originalPriceInput ? parseFloat(originalPriceInput) : null;
            const price = parseFloat(priceInput);
            const stock = parseInt(stockInput, 10);

            if (isNaN(price) || isNaN(stock) || stock < 0) {
                showModal(`
                    <h3 class="font-bold text-xl text-red-600 mb-2">Error de Validación</h3>
                    <p class="text-gray-700 mb-4">Por favor, introduce valores numéricos válidos para precio y stock.</p>
                    <button onclick="closeModal()" class="bg-red-500 text-white px-4 py-2 rounded-lg">Aceptar</button>
                `);
                showLoading(false);
                return;
            }

            if (originalPrice !== null && price > originalPrice) {
                showModal(`
                    <h3 class="font-bold text-xl text-red-600 mb-2">Error de Validación</h3>
                    <p class="text-gray-700 mb-4">El precio final no puede ser mayor que el precio original.</p>
                    <button onclick="closeModal()" class="bg-red-500 text-white px-4 py-2 rounded-lg">Aceptar</button>
                `);
                showLoading(false);
                return;
            }

            try {
                if (imageFile) {
                    const filePath = `${appState.userId}/${Date.now()}_${imageFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('promo_images')
                        .upload(filePath, imageFile);
                    if (uploadError) throw uploadError;
                    const { data: publicUrl } = supabase.storage.from('promo_images').getPublicUrl(filePath);
                    imageUrl = publicUrl.publicUrl;
                }

                const promoData = {
                    name,
                    original_price: originalPrice,
                    price,
                    stock,
                    category_id: categoryId,
                    image: imageUrl,
                    user_id: appState.userId
                };

                if (promoId) {
                    const { error } = await supabase.from('promotions').update(promoData).eq('id', promoId);
                    if (error) throw error;
                } else {
                    const { error } = await supabase.from('promotions').insert(promoData);
                    if (error) throw error;
                }
                
                closeModal();
                showStatusMessage('Promoción guardada con éxito.');

            } catch (error) {
                console.error("Error al guardar promoción:", error.message);
                showStatusMessage('Error al guardar promoción. Revisa la consola para más detalles.', true);
            } finally {
                await fetchPromotions();
                setTimeout(() => showLoading(false), 2000);
            }
        };

        window.deletePromo = async function(promoId) {
            showModal(`
                <h3 class="font-bold text-xl text-red-600 mb-2">Confirmar Eliminación</h3>
                <p class="text-gray-700 mb-4">¿Estás seguro de que quieres eliminar esta promoción?</p>
                <div class="flex justify-end space-x-2">
                    <button onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Cancelar</button>
                    <button onclick="confirmDeletePromo('${promoId}')" class="bg-red-500 text-white px-4 py-2 rounded-lg">Eliminar</button>
                </div>
            `);
        };
        
        window.confirmDeletePromo = async function(promoId) {
            showLoading(true, 'Eliminando promoción...');
            try {
                const { error } = await supabase.from('promotions').delete().eq('id', promoId);
                if (error) throw error;
                closeModal();
                showStatusMessage('Promoción eliminada con éxito.');
            } catch (error) {
                console.error("Error deleting promotion:", error.message);
                showStatusMessage('Error al eliminar promoción. Revisa la consola.', true);
            } finally {
                await fetchPromotions();
                setTimeout(() => showLoading(false), 2000);
            }
        };

        // Locations
        window.addLocation = async function() {
            const name = document.getElementById('new-location-input').value.trim();
            if (!name) return;
            try {
                const { error } = await supabase.from('locations').insert({ name, user_id: appState.userId });
                if (error) throw error;
                document.getElementById('new-location-input').value = '';
            } catch (e) {
                console.error("Error adding location: ", e.message);
            }
        };

        window.deleteLocation = async function(id) {
            try {
                const { error } = await supabase.from('locations').delete().eq('id', id);
                if (error) throw error;
            } catch (e) {
                console.error("Error deleting location: ", e.message);
            }
        };

        // Categories
        window.addCategory = async function() {
            const name = document.getElementById('new-category-input').value.trim();
            if (!name) return;
            try {
                const { error } = await supabase.from('categories').insert({ name, user_id: appState.userId });
                if (error) throw error;
                document.getElementById('new-category-input').value = '';
            } catch (e) {
                console.error("Error adding category: ", e.message);
            }
        };

        window.deleteCategory = async function(id) {
            try {
                const { error } = await supabase.from('categories').delete().eq('id', id);
                if (error) throw error;
            } catch (e) {
                console.error("Error deleting category: ", e.message);
            }
        };

        // Orders
        window.showOrderModal = async function(orderId = null) {
            if (orderId) {
                showLoading(true, 'Cargando pedido...');
                const { data: orderData, error: orderError } = await supabase.from('orders').select('*').eq('id', orderId).single();
                if (orderError) {
                    console.error("Error fetching order:", orderError);
                    showStatusMessage('Error al cargar el pedido.', true);
                    setTimeout(() => showLoading(false), 2000);
                    return;
                }
                appState.selectedOrder = orderData;
                
                const { data: productsData, error: productsError } = await supabase.from('order_products').select('*').eq('order_id', orderId);
                if (productsError) {
                    console.error("Error fetching order products:", productsError);
                    appState.orderProducts = [];
                } else {
                    appState.orderProducts = productsData;
                }
            } else {
                appState.selectedOrder = {
                    client_name: '',
                    client_phone: '',
                    location_id: '',
                    total: 0,
                    status: 'Pendiente'
                };
                appState.orderProducts = [];
            }
            
            showLoading(false);
            renderOrderModalContent();
        };

        function renderOrderModalContent() {
            const order = appState.selectedOrder;
            const locationOptions = Object.keys(appState.locations).map(id => `<option value="${id}" ${order.location_id === id ? 'selected' : ''}>${appState.locations[id]}</option>`).join('');
            const productOptions = Object.keys(appState.promotions).map(id => `<option value="${id}">${appState.promotions[id].name} - $${appState.promotions[id].price.toFixed(2)}</option>`).join('');
            
            const productListHtml = appState.orderProducts.map((item, index) => {
                const promoName = appState.promotions[item.promo_id]?.name || 'Producto Desconocido';
                return `
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg mb-2">
                        <span class="flex-grow">${item.quantity} x ${promoName}</span>
                        <span>$${(item.quantity * item.price).toFixed(2)}</span>
                        <button type="button" onclick="removeOrderProduct(${index})" class="ml-2 text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </div>
                `;
            }).join('');

            const modalHtml = `
                <h3 class="text-xl font-bold mb-4">${order.id ? 'Ver Pedido' : 'Nuevo Pedido'}</h3>
                <form id="order-form" class="space-y-4">
                    <div>
                        <label for="client-name" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                        <input type="text" id="client-name" value="${order.client_name}" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="client-phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
                        <input type="tel" id="client-phone" value="${order.client_phone}" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="order-location" class="block text-sm font-medium text-gray-700">Localidad</label>
                        <select id="order-location" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Selecciona una localidad</option>
                            ${locationOptions}
                        </select>
                    </div>
                    <div class="border-t pt-4">
                        <h4 class="text-lg font-semibold mb-2">Productos</h4>
                        <div id="order-products-list" class="max-h-48 overflow-y-auto mb-2">
                            ${productListHtml}
                        </div>
                        <div class="flex items-end space-x-2">
                            <div class="flex-grow">
                                <label for="product-select" class="block text-sm font-medium text-gray-700">Añadir producto</label>
                                <select id="product-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg">
                                    ${productOptions}
                                </select>
                            </div>
                            <div>
                                <label for="product-quantity" class="block text-sm font-medium text-gray-700">Cantidad</label>
                                <input type="number" id="product-quantity" value="1" min="1" class="mt-1 w-20 p-2 border border-gray-300 rounded-lg">
                            </div>
                            <button type="button" onclick="addOrderProduct()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors shadow-md flex-shrink-0">Añadir</button>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-bold text-gray-800">Total: $${appState.selectedOrder.total.toFixed(2)}</p>
                    </div>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">${order.id ? 'Guardar Pedido' : 'Crear Pedido'}</button>
                    </div>
                </form>
            `;
            showModal(modalHtml);
            
            document.getElementById('order-form').onsubmit = async (e) => {
                e.preventDefault();
                await saveOrder(order.id);
            };
        };

        window.addOrderProduct = function() {
            const select = document.getElementById('product-select');
            const quantityInput = document.getElementById('product-quantity');
            const promoId = select.value;
            const quantity = parseInt(quantityInput.value, 10);
            
            if (!promoId || quantity <= 0 || isNaN(quantity)) {
                alert('Por favor, selecciona una promoción y una cantidad válida.');
                return;
            }

            const promo = appState.promotions[promoId];
            if (!promo) {
                alert('Promoción no encontrada.');
                return;
            }

            const existingItemIndex = appState.orderProducts.findIndex(item => item.promo_id === promoId);
            if (existingItemIndex !== -1) {
                appState.orderProducts[existingItemIndex].quantity += quantity;
            } else {
                appState.orderProducts.push({
                    promo_id: promoId,
                    quantity,
                    price: promo.price
                });
            }

            // Recalcular el total
            appState.selectedOrder.total = appState.orderProducts.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            renderOrderModalContent();
        };

        window.removeOrderProduct = function(index) {
            appState.orderProducts.splice(index, 1);
            appState.selectedOrder.total = appState.orderProducts.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            renderOrderModalContent();
        };

        window.saveOrder = async function(orderId) {
            showLoading(true, 'Guardando pedido...');
            
            const clientName = document.getElementById('client-name').value.trim();
            const clientPhone = document.getElementById('client-phone').value.trim();
            const locationId = document.getElementById('order-location').value;

            if (!clientName || !locationId) {
                showStatusMessage('Por favor, completa todos los campos obligatorios.', true);
                setTimeout(() => showLoading(false), 2000);
                return;
            }

            const orderData = {
                client_name: clientName,
                client_phone: clientPhone,
                location_id: locationId,
                total: appState.selectedOrder.total,
                status: 'Pendiente',
                user_id: appState.userId
            };

            try {
                let orderResult;
                if (orderId) {
                    const { data, error } = await supabase.from('orders').update(orderData).eq('id', orderId).select();
                    if (error) throw error;
                    orderResult = data[0];
                } else {
                    const { data, error } = await supabase.from('orders').insert(orderData).select();
                    if (error) throw error;
                    orderResult = data[0];
                }

                // Guardar los productos de la orden en la tabla `order_products`
                await supabase.from('order_products').delete().eq('order_id', orderResult.id); // Limpiar antiguos
                if (appState.orderProducts.length > 0) {
                    const productsWithOrderId = appState.orderProducts.map(p => ({ ...p, order_id: orderResult.id }));
                    const { error } = await supabase.from('order_products').insert(productsWithOrderId);
                    if (error) throw error;
                }
                
                closeModal();
                showStatusMessage('Pedido guardado con éxito.');

            } catch (error) {
                console.error("Error saving order:", error.message);
                showStatusMessage('Error al guardar el pedido. Revisa la consola.', true);
            } finally {
                await fetchOrders();
                setTimeout(() => showLoading(false), 2000);
            }
        };

        window.toggleOrderStatus = async function(orderId, currentStatus) {
            showLoading(true, 'Actualizando estado...');
            const newStatus = currentStatus === 'Entregado' ? 'Pendiente' : 'Entregado';
            try {
                const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
                if (error) throw error;
                showStatusMessage('Estado actualizado con éxito.');
            } catch (error) {
                console.error("Error updating status:", error.message);
                showStatusMessage('Error al actualizar el estado.', true);
            } finally {
                await fetchOrders();
                setTimeout(() => showLoading(false), 2000);
            }
        };

        window.deleteOrder = async function(orderId) {
            showLoading(true, 'Eliminando pedido...');
            try {
                // Supabase puede eliminar los productos de la orden si configuras una "cascada" en la base de datos
                // Pero para mayor seguridad, los eliminamos primero
                await supabase.from('order_products').delete().eq('order_id', orderId);
                const { error } = await supabase.from('orders').delete().eq('id', orderId);
                if (error) throw error;

                showStatusMessage('Pedido eliminado con éxito.');
            } catch (error) {
                console.error("Error deleting order:", error.message);
                showStatusMessage('Error al eliminar el pedido.', true);
            } finally {
                await fetchOrders();
                setTimeout(() => showLoading(false), 2000);
            }
        };
    </script>
</body>
</html>







