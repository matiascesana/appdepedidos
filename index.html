<script>
// -------------------- Supabase --------------------
const SUPABASE_URL='https://ejbqlejlgprvwzrptojo.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

// -------------------- Helpers --------------------
function showToast(msg,d=3000){ 
  const t=document.createElement('div'); 
  t.textContent=msg; 
  Object.assign(t.style,{position:'fixed',bottom:'20px',right:'20px',background:'#6a1b9a',color:'#fff',padding:'10px 15px',borderRadius:'5px',opacity:'0.95'}); 
  document.body.appendChild(t); 
  setTimeout(()=>t.remove(),d);
}
function openModal(title,html){ 
  const modal=document.getElementById('modal'); 
  const content=document.getElementById('modalContent'); 
  content.innerHTML=`<span class="modal-close" onclick="closeModal()">×</span><h3>${title}</h3>${html}`; 
  modal.style.display='flex';
}
function closeModal(){ document.getElementById('modal').style.display='none'; }
async function safeGetFileUrl(fileName,bucket='private-documents'){ 
  try{
    const {data,error}=await supabase.storage.from(bucket).createSignedUrl(fileName,3600); 
    return error?null:data.signedUrl;
  }catch{return null;}
}

// -------------------- Tabs --------------------
const tabBtns=document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn=>btn.addEventListener('click',()=>{
  tabBtns.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(btn.dataset.tab).style.display='block';
}));
document.getElementById('promos').style.display='block';

// -------------------- CATEGORÍAS --------------------
async function fetchCategorias(){
  const {data,error}=await supabase.from('categorias').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('categoriaList'); container.innerHTML='';
  const select=document.getElementById('promoCategoria'); select.innerHTML='<option value="">Seleccione</option>';
  data.forEach(cat=>{
    select.innerHTML+=`<option value="${cat.id}">${cat.nombre}</option>`;
    const div=document.createElement('div'); div.className='item-card';
    div.innerHTML=`<span>${cat.nombre}</span> <div>
      <button onclick="editCategoria(${cat.id},'${cat.nombre}')">Editar</button>
      <button class="delete-btn" onclick="deleteCategoria(${cat.id})">Eliminar</button>
    </div>`;
    container.appendChild(div);
  });
}
async function addCategoria(){
  const nombre=document.getElementById('categoriaNombre').value.trim();
  if(!nombre) return alert('Ingrese nombre'); 
  const {error}=await supabase.from('categorias').insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById('categoriaForm').reset();
  fetchCategorias();
}
async function editCategoria(id,nombre){
  openModal('Editar Categoría',`<input id="editCatName" value="${nombre}"><button onclick="updateCategoria(${id})">Guardar</button>`);
}
async function updateCategoria(id){
  const nombre=document.getElementById('editCatName').value.trim();
  if(!nombre) return alert('Ingrese nombre');
  const {error}=await supabase.from('categorias').update({nombre}).eq('id',id);
  if(error) return alert(error.message);
  closeModal(); fetchCategorias(); fetchPromotions();
}
async function deleteCategoria(id){ if(confirm('Eliminar categoría?')){ await supabase.from('categorias').delete().eq('id',id); fetchCategorias(); fetchPromotions(); } }
document.getElementById('addCategoriaBtn').addEventListener('click',addCategoria);
fetchCategorias();

// -------------------- LOCALIDADES --------------------
async function fetchLocalidades(){
  const {data,error}=await supabase.from('localidades').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('localidadList'); container.innerHTML='';
  const select=document.getElementById('pedidoLocalidad'); select.innerHTML='<option value="">Seleccione</option>';
  data.forEach(loc=>{
    select.innerHTML+=`<option value="${loc.id}">${loc.nombre}</option>`;
    const div=document.createElement('div'); div.className='item-card';
    div.innerHTML=`<span>${loc.nombre}</span> <div>
      <button onclick="editLocalidad(${loc.id},'${loc.nombre}')">Editar</button>
      <button class="delete-btn" onclick="deleteLocalidad(${loc.id})">Eliminar</button>
    </div>`;
    container.appendChild(div);
  });
}
async function addLocalidad(){
  const nombre=document.getElementById('localidadNombre').value.trim();
  if(!nombre) return alert('Ingrese nombre'); 
  const {error}=await supabase.from('localidades').insert([{nombre}]);
  if(error) return alert(error.message);
  document.getElementById('localidadForm').reset();
  fetchLocalidades();
}
async function editLocalidad(id,nombre){ openModal('Editar Localidad',`<input id="editLocName" value="${nombre}"><button onclick="updateLocalidad(${id})">Guardar</button>`);}
async function updateLocalidad(id){ const nombre=document.getElementById('editLocName').value.trim(); if(!nombre) return alert('Ingrese nombre'); const {error}=await supabase.from('localidades').update({nombre}).eq('id',id); if(error) return alert(error.message); closeModal(); fetchLocalidades(); fetchOrders();}
async function deleteLocalidad(id){ if(confirm('Eliminar localidad?')){ await supabase.from('localidades').delete().eq('id',id); fetchLocalidades(); fetchOrders(); }}
document.getElementById('addLocalidadBtn').addEventListener('click',addLocalidad);
fetchLocalidades();

// -------------------- PROMOCIONES --------------------
async function fetchPromotions(){
  const {data,error}=await supabase.from('promociones').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('promoList'); container.innerHTML='';
  for(let promo of data){
    const catName=await getCategoriaName(promo.categoria_id);
    const card=document.createElement('div'); card.className='item-card';
    let imgHTML=promo.imagen?`<img src="${await safeGetFileUrl(promo.imagen)}">`:'';
    card.innerHTML=`${imgHTML}<div><strong>${promo.nombre}</strong><br>$${promo.precio} - Stock: ${promo.stock} - ${catName}</div>
    <div>
      <button onclick="editPromo(${promo.id})">Editar</button>
      <button class="delete-btn" onclick="deletePromo(${promo.id})">Eliminar</button>
    </div>`;
    container.appendChild(card);
  }
}
async function getCategoriaName(id){ if(!id) return ''; const {data}=await supabase.from('categorias').select('nombre').eq('id',id).single(); return data?data.nombre:''; }
document.getElementById('addPromoBtn').addEventListener('click',async()=>{
  const nombre=document.getElementById('promoNombre').value.trim();
  const precio=parseFloat(document.getElementById('promoPrecio').value);
  const stock=parseInt(document.getElementById('promoStock').value,10);
  const categoria_id=document.getElementById('promoCategoria').value||null;
  const imagenFile=document.getElementById('promoImagen').files[0];
  if(!nombre || isNaN(precio)||isNaN(stock)) return alert('Complete campos');
  let imagePath=null;
  if(imagenFile){
    const fileName=`promo_${Date.now()}_${imagenFile.name.replaceAll(' ','_')}`;
    const {error}=await supabase.storage.from('promo_images').upload(fileName,imagenFile,{upsert:true});
    if(error) return alert(error.message);
    imagePath=fileName;
  }
  const {error}=await supabase.from('promociones').insert([{nombre,precio,stock,categoria_id,imagen:imagePath}]);
  if(error) return alert(error.message);
  document.getElementById('promoForm').reset(); fetchPromotions(); showToast('Promoción agregada');
});
async function editPromo(id){
  const {data,error}=await supabase.from('promociones').select('*').eq('id',id).single();
  if(error) return alert(error.message);
  openModal('Editar Promoción',`
    <label>Nombre:<input id="editPromoNombre" value="${data.nombre}"></label>
    <label>Precio:<input id="editPromoPrecio" type="number" step="0.01" value="${data.precio}"></label>
    <label>Stock:<input id="editPromoStock" type="number" value="${data.stock}"></label>
    <label>Categoría:<select id="editPromoCategoria"></select></label>
    <button onclick="updatePromo(${id})">Guardar</button>
  `);
  const cats=await supabase.from('categorias').select('*'); 
  const sel=document.getElementById('editPromoCategoria'); sel.innerHTML='<option value="">Seleccione</option>';
  cats.data.forEach(c=>sel.innerHTML+=`<option value="${c.id}" ${c.id===data.categoria_id?'selected':''}>${c.nombre}</option>`);
}
async function updatePromo(id){
  const nombre=document.getElementById('editPromoNombre').value.trim();
  const precio=parseFloat(document.getElementById('editPromoPrecio').value);
  const stock=parseInt(document.getElementById('editPromoStock').value,10);
  const categoria_id=document.getElementById('editPromoCategoria').value||null;
  const {error}=await supabase.from('promociones').update({nombre,precio,stock,categoria_id}).eq('id',id);
  if(error) return alert(error.message);
  closeModal(); fetchPromotions(); showToast('Promoción actualizada');
}
async function deletePromo(id){ if(confirm('Eliminar promoción?')){ await supabase.from('promociones').delete().eq('id',id); fetchPromotions(); } }
fetchPromotions();

// -------------------- PEDIDOS --------------------
async function fetchOrders(){
  const {data,error}=await supabase.from('pedidos').select('*').order('id');
  if(error) return console.error(error);
  const container=document.getElementById('pedidoList'); container.innerHTML='';
  for(let p of data){
    const locName=await getLocalidadName(p.localidad_id);
    const div=document.createElement('div'); div.className='item-card';
    div.innerHTML=`<span>${p.cliente} pidió ${p.cantidad} x ${p.producto} - ${locName}</span>
    <div>
      <button onclick="editOrder(${p.id})">Editar</button>
      <button class="delete-btn" onclick="deleteOrder(${p.id})">Eliminar</button>
    </div>`;
    container.appendChild(div);
  }
}
async function getLocalidadName(id){ if(!id) return ''; const {data}=await supabase.from('localidades').select('nombre').eq('id',id).single(); return data?data.nombre:''; }
document.getElementById('addOrderBtn').addEventListener('click',async()=>{
  const cliente=document.getElementById('pedidoCliente').value.trim();
  const producto=document.getElementById('pedidoProducto').value.trim();
  const cantidad=parseInt(document.getElementById('pedidoCantidad').value,10);
  const localidad_id=document.getElementById('pedidoLocalidad').value||null;
  if(!cliente||!producto||isNaN(cantidad)) return alert('Complete campos');
  const {error}=await supabase.from('pedidos').insert([{cliente,producto,cantidad,localidad_id}]);
  if(error) return alert(error.message);
  document.getElementById('pedidoForm').reset(); fetchOrders(); showToast('Pedido agregado');
});
async function editOrder(id){
  const {data,error}=await supabase.from('pedidos').select('*').eq('id',id).single();
  if(error) return alert(error.message);
  openModal('Editar Pedido',`
    <label>Cliente:<input id="editPedidoCliente" value="${data.cliente}"></label>
    <label>Producto:<input id="editPedidoProducto" value="${data.producto}"></label>
    <label>Cantidad:<input type="number" id="editPedidoCantidad" value="${data.cantidad}"></label>
    <label>Localidad:<select id="editPedidoLocalidad"></select></label>
    <button onclick="updateOrder(${id})">Guardar</button>
  `);
  const locs=await supabase.from('localidades').select('*');
  const sel=document.getElementById('editPedidoLocalidad'); sel.innerHTML='<option value="">Seleccione</option>';
  locs.data.forEach(l=>sel.innerHTML+=`<option value="${l.id}" ${l.id===data.localidad_id?'selected':''}>${l.nombre}</option>`);
}
async function updateOrder(id){
  const cliente=document.getElementById('editPedidoCliente').value.trim();
  const producto=document.getElementById('editPedidoProducto').value.trim();
  const cantidad=parseInt(document.getElementById('editPedidoCantidad').value,10);
  const localidad_id=document.getElementById('editPedidoLocalidad').value||null;
  if(!cliente||!producto||isNaN(cantidad)) return alert('Complete campos');
  const {error}=await supabase.from('pedidos').update({cliente,producto,cantidad,localidad_id}).eq('id',id);
  if(error) return alert(error.message);
  closeModal(); fetchOrders(); showToast('Pedido actualizado');
}
async function deleteOrder(id){ if(confirm('Eliminar pedido?')){ await supabase.from('pedidos').delete().eq('id',id); fetchOrders(); } }
fetchOrders();

// -------------------- DOCUMENTOS --------------------
async function fetchDocuments(filter=''){
  const {data,error}=await supabase.storage.from('private-documents').list('',{limit:200});
  if(error) return console.error(error);
  const container=document.getElementById('documentsList'); container.innerHTML='';
  data.filter(f=>f.name.includes(filter)).forEach(async file=>{
    const url=await safeGetFileUrl(file.name);
    const div=document.createElement('div'); div.className='doc-item';
    div.innerHTML=`<a href="${url}" target="_blank">${file.name}</a>
    <button class="delete-btn" onclick="deleteDoc('${file.name}')">Eliminar</button>`;
    container.appendChild(div);
  });
}
document.getElementById('uploadDocsBtn').addEventListener('click',async()=>{
  const files=document.getElementById('docFiles').files;
  if(!files.length) return alert('Seleccione archivos');
  const progress=document.getElementById('docProgress');
  for(let i=0;i<files.length;i++){
    const file=files[i];
    const storageName=`${Date.now()}_${file.name.replaceAll(' ','_')}`;
    const {error}=await supabase.storage.from('private-documents').upload(storageName,file,{upsert:true});
    if(error) return alert(error.message);
    progress.style.width=`${Math.round(((i+1)/files.length)*100)}%`;
  }
  document.getElementById('docFiles').value='';
  progress.style.width='0%'; showToast('Documentos subidos'); fetchDocuments();
});
document.getElementById('searchDoc').addEventListener('input',(e)=>fetchDocuments(e.target.value));
async function deleteDoc(name){ if(confirm('Eliminar documento?')){ await supabase.storage.from('private-documents').remove([name]); fetchDocuments(); } }
document.getElementById('deleteAllDocsBtn').addEventListener('click',async()=>{ if(confirm('Eliminar todos los documentos?')){ const {data}=await supabase.storage.from('private-documents').list(''); await supabase.storage.from('private-documents').remove(data.map(f=>f.name)); fetchDocuments(); } });
fetchDocuments();

// -------------------- EXPORT PDF --------------------
document.getElementById('exportPromoPDFBtn').addEventListener('click',async()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const {data}=await supabase.from('promociones').select('*').order('id');
  let y=10;
  for(let p of data){
    doc.setFontSize(12); doc.text(`Nombre: ${p.nombre}`,10,y); y+=6;
    doc.text(`Precio: ${p.precio} - Stock: ${p.stock}`,10,y); y+=6;
    if(p.imagen){
      const url=await safeGetFileUrl(p.imagen,'promo_images');
      if(url){ const img=await loadImageToCanvas(url); doc.addImage(img, 'JPEG', 10, y, 40, 40); }
      y+=45;
    }
    y+=5; if(y>270){ doc.addPage(); y=10;}
  }
  doc.save('promociones.pdf');
});
async function loadImageToCanvas(url){
  const img=await new Promise(res=>{ const i=new Image(); i.crossOrigin="Anonymous"; i.onload=()=>res(i); i.src=url; });
  const canvas=document.createElement('canvas'); canvas.width=img.width; canvas.height=img.height;
  const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0); return canvas.toDataURL('image/jpeg');
}
document.getElementById('exportPedidosPDFBtn').addEventListener('click',async()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const {data}=await supabase.from('pedidos').select('*').order('localidad_id');
  let y=10; let currentLoc='';
  for(let p of data){
    const locName=await getLocalidadName(p.localidad_id);
    if(locName!==currentLoc){ currentLoc=locName; doc.setFontSize(14); doc.text(`Localidad: ${locName}`,10,y); y+=7;}
    doc.setFontSize(12); doc.text(`${p.cliente} pidió ${p.cantidad} x ${p.producto}`,10,y); y+=6;
    if(y>270){ doc.addPage(); y=10;}
  }
  doc.save('pedidos.pdf');
});
</script>
