<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>App Completa â€” Pedidos, Promos, Docs</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto&display=swap" rel="stylesheet">

<style>
/* -----------------------
Â  Â Estilos (con mejoras de visualizaciÃ³n)
Â  Â ----------------------- */
:root{
    --accent:#6a1b9a;
    --accent-2:#7b1fa2;
    --danger:#e53935;
    --sidebar-width: 220px; /* Variable para ancho de barra lateral */
}
*{box-sizing:border-box}

/* CAMBIO CLAVE 1: Eliminamos display:flex del body */
body{
    margin:0;
    font-family:Roboto,Arial,Helvetica,sans-serif;
    background:#f9f9f9;
    color:#222;
    min-height:100vh; /* Mantenemos la altura mÃ­nima */
}

/* CAMBIO CLAVE 2: Sidebar fija de altura completa */
.sidebar{
    position: fixed;
    top: 0;
    left: 0;
    width: var(--sidebar-width);
    background:var(--accent);
    color:#fff;
    padding:18px;
    display:flex;
    flex-direction:column;
    height: 100vh; /* Altura completa de la ventana */
    z-index: 100; /* Asegura que estÃ© por encima del contenido */
}
.sidebar .logo{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:12px}
.sidebar button{background:transparent;border:0;color:#fff;padding:10px;border-radius:8px;text-align:left;cursor:pointer;margin-bottom:8px;font-weight:700}
.sidebar button.active{background:#fff;color:var(--accent);box-shadow:0 6px 20px rgba(0,0,0,0.08)}

/* CAMBIO CLAVE 3: El contenedor principal solo desplaza el contenido */
.main{
    /* Ya no es flex. Solo necesitamos un padding-left para evitar que el contenido
       quede debajo de la sidebar cuando no tiene position:absolute */
    padding-left: var(--sidebar-width);
}
h1,h2{font-family:'Playfair Display',serif;margin:0 0 12px 0}

/* CAMBIO CLAVE 4: Cada secciÃ³n es ahora una 'pÃ¡gina' a pantalla completa */
.section{
    display:none;
    position: absolute; /* Posicionamiento absoluto para superponer secciones */
    top: 0;
    left: var(--sidebar-width); /* Empieza despuÃ©s de la sidebar */
    width: calc(100% - var(--sidebar-width)); /* Ancho restante de la pantalla */
    height: 100vh; /* Altura completa de la ventana */
    overflow-y: auto; /* Permite el scroll dentro de la secciÃ³n si el contenido es largo */
    background:#fff;
    padding:20px;
    border-radius:0; /* Quitamos border-radius ya que ocupa toda la pantalla */
    box-shadow:0 6px 20px rgba(0,0,0,0.06);
    margin-bottom:0;
}
.item-card,.doc-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#f4f4f4;margin-bottom:10px}
.item-card img{width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px}
label{display:block;margin:8px 0;font-size:14px}
input[type=text],input[type=number],select{padding:8px;margin-top:4px;border-radius:8px;border:1px solid #ddd;width:100%}
button{cursor:pointer;border:0;border-radius:8px;padding:8px 12px;background:var(--accent);color:#fff;font-weight:700}
button:hover{background:var(--accent-2)}
.delete-btn{background:var(--danger)}
.delete-btn:hover{background:#c62828}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal-content{background:#fff;padding:16px;border-radius:10px;max-width:860px;width:96%;max-height:86vh;overflow:auto;position:relative}
.modal-close{position:absolute;right:12px;top:8px;cursor:pointer;font-weight:700}
.table {width:100%;border-collapse:collapse;margin:8px 0}
.table th,.table td{padding:8px;border:1px solid #e6e6e6}
.small-muted{font-size:13px;color:#666}
.flex{display:flex;gap:10px;align-items:center}
.row{display:flex;gap:12px}
</style>
</head>
<body>

<div class="sidebar">
Â  <div class="logo">App Pedidos</div>
Â  <button class="tab-btn active" data-tab="promos">Promociones</button>
Â  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
Â  <button class="tab-btn" data-tab="categorias">CategorÃ­as</button>
Â  <button class="tab-btn" data-tab="localidades">Localidades</button>
Â  <button class="tab-btn" data-tab="documentos">Documentos</button>
Â  <div style="margin-top:auto;font-size:12px;opacity:.9">Integrado Â· PDF catÃ¡logo Â· Stock</div>
</div>

<div class="main">
Â  Â  Â  <div class="section" id="promos">
Â  Â  <h1>Promociones</h1> Â  Â  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
Â  Â  Â  <div style="flex:1;min-width:220px">
Â  Â  Â  Â  <label>Nombre / DescripciÃ³n
Â  Â  Â  Â  Â  <input id="promoNombre" type="text" placeholder="Ej: Promo de Tinturas">
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  Â  <div style="width:140px">
Â  Â  Â  Â  <label>Precio
Â  Â  Â  Â  Â  <input id="promoPrecio" type="number" step="0.01" placeholder="0.00">
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  Â  <div style="width:140px">
Â  Â  Â  Â  <label>Stock
Â  Â  Â  Â  Â  <input id="promoStock" type="number" placeholder="0">
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  Â  <div style="width:220px">
Â  Â  Â  Â  <label>CategorÃ­a
Â  Â  Â  Â  Â  <select id="promoCategoria"></select>
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  Â </div>

Â  Â  Â  <div style="width:220px">
Â  Â  Â  Â  <label>Imagen (jpg/png)
Â  Â  Â  Â  Â  <input id="promoImagen" type="file" accept="image/*">
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div style="display:flex;gap:10px;margin-bottom:12px">
Â  Â  Â  <button id="addPromoBtn">Agregar PromociÃ³n</button>
Â  Â  Â  <button id="exportPromoPdfBtn">Exportar CatÃ¡logo PDF</button>
Â  Â  Â  <button id="refreshPromosBtn" style="background:#444">Refrescar</button>
Â  Â  </div>

Â  Â  <h3>Lista de Promociones</h3>
Â  Â  <div id="promoList"></div>
Â  </div>

Â  Â  <div class="section" id="pedidos">
Â  Â  <h1>Pedidos</h1> Â  Â  <form id="pedidoForm" onsubmit="return false;" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
Â  Â  Â  <div style="flex:1;min-width:220px">
Â  Â  Â  Â  <label>Cliente
Â  Â  Â  Â  Â  <input id="pedidoCliente" type="text" placeholder="Nombre cliente">
Â  Â  Â  Â  </label>
Â  Â  Â  </div>
Â  Â  Â  <div style="width:220px">
Â  Â  Â  Â  <label>Localidad
Â  Â  Â  Â  Â  <select id="pedidoLocalidad"></select>
Â  Â  Â  Â  </label>
Â  Â  Â  </div>

Â  Â  Â  <div style="display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  <button type="button" id="selectProductsBtn">Seleccionar Productos</button>
Â  Â  Â  </div>

Â  Â  Â  <div style="width:100%;margin-top:6px">
Â  Â  Â  Â  <div id="selectedProductsContainer" class="small-muted"></div>
Â  Â  Â  </div>

Â  Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  Â  <button type="button" id="addOrderBtn">Agregar Pedido</button>
Â  Â  Â  Â  <button type="button" id="exportPedidosPDFBtn">Exportar Pedidos (PDF)</button>
Â  Â  Â  </div>
Â  Â  </form>

Â  Â  <h3>Lista de Pedidos</h3>
Â  Â  <div id="pedidoList"></div>
Â  </div>

Â  Â  <div class="section" id="categorias">
Â  Â  <h2>CategorÃ­as</h2>
Â  Â  <form id="categoriaForm" onsubmit="return false;" style="display:flex;gap:8px;margin-bottom:12px">
Â  Â  Â  <input id="categoriaNombre" placeholder="Nombre categorÃ­a" />
Â  Â  Â  <button id="addCategoriaBtn">Agregar CategorÃ­a</button>
Â  Â  </form>
Â  Â  <div id="categoriaList"></div>
Â  </div>

Â  Â  <div class="section" id="localidades">
Â  Â  <h2>Localidades</h2>
Â  Â  <form id="localidadForm" onsubmit="return false;" style="display:flex;gap:8px;margin-bottom:12px">
Â  Â  Â  <input id="localidadNombre" placeholder="Nombre localidad" />
Â  Â  Â  <button id="addLocalidadBtn">Agregar Localidad</button>
Â  Â  </form>
Â  Â  <div id="localidadList"></div>
Â  </div>

Â  Â  <div class="section" id="documentos">
Â  Â  <h2>Documentos</h2>
Â  Â  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
Â  Â  Â  <input id="searchDoc" placeholder="Buscar por DNI">
Â  Â  Â  <input id="docFiles" type="file" multiple>
Â  Â  Â  <button id="uploadDocsBtn">Subir Documentos</button>
Â  Â  Â  <button id="deleteAllDocsBtn" class="delete-btn">Eliminar Todos</button>
Â  Â  </div>

Â  Â  <div id="docProgressContainer" style="width:100%;background:#eee;border-radius:6px;overflow:hidden;margin-bottom:8px;display:none">
Â  Â  Â  <div id="docProgress" style="width:0;height:8px;background:green"></div>
Â  Â  </div>

Â  Â  <h3>Documentos subidos</h3>
Â  Â  <div id="documentsList"></div>
Â  </div>

</div>

<div id="modal" class="modal">
Â  <div class="modal-content">
Â  Â  <span class="modal-close" onclick="closeModal()">Ã—</span>
Â  Â  <div id="modalInner"></div>
Â  </div>
</div>

<script>
/* ============================
Â  Â CONFIG: Supabase (usar tus credenciales)
Â  Â ============================ */
const SUPABASE_URL = 'https://ejbqlejlgprvwzrptojo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============================
Â  Â HELPERS UI
Â  Â ============================ */
function showToast(msg, ms=3000){
Â  const t = document.createElement('div');
Â  t.textContent = msg;
Â  Object.assign(t.style,{
Â  Â  position:'fixed',right:'20px',bottom:'20px',background: 'var(--accent)', color:'#fff', padding:'10px 14px',
Â  Â  borderRadius:'8px', boxShadow:'0 6px 18px rgba(0,0,0,0.12)', zIndex:9999
Â  });
Â  document.body.appendChild(t);
Â  setTimeout(()=>t.remove(), ms);
}
function openModal(title, html){
Â  document.getElementById('modalInner').innerHTML = `<h3>${title}</h3>${html}`;
Â  document.getElementById('modal').style.display = 'flex';
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }
function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

/* ============================
Â  Â TABS (sidebar)
Â  Â ============================ */
const tabBtns = document.querySelectorAll('.tab-btn');
tabBtns.forEach(btn => btn.addEventListener('click', () => {
Â  tabBtns.forEach(b => b.classList.remove('active'));
Â  btn.classList.add('active');
Â  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
Â  document.getElementById(btn.dataset.tab).style.display = 'block';
}));
document.getElementById('promos').style.display = 'block'; // vista por defecto

/* ============================
Â  Â CATEGORÃAS
Â  Â ============================ */
async function fetchCategorias(){
Â  const { data, error } = await supabase.from('categorias').select('*').order('id');
Â  if(error) return console.error(error);
Â  const container = document.getElementById('categoriaList');
Â  container.innerHTML = '';
Â  const select = document.getElementById('promoCategoria');
Â  select.innerHTML = '<option value="">Sin categorÃ­a</option>';
Â  data.forEach(c => {
Â  Â  const div = document.createElement('div');
Â  Â  div.className = 'item-card';
Â  Â  div.innerHTML = `<span>${escapeHtml(c.nombre)}</span>
Â  Â  Â  <div><button onclick="editCategoria(${c.id},'${escapeHtml(c.nombre)}')">Editar</button>
Â  Â  Â  <button class="delete-btn" onclick="deleteCategoria(${c.id})">Eliminar</button></div>`;
Â  Â  container.appendChild(div);
Â  Â  select.innerHTML += `<option value="${c.id}">${escapeHtml(c.nombre)}</option>`;
Â  });
}
window.addCategoria = async function(){
Â  const nombre = document.getElementById('categoriaNombre').value.trim();
Â  if(!nombre) return alert('Ingrese nombre');
Â  const { error } = await supabase.from('categorias').insert([{ nombre }]);
Â  if(error) return alert(error.message);
Â  document.getElementById('categoriaNombre').value = '';
Â  fetchCategorias();
};
window.editCategoria = function(id,nombre){
Â  openModal('Editar CategorÃ­a', `<input id="editCatName" value="${escapeHtml(nombre)}"><div style="margin-top:10px"><button onclick="updateCategoria(${id})">Guardar</button></div>`);
};
window.updateCategoria = async function(id){
Â  const nombre = document.getElementById('editCatName').value.trim();
Â  if(!nombre) return alert('Ingrese nombre');
Â  const { error } = await supabase.from('categorias').update({ nombre }).eq('id', id);
Â  if(error) return alert(error.message);
Â  closeModal(); fetchCategorias();
};
window.deleteCategoria = async function(id){
Â  if(!confirm('Eliminar categorÃ­a?')) return;
Â  await supabase.from('categorias').delete().eq('id', id);
Â  fetchCategorias();
};
fetchCategorias();

/* ============================
Â  Â LOCALIDADES
Â  Â ============================ */
async function fetchLocalidades(){
Â  const { data, error } = await supabase.from('localidades').select('*').order('id');
Â  if(error) return console.error(error);
Â  const container = document.getElementById('localidadList');
Â  const sel = document.getElementById('pedidoLocalidad');
Â  container.innerHTML = ''; sel.innerHTML = '<option value="">Seleccione</option>';
Â  data.forEach(l=>{
Â  Â  container.innerHTML += `<div class="item-card"><span>${escapeHtml(l.nombre)}</span><div><button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')">Editar</button><button class="delete-btn" onclick="deleteLocalidad(${l.id})">Eliminar</button></div></div>`;
Â  Â  sel.innerHTML += `<option value="${l.id}">${escapeHtml(l.nombre)}</option>`;
Â  });
}
window.addLocalidad = async function(){
Â  const nombre = document.getElementById('localidadNombre').value.trim();
Â  if(!nombre) return alert('Ingrese nombre');
Â  const { error } = await supabase.from('localidades').insert([{ nombre }]);
Â  if(error) return alert(error.message);
Â  document.getElementById('localidadNombre').value='';
Â  fetchLocalidades();
};
window.editLocalidad = function(id,nombre){
Â  openModal('Editar Localidad', `<input id="editLocName" value="${escapeHtml(nombre)}"><div style="margin-top:10px"><button onclick="updateLocalidad(${id})">Guardar</button></div>`);
};
window.updateLocalidad = async function(id){
Â  const nombre = document.getElementById('editLocName').value.trim();
Â  if(!nombre) return alert('Ingrese nombre');
Â  const { error } = await supabase.from('localidades').update({ nombre }).eq('id', id);
Â  if(error) return alert(error.message);
Â  closeModal(); fetchLocalidades();
};
window.deleteLocalidad = async function(id){
Â  if(!confirm('Eliminar localidad?')) return;
Â  await supabase.from('localidades').delete().eq('id', id);
Â  fetchLocalidades();
};
fetchLocalidades();

/* ============================
Â  Â PROMOCIONES
Â  Â - fetchPromotions limpia el contenedor para evitar duplicados
Â  Â - upload imagen al bucket 'promo_images'
Â  Â - safeGetFileUrl para obtener signed URL (temporal) para mostrar o para PDF
Â  Â ============================ */
async function safeGetFileUrl(fileName, bucket='promo_images'){
Â  if(!fileName) return null;
Â  try{
Â  Â  const { data, error } = await supabase.storage.from(bucket).createSignedUrl(fileName, 60*60);
Â  Â  return error ? null : data.signedUrl;
Â  }catch{return null;}
}

async function fetchPromotions(){
Â  console.log('ğŸ‘‰ fetchPromotions ejecutado');
Â  const { data, error } = await supabase.from('promociones').select('*').order('id');
Â  if(error) return console.error(error);
Â  const container = document.getElementById('promoList');
Â  container.innerHTML = ''; // <-- limpiar siempre antes de renderizar

Â  // render
Â  for(const promo of data){
Â  Â  const imgUrl = promo.imagen ? await safeGetFileUrl(promo.imagen) : (promo.imagen_url || '');
Â  Â  const imgHTML = imgUrl ? `<img src="${imgUrl}" alt="" style="width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px">` : '';
Â  Â  const div = document.createElement('div');
Â  Â  div.className = 'item-card';
Â  Â  div.innerHTML = `${imgHTML}<div style="flex:1"><strong>${escapeHtml(promo.nombre || promo.descripcion || '')}</strong><div class="small-muted">$${Number(promo.precio).toFixed(2)} &nbsp; Â· &nbsp; Stock: ${promo.stock ?? 0}</div></div>
Â  Â  Â  <div>
Â  Â  Â  Â  <button onclick="editPromo(${promo.id})">Editar</button>
Â  Â  Â  Â  <button class="delete-btn" onclick="deletePromo(${promo.id})">Eliminar</button>
Â  Â  Â  </div>`;
Â  Â  container.appendChild(div);
Â  }
}

// Agregar promociÃ³n (sube imagen luego inserta registro)
document.getElementById('addPromoBtn').addEventListener('click', async ()=>{
Â  const nombre = document.getElementById('promoNombre').value.trim();
Â  const precio = parseFloat(document.getElementById('promoPrecio').value);
Â  const stock = parseInt(document.getElementById('promoStock').value,10) || 0;
Â  const categoria_id = document.getElementById('promoCategoria').value || null;
Â  const file = document.getElementById('promoImagen').files[0];
Â  if(!nombre || isNaN(precio) || !file) return alert('Complete nombre, precio e imagen');
Â  const fileName = `promo_${Date.now()}_${file.name.replaceAll(' ','_')}`;
Â  const { error: upErr } = await supabase.storage.from('promo_images').upload(fileName, file, { upsert:true });
Â  if(upErr) return alert(upErr.message);
Â  const publicUrl = await safeGetFileUrl(fileName);
Â  const { error } = await supabase.from('promociones').insert([{ nombre, precio, stock, categoria_id, imagen: fileName, imagen_url: publicUrl }]);
Â  if(error) return alert(error.message);
Â  // limpiar form y recargar promos
Â  document.getElementById('promoNombre').value=''; document.getElementById('promoPrecio').value=''; document.getElementById('promoStock').value=''; document.getElementById('promoImagen').value='';
Â  fetchPromotions(); showToast('PromociÃ³n agregada');
});

// editar promociÃ³n (simple)
window.editPromo = async function(id){
Â  const { data, error } = await supabase.from('promociones').select('*').eq('id',id).single();
Â  if(error) return alert(error.message);
Â  const p = data;
Â  openModal('Editar PromociÃ³n', `
Â  Â  <label>Nombre<input id="editPromoNombre" value="${escapeHtml(p.nombre||p.descripcion||'')}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"></label>
Â  Â  <label>Precio<input id="editPromoPrecio" type="number" step="0.01" value="${p.precio}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"></label>
Â  Â  <label>Stock<input id="editPromoStock" type="number" value="${p.stock||0}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd"></label>
Â  Â  <div style="margin-top:10px"><button onclick="updatePromo(${p.id})">Guardar</button></div>
Â  `);
};

window.updatePromo = async function(id){
Â  const nombre = document.getElementById('editPromoNombre').value.trim();
Â  const precio = parseFloat(document.getElementById('editPromoPrecio').value);
Â  const stock = parseInt(document.getElementById('editPromoStock').value,10)||0;
Â  if(!nombre || isNaN(precio)) return alert('Complete campos');
Â  const { error } = await supabase.from('promociones').update({ nombre, precio, stock }).eq('id', id);
Â  if(error) return alert(error.message);
Â  closeModal(); fetchPromotions(); showToast('PromociÃ³n actualizada');
};
window.deletePromo = async function(id){
Â  if(!confirm('Eliminar promociÃ³n?')) return;
Â  await supabase.from('promociones').delete().eq('id', id);
Â  fetchPromotions();
};
document.getElementById('refreshPromosBtn').addEventListener('click', fetchPromotions);

/* ============================
Â  Â PEDIDOS
Â  Â - selecciÃ³n mÃºltiple desde modal tipo tabla
Â  Â - control stock antes de guardar
Â  Â - ediciÃ³n: devuelve stock anterior, aplica nuevo
Â  Â - eliminaciÃ³n: devuelve stock
Â  Â ============================ */

let selectedProducts = []; // {id,nombre,cantidad,precio}
let editingOrderId = null;

// Abre modal con tabla de promos y inputs de cantidad
document.getElementById('selectProductsBtn').addEventListener('click', async ()=>{
Â  const { data:promos, error } = await supabase.from('promociones').select('*').order('id');
Â  if(error) return alert(error.message);
Â  // construir tabla HTML
Â  let html = `<table class="table"><thead><tr><th>Producto</th><th>Precio</th><th>Stock</th><th>Cantidad</th><th>Subtotal</th></tr></thead><tbody>`;
Â  for(const p of promos){
Â  Â  const qty = getSelectedQty(p.id);
Â  Â  html += `<tr>
Â  Â  Â  <td>${escapeHtml(p.nombre || p.descripcion || '')}</td>
Â  Â  Â  <td>$${Number(p.precio).toFixed(2)}</td>
Â  Â  Â  <td>${p.stock ?? 0}</td>
Â  Â  Â  <td><input type="number" min="0" max="${p.stock ?? 0}" value="${qty}" id="prod_${p.id}" data-price="${Number(p.precio)}" style="width:80px" oninput="updateSubtotal(${p.id}, ${Number(p.precio)})"></td>
Â  Â  Â  <td id="sub_${p.id}">$${(qty * Number(p.precio)).toFixed(2)}</td>
Â  Â  </tr>`;
Â  }
Â  html += `<tr><td colspan="3" style="text-align:right"><strong>Total:</strong></td><td colspan="2" id="totalPedido">$0.00</td></tr></tbody></table>
Â  Â  <div style="margin-top:10px"><button onclick="confirmProducts()">Confirmar selecciÃ³n</button></div>`;
Â  openModal('Seleccionar Productos', html);
Â  // set initial total (after modal rendered)
Â  setTimeout(()=>{ const tEl = document.getElementById('totalPedido'); if(tEl) tEl.textContent = `$${calculateTotal().toFixed(2)}` }, 40);
});

// retorna cantidad si ya estÃ¡ seleccionado
function getSelectedQty(id){ const it = selectedProducts.find(x => x.id === id); return it ? it.cantidad : 0; }

// update subtotal UI y total
function updateSubtotal(id, price){
Â  const input = document.getElementById(`prod_${id}`);
Â  if(!input) return;
Â  let qty = parseInt(input.value,10) || 0;
Â  if(qty < 0) qty = 0;
Â  if(input.max){ const mx = parseInt(input.max,10); if(qty > mx) qty = mx; }
Â  input.value = qty;
Â  const sub = document.getElementById(`sub_${id}`);
Â  if(sub) sub.textContent = `$${(qty*price).toFixed(2)}`;
Â  const tot = document.getElementById('totalPedido');
Â  if(tot) tot.textContent = `$${calculateTotal().toFixed(2)}`;
}

// calcular total en modal
function calculateTotal(){
Â  let total = 0;
Â  const inputs = document.querySelectorAll('#modalInner input[type=number]');
Â  inputs.forEach(inp=>{
Â  Â  const id = parseInt(inp.id.replace('prod_',''),10);
Â  Â  const qty = parseInt(inp.value,10) || 0;
Â  Â  const price = parseFloat(inp.getAttribute('data-price')) || 0;
Â  Â  total += qty * price;
Â  });
Â  return total;
}

// confirmar selecciÃ³n -> guarda en selectedProducts y render outside
function confirmProducts(){
Â  selectedProducts = [];
Â  const inputs = document.querySelectorAll('#modalInner input[type=number]');
Â  inputs.forEach(inp=>{
Â  Â  const qty = parseInt(inp.value,10) || 0;
Â  Â  if(qty > 0){
Â  Â  Â  const id = parseInt(inp.id.replace('prod_',''),10);
Â  Â  Â  const row = inp.closest('tr');
Â  Â  Â  const nombre = row.cells[0].textContent;
Â  Â  Â  const precio = parseFloat(row.cells[1].textContent.replace('$','')) || 0;
Â  Â  Â  selectedProducts.push({ id, nombre, cantidad: qty, precio });
Â  Â  }
Â  });
Â  closeModal(); renderSelectedProducts();

Â  // if editing an order, trigger update flow
Â  if(editingOrderId){
Â  Â  // button will call updateOrder when user clicks 'Actualizar' (we handle editing on a separate button)
Â  }
}

// render summary of selected products in pedido form
function renderSelectedProducts(){
Â  const c = document.getElementById('selectedProductsContainer');
Â  if(!selectedProducts.length){ c.innerHTML = '<span class="small-muted">No hay productos seleccionados</span>'; return; }
Â  let html = `<table class="table"><thead><tr><th>Producto</th><th>Cantidad</th><th>Subtotal</th></tr></thead><tbody>`;
Â  selectedProducts.forEach(p=>{
Â  Â  html += `<tr><td>${escapeHtml(p.nombre)}</td><td>${p.cantidad}</td><td>$${(p.precio*p.cantidad).toFixed(2)}</td></tr>`;
Â  });
Â  const total = selectedProducts.reduce((s,p)=>s + p.precio * p.cantidad, 0);
Â  html += `<tr><td colspan="2" style="text-align:right"><strong>Total:</strong></td><td>$${total.toFixed(2)}</td></tr></tbody></table>`;
Â  c.innerHTML = html;
}

/* GET promo by id helper */
async function getPromoById(id){
Â  const { data, error } = await supabase.from('promociones').select('*').eq('id', id).single();
Â  if(error) throw new Error(error.message);
Â  return data;
}

/* AGREGAR pedido -> actualiza stock, inserta pedido */
document.getElementById('addOrderBtn').addEventListener('click', async ()=>{
Â  const cliente = document.getElementById('pedidoCliente').value.trim();
Â  const localidad_id = document.getElementById('pedidoLocalidad').value || null;
Â  if(!cliente || selectedProducts.length === 0) return alert('Complete cliente y seleccione productos');

Â  // chequear stock localmente contra DB
Â  for(const p of selectedProducts){
Â  Â  const promo = await getPromoById(p.id);
Â  Â  if(p.cantidad > (promo.stock || 0)) return alert(`Stock insuficiente para ${p.nombre} (disponible: ${promo.stock})`);
Â  }

Â  // restar stock en DB
Â  for(const p of selectedProducts){
Â  Â  const promo = await getPromoById(p.id);
Â  Â  const newStock = (promo.stock || 0) - p.cantidad;
Â  Â  await supabase.from('promociones').update({ stock: newStock }).eq('id', p.id);
Â  }

Â  // insertar pedido (productos como JSON)
Â  const productosPayload = selectedProducts.map(p => ({ id: p.id, nombre: p.nombre, cantidad: p.cantidad, precio: p.precio }));
Â  const total = productosPayload.reduce((s,x)=>s + x.precio * x.cantidad, 0);
Â  const { error } = await supabase.from('pedidos').insert([{ cliente, localidad_id, productos: productosPayload, total }]);
Â  if(error) return alert(error.message);

Â  // limpiar
Â  document.getElementById('pedidoForm').reset();
Â  selectedProducts = []; renderSelectedProducts();
Â  fetchOrders(); fetchPromotions(); showToast('Pedido agregado');
});

/* FETCH and render orders */
async function fetchOrders(){
Â  const { data, error } = await supabase.from('pedidos').select('*').order('id');
Â  if(error) return console.error(error);
Â  const container = document.getElementById('pedidoList'); container.innerHTML = '';
Â  for(const p of data){
Â  Â  const div = document.createElement('div'); div.className = 'item-card';
Â  Â  let prodHTML = '<ul style="margin:6px 0;padding-left:18px">';
Â  Â  p.productos.forEach(pr => prodHTML += `<li>${escapeHtml(pr.nombre)} x ${pr.cantidad} = $${(pr.precio*pr.cantidad).toFixed(2)}</li>`);
Â  Â  prodHTML += '</ul>';
Â  Â  div.innerHTML = `<div style="flex:1"><strong>${escapeHtml(p.cliente)}</strong><div class="small-muted">${p.localidad_id?('Localidad ID:'+p.localidad_id):''}</div>${prodHTML}<strong>Total: $${Number(p.total).toFixed(2)}</strong></div>
Â  Â  Â  <div style="display:flex;flex-direction:column;gap:6px">
Â  Â  Â  Â  <button onclick="openEditOrder(${p.id})">Editar</button>
Â  Â  Â  Â  <button class="delete-btn" onclick="deleteOrder(${p.id})">Eliminar</button>
Â  Â  Â  </div>`;
Â  Â  container.appendChild(div);
Â  }
}
fetchOrders();

/* Edit order:
Â  Â - restore old stock (add back quantities from old.order)
Â  Â - load order into selectedProducts and form
Â  Â - set editingOrderId
*/
async function openEditOrder(id){
Â  const { data, error } = await supabase.from('pedidos').select('*').eq('id', id).single();
Â  if(error) return alert(error.message);
Â  const order = data;

Â  // devolver stock del pedido anterior
Â  if(order.productos && order.productos.length){
Â  Â  for(const pr of order.productos){
Â  Â  Â  // pr.id stored in payload
Â  Â  Â  const promo = await getPromoById(pr.id);
Â  Â  Â  const newStock = (promo.stock || 0) + pr.cantidad;
Â  Â  Â  await supabase.from('promociones').update({ stock: newStock }).eq('id', pr.id);
Â  Â  }
Â  }

Â  // cargar pedido en formulario para editar
Â  selectedProducts = order.productos.map(pr => ({ id: pr.id, nombre: pr.nombre, cantidad: pr.cantidad, precio: pr.precio }));
Â  document.getElementById('pedidoCliente').value = order.cliente;
Â  document.getElementById('pedidoLocalidad').value = order.localidad_id || '';
Â  renderSelectedProducts();
Â  editingOrderId = id;

Â  // change Add button behaviour: we will use confirmProducts flow to update after selecting new products
Â  showToast('Editando pedido: ajusta productos y presiona "Actualizar" en la misma secciÃ³n.');
Â  // When user opens selection modal and confirms (confirmProducts), if editingOrderId set, we will call updateOrder
Â  // Provide a direct "Actualizar Pedido" quick button:
Â  const addBtn = document.getElementById('addOrderBtn');
Â  addBtn.textContent = 'Actualizar Pedido';
Â  addBtn.onclick = async function(){ await updateOrder(editingOrderId); addBtn.textContent = 'Agregar Pedido'; addBtn.onclick = async ()=>{ /* restore listener */ document.getElementById('addOrderBtn').dispatchEvent(new Event('click')); }; };
}

/* Update order: after new selection (selectedProducts) */
async function updateOrder(id){
Â  if(!id) return alert('No hay pedido seleccionado para actualizar');
Â  const cliente = document.getElementById('pedidoCliente').value.trim();
Â  if(!cliente) return alert('Ingrese cliente');
Â  if(!selectedProducts.length) return alert('Seleccione productos');

Â  // verify stock for new selection
Â  for(const p of selectedProducts){
Â  Â  const promo = await getPromoById(p.id);
Â  Â  if(p.cantidad > (promo.stock || 0)) return alert(`Stock insuficiente para ${p.nombre}`);
Â  }
Â  // subtract stock for new selection
Â  for(const p of selectedProducts){
Â  Â  const promo = await getPromoById(p.id);
Â  Â  const newStock = (promo.stock || 0) - p.cantidad;
Â  Â  await supabase.from('promociones').update({ stock: newStock }).eq('id', p.id);
Â  }

Â  // update pedido record
Â  const payload = selectedProducts.map(p=>({ id: p.id, nombre: p.nombre, cantidad: p.cantidad, precio: p.precio }));
Â  const total = payload.reduce((s,x)=>s + x.precio * x.cantidad, 0);
Â  const { error } = await supabase.from('pedidos').update({ cliente, productos: payload, total }).eq('id', id);
Â  if(error) return alert(error.message);

Â  // reset
Â  editingOrderId = null;
Â  selectedProducts = []; renderSelectedProducts();
Â  document.getElementById('pedidoCliente').value = '';
Â  document.getElementById('pedidoLocalidad').value = '';
Â  fetchOrders(); fetchPromotions(); showToast('Pedido actualizado');
}

/* Delete order: return stock, delete row */
async function deleteOrder(id){
Â  if(!confirm('Eliminar pedido?')) return;
Â  const { data, error } = await supabase.from('pedidos').select('*').eq('id', id).single();
Â  if(error) return alert(error.message);
Â  if(data.productos && data.productos.length){
Â  Â  for(const pr of data.productos){
Â  Â  Â  const promo = await getPromoById(pr.id);
Â  Â  Â  const newStock = (promo.stock || 0) + pr.cantidad;
Â  Â  Â  await supabase.from('promociones').update({ stock: newStock }).eq('id', pr.id);
Â  Â  }
Â  }
Â  await supabase.from('pedidos').delete().eq('id', id);
Â  fetchOrders(); fetchPromotions(); showToast('Pedido eliminado y stock restaurado');
}

/* ============================
Â  Â DOCUMENTOS (storage)
Â  Â - subir, listar, eliminar
Â  Â ============================ */
async function fetchDocuments(filter=''){
Â  const { data, error } = await supabase.storage.from('private-documents').list('', { limit: 500 });
Â  if(error) return console.error(error);
Â  const container = document.getElementById('documentsList'); container.innerHTML = '';
Â  for(const f of data){
Â  Â  if(filter && !f.name.includes(filter)) continue;
Â  Â  const { data: urlData } = await supabase.storage.from('private-documents').createSignedUrl(f.name, 60*60);
Â  Â  const div = document.createElement('div'); div.className = 'doc-item';
Â  Â  div.innerHTML = `<a href="${urlData.signedUrl}" target="_blank">${f.name}</a>
Â  Â  Â  <div><button class="delete-btn" onclick="deleteDoc('${f.name}')">Eliminar</button></div>`;
Â  Â  container.appendChild(div);
Â  }
}
document.getElementById('uploadDocsBtn').addEventListener('click', async ()=>{
Â  const files = document.getElementById('docFiles').files;
Â  if(!files.length) return alert('Seleccione archivos');
Â  document.getElementById('docProgressContainer').style.display = 'block';
Â  const progressEl = document.getElementById('docProgress');
Â  for(let i=0;i<files.length;i++){
Â  Â  const file = files[i];
Â  Â  const name = `${Date.now()}_${file.name.replaceAll(' ','_')}`;
Â  Â  const { error } = await supabase.storage.from('private-documents').upload(name, file, { upsert:true });
Â  Â  if(error){ alert(error.message); break; }
Â  Â  progressEl.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
Â  }
Â  setTimeout(()=>{ document.getElementById('docProgressContainer').style.display='none'; document.getElementById('docProgress').style.width='0%'; }, 600);
Â  document.getElementById('docFiles').value='';
Â  showToast('Documentos subidos');
Â  fetchDocuments();
});
window.deleteDoc = async function(name){
Â  if(!confirm('Eliminar archivo?')) return;
Â  await supabase.storage.from('private-documents').remove([name]);
Â  fetchDocuments();
};
document.getElementById('searchDoc').addEventListener('input', (e)=>fetchDocuments(e.target.value));
fetchDocuments();

/* ============================
Â  Â EXPORTAR CATALOGO PDF (6 promos por pÃ¡gina)
Â  Â - convertimos imÃ¡genes a base64 para que aparezcan siempre
Â  Â - usamos page-break para que no corte tarjetas
Â  Â ============================ */

async function toBase64(url){
Â  return new Promise((resolve)=>{
Â  Â  if(!url) return resolve(null);
Â  Â  const img = new Image();
Â  Â  img.crossOrigin = 'anonymous';
Â  Â  img.onload = ()=>{
Â  Â  Â  try{
Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  canvas.width = img.naturalWidth
/* ... El resto de tu cÃ³digo JavaScript se mantiene sin cambios ... */
Â  Â  Â  Â  canvas.height = img.naturalHeight;
Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  ctx.drawImage(img, 0, 0);
Â  Â  Â  Â  resolve(canvas.toDataURL('image/png'));
Â  Â  Â  }catch(e){
Â  Â  Â  Â  console.error("Error converting image to base64:", e);
Â  Â  Â  Â  resolve(null);
Â  Â  Â  }
Â  Â  };
Â  Â  img.onerror = () => {
Â  Â  Â  console.warn('Error loading image for base64 conversion:', url);
Â  Â  Â  resolve(null);
Â  Â  };
Â  Â  img.src = url;
Â  });
}

async function exportPromoPdf(){
Â  const { data: promos } = await supabase.from('promociones').select('*').order('id');
Â  const categoriasData = await supabase.from('categorias').select('*');
Â  const categorias = new Map((categoriasData.data || []).map(c => [c.id, c.nombre]));

Â  let pdfContent = `
Â  Â  <div style="width:100%;padding:20px;font-family:Roboto,sans-serif;box-sizing:border-box" id="pdfCatalog">
Â  Â  Â  <h1 style="text-align:center;color:#6a1b9a;margin-bottom:20px">CatÃ¡logo de Promociones</h1>
Â  `;

Â  let cardCount = 0;
Â  for(const promo of promos){
Â  Â  const imgUrl = promo.imagen ? await safeGetFileUrl(promo.imagen) : (promo.imagen_url || '');
Â  Â  const base64Image = imgUrl ? await toBase64(imgUrl) : null;
Â  Â  const categoryName = categorias.get(promo.categoria_id) || 'General';

Â  Â  if(cardCount % 6 === 0 && cardCount !== 0){
Â  Â  Â  // Insertar salto de pÃ¡gina despuÃ©s de cada 6 tarjetas (excepto el primero)
Â  Â  Â  pdfContent += `<div style="page-break-after: always;"></div>`;
Â  Â  }

Â  Â  pdfContent += `
Â  Â  Â  <div style="display:flex;margin-bottom:15px;padding:15px;border:1px solid #ddd;border-radius:10px;page-break-inside: avoid;">
Â  Â  Â  Â  ${base64Image ? `<img src="${base64Image}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;margin-right:15px;">` : '<div style="width:80px;height:80px;border:1px solid #eee;margin-right:15px;display:inline-block;text-align:center;line-height:80px;font-size:12px;color:#aaa">Sin Imagen</div>'}
Â  Â  Â  Â  <div style="flex:1">
Â  Â  Â  Â  Â  <div style="font-weight:700;font-size:16px;color:#222">${escapeHtml(promo.nombre)}</div>
Â  Â  Â  Â  Â  <div style="color:#6a1b9a;font-weight:700;font-size:18px;margin-top:5px">$${Number(promo.precio).toFixed(2)}</div>
Â  Â  Â  Â  Â  <div style="font-size:12px;color:#666;margin-top:5px">CategorÃ­a: ${escapeHtml(categoryName)} | Stock: ${promo.stock ?? 0}</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;
Â  Â  cardCount++;
Â  }

Â  pdfContent += `</div>`;

Â  // Generar el PDF
Â  const element = document.createElement('div');
Â  element.innerHTML = pdfContent;

Â  html2pdf().set({
Â  Â  margin: [10, 10, 10, 10],
Â  Â  filename: 'catalogo_promociones.pdf',
Â  Â  image: { type: 'jpeg', quality: 0.98 },
Â  Â  html2canvas: { scale: 2, logging: false, useCORS: true },
Â  Â  jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
Â  }).from(element).save();
}

document.getElementById('exportPromoPdfBtn').addEventListener('click', exportPromoPdf);

/* ============================
Â  Â EXPORTAR PEDIDOS PDF
Â  Â ============================ */
async function exportPedidosPDF(){
Â  const { data: pedidos } = await supabase.from('pedidos').select('*').order('id', { ascending: false });
Â  const { data: localidadesData } = await supabase.from('localidades').select('*');
Â  const localidades = new Map((localidadesData || []).map(l => [l.id, l.nombre]));

Â  let pdfContent = `
Â  Â  <div style="width:100%;padding:20px;font-family:Roboto,sans-serif;box-sizing:border-box" id="pdfPedidos">
Â  Â  Â  <h1 style="text-align:center;color:#6a1b9a;margin-bottom:20px">Reporte de Pedidos</h1>
Â  `;

Â  for(const pedido of pedidos){
Â  Â  const localidad = localidades.get(pedido.localidad_id) || 'N/A';
Â  Â  const fecha = new Date(pedido.created_at).toLocaleDateString();

Â  Â  pdfContent += `
Â  Â  Â  <div style="margin-bottom:25px;padding:15px;border:1px solid #ddd;border-left:5px solid #6a1b9a;border-radius:5px;page-break-inside: avoid;">
Â  Â  Â  Â  <div style="font-weight:700;font-size:18px;color:#222">${escapeHtml(pedido.cliente)}</div>
Â  Â  Â  Â  <div style="font-size:12px;color:#666;margin-top:2px">Localidad: ${escapeHtml(localidad)} | Fecha: ${fecha}</div>
Â  Â  Â  Â  <div style="margin-top:10px;font-size:14px">
Â  Â  Â  Â  Â  <ul style="list-style-type:none;padding:0;margin:0 0 10px 0;">
Â  Â  Â  Â  Â  Â  ${pedido.productos.map(p => `
Â  Â  Â  Â  Â  Â  Â  <li style="padding:4px 0;">${escapeHtml(p.nombre)} <span style="font-weight:700">x ${p.cantidad}</span> <span style="float:right">$${(p.precio * p.cantidad).toFixed(2)}</span></li>
Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="text-align:right;font-size:16px;font-weight:700;border-top:1px solid #eee;padding-top:5px;">
Â  Â  Â  Â  Â  Total: $${Number(pedido.total).toFixed(2)}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;
Â  }

Â  pdfContent += `</div>`;

Â  // Generar el PDF
Â  const element = document.createElement('div');
Â  element.innerHTML = pdfContent;

Â  html2pdf().set({
Â  Â  margin: [10, 10, 10, 10],
Â  Â  filename: 'reporte_pedidos.pdf',
Â  Â  image: { type: 'jpeg', quality: 0.98 },
Â  Â  html2canvas: { scale: 2, logging: false },
Â  Â  jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
Â  }).from(element).save();
}

document.getElementById('exportPedidosPDFBtn').addEventListener('click', exportPedidosPDF);
</script>

</body>
</html>
