<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>App Completa — Pedidos, Promos, Docs</title>

<!-- Librerías -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto&display=swap" rel="stylesheet">

<style>
:root{--accent:#6a1b9a;--accent-2:#7b1fa2;--danger:#e53935}
*{box-sizing:border-box}
body{margin:0;font-family:Roboto,Arial,Helvetica,sans-serif;background:#f9f9f9;color:#222;display:flex;min-height:100vh}
.sidebar{width:220px;background:var(--accent);color:#fff;padding:18px;display:flex;flex-direction:column}
.sidebar .logo{font-family:'Playfair Display',serif;font-size:18px;margin-bottom:12px}
.sidebar button{background:transparent;border:0;color:#fff;padding:10px;border-radius:8px;text-align:left;cursor:pointer;margin-bottom:8px;font-weight:700}
.sidebar button.active{background:#fff;color:var(--accent);box-shadow:0 6px 20px rgba(0,0,0,0.08)}
.main{flex:1;padding:20px;overflow:auto}
h1,h2{font-family:'Playfair Display',serif;margin:0 0 12px 0}
.section{display:none;background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:18px}
.item-card,.doc-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#f4f4f4;margin-bottom:10px}
.item-card img{width:56px;height:56px;object-fit:cover;border-radius:8px;margin-right:10px}
label{display:block;margin:8px 0;font-size:14px}
input[type=text],input[type=number],select{padding:8px;margin-top:4px;border-radius:8px;border:1px solid #ddd;width:100%}
button{cursor:pointer;border:0;border-radius:8px;padding:8px 12px;background:var(--accent);color:#fff;font-weight:700}
button:hover{background:var(--accent-2)}
.delete-btn{background:var(--danger)}
.delete-btn:hover{background:#c62828}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal-content{background:#fff;padding:16px;border-radius:10px;max-width:860px;width:96%;max-height:86vh;overflow:auto;position:relative}
.modal-close{position:absolute;right:12px;top:8px;cursor:pointer;font-weight:700}
.table {width:100%;border-collapse:collapse;margin:8px 0}
.table th,.table td{padding:8px;border:1px solid #e6e6e6}
.small-muted{font-size:13px;color:#666}
.flex{display:flex;gap:10px;align-items:center}
.row{display:flex;gap:12px}
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">App Pedidos</div>
  <button class="tab-btn active" data-tab="promos">Promociones</button>
  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
  <button class="tab-btn" data-tab="categorias">Categorías</button>
  <button class="tab-btn" data-tab="localidades">Localidades</button>
  <button class="tab-btn" data-tab="documentos">Documentos</button>
  <div style="margin-top:auto;font-size:12px;opacity:.9">Integrado · PDF catálogo · Stock</div>
</div>

<!-- MAIN -->
<div class="main">
  <h1>App Completa de Pedidos y Documentos</h1>

  <!-- PROMOCIONES -->
  <div class="section" id="promos">
    <h2>Promociones</h2>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px">
      <div style="flex:1;min-width:220px">
        <label>Nombre / Descripción
          <input id="promoNombre" type="text" placeholder="Ej: Combo Hamburguesa + Papas">
        </label>
      </div>
      <div style="width:140px">
        <label>Precio
          <input id="promoPrecio" type="number" step="0.01" placeholder="0.00">
        </label>
      </div>
      <div style="width:140px">
        <label>Stock
          <input id="promoStock" type="number" placeholder="0">
        </label>
      </div>
      <div style="width:220px">
        <label>Categoría
          <select id="promoCategoria"></select>
        </label>
      </div>
      <div style="width:220px">
        <label>Imagen (jpg/png)
          <input id="promoImagen" type="file" accept="image/*">
        </label>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:12px">
      <button id="addPromoBtn">Agregar Promoción</button>
      <button id="exportPromoPdfBtn">Exportar Catálogo PDF</button>
      <button id="refreshPromosBtn" style="background:#444">Refrescar</button>
    </div>

    <h3>Lista de Promociones</h3>
    <div id="promoList"></div>
  </div>

  <!-- PEDIDOS -->
  <div class="section" id="pedidos">
    <h2>Pedidos</h2>
    <form id="pedidoForm" onsubmit="return false;" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:center">
      <div style="flex:1;min-width:220px">
        <label>Cliente
          <input id="pedidoCliente" type="text" placeholder="Nombre cliente">
        </label>
      </div>
      <div style="width:120px">
        <label>DNI
          <input id="pedidoDNI" type="text" placeholder="DNI">
        </label>
      </div>
      <div style="width:100px">
        <label>Saldo
          <input id="pedidoSaldo" type="number" placeholder="Saldo" step="0.01">
        </label>
      </div>
      <div style="width:220px">
        <label>Localidad
          <select id="pedidoLocalidad"></select>
        </label>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button type="button" id="selectProductsBtn">Seleccionar Productos</button>
      </div>

      <div style="width:100%;margin-top:6px">
        <div id="selectedProductsContainer" class="small-muted"></div>
      </div>

      <div style="display:flex;gap:8px">
        <button type="button" id="addOrderBtn">Agregar Pedido</button>
        <button type="button" id="exportPedidosPDFBtn">Exportar Pedidos (PDF)</button>
      </div>
    </form>

    <h3>Lista de Pedidos</h3>
    <div id="pedidoList"></div>
  </div>

  <!-- CATEGORÍAS -->
  <div class="section" id="categorias">
    <h2>Categorías</h2>
    <form id="categoriaForm" onsubmit="return false;" style="display:flex;gap:8px;margin-bottom:12px">
      <input id="categoriaNombre" placeholder="Nombre categoría" />
      <button id="addCategoriaBtn">Agregar Categoría</button>
    </form>
    <div id="categoriaList"></div>
  </div>

  <!-- LOCALIDADES -->
  <div class="section" id="localidades">
    <h2>Localidades</h2>
    <form id="localidadForm" onsubmit="return false;" style="display:flex;gap:8px;margin-bottom:12px">
      <input id="localidadNombre" placeholder="Nombre localidad" />
      <button id="addLocalidadBtn">Agregar Localidad</button>
    </form>
    <div id="localidadList"></div>
  </div>

  <!-- DOCUMENTOS -->
  <div class="section" id="documentos">
    <h2>Buscar Comprobantes</h2>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input type="text" id="searchDoc" placeholder="Ingresar DNI" />
      <button id="searchDocBtn">Buscar</button>
    </div>
    <div id="saldoCliente" class="small-muted" style="margin-bottom:6px"></div>
    <div id="documentList"></div>
  </div>
</div>

<!-- MODAL PRODUCTOS -->
<div class="modal" id="productsModal">
  <div class="modal-content">
    <span class="modal-close" id="closeProductsModal">X</span>
    <h3>Seleccionar Productos</h3>
    <div id="modalProductsList"></div>
    <button id="saveSelectedProductsBtn" style="margin-top:12px">Guardar Selección</button>
  </div>
</div>

<script>
const supabaseUrl = 'https://ejbqlejlgprvwzrptojo.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

let selectedProducts = [];

document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.section').forEach(sec=>sec.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
    if(btn.dataset.tab==='promos') fetchPromos();
    if(btn.dataset.tab==='pedidos') fetchOrders();
    if(btn.dataset.tab==='categorias') fetchCategorias();
    if(btn.dataset.tab==='localidades') fetchLocalidades();
  });
});
document.querySelector('.tab-btn.active').click();

// === CARGA DE PROMOCIONES ===
async function fetchPromos(){
  const { data } = await supabase.from('promociones').select('*');
  const container = document.getElementById('promoList');
  container.innerHTML='';
  data.forEach(p=>{
    const div = document.createElement('div');
    div.className='item-card';
    div.innerHTML=`<div style="display:flex;align-items:center"><img src="${p.imagen_url}" /><div>${p.nombre}<br><small>$${p.precio}</small></div></div>
      <button class="delete-btn" onclick="deletePromo(${p.id})">Eliminar</button>`;
    container.appendChild(div);
  });
}
document.getElementById('addPromoBtn').addEventListener('click',async()=>{
  const nombre=document.getElementById('promoNombre').value.trim();
  const precio=parseFloat(document.getElementById('promoPrecio').value)||0;
  const stock=parseInt(document.getElementById('promoStock').value)||0;
  const categoria=parseInt(document.getElementById('promoCategoria').value)||null;
  const imagen=document.getElementById('promoImagen').files[0];
  let imagen_url='';
  if(imagen){
    const { data } = await supabase.storage.from('promo-images').upload(`${Date.now()}_${imagen.name}`,imagen);
    imagen_url= supabase.storage.from('promo-images').getPublicUrl(data.path).publicUrl;
  }
  await supabase.from('promociones').insert([{nombre,precio,stock,categoria,imagen_url}]);
  fetchPromos();
});

// === PEDIDOS ===
async function fetchOrders(){
  const { data } = await supabase.from('pedidos').select('*');
  const container = document.getElementById('pedidoList');
  container.innerHTML='';
  for(let p of data){
    let cliente=null;
    if(p.cliente_id){
      const { data: c } = await supabase.from('clientes').select('*').eq('id',p.cliente_id).single();
      cliente=c;
    }
    const prodHTML = JSON.parse(p.productos||'[]').map(pr=>`${pr.nombre} x ${pr.cantidad}`).join(', ');
    const saldoHTML = cliente ? `<div class="small-muted">Saldo pendiente: $${Number(cliente.saldo).toFixed(2)}</div>` : '';
    const clienteNombre = cliente ? cliente.nombre : p.cliente;
    const div=document.createElement('div');
    div.className='item-card';
    div.innerHTML=`<div style="flex:1"><strong>${clienteNombre}</strong>${saldoHTML}<div class="small-muted">${prodHTML}<br>Total: $${Number(p.total).toFixed(2)}</div></div>
      <button class="delete-btn" onclick="deleteOrder(${p.id})">Eliminar</button>`;
    container.appendChild(div);
  }
}

document.getElementById('addOrderBtn').addEventListener('click',async()=>{
  const cliente=document.getElementById('pedidoCliente').value.trim();
  const dni=document.getElementById('pedidoDNI').value.trim();
  const saldo=parseFloat(document.getElementById('pedidoSaldo').value)||0;
  const localidad_id=parseInt(document.getElementById('pedidoLocalidad').value)||null;
  const productosPayload=selectedProducts;

  let cliente_id=null;
  if(dni){
    const { data: existingClient } = await supabase.from('clientes').select('*').eq('dni',dni).single();
    if(existingClient){
      cliente_id=existingClient.id;
      if(saldo!==existingClient.saldo){
        await supabase.from('clientes').update({saldo}).eq('id',cliente_id);
      }
    } else {
      const { data: newClient } = await supabase.from('clientes').insert([{nombre:cliente,dni,saldo,localidad_id}]).select().single();
      cliente_id=newClient.id;
    }
  }

  const total=productosPayload.reduce((sum,p)=>sum+p.precio*p.cantidad,0);
  await supabase.from('pedidos').insert([{cliente_id,cliente,productos:JSON.stringify(productosPayload),total,localidad_id}]);
  selectedProducts=[];
  document.getElementById('selectedProductsContainer').innerHTML='';
  fetchOrders();
});

// === DOCUMENTOS ===
document.getElementById('searchDocBtn').addEventListener('click',async()=>{
  const dni=document.getElementById('searchDoc').value.trim();
  document.getElementById('saldoCliente').textContent='';
  if(!dni) return;
  const { data: client } = await supabase.from('clientes').select('*').eq('dni',dni).single();
  if(client) document.getElementById('saldoCliente').textContent=`Saldo pendiente: $${client.saldo}`;
  // Buscar documentos en bucket
  const { data: docs } = await supabase.storage.from('private-documents').list('', {search:dni});
  const container=document.getElementById('documentList');
  container.innerHTML='';
  if(!docs || docs.length===0){
    container.innerHTML='<div>No hay documentos para ese DNI.</div>'; return;
  }
  for(let doc of docs){
    const { data: urlData } = await supabase.storage.from('private-documents').createSignedUrl(doc.name,60);
    const div=document.createElement('div');
    div.className='doc-item';
    div.innerHTML=`<div>${doc.name}</div><a href="${urlData.signedUrl}" target="_blank">Descargar</a>`;
    container.appendChild(div);
  }
});

// === MODAL PRODUCTOS ===
const productsModal=document.getElementById('productsModal');
document.getElementById('selectProductsBtn').addEventListener('click',async()=>{
  productsModal.style.display='flex';
  const { data } = await supabase.from('promociones').select('*');
  const list=document.getElementById('modalProductsList');
  list.innerHTML='';
  data.forEach(p=>{
    const div=document.createElement('div');
    div.className='flex';
    div.innerHTML=`<input type="number" min="0" value="0" style="width:60px"/> ${p.nombre} ($${p.precio})`;
    list.appendChild(div);
  });
});
document.getElementById('closeProductsModal').addEventListener('click',()=>productsModal.style.display='none');
document.getElementById('saveSelectedProductsBtn').addEventListener('click',()=>{
  const list=document.getElementById('modalProductsList');
  selectedProducts=[];
  list.querySelectorAll('div').forEach((div,i)=>{
    const cantidad=parseInt(div.querySelector('input').value);
    if(cantidad>0) selectedProducts.push({nombre:div.textContent.replace(/\(\$\d+(\.\d+)?\)/,''),cantidad,precio:parseFloat(div.textContent.match(/\$(\d+(\.\d+)?)/)[1])});
  });
  document.getElementById('selectedProductsContainer').textContent=selectedProducts.map(p=>`${p.nombre} x ${p.cantidad}`).join(', ');
  productsModal.style.display='none';
});

// === BORRAR ===
async function deletePromo(id){await supabase.from('promociones').delete().eq('id',id);fetchPromos();}
async function deleteOrder(id){await supabase.from('pedidos').delete().eq('id',id);fetchOrders();}

// === CATEGORÍAS ===
async function fetchCategorias(){
  const { data } = await supabase.from('categorias').select('*');
  const container=document.getElementById('categoriaList');
  container.innerHTML='';
  const select=document.getElementById('promoCategoria');
  select.innerHTML='<option value="">Sin categoría</option>';
  data.forEach(c=>{
    const div=document.createElement('div');
    div.className='item-card';
    div.innerHTML=`${c.nombre} <button class="delete-btn" onclick="deleteCategoria(${c.id})">Eliminar</button>`;
    container.appendChild(div);
    select.innerHTML+=`<option value="${c.id}">${c.nombre}</option>`;
  });
}
document.getElementById('addCategoriaBtn').addEventListener('click',async()=>{
  const nombre=document.getElementById('categoriaNombre').value.trim();
  if(!nombre) return;
  await supabase.from('categorias').insert([{nombre}]);
  document.getElementById('categoriaNombre').value='';
  fetchCategorias();
});
async function deleteCategoria(id){await supabase.from('categorias').delete().eq('id',id);fetchCategorias();}

// === LOCALIDADES ===
async function fetchLocalidades(){
  const { data } = await supabase.from('localidades').select('*');
  const container=document.getElementById('localidadList');
  const select=document.getElementById('pedidoLocalidad');
  container.innerHTML='';
  select.innerHTML='<option value="">Sin localidad</option>';
  data.forEach(l=>{
    const div=document.createElement('div');
    div.className='item-card';
    div.innerHTML=`${l.nombre} <button class="delete-btn" onclick="deleteLocalidad(${l.id})">Eliminar</button>`;
    container.appendChild(div);
    select.innerHTML+=`<option value="${l.id}">${l.nombre}</option>`;
  });
}
document.getElementById('addLocalidadBtn').addEventListener('click',async()=>{
  const nombre=document.getElementById('localidadNombre').value.trim();
  if(!nombre) return;
  await supabase.from('localidades').insert([{nombre}]);
  document.getElementById('localidadNombre').value='';
  fetchLocalidades();
});
async function deleteLocalidad(id){await supabase.from('localidades').delete().eq('id',id);fetchLocalidades();}
</script>
</body>
</html>
