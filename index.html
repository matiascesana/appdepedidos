<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>App de Pedidos y Documentos</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #docProgressContainer { width: 100%; background:#eee; border-radius:5px; margin-top:5px; }
    #docProgress { width:0%; height:10px; background:green; border-radius:5px; }
    .section { margin-bottom: 40px; }
</style>
</head>
<body>

<h1>App de Pedidos y Promociones</h1>

<div class="section">
    <h2>Promociones</h2>
    <form id="promoForm">
        <label>Nombre: <input type="text" id="promoNombre"></label><br><br>
        <label>Precio: <input type="number" id="promoPrecio"></label><br><br>
        <label>Stock: <input type="number" id="promoStock"></label><br><br>
        <label>Imagen: <input type="file" id="promoImagen"></label><br><br>
        <button type="button" onclick="addPromotion()">Agregar Promoción</button>
    </form>
    <h3>Lista de Promociones</h3>
    <div id="promoList"></div>
</div>

<div class="section">
    <h2>Pedidos</h2>
    <form id="pedidoForm">
        <label>Cliente: <input type="text" id="pedidoCliente"></label><br><br>
        <label>Producto: <input type="text" id="pedidoProducto"></label><br><br>
        <label>Cantidad: <input type="number" id="pedidoCantidad"></label><br><br>
        <button type="button" onclick="addOrder()">Agregar Pedido</button>
    </form>
    <h3>Lista de Pedidos</h3>
    <div id="pedidoList"></div>
</div>

<div class="section">
    <h2>Documentos</h2>
    <input type="file" id="docFiles" multiple>
    <button onclick="uploadFiles()">Subir Documentos</button>
    <div id="docProgressContainer">
        <div id="docProgress"></div>
    </div>
    <h3>Documentos subidos:</h3>
    <div id="documentsList"></div>
</div>

<script>
    // Inicialización Supabase
    const supabaseUrl = 'https://ejbqlejlgprvwzrptojo.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // ------------------ PROMOCIONES ------------------
    async function addPromotion() {
        const nombre = document.getElementById('promoNombre').value;
        const precio = parseFloat(document.getElementById('promoPrecio').value);
        const stock = parseInt(document.getElementById('promoStock').value);
        const imagenFile = document.getElementById('promoImagen').files[0];

        if (!nombre || isNaN(precio) || isNaN(stock)) {
            return alert('Complete todos los campos correctamente');
        }

        let imagePath = null;
        if (imagenFile) {
            const fileName = `${Date.now()}_${imagenFile.name}`;
            const { error } = await supabase.storage.from('private-documents').upload(fileName, imagenFile, { upsert: true });
            if (error) return alert('Error subiendo imagen: ' + error.message);
            imagePath = fileName;
        }

        try {
            const { data, error } = await supabase.from('promociones').insert([{ nombre, precio, stock, imagen: imagePath }]);
            if (error) throw error;
            document.getElementById('promoForm').reset();
            fetchPromotions();
            showToast('Promoción agregada');
        } catch (err) {
            console.error(err);
            alert('Error agregando promoción: ' + err.message);
        }
    }

    async function fetchPromotions() {
        const { data, error } = await supabase.from('promociones').select();
        if (error) return console.error(error);

        const container = document.getElementById('promoList');
        container.innerHTML = '';
        for (let promo of data) {
            let imgTag = promo.imagen ? `<img src="${await getFileUrl(promo.imagen)}" width="50">` : '';
            container.innerHTML += `<div>${imgTag} ${promo.nombre} - $${promo.precio} - Stock: ${promo.stock}</div>`;
        }
    }

    // ------------------ PEDIDOS ------------------
    async function addOrder() {
        const cliente = document.getElementById('pedidoCliente').value;
        const producto = document.getElementById('pedidoProducto').value;
        const cantidad = parseInt(document.getElementById('pedidoCantidad').value);

        if (!cliente || !producto || isNaN(cantidad)) return alert('Complete todos los campos correctamente');

        try {
            const { data, error } = await supabase.from('pedidos').insert([{ cliente, producto, cantidad }]);
            if (error) throw error;
            document.getElementById('pedidoForm').reset();
            fetchOrders();
            showToast('Pedido agregado');
        } catch (err) {
            console.error(err);
            alert('Error agregando pedido: ' + err.message);
        }
    }

    async function fetchOrders() {
        const { data, error } = await supabase.from('pedidos').select();
        if (error) return console.error(error);

        const container = document.getElementById('pedidoList');
        container.innerHTML = '';
        for (let pedido of data) {
            container.innerHTML += `<div>${pedido.cliente} pidió ${pedido.cantidad} x ${pedido.producto}</div>`;
        }
    }

    // ------------------ DOCUMENTOS ------------------
    async function uploadFiles() {
        const files = document.getElementById('docFiles').files;
        if (files.length === 0) return alert('Seleccione archivos');

        const progressElem = document.getElementById('docProgress');

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileName = `${Date.now()}_${file.name}`;

            try {
                const { error } = await supabase.storage.from('private-documents').upload(fileName, file, { upsert: true });
                if (error) throw error;

                progressElem.style.width = `${Math.round(((i + 1) / files.length) * 100)}%`;
            } catch (err) {
                console.error('Error subiendo archivo:', err.message);
                alert('Error subiendo ' + file.name + ': ' + err.message);
                progressElem.style.width = '0%';
                return;
            }
        }

        document.getElementById('docFiles').value = '';
        progressElem.style.width = '0%';
        showToast('Documentos subidos');
        fetchDocuments();
    }

    async function fetchDocuments() {
        const { data, error } = await supabase.storage.from('private-documents').list('', { limit: 100 });
        if (error) return console.error(error);

        const container = document.getElementById('documentsList');
        container.innerHTML = '';

        for (let file of data) {
            const url = await getFileUrl(file.name);
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.textContent = file.name;
            container.appendChild(link);
            container.appendChild(document.createElement('br'));
        }
    }

    async function getFileUrl(fileName) {
        const { data, error } = await supabase.storage.from('private-documents').createSignedUrl(fileName, 3600);
        if (error) {
            console.error('Error creando URL firmada', error);
            return '#';
        }
        return data.signedUrl;
    }

    // ------------------ TOAST ------------------
    function showToast(msg) {
        const toast = document.createElement('div');
        toast.textContent = msg;
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.right = '20px';
        toast.style.background = '#333';
        toast.style.color = '#fff';
        toast.style.padding = '10px 15px';
        toast.style.borderRadius = '5px';
        toast.style.opacity = '0.9';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // ------------------ INICIALIZACION ------------------
    fetchPromotions();
    fetchOrders();
    fetchDocuments();

</script>

</body>
</html>
