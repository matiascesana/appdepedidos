<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Administrativo Completo</title>
<style>
:root {
  --sidebar-bg: #2c3e50;
  --sidebar-hover: #34495e;
  --accent: #ff4d4f;
  --card-bg: #fff;
  --card-border: #ddd;
  --text-muted: #555;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  display: flex;
  height: 100vh;
  background: #f5f6fa;
}

.sidebar {
  width: 220px;
  background: var(--sidebar-bg);
  color: #fff;
  display: flex;
  flex-direction: column;
  padding-top: 20px;
  flex-shrink: 0;
}

.sidebar h2 {
  text-align: center;
  margin-bottom: 20px;
  font-size: 22px;
}

.sidebar button {
  background: none;
  border: none;
  color: white;
  text-align: left;
  padding: 12px 20px;
  cursor: pointer;
  font-size: 16px;
  width: 100%;
  transition: 0.2s;
}

.sidebar button:hover,
.sidebar button.active {
  background: var(--sidebar-hover);
}

.content {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.section {
  display: none;
}

.section.active {
  display: block;
}

.item-card {
  display: flex;
  align-items: center;
  gap: 15px;
  background: var(--card-bg);
  padding: 12px 15px;
  border-radius: 8px;
  margin-bottom: 10px;
  border: 1px solid var(--card-border);
  transition: 0.2s;
}

.item-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.item-card img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.item-card .info {
  flex: 1;
}

.item-card .delete-btn {
  color: var(--accent);
  background: none;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

.item-card .delete-btn:hover {
  text-decoration: underline;
}

.small-muted {
  font-size: 0.85em;
  color: var(--text-muted);
}

form input, form select, form button {
  padding: 8px;
  margin-bottom: 10px;
  font-size: 14px;
  border-radius: 5px;
  border: 1px solid #ccc;
  width: 100%;
  box-sizing: border-box;
}

form button {
  background: var(--accent);
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.2s;
}

form button:hover {
  background: #e8434f;
}

h1 { margin-top:0; margin-bottom:15px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="sidebar">
  <h2>Admin</h2>
  <button class="tab-btn active" data-tab="promos">Promociones</button>
  <button class="tab-btn" data-tab="pedidos">Pedidos</button>
  <button class="tab-btn" data-tab="categorias">Categorías</button>
  <button class="tab-btn" data-tab="localidades">Localidades</button>
  <button class="tab-btn" data-tab="documentos">Documentos</button>
</div>

<div class="content">
  <!-- PROMOCIONES -->
  <div id="promos" class="section active">
    <h1>Gestión de Promociones</h1>
    <form id="promoForm" onsubmit="event.preventDefault(); addPromo();">
      <input type="text" id="promoNombre" placeholder="Nombre" required>
      <input type="number" id="promoPrecio" placeholder="Precio" step="0.01" required>
      <input type="number" id="promoPrecioAnterior" placeholder="Precio anterior" step="0.01">
      <input type="number" id="promoStock" placeholder="Stock">
      <select id="promoCategoria"></select>
      <input type="file" id="promoImagen" accept="image/*">
      <button type="submit">Agregar promoción</button>
    </form>
    <div id="promoList"></div>
  </div>

  <!-- CATEGORÍAS -->
  <div id="categorias" class="section">
    <h1>Gestión de Categorías</h1>
    <form id="categoriaForm" onsubmit="event.preventDefault(); addCategoria();">
      <input type="text" id="categoriaNombre" placeholder="Nombre de categoría" required>
      <button type="submit">Agregar</button>
    </form>
    <div id="categoriaList"></div>
  </div>

  <!-- LOCALIDADES -->
  <div id="localidades" class="section">
    <h1>Gestión de Localidades</h1>
    <form id="localidadForm" onsubmit="event.preventDefault(); addLocalidad();">
      <input type="text" id="localidadNombre" placeholder="Nombre de localidad" required>
      <button type="submit">Agregar</button>
    </form>
    <div id="localidadList"></div>
  </div>

  <!-- PEDIDOS -->
  <div id="pedidos" class="section">
    <h1>Gestión de Pedidos</h1>
    <form id="pedidoForm" onsubmit="event.preventDefault(); addPedido();">
      <input type="text" id="pedidoCliente" placeholder="Cliente" required>
      <input type="text" id="pedidoProducto" placeholder="Producto" required>
      <input type="number" id="pedidoCantidad" placeholder="Cantidad" required>
      <select id="pedidoLocalidad"></select>
      <button type="submit">Agregar pedido</button>
    </form>
    <div id="pedidoList"></div>
  </div>

  <!-- DOCUMENTOS -->
  <div id="documentos" class="section">
    <h1>Gestión de Documentos</h1>
    <form id="docForm" onsubmit="event.preventDefault(); addDocumento();">
      <input type="file" id="docFile" required>
      <button type="submit">Subir documento</button>
    </form>
    <div id="docList"></div>
  </div>
</div>

<script>
const SUPABASE_URL = "https://ejbqlejlgprvwzrptojo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqYnFsZWpsZ3Bydnd6cnB0b2pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwMjkwMjIsImV4cCI6MjA3MjYwNTAyMn0.9fVItJka0MN3nlfowVudIE0AuNmfTJGQcbbqpau2Th8";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Sidebar tabs
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// Escape HTML
function escapeHtml(text){ var div=document.createElement("div"); div.innerText=text; return div.innerHTML; }

// ---------------- PROMOCIONES ----------------
async function fetchPromotions() {
  const { data: promos, error } = await supabase
    .from("promociones")
    .select("id,nombre,precio,precio_anterior,stock,imagen_url,categoria_id,categorias(nombre)")
    .order("id",{ascending:false});
  if(error){ console.error(error); return; }

  const promoList = document.getElementById("promoList");
  promoList.innerHTML = "";

  for(const promo of promos){
    const card=document.createElement("div"); card.className="item-card";

    const img=document.createElement("img");
    if(promo.imagen_url){
      const url = supabase.storage.from("promo_images").getPublicUrl(promo.imagen_url).data.publicUrl;
      img.src=url;
    }
    card.appendChild(img);

    const info=document.createElement("div"); info.className="info";
    let precioHTML=`<b>$${Number(promo.precio).toFixed(2)}</b>`;
    if(promo.precio_anterior && Number(promo.precio_anterior)>Number(promo.precio)){
      precioHTML=`<span style="text-decoration:line-through;color:#999;margin-right:6px;">$${Number(promo.precio_anterior).toFixed(2)}</span>
                  <b style="color:var(--accent);">$${Number(promo.precio).toFixed(2)}</b>`;
    }
    const catNombre=promo.categorias?.nombre||"Sin categoría";
    info.innerHTML=`<b>${escapeHtml(promo.nombre)}</b> (${escapeHtml(catNombre)})<br>${precioHTML}<br>
                    <span class="small-muted">Stock: ${promo.stock??0}</span>`;
    card.appendChild(info);

    const delBtn=document.createElement("button"); delBtn.className="delete-btn"; delBtn.textContent="Eliminar";
    delBtn.onclick=()=>deletePromo(promo.id);
    card.appendChild(delBtn);

    promoList.appendChild(card);
  }
}

async function addPromo(){
  const nombre=document.getElementById("promoNombre").value;
  const precio=document.getElementById("promoPrecio").value;
  const precio_anterior=document.getElementById("promoPrecioAnterior").value;
  const stock=document.getElementById("promoStock").value;
  const categoria=document.getElementById("promoCategoria").value;
  const file=document.getElementById("promoImagen").files[0];
  let imagenPath=null;
  if(file){
    const fileName=`${Date.now()}_${file.name}`;
    const {error:upError}=await supabase.storage.from("promo_images").upload(fileName,file);
    if(upError){ alert(upError.message); return; }
    imagenPath=fileName;
  }
  const {error}=await supabase.from("promociones").insert({
    nombre, precio, precio_anterior, stock, categoria_id:categoria||null, imagen_url:imagenPath
  });
  if(error){ alert(error.message); return; }
  document.getElementById("promoForm").reset();
  fetchPromotions();
}

async function deletePromo(id){
  if(!confirm("¿Eliminar promoción?")) return;
  const {error}=await supabase.from("promociones").delete().eq("id",id);
  if(error){ alert(error.message); return; }
  fetchPromotions();
}

// ---------------- CATEGORÍAS ----------------
async function fetchCategorias(){
  const { data, error } = await supabase.from("categorias").select("*").order("id");
  if(error) return console.error(error);
  const container=document.getElementById("categoriaList");
  const select=document.getElementById("promoCategoria");
  const pedidoSelect=document.getElementById("pedidoLocalidad");
  container.innerHTML=""; select.innerHTML='<option value="">Sin categoría</option>';
  data.forEach(c=>{
    const div=document.createElement("div"); div.className="item-card";
    div.innerHTML=`<span>${escapeHtml(c.nombre)}</span>
      <div><button onclick="editCategoria(${c.id},'${escapeHtml(c.nombre)}')">Editar</button>
      <button class="delete-btn" onclick="deleteCategoria(${c.id})">Eliminar</button></div>`;
    container.appendChild(div);
    select.innerHTML+=`<option value="${c.id}">${escapeHtml(c.nombre)}</option>`;
  });
}
async function addCategoria(){
  const nombre=document.getElementById("categoriaNombre").value.trim();
  if(!nombre) return alert("Ingrese nombre");
  const {error}=await supabase.from("categorias").insert([{nombre}]);
  if(error){ alert(error.message); return; }
  document.getElementById("categoriaForm").reset();
  fetchCategorias(); fetchPromotions();
}
async function deleteCategoria(id){
  if(!confirm("Eliminar categoría?")) return;
  await supabase.from("categorias").delete().eq("id",id);
  fetchCategorias(); fetchPromotions();
}
function editCategoria(id,nombre){
  const newName=prompt("Editar categoría",nombre);
  if(!newName) return;
  supabase.from("categorias").update({nombre:newName}).eq("id",id).then(()=>fetchCategorias());
}

// ---------------- LOCALIDADES ----------------
async function fetchLocalidades(){
  const { data, error } = await supabase.from("localidades").select("*").order("id");
  if(error) return console.error(error);
  const container=document.getElementById("localidadList");
  const sel=document.getElementById("pedidoLocalidad");
  container.innerHTML=""; sel.innerHTML='<option value="">Seleccione</option>';
  data.forEach(l=>{
    container.innerHTML+=`<div class="item-card"><span>${escapeHtml(l.nombre)}</span><div>
      <button onclick="editLocalidad(${l.id},'${escapeHtml(l.nombre)}')">Editar</button>
      <button class="delete-btn" onclick="deleteLocalidad(${l.id})">Eliminar</button></div></div>`;
    sel.innerHTML+=`<option value="${l.id}">${escapeHtml(l.nombre)}</option>`;
  });
}
async function addLocalidad(){
  const nombre=document.getElementById("localidadNombre").value.trim();
  if(!nombre) return alert("Ingrese nombre");
  const {error}=await supabase.from("localidades").insert([{nombre}]);
  if(error){ alert(error.message); return; }
  document.getElementById("localidadForm").reset();
  fetchLocalidades();
}
async function deleteLocalidad(id){
  if(!confirm("Eliminar localidad?")) return;
  await supabase.from("localidades").delete().eq("id",id);
  fetchLocalidades();
}
function editLocalidad(id,nombre){
  const newName=prompt("Editar localidad",nombre);
  if(!newName) return;
  supabase.from("localidades").update({nombre:newName}).eq("id",id).then(()=>fetchLocalidades());
}

// ---------------- PEDIDOS ----------------
async function fetchPedidos(){
  const { data, error } = await supabase.from("pedidos").select("*").order("id",{ascending:false});
  if(error) return console.error(error);
  const container=document.getElementById("pedidoList"); container.innerHTML="";
  data.forEach(p=>{
    const div=document.createElement("div"); div.className="item-card";
    div.innerHTML=`<div class="info"><b>${escapeHtml(p.cliente)}</b> - ${escapeHtml(p.producto)}<br>
                   Cantidad: ${p.cantidad}<br>
                   <span class="small-muted">Localidad: ${escapeHtml(p.localidad_id)}</span></div>
                   <button class="delete-btn" onclick="deletePedido(${p.id})">Eliminar</button>`;
    container.appendChild(div);
  });
}
async function addPedido(){
  const cliente=document.getElementById("pedidoCliente").value.trim();
  const producto=document.getElementById("pedidoProducto").value.trim();
  const cantidad=document.getElementById("pedidoCantidad").value;
  const localidad=document.getElementById("pedidoLocalidad").value;
  if(!cliente||!producto||!cantidad||!localidad) return alert("Complete todos los campos");
  const {error}=await supabase.from("pedidos").insert([{cliente,producto,cantidad,localidad_id:localidad}]);
  if(error){ alert(error.message); return; }
  document.getElementById("pedidoForm").reset();
  fetchPedidos();
}
async function deletePedido(id){
  if(!confirm("Eliminar pedido?")) return;
  const {error}=await supabase.from("pedidos").delete().eq("id",id);
  if(error){ alert(error.message); return; }
  fetchPedidos();
}

// ---------------- DOCUMENTOS ----------------
async function fetchDocumentos(){
  const { data, error } = await supabase.storage.from("documentos").list();
  if(error){ console.error(error); return; }
  const container=document.getElementById("docList"); container.innerHTML="";
  data.forEach(d=>{
    const url = supabase.storage.from("documentos").getPublicUrl(d.name).data.publicUrl;
    const div=document.createElement("div"); div.className="item-card";
    div.innerHTML=`<div class="info"><a href="${url}" target="_blank">${escapeHtml(d.name)}</a></div>
                   <button class="delete-btn" onclick="deleteDocumento('${d.name}')">Eliminar</button>`;
    container.appendChild(div);
  });
}
async function addDocumento(){
  const file=document.getElementById("docFile").files[0];
  if(!file) return alert("Seleccione un archivo");
  const fileName=`${Date.now()}_${file.name}`;
  const {error}=await supabase.storage.from("documentos").upload(fileName,file);
  if(error){ alert(error.message); return; }
  document.getElementById("docForm").reset();
  fetchDocumentos();
}
async function deleteDocumento(name){
  if(!confirm("Eliminar documento?")) return;
  const {error}=await supabase.storage.from("documentos").remove([name]);
  if(error){ alert(error.message); return; }
  fetchDocumentos();
}

// ---------------- INICIALIZACIÓN -----------------
fetchCategorias(); fetchLocalidades(); fetchPromotions(); fetchPedidos(); fetchDocumentos();
</script>
</body>
</html>
